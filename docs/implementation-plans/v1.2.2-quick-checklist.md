# Dify v1.2.2 混合搜尋實施快速檢查清單

**版本**: v1.2.2 (Hybrid Search + Title Boost)  
**日期**: 2025-11-27  
**狀態**: 📝 規劃完成，待執行

---

## 🎯 核心目標
- ✅ 第一階段改用混合搜尋（向量+關鍵字+RRF）
- ✅ 保留第二階段邏輯（全文向量搜尋）
- ✅ 保留 Title Boost（15%/10%）
- ✅ 獨立版本（不影響 v1.1, v1.2, v1.2.1）
- ✅ Baseline 功能（一鍵切換）
- ✅ Dify 外部知識庫整合

---

## 📝 實施步驟（依序執行）

### ✅ 階段 1：資料庫準備
- [x] **步驟 1：建立 GIN 索引** (10 分鐘) ✅ **已完成 2025-11-27**
  ```sql
  CREATE INDEX idx_section_fulltext_search 
  ON document_section_embeddings USING GIN (
      to_tsvector('simple', coalesce(title, '') || ' ' || coalesce(content, ''))
  );
  ```
  - 驗證：✅ 索引已創建，345 筆記錄
  - 檔案：無（直接執行 SQL）

---

### ✅ 階段 2：核心功能開發
- [x] **步驟 2：實作混合搜尋方法** (3 小時) ✅ **已完成 2025-11-27**
  - 檔案：`library/protocol_guide/search_service.py`
  - 新增：`_keyword_search()`, `_merge_with_rrf()`, `_get_doc_identifier()`
  - 修改：`search_knowledge()` 添加混合搜尋分支
  - 驗證：✅ 測試通過，「iol 密碼」查詢返回正確結果

- [x] **步驟 3：創建 v1.2.2 版本腳本** (30 分鐘) ✅ **已完成 2025-11-27**
  - 檔案：`backend/scripts/create_dify_v1_2_2_hybrid_version.py`
  - 執行：`docker exec ai-django python scripts/create_dify_v1_2_2_hybrid_version.py`
  - 驗證：✅ v1.2.2 已創建，is_baseline=True

---

### ✅ 階段 3：Dify 整合
- [x] **步驟 4：更新 Dify 外部知識庫 API** (1 小時) ✅ **已完成 2025-11-27**
  - 檔案 1：`backend/api/views/dify_knowledge_views.py`
    - 修改：✅ 已存在 Baseline 配置讀取邏輯
  - 檔案 2：`library/dify_knowledge/__init__.py`
    - 修改：✅ 已支援 version_config 參數傳遞
  - 驗證：✅ 數據流完整，version_config 正確傳遞到底層搜尋服務

- [ ] **步驟 5：實作 Baseline 切換 API** (1 小時)
  - 檔案：`backend/api/views/dify_knowledge_views.py`
  - 新增：`set_baseline_version(request, version_id)`
  - URL：`/api/dify/versions/<id>/set_baseline/`
  - 驗證：Postman/curl 測試通過

---

### ✅ 階段 4：前端整合
- [ ] **步驟 6：前端 Baseline 按鈕** (2 小時)
  - 檔案：前端 VSA 版本管理頁面
  - 新增：「設為 Baseline」按鈕
  - 新增：星星圖標標記
  - 驗證：點擊按鈕後 API 調用成功，UI 更新

- [x] **步驟 7：Protocol Chat Handler 使用 Baseline** (30 分鐘) ✅ **已完成 2025-11-27**
  - 檔案：`library/dify_integration/protocol_chat_handler.py`
  - 修改：✅ `_load_version_config()` 優先讀取 Baseline
  - 驗證：✅ 測試通過，自動載入 v1.2.2

---

### ✅ 階段 5：測試與驗收
- [ ] **步驟 8：建立測試腳本** (1.5 小時)
  - 檔案：`backend/test_hybrid_search_v1_2_2.py`
  - 內容：10 條驗證問題（見下方測試題庫）
  - 執行：`docker exec ai-django python backend/test_hybrid_search_v1_2_2.py`
  - 驗證：通過率 ≥ 90%

- [ ] **步驟 9：文檔與最終驗收** (2 小時)
  - 更新：實施計畫文檔（標記完成狀態）
  - 更新：VSA 使用手冊
  - 執行：完整驗收測試（功能、效能、兼容性）

---

## 🧪 測試題庫（10 條驗證問題）

### 類型 1：精確關鍵字查詢（3 題）
1. **「iol 密碼」** - 期望：sec_5 排名第 1（從第 5 名提升）
2. **「sudo 密碼」** - 期望：包含 sudo 和密碼的段落排名 Top 3
3. **「IOL 執行檔路徑」** - 期望：sec_1 排名第 1（基準測試）

### 類型 2：語義查詢（2 題）
4. **「如何測試 USB 裝置」** - 期望：USB 測試 SOP Top 3（保持準確度）
5. **「連接測試設備的步驟」** - 期望：連接流程 Top 3（不能下降）

### 類型 3：混合查詢（3 題）
6. **「CrystalDiskMark 測試參數」** - 期望：CrystalDiskMark 段落排名第 1
7. **「UNH-IOL 認證流程」** - 期望：UNH-IOL 文檔排名第 1
8. **「Protocol 版本對應 SPEC」** - 期望：版本對應表排名第 1

### 類型 4：長尾查詢（2 題）
9. **「測試失敗時的錯誤訊息」** - 期望：錯誤處理段落 Top 3
10. **「IOL 完整測試流程」** - 期望：完整 IOL SOP 文檔排名第 1

### 通過標準
- **精確關鍵字**: ≥ 85% (3題中至少2題通過)
- **語義查詢**: ≥ 85% (2題中至少2題通過，不能下降)
- **混合查詢**: ≥ 90% (3題中至少3題通過)
- **長尾查詢**: ≥ 75% (2題中至少1題通過)
- **總體通過率**: ≥ 90% (10題中至少9題通過)

---

## 🔍 關鍵驗證點

### Dify 外部知識庫整合驗證
```bash
# 測試 1：模擬 Dify 調用 API
curl -X POST "http://10.10.172.127/api/dify/knowledge/retrieval/" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_id": "protocol_guide_db",
    "query": "iol 密碼",
    "retrieval_setting": {"top_k": 3, "score_threshold": 0.7}
  }' | python -m json.tool

# 預期：sec_5 排名第 1，包含 rrf_score 和 title_boost_applied 欄位
```

### Baseline 功能驗證
```bash
# 測試 2：檢查 Baseline 版本
docker exec postgres_db psql -U postgres -d ai_platform -c \
  "SELECT version_code, is_baseline FROM dify_config_version WHERE is_active = true ORDER BY version_code;"

# 預期：v1.2.2 的 is_baseline = true
```

### 效能驗證
```bash
# 測試 3：效能測試
time docker exec ai-django python -c "
from library.protocol_guide.search_service import ProtocolGuideSearchService
service = ProtocolGuideSearchService()
results = service.search_knowledge('iol 密碼', limit=5, stage=1)
print(f'Found {len(results)} results')
"

# 預期：執行時間 < 0.1 秒
```

---

## ⚠️ 常見問題處理

### 問題 1：GIN 索引建立失敗
**錯誤**：`ERROR: could not create index`
**解決**：
```bash
# 檢查磁碟空間
df -h

# 使用 CONCURRENTLY（非阻塞）
CREATE INDEX CONCURRENTLY idx_section_fulltext_search ...
```

### 問題 2：混合搜尋未啟用
**症狀**：測試結果與 v1.2.1 相同
**排查**：
```python
# 檢查版本配置
from api.models import DifyConfigVersion
v = DifyConfigVersion.objects.get(version_code='dify-two-tier-v1.2.2')
print(v.rag_settings['stage1'].get('use_hybrid_search'))  # 應為 True
```

### 問題 3：Baseline 未生效
**症狀**：Protocol Assistant 仍使用舊版本
**排查**：
```python
# 檢查快取
from backend.api.views.dify_knowledge_views import get_baseline_version_code, clear_baseline_version_cache
clear_baseline_version_cache()
print(get_baseline_version_code())  # 應返回 'dify-two-tier-v1.2.2'
```

---

## 📊 進度追蹤

| 階段 | 步驟 | 狀態 | 完成時間 | 備註 |
|------|------|------|---------|------|
| 準備 | 1. GIN 索引 | ⬜ 待執行 | - | - |
| 開發 | 2. 混合搜尋方法 | ⬜ 待執行 | - | - |
| 開發 | 3. 版本腳本 | ⬜ 待執行 | - | - |
| 整合 | 4. Dify API | ⬜ 待執行 | - | - |
| 整合 | 5. Baseline API | ⬜ 待執行 | - | - |
| 前端 | 6. 前端按鈕 | ⬜ 待執行 | - | - |
| 整合 | 7. Chat Handler | ⬜ 待執行 | - | - |
| 測試 | 8. 測試腳本 | ⬜ 待執行 | - | - |
| 收尾 | 9. 文檔驗收 | ⬜ 待執行 | - | - |

**總預估時間**: 約 12 小時（2 個工作日）

---

## ✅ 最終驗收清單

### 功能驗收
- [ ] v1.2.2 版本出現在 VSA 列表
- [ ] 可設定為 Baseline（按鈕功能正常）
- [ ] Dify API 正確調用混合搜尋
- [ ] 10 條測試題通過率 ≥ 90%
- [ ] 「iol 密碼」查詢 sec_5 排名第 1

### 效能驗收
- [ ] 延遲 < 100ms
- [ ] CPU 增加 < 10%
- [ ] 記憶體增加 < 20MB

### 兼容性驗收
- [ ] v1.1, v1.2, v1.2.1 完全不受影響
- [ ] 切換回 v1.2.1 行為一致

### 文檔驗收
- [ ] 實施計畫文檔完整
- [ ] VSA 使用手冊已更新
- [ ] 測試報告已產出

---

**狀態更新**: 規劃完成 ✅  
**下一步**: 等待確認後開始執行步驟 1  
**負責人**: AI Platform Team
