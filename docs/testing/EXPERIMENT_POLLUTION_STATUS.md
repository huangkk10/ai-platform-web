# 🔬 對話歷史污染實驗 - 執行中

## 📊 **實驗狀態：執行中**

**執行時間**：2025-11-12 07:13 開始  
**預計完成時間**：約 15-20 分鐘（取決於 Dify 響應速度）

---

## 🎯 **實驗目的**

驗證「對話歷史複雜度」是否是導致 Web 前端 crystaldiskmark 查詢失敗率高（14.3%）的關鍵因素。

---

## 🧪 **實驗設計**

### **實驗 A：純淨對話（基準測試）**
- **設計**：連續 10 次查詢 "crystaldiskmark"
- **環境**：全新 conversation_id，無任何干擾
- **預期成功率**：**80%+**（與之前測試腳本一致）
- **目的**：建立基準線

### **實驗 B：I3C 污染對話**
- **設計**：
  1. 階段 1：查詢 10 次 "I3C 相關說明"（建立污染）
  2. 階段 2：查詢 10 次 "crystaldiskmark"（測試影響）
- **環境**：使用相同 conversation_id，累積 20 輪對話
- **預期成功率**：**< 50%**（顯著下降，接近 Web 的 14.3%）
- **目的**：驗證 I3C 記憶污染效應

### **實驗 C：長對話污染（模擬真實使用）**
- **設計**：
  1. 階段 1：30 輪混合主題查詢（Protocol、IOL、ULINK、I3C、CUP 等）
  2. 階段 2：查詢 10 次 "crystaldiskmark"
- **環境**：使用相同 conversation_id，累積 40 輪對話
- **預期成功率**：**50-70%**（中等下降）
- **目的**：模擬用戶長期使用的真實情境

---

## 📈 **預期結果**

如果「對話歷史污染」是關鍵因素，我們應該看到：

| 實驗 | 對話輪數 | 預期成功率 | 預期 I3C 錯誤率 |
|------|---------|-----------|---------------|
| **A - 純淨對話** | 10 輪 | 80%+ | < 10% |
| **B - I3C 污染** | 20 輪（前 10 輪 I3C） | < 50% | > 40% |
| **C - 長對話** | 40 輪（混合主題） | 50-70% | 20-40% |

### **關鍵指標**

1. **成功率**：引用 CrystalDiskMark 且未引用 I3C 的比例
2. **I3C 錯誤率**：引用 I3C（錯誤文檔）的比例
3. **連續失敗次數**：最長的連續失敗記錄

---

## 🔍 **如何檢查進度**

### **方法 1：即時監控（推薦）**
```bash
./monitor_pollution_experiment.sh
```

### **方法 2：手動查看日誌**
```bash
# 查看最新進度
docker exec ai-django tail -50 /app/experiment_pollution_output.log

# 查看完整日誌
docker exec ai-django cat /app/experiment_pollution_output.log

# 查找關鍵資訊
docker exec ai-django grep -E "(實驗|階段|成功率|總測試)" /app/experiment_pollution_output.log
```

### **方法 3：檢查結果文件**
```bash
# 實驗 A 結果
docker exec ai-django cat /app/experiment_a_pure_conversation.txt

# 實驗 B 結果
docker exec ai-django cat /app/experiment_b_i3c_pollution.txt

# 實驗 C 結果
docker exec ai-django cat /app/experiment_c_long_conversation.txt
```

---

## 📊 **實驗進度追蹤**

### **當前進度（自動更新）**

```bash
# 執行此命令查看當前進度
docker exec ai-django tail -20 /app/experiment_pollution_output.log | grep -E "(🧪|實驗|階段|統計)"
```

### **預計時間表**

- ⏰ **07:13** - 實驗開始
- ⏰ **07:16** - 實驗 A 完成（10 輪 × 約 17 秒 = 3 分鐘）
- ⏰ **07:23** - 實驗 B 完成（20 輪 × 約 17 秒 = 6 分鐘）
- ⏰ **07:38** - 實驗 C 完成（40 輪 × 約 17 秒 = 11 分鐘）
- ⏰ **07:38** - 所有實驗完成，生成總結

**總預計時間**：約 20-25 分鐘

---

## 🎯 **實驗假設驗證**

### **如果假設成立（對話歷史污染是主因）**

**預期觀察**：
1. ✅ 實驗 A 成功率高（80%+）
2. ❌ 實驗 B 成功率顯著下降（< 50%）
3. ⚠️ 實驗 C 成功率中等下降（50-70%）

**結論**：
- 對話歷史污染確實影響查詢準確性
- I3C 記憶關聯是導致錯誤的關鍵因素
- 長對話累積會逐漸降低準確性

### **如果假設不成立（對話歷史污染不是主因）**

**預期觀察**：
1. 實驗 A、B、C 的成功率相近（都在 70-80%）
2. I3C 污染沒有明顯影響

**結論**：
- 對話歷史不是主因
- 需要重新尋找其他因素（如向量搜尋隨機性、Dify 內部機制等）

---

## 🚀 **實驗完成後的行動方案**

### **如果假設成立**

**短期解決方案**：
1. ✅ 提高 Score Threshold 到 0.88（過濾 I3C 85.32%）
2. ✅ 前端添加「清除對話」提示（連續失敗 3 次）
3. ✅ 限制對話歷史長度（如最多 50 輪）

**長期解決方案**：
1. 優化向量資料庫（提高 CrystalDiskMark 的相關性分數）
2. 改進文檔標題和描述（增強語義區分度）
3. 考慮添加文檔類型標籤（硬性過濾）

### **如果假設不成立**

**需要進一步調查**：
1. 🔍 檢查 Dify 平台的內部記憶機制
2. 🔍 分析向量搜尋的隨機性來源
3. 🔍 對比不同環境的配置差異
4. 🔍 檢查 Score Threshold 的實際應用邏輯

---

## 📝 **實驗記錄**

### **執行日誌**
```
開始時間: 2025-11-12 07:13
執行方式: Docker 容器背景執行
日誌文件: /app/experiment_pollution_output.log
```

### **環境資訊**
```
Django 容器: ai-django
Python 環境: Django 4.2.x
Dify API: http://10.10.172.37/v1/chat-messages
Score Threshold: 0.85（當前設定）
Top K: 3
```

### **測試參數**
```
查詢延遲: 0.3-0.5 秒
Dify 響應時間: 平均 13-17 秒
超時設定: 75 秒
```

---

## 📅 **更新記錄**

**2025-11-12 07:13**：
- ✅ 實驗腳本創建完成
- ✅ 開始執行實驗（背景執行）
- ⏳ 預計 20-25 分鐘完成

**2025-11-12 07:14**：
- ⏳ 實驗 A 進行中（測試 #6）
- ⏳ 預計 07:16 完成實驗 A

---

## 🔗 **相關文檔**

- **實驗腳本**：`backend/test_conversation_history_pollution.py`
- **監控腳本**：`monitor_pollution_experiment.sh`
- **根因分析**：`WEB_FAILURE_ROOT_CAUSE_ANALYSIS.md`
- **對話歷史分析**：`TEST_VS_WEB_SAME_CONVERSATION_ID_PARADOX.md`

---

**⏰ 請耐心等待實驗完成，或使用監控腳本查看即時進度！**

