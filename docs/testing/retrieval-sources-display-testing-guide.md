# 引用來源顯示功能測試指南

## 📋 功能概述

Protocol Assistant 現在支援顯示 AI 回覆引用的知識庫來源，用戶可以：
1. 在 AI 回覆下方看到引用來源列表
2. 點擊任何來源卡片查看完整內容
3. 複製引用內容到剪貼簿

## 🎯 測試環境

- **測試頁面**：http://localhost/protocol-assistant-chat
- **權限要求**：需要 `webProtocolAssistant` 權限
- **先決條件**：Dify 應用必須配置知識庫並正常返回 `metadata.retriever_resources`

## 🧪 測試步驟

### 步驟 1：登入並訪問 Protocol Assistant

1. 登入系統（需要有 Protocol Assistant 權限）
2. 導航至側邊欄的 "Protocol Assistant"
3. 確認頁面正常載入

### 步驟 2：發送測試問題

**測試問題範例**（這些問題應該會觸發知識庫檢索）：

```
1. "Protocol 測試的 SOP 流程是什麼？"
2. "UNH-IOL 的測試標準有哪些？"
3. "如何進行 Protocol 測試？"
4. "測試環境的設置步驟"
```

### 步驟 3：驗證引用來源顯示

**預期結果**：

1. **AI 回覆區域**：
   - 顯示正常的 AI 回答內容
   - 回答內容下方顯示「引用來源」卡片區域

2. **引用來源卡片**：
   ```
   ┌────────────────────────────────────┐
   │ 📚 引用來源 (3)                     │
   ├────────────────────────────────────┤
   │ ┌──────────────────────────────┐  │
   │ │ 📄 UNH-IOL SOP      ⭐ 85%   │  │  ← 可點擊
   │ │ 內容可參考發送者核對...       │  │
   │ │       點擊查看完整內容 →      │  │
   │ └──────────────────────────────┘  │
   └────────────────────────────────────┘
   ```

3. **視覺特徵**：
   - 淡藍色背景
   - 顯示文件名稱和相似度分數
   - 顯示內容預覽（前 80 字元）
   - Hover 時卡片有陰影效果

### 步驟 4：測試 Modal 彈出視窗

1. **點擊任一來源卡片**
2. **驗證 Modal 顯示**：
   - Modal 標題顯示文件名稱和相似度分數
   - Metadata 區域顯示：
     - 知識庫名稱
     - 相似度分數（帶顏色標籤）
     - 位置資訊
     - 文件 ID 和片段 ID（如果有）
   - 內容區域顯示完整的引用內容（支援 Markdown）

3. **測試互動功能**：
   - 點擊「複製內容」按鈕 → 應該顯示成功訊息
   - 點擊「關閉」按鈕 → Modal 應該關閉
   - 點擊遮罩區域 → Modal 應該關閉
   - 按 ESC 鍵 → Modal 應該關閉

### 步驟 5：測試邊緣情況

**測試案例 1：無引用來源的回答**
```
問題："你好"
預期：顯示提示「此回答基於 AI 的通用知識，未使用知識庫資料」
```

**測試案例 2：多個引用來源**
```
問題："Protocol 測試的完整流程"
預期：顯示多個來源卡片，按相似度降序排列
```

**測試案例 3：長文件名稱**
```
預期：文件名稱超長時應該截斷並顯示省略號
```

**測試案例 4：長內容**
```
預期：Modal 中的內容區域應該可以滾動查看
```

## ✅ 驗證檢查清單

### 前端顯示
- [ ] 引用來源卡片正常顯示
- [ ] 文件名稱正確顯示
- [ ] 相似度分數正確顯示（帶顏色標籤）
- [ ] 內容預覽截斷正常（80 字元）
- [ ] Hover 效果正常（陰影、位移）

### Modal 功能
- [ ] 點擊卡片 Modal 正常彈出
- [ ] Modal 標題正確
- [ ] Metadata 資訊完整
- [ ] 內容完整顯示
- [ ] Markdown 渲染正常
- [ ] 複製按鈕正常工作
- [ ] 關閉按鈕正常工作
- [ ] ESC 鍵關閉正常
- [ ] 點擊遮罩關閉正常

### 響應式設計
- [ ] 桌面端顯示正常（寬度 > 768px）
- [ ] 手機端顯示正常（寬度 < 768px）
- [ ] Modal 在手機端全螢幕顯示

### 效能
- [ ] 卡片點擊反應迅速
- [ ] Modal 開啟/關閉動畫流暢
- [ ] 無記憶體洩漏（多次開啟/關閉測試）

## 🐛 已知問題與解決方案

### 問題 1：引用來源不顯示
**可能原因**：
- Dify 未返回 `metadata.retriever_resources`
- 知識庫未配置或 Score 閾值設定過高

**解決方案**：
1. 檢查 Dify 應用的知識庫配置
2. 調整 Score 閾值（建議 0.5-0.7）
3. 檢查後端日誌：`docker logs ai-django | grep metadata`

### 問題 2：Modal 無法打開
**可能原因**：
- JavaScript 錯誤
- React 組件未正確載入

**解決方案**：
1. 打開瀏覽器開發者工具（F12）
2. 查看 Console 錯誤訊息
3. 檢查 React 前端日誌

### 問題 3：樣式顯示異常
**可能原因**：
- CSS 文件未載入
- 瀏覽器快取問題

**解決方案**：
1. 清除瀏覽器快取（Ctrl+Shift+Delete）
2. 重新啟動前端容器：`docker compose restart react`
3. 確認 CSS 文件存在：
   - `SourceDetailModal.css`
   - `SourceCard.css`
   - `RetrievalSourcesDisplay.css`

## 📊 測試結果記錄

### 測試環境資訊
- 測試日期：____________________
- 測試人員：____________________
- 瀏覽器版本：__________________
- 螢幕解析度：__________________

### 功能測試結果

| 測試項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| 引用來源顯示 | 正常顯示 | | ☐ 通過 ☐ 失敗 | |
| 卡片點擊 | 打開 Modal | | ☐ 通過 ☐ 失敗 | |
| Modal 內容 | 完整顯示 | | ☐ 通過 ☐ 失敗 | |
| 複製功能 | 成功複製 | | ☐ 通過 ☐ 失敗 | |
| 關閉功能 | 正常關閉 | | ☐ 通過 ☐ 失敗 | |
| 響應式設計 | 適配正常 | | ☐ 通過 ☐ 失敗 | |
| 無引用情況 | 顯示提示 | | ☐ 通過 ☐ 失敗 | |

## 🔍 除錯技巧

### 1. 檢查 Dify 回應結構
```javascript
// 在瀏覽器 Console 中執行
// 查看最後一條 AI 訊息的 metadata
console.log(messages[messages.length - 1].metadata);
```

### 2. 檢查引用來源資料
```javascript
// 查看 retriever_resources 陣列
console.log(messages[messages.length - 1].metadata?.retriever_resources);
```

### 3. 強制重新渲染
```javascript
// 如果引用來源沒有顯示，嘗試發送新訊息
// 或重新整理頁面（F5）
```

### 4. 查看網路請求
1. 打開開發者工具 → Network 標籤
2. 發送測試問題
3. 查看 `/api/protocol-assistant/chat/` 請求的回應
4. 確認 `metadata.retriever_resources` 存在

## 📝 回報問題格式

如果發現問題，請按照以下格式回報：

```
### 問題描述
[詳細描述問題現象]

### 重現步驟
1. [步驟 1]
2. [步驟 2]
3. [步驟 3]

### 預期結果
[應該發生什麼]

### 實際結果
[實際發生什麼]

### 環境資訊
- 瀏覽器：[Chrome / Firefox / Safari]
- 版本：[版本號]
- 作業系統：[Windows / macOS / Linux]
- 螢幕解析度：[1920x1080]

### 錯誤訊息
[如果有，請貼上 Console 錯誤訊息]

### 截圖
[如果有，請附上截圖]
```

## 🎉 測試完成

如果所有測試項目都通過，代表引用來源顯示功能正常運作！

---

**文檔版本**：v1.0  
**更新日期**：2025-10-31  
**負責人**：AI Platform Team
