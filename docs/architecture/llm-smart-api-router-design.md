# LLM æ™ºèƒ½ API è·¯ç”±ç³»çµ±è¨­è¨ˆæ–‡æª”

**æ–‡æª”ç‰ˆæœ¬**ï¼šv1.6  
**å‰µå»ºæ—¥æœŸ**ï¼š2025-12-05  
**æœ€å¾Œæ›´æ–°**ï¼š2025-12-05  
**ç‹€æ…‹**ï¼šğŸ“‹ è¦åŠƒä¸­ï¼ˆå°šæœªåŸ·è¡Œï¼‰  
**ä½œè€…**ï¼šAI Platform Team  
**ç¢ºå®šæ–¹æ¡ˆ**ï¼šDjango æ™ºèƒ½è·¯ç”± API + Dify é›™ App å”ä½œ

---

## ğŸ“‹ ç›®éŒ„

1. [å°ˆæ¡ˆæ¦‚è¿°](#1-å°ˆæ¡ˆæ¦‚è¿°)
2. [ç³»çµ±æ¶æ§‹è¨­è¨ˆ](#2-ç³»çµ±æ¶æ§‹è¨­è¨ˆ)
3. [æ„åœ–é¡å‹å®šç¾©](#3-æ„åœ–é¡å‹å®šç¾©)
4. [æŠ€è¡“å¯¦ä½œæ–¹æ¡ˆï¼šDjango æ™ºèƒ½è·¯ç”± API](#4-æŠ€è¡“å¯¦ä½œæ–¹æ¡ˆdjango-æ™ºèƒ½è·¯ç”±-api)
5. [æ ¸å¿ƒçµ„ä»¶è¨­è¨ˆ](#5-æ ¸å¿ƒçµ„ä»¶è¨­è¨ˆ)
6. [å¯¦ä½œéšæ®µè¦åŠƒï¼ˆè©³ç´°ç‰ˆï¼‰](#6-å¯¦ä½œéšæ®µè¦åŠƒè©³ç´°ç‰ˆ)
7. [æ¥­ç•Œåƒè€ƒæ¡ˆä¾‹](#7-æ¥­ç•Œåƒè€ƒæ¡ˆä¾‹)
8. [Dify é›™ App æ•´åˆè¨­è¨ˆï¼ˆå·²ç¢ºå®šæ–¹æ¡ˆï¼‰](#8-dify-é›™-app-æ•´åˆè¨­è¨ˆå·²ç¢ºå®šæ–¹æ¡ˆ)
9. [å„ªå…ˆå¯¦ä½œçš„æ„åœ–](#9-å„ªå…ˆå¯¦ä½œçš„æ„åœ–)

---

## 1. å°ˆæ¡ˆæ¦‚è¿°

### 1.1 èƒŒæ™¯

ç›®å‰ SAF å¤–éƒ¨çŸ¥è­˜åº«ä½¿ç”¨é—œéµå­—åŒ¹é…æ–¹å¼æœå°‹è³‡æ–™ï¼Œå­˜åœ¨ä»¥ä¸‹å•é¡Œï¼š
- è¿”å›å¤§é‡å¯èƒ½ç›¸é—œçš„è³‡æ–™ï¼Œä¾è³´ LLM å¾ä¸­ç¯©é¸
- ç„¡æ³•ç²¾æº–å›ç­”æ•¸é‡é¡å•é¡Œï¼ˆå¦‚ã€ŒWD æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿã€ï¼‰
- ä¸åŒé¡å‹çš„æŸ¥è©¢ç„¡æ³•æœ€ä½³åŒ–

### 1.2 ç›®æ¨™

å»ºç«‹ã€Œ**æ™ºèƒ½ API è·¯ç”±ç³»çµ±**ã€ï¼Œè®“ LLM èƒ½å¤ ï¼š
1. åˆ†æç”¨æˆ¶å•é¡Œçš„æ„åœ–
2. è‡ªå‹•é¸æ“‡æ­£ç¢ºçš„ API é€²è¡Œç²¾æº–æŸ¥è©¢
3. è¿”å›ç²¾ç¢ºçš„è³‡æ–™çµæœ
4. ç”Ÿæˆæº–ç¢ºçš„å›ç­”

### 1.3 æ ¸å¿ƒæ¦‚å¿µ

```
ç”¨æˆ¶å•é¡Œ â†’ LLM åˆ†ææ„åœ– â†’ é¸æ“‡æ­£ç¢º API â†’ ç²¾æº–æŸ¥è©¢ â†’ æ ¼å¼åŒ–å›ç­”
```

### 1.4 èˆ‡ç¾æœ‰æ–¹æ¡ˆæ¯”è¼ƒ

| æ¯”è¼ƒé …ç›® | ç¾æœ‰åšæ³•ï¼ˆå¤–éƒ¨çŸ¥è­˜åº«ï¼‰ | æ–°æ–¹æ¡ˆï¼ˆæ™ºèƒ½è·¯ç”±ï¼‰ |
|---------|----------------------|------------------|
| **æŸ¥è©¢æ–¹å¼** | é—œéµå­—åŒ¹é…æ‰€æœ‰è³‡æ–™ | LLM åˆ¤æ–·å¾Œç²¾æº–èª¿ç”¨ API |
| **è³‡æ–™é‡** | è¿”å›å¤§é‡å¯èƒ½ç›¸é—œçš„è³‡æ–™ | åªè¿”å›ç²¾æº–åŒ¹é…çš„è³‡æ–™ |
| **API èª¿ç”¨** | å›ºå®šèª¿ç”¨ /projects å†éæ¿¾ | æ ¹æ“šæ„åœ–èª¿ç”¨ä¸åŒ API |
| **å›ç­”å“è³ª** | ä¾è³´ LLM å¾å¤§é‡è³‡æ–™ä¸­ç¯©é¸ | è³‡æ–™æœ¬èº«å°±æ˜¯ç²¾æº–çš„ |
| **æ•¸é‡æŸ¥è©¢** | ä¸ç²¾æº– | ç²¾æº– |

---

## 2. ç³»çµ±æ¶æ§‹è¨­è¨ˆ

### 2.1 æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç”¨æˆ¶å•é¡Œ                                       â”‚
â”‚                    ã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ§  LLM æ„åœ–åˆ†æå™¨ (Intent Analyzer)                   â”‚
â”‚                                                                          â”‚
â”‚  è¼¸å…¥ï¼šç”¨æˆ¶å•é¡Œ                                                          â”‚
â”‚  è¼¸å‡ºï¼šJSON çµæ§‹åŒ–æ„åœ–                                                   â”‚
â”‚                                                                          â”‚
â”‚  {                                                                       â”‚
â”‚    "intent": "query_projects_by_customer",                              â”‚
â”‚    "parameters": {                                                       â”‚
â”‚      "customer": "WD"                                                    â”‚
â”‚    },                                                                    â”‚
â”‚    "confidence": 0.95                                                    â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ”€ API è·¯ç”±å™¨ (Query Router)                          â”‚
â”‚                                                                          â”‚
â”‚  æ ¹æ“š intent é¸æ“‡å°æ‡‰çš„ API Handlerï¼š                                    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ CustomerHandler â”‚  â”‚ ControllerHandlerâ”‚  â”‚ ProjectHandler â”‚          â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚          â”‚
â”‚  â”‚ GET /projects   â”‚  â”‚ GET /projects   â”‚  â”‚ GET /projects/  â”‚          â”‚
â”‚  â”‚ ?customer=WD    â”‚  â”‚ ?controller=    â”‚  â”‚ {name}/summary  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚                    â”‚
            â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“¡ SAF API Server                                     â”‚
â”‚                    http://10.252.170.171:8080                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“Š ç²¾æº–è³‡æ–™çµæœ                                        â”‚
â”‚                                                                          â”‚
â”‚  [                                                                       â”‚
â”‚    { "projectName": "DEMETER", "customer": "WD", ... },                 â”‚
â”‚    { "projectName": "Demeter", "customer": "WD", ... },                 â”‚
â”‚    { "projectName": "Garuda", "customer": "WD", ... }                   â”‚
â”‚  ]                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“ å›æ‡‰æ ¼å¼åŒ–å™¨ (Response Formatter)                   â”‚
â”‚                                                                          â”‚
â”‚  å°‡ API çµæœæ ¼å¼åŒ–ç‚ºè‡ªç„¶èªè¨€å›ç­”æˆ– Dify çŸ¥è­˜åº«æ ¼å¼                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ¤– æœ€çµ‚å›ç­”                                            â”‚
â”‚                                                                          â”‚
â”‚  ã€ŒWD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆï¼š                                                â”‚
â”‚   1. DEMETER - æ§åˆ¶å™¨ SM2264XT, NAND: WDC BiCS5 TLC                     â”‚
â”‚   2. Demeter - æ§åˆ¶å™¨ SM2264XT, NAND: WDC BiCS5 TLC                     â”‚
â”‚   3. Garuda - æ§åˆ¶å™¨ SM2269XT, NAND: WDC BiCS6 TLCã€                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¨¡çµ„çµæ§‹è¨­è¨ˆ

```
library/saf_integration/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ endpoint_registry.py      # ç¾æœ‰ - SAF API ç«¯é»å®šç¾©
â”œâ”€â”€ api_client.py             # ç¾æœ‰ - SAF API å®¢æˆ¶ç«¯
â”œâ”€â”€ auth_manager.py           # ç¾æœ‰ - èªè­‰ç®¡ç†
â”œâ”€â”€ cache_manager.py          # ç¾æœ‰ - å¿«å–ç®¡ç†
â”œâ”€â”€ data_transformer.py       # ç¾æœ‰ - è³‡æ–™è½‰æ›
â”œâ”€â”€ search_service.py         # ç¾æœ‰ - æœå°‹æœå‹™
â”œâ”€â”€ handler.py                # ç¾æœ‰ - Dify å¤–éƒ¨çŸ¥è­˜åº«è™•ç†å™¨
â”‚
â”‚   # ğŸ†• æ–°å¢æ™ºèƒ½è·¯ç”±æ¨¡çµ„
â””â”€â”€ smart_query/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ intent_analyzer.py    # ğŸ†• LLM æ„åœ–åˆ†æå™¨
    â”œâ”€â”€ intent_types.py       # ğŸ†• æ„åœ–é¡å‹å®šç¾©
    â”œâ”€â”€ query_router.py       # ğŸ†• æŸ¥è©¢è·¯ç”±å™¨
    â”œâ”€â”€ query_handlers/       # ğŸ†• å„ç¨®æŸ¥è©¢è™•ç†å™¨
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ base_handler.py
    â”‚   â”œâ”€â”€ customer_handler.py
    â”‚   â”œâ”€â”€ controller_handler.py
    â”‚   â”œâ”€â”€ project_handler.py
    â”‚   â””â”€â”€ statistics_handler.py
    â””â”€â”€ response_formatter.py # ğŸ†• å›æ‡‰æ ¼å¼åŒ–å™¨

backend/api/views/
â”œâ”€â”€ dify_saf_views.py         # ç¾æœ‰ - å¤–éƒ¨çŸ¥è­˜åº« API
â””â”€â”€ dify_saf_smart_views.py   # ğŸ†• æ™ºèƒ½æŸ¥è©¢ API
```

---

## 3. æ„åœ–é¡å‹å®šç¾©

### 3.1 Phase 1ï¼šåŸºç¤æŸ¥è©¢æ„åœ–

| æ„åœ– ID | ç”¨æˆ¶å•é¡Œç¯„ä¾‹ | API èª¿ç”¨ | åƒæ•¸ |
|---------|-------------|----------|------|
| `query_projects_by_customer` | ã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€ã€Œåˆ—å‡º Samsung çš„å°ˆæ¡ˆã€ | `GET /projects?customer={customer}` | customer |
| `query_projects_by_controller` | ã€ŒSM2264 ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿã€ã€Œ2269 æ§åˆ¶å™¨çš„å°ˆæ¡ˆã€ | `GET /projects?controller={controller}` | controller |
| `query_projects_by_nand` | ã€Œç”¨ BiCS5 çš„å°ˆæ¡ˆæœ‰å“ªäº›ï¼Ÿã€ | `GET /projects?nand={nand}` | nand |
| `query_project_detail` | ã€ŒDEMETER å°ˆæ¡ˆçš„è©³ç´°è³‡è¨Šã€ | `GET /projects/{name}` | project_name |
| `query_project_summary` | ã€ŒDEMETER çš„æ¸¬è©¦çµæœå¦‚ä½•ï¼Ÿã€ | `GET /projects/{name}/summary` | project_name |
| `list_all_customers` | ã€Œæœ‰å“ªäº›å®¢æˆ¶ï¼Ÿã€ã€Œå®¢æˆ¶åˆ—è¡¨ã€ | `GET /projects` â†’ çµ±è¨ˆ | - |
| `list_all_controllers` | ã€Œæœ‰å“ªäº›æ§åˆ¶å™¨å‹è™Ÿï¼Ÿã€ | `GET /projects` â†’ çµ±è¨ˆ | - |
| `count_projects` | ã€Œç¸½å…±æœ‰å¤šå°‘å°ˆæ¡ˆï¼Ÿã€ã€ŒWD æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿã€ | `GET /projects?customer={customer}` â†’ count | customer (optional) |

### 3.2 Phase 2ï¼šé€²éšæŸ¥è©¢æ„åœ–

| æ„åœ– ID | ç”¨æˆ¶å•é¡Œç¯„ä¾‹ | èªªæ˜ |
|---------|-------------|------|
| `query_projects_multi_filter` | ã€ŒWD ç”¨ SM2264 çš„å°ˆæ¡ˆã€ | å¤šæ¢ä»¶éæ¿¾ |
| `compare_projects` | ã€Œæ¯”è¼ƒ DEMETER å’Œ Garudaã€ | å¤šæ¬¡èª¿ç”¨ + æ¯”è¼ƒ |
| `query_project_status` | ã€Œå“ªäº›å°ˆæ¡ˆé‚„åœ¨é€²è¡Œä¸­ï¼Ÿã€ | ç‹€æ…‹éæ¿¾ |
| `query_recent_projects` | ã€Œæœ€è¿‘å»ºç«‹çš„å°ˆæ¡ˆã€ | æ™‚é–“æ’åº |
| `query_projects_by_pl` | ã€Œryder.lin è² è²¬å“ªäº›å°ˆæ¡ˆï¼Ÿã€ | æŒ‰è² è²¬äººæŸ¥è©¢ |

### 3.3 æ„åœ–åˆ†æ Prompt è¨­è¨ˆ

```
ä½ æ˜¯ä¸€å€‹æ„åœ–åˆ†æå™¨ï¼Œè² è²¬åˆ†æç”¨æˆ¶é—œæ–¼ SAF å°ˆæ¡ˆç®¡ç†ç³»çµ±çš„å•é¡Œã€‚

è«‹åˆ†æç”¨æˆ¶çš„å•é¡Œï¼Œä¸¦è¿”å› JSON æ ¼å¼çš„æ„åœ–çµæ§‹ã€‚

å¯ç”¨çš„æ„åœ–é¡å‹ï¼š
1. query_projects_by_customer - æŒ‰å®¢æˆ¶æŸ¥è©¢å°ˆæ¡ˆ
2. query_projects_by_controller - æŒ‰æ§åˆ¶å™¨æŸ¥è©¢å°ˆæ¡ˆ
3. query_projects_by_nand - æŒ‰ NAND é¡å‹æŸ¥è©¢å°ˆæ¡ˆ
4. query_project_detail - æŸ¥è©¢å°ˆæ¡ˆè©³ç´°è³‡è¨Š
5. query_project_summary - æŸ¥è©¢å°ˆæ¡ˆæ¸¬è©¦çµæœæ‘˜è¦
6. list_all_customers - åˆ—å‡ºæ‰€æœ‰å®¢æˆ¶
7. list_all_controllers - åˆ—å‡ºæ‰€æœ‰æ§åˆ¶å™¨
8. count_projects - çµ±è¨ˆå°ˆæ¡ˆæ•¸é‡
9. unknown - ç„¡æ³•è­˜åˆ¥çš„æ„åœ–

å·²çŸ¥çš„å®¢æˆ¶ï¼šWD, WDC, Samsung, Micron, Transcend, ADATA, UMIS, Biwin, ...
å·²çŸ¥çš„æ§åˆ¶å™¨ï¼šSM2263, SM2264, SM2267, SM2269, ...

ç”¨æˆ¶å•é¡Œï¼š{query}

è«‹è¿”å› JSONï¼š
{
  "intent": "æ„åœ–ID",
  "parameters": {
    // æå–çš„åƒæ•¸
  },
  "confidence": 0.0-1.0
}
```

---

## 4. æŠ€è¡“å¯¦ä½œæ–¹æ¡ˆï¼šDjango æ™ºèƒ½è·¯ç”± API

### 4.1 æ–¹æ¡ˆæ¦‚è¿°

**æ¶æ§‹**ï¼š
```python
# POST /api/dify/saf/smart-query/
{
    "query": "WD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ",
    "conversation_id": "xxx"
}

# å›æ‡‰
{
    "answer": "WD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆï¼š...",
    "intent": "query_projects_by_customer",
    "parameters": {"customer": "WD"},
    "data": [...],
    "source": "saf_api"
}
```

**å„ªé»**ï¼š
- âœ… å®Œå…¨æ§åˆ¶é‚è¼¯
- âœ… å¯ä»¥è™•ç†è¤‡é›œæŸ¥è©¢
- âœ… å¯æ•´åˆå¿«å–
- âœ… æ˜“æ–¼æ¸¬è©¦å’Œé™¤éŒ¯
- âœ… ç‰ˆæœ¬æ§åˆ¶å‹å¥½
- âœ… èˆ‡ç¾æœ‰æ¶æ§‹æ•´åˆ

**é¸æ“‡åŸå› **ï¼š
1. ç²¾æº–åº¦æœ€é«˜ - å®Œå…¨æ§åˆ¶ API èª¿ç”¨é‚è¼¯
2. å¯æ•´åˆç¾æœ‰æ¶æ§‹ - èˆ‡ç¾æœ‰ SAF æ•´åˆæ¨¡çµ„ç„¡ç¸«éŠœæ¥
3. æ˜“æ–¼æ“´å±• - æ–°å¢æ„åœ–åªéœ€æ·»åŠ  Handler
4. å¯æ¸¬è©¦ - æ¯å€‹çµ„ä»¶éƒ½å¯ä»¥å–®ç¨æ¸¬è©¦
5. æˆæœ¬å¯æ§ - LLM åªç”¨æ–¼æ„åœ–åˆ†æ

---

## 5. æ ¸å¿ƒçµ„ä»¶è¨­è¨ˆ

### 5.1 æ„åœ–åˆ†æå™¨ (IntentAnalyzer)

```python
# library/saf_integration/smart_query/intent_analyzer.py

class IntentAnalyzer:
    """LLM æ„åœ–åˆ†æå™¨"""
    
    def __init__(self, llm_client):
        self.llm_client = llm_client
        self.prompt_template = INTENT_ANALYSIS_PROMPT
    
    async def analyze(self, query: str) -> IntentResult:
        """
        åˆ†æç”¨æˆ¶å•é¡Œçš„æ„åœ–
        
        Args:
            query: ç”¨æˆ¶å•é¡Œ
            
        Returns:
            IntentResult: åŒ…å« intent, parameters, confidence
        """
        pass
```

### 5.2 æŸ¥è©¢è·¯ç”±å™¨ (QueryRouter)

```python
# library/saf_integration/smart_query/query_router.py

class QueryRouter:
    """æŸ¥è©¢è·¯ç”±å™¨"""
    
    def __init__(self):
        self.handlers = {
            'query_projects_by_customer': CustomerHandler(),
            'query_projects_by_controller': ControllerHandler(),
            'query_project_detail': ProjectHandler(),
            'count_projects': StatisticsHandler(),
            # ...
        }
    
    def route(self, intent_result: IntentResult) -> BaseHandler:
        """æ ¹æ“šæ„åœ–é¸æ“‡å°æ‡‰çš„ Handler"""
        return self.handlers.get(intent_result.intent)
```

### 5.3 æŸ¥è©¢è™•ç†å™¨ (Handler)

```python
# library/saf_integration/smart_query/query_handlers/customer_handler.py

class CustomerHandler(BaseHandler):
    """å®¢æˆ¶æŸ¥è©¢è™•ç†å™¨"""
    
    async def execute(self, parameters: dict) -> QueryResult:
        """
        åŸ·è¡Œå®¢æˆ¶æŸ¥è©¢
        
        Args:
            parameters: {"customer": "WD"}
            
        Returns:
            QueryResult: åŒ…å«ç²¾æº–çš„å°ˆæ¡ˆè³‡æ–™
        """
        customer = parameters.get('customer')
        projects = await self.api_client.get_projects_by_customer(customer)
        return QueryResult(
            data=projects,
            count=len(projects),
            query_type='customer',
            parameters=parameters
        )
```

### 5.4 API è¨­è¨ˆ

#### æ™ºèƒ½æŸ¥è©¢ API

```
POST /api/dify/saf/smart-query/
```

**Request**:
```json
{
    "query": "WD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ",
    "conversation_id": "optional-conversation-id",
    "options": {
        "include_details": true,
        "format": "natural_language"
    }
}
```

**Response**:
```json
{
    "success": true,
    "answer": "WD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆï¼š\n1. DEMETER - æ§åˆ¶å™¨ SM2264XT\n2. Demeter - æ§åˆ¶å™¨ SM2264XT\n3. Garuda - æ§åˆ¶å™¨ SM2269XT",
    "intent": {
        "type": "query_projects_by_customer",
        "parameters": {
            "customer": "WD"
        },
        "confidence": 0.95
    },
    "data": {
        "projects": [
            {
                "projectName": "DEMETER",
                "customer": "WD",
                "controller": "SM2264XT",
                "nand": "WDC BiCS5 TLC"
            }
        ],
        "count": 3
    },
    "metadata": {
        "query_time_ms": 150,
        "source": "saf_api",
        "cached": false
    }
}
```

---

## 6. å¯¦ä½œéšæ®µè¦åŠƒï¼ˆè©³ç´°ç‰ˆï¼‰

### 6.0 é–‹ç™¼ç¯„åœç¢ºèª

#### 6.0.1 æ„åœ–é¡å‹ï¼ˆ8 ç¨®ï¼Œå…¨éƒ¨å¯¦ä½œï¼‰

| # | æ„åœ– ID | èªªæ˜ | åƒæ•¸ |
|---|---------|------|------|
| 1 | `query_projects_by_customer` | æŒ‰å®¢æˆ¶æŸ¥è©¢å°ˆæ¡ˆ | customer |
| 2 | `query_projects_by_controller` | æŒ‰æ§åˆ¶å™¨æŸ¥è©¢å°ˆæ¡ˆ | controller |
| 3 | `query_project_detail` | æŸ¥è©¢å°ˆæ¡ˆè©³ç´°è³‡è¨Š | project_name |
| 4 | `query_project_summary` | æŸ¥è©¢å°ˆæ¡ˆæ¸¬è©¦æ‘˜è¦ | project_name |
| 5 | `count_projects` | çµ±è¨ˆå°ˆæ¡ˆæ•¸é‡ | customer (å¯é¸) |
| 6 | `list_all_customers` | åˆ—å‡ºæ‰€æœ‰å®¢æˆ¶ | ç„¡ |
| 7 | `list_all_controllers` | åˆ—å‡ºæ‰€æœ‰æ§åˆ¶å™¨ | ç„¡ |
| 8 | `unknown` | ç„¡æ³•è­˜åˆ¥çš„æ„åœ– | ç„¡ |

#### 6.0.2 å›ç­”æ ¼å¼

**ç¢ºå®šæ ¼å¼**ï¼šè‡ªç„¶èªè¨€ + Table

```
ç¯„ä¾‹å›ç­”ï¼š

WD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆï¼š

| å°ˆæ¡ˆåç¨± | æ§åˆ¶å™¨ | NAND é¡å‹ | ç‹€æ…‹ |
|---------|--------|----------|------|
| DEMETER | SM2264XT | WDC BiCS5 TLC | Active |
| Demeter | SM2264XT | WDC BiCS5 TLC | Active |
| Garuda | SM2269XT | WDC BiCS6 TLC | Active |
```

#### 6.0.3 é–‹ç™¼å‰ç½®éœ€æ±‚

| é …ç›® | ç‹€æ…‹ | å‚™è¨» |
|------|------|------|
| æ¸¬è©¦ç”¨ SAF API Server | â¬œ å¾…ç¢ºèª | éœ€è¦ç¨ç«‹æ¸¬è©¦ç’°å¢ƒ |
| `SAF_Intent_Analyzer` Dify App | âœ… å·²å»ºç«‹ | `app-vMNSUqgEIoejnXo3fuFvp1hC` |
| `SAF_Analyzer` Dify App | âœ… å·²å»ºç«‹ | `app-0GyoZLrr4tDpT4EO2Kihuvux` |

---

### 6.1 Phase 0ï¼šç’°å¢ƒæº–å‚™èˆ‡é…ç½®ï¼ˆ0.5 å¤©ï¼‰

| æ­¥é©Ÿ | ä»»å‹™ | ç”¢å‡ºæª”æ¡ˆ |
|------|------|---------|
| 0.1 | æ·»åŠ  `SAF_Intent_Analyzer` é…ç½® | `dify_config_manager.py` |
| 0.2 | æ·»åŠ  `SAF_Analyzer` é…ç½® | `dify_config_manager.py` |
| 0.3 | å»ºç«‹ `smart_query/` æ¨¡çµ„ç›®éŒ„çµæ§‹ | ç›®éŒ„çµæ§‹ |
| 0.4 | å®šç¾©æ„åœ–é¡å‹ Enumï¼ˆ8 ç¨®ï¼‰ | `intent_types.py` |
| 0.5 | ç¢ºèªæ¸¬è©¦ç”¨ SAF API Server ç’°å¢ƒ | ç’°å¢ƒæ–‡æª” |

**Phase 0 é©—æ”¶æ¨™æº–**ï¼š
- [ ] `get_saf_intent_analyzer_config()` å¯æ­£å¸¸èª¿ç”¨
- [ ] `get_saf_analyzer_config()` å¯æ­£å¸¸èª¿ç”¨
- [ ] æ¸¬è©¦ç”¨ SAF API Server å¯è¨ªå•

---

### 6.2 Phase 1ï¼šæ„åœ–åˆ†æå™¨é–‹ç™¼ï¼ˆ1.5-2 å¤©ï¼‰

| æ­¥é©Ÿ | ä»»å‹™ | ç”¢å‡ºæª”æ¡ˆ |
|------|------|---------|
| 1.1 | å¯¦ä½œ `IntentResult` dataclass | `intent_analyzer.py` |
| 1.2 | è¨­è¨ˆå®Œæ•´çš„ `INTENT_ANALYSIS_PROMPT`ï¼ˆæ”¯æ´ 8 ç¨®æ„åœ–ï¼‰ | `intent_analyzer.py` |
| 1.3 | å¯¦ä½œ `SAFIntentAnalyzer.analyze()` | `intent_analyzer.py` |
| 1.4 | å¯¦ä½œ JSON è§£æé‚è¼¯ | `intent_analyzer.py` |
| 1.5 | å¯¦ä½œé™ç´šé‚è¼¯ï¼ˆé—œéµå­—åŒ¹é…ï¼‰ | `intent_analyzer.py` |
| 1.6 | æ’°å¯«å–®å…ƒæ¸¬è©¦ï¼ˆ8 ç¨®æ„åœ– Ã— å¤šå€‹æ¸¬è©¦æ¡ˆä¾‹ï¼‰ | `tests/test_intent_analyzer.py` |

**æ¸¬è©¦æ¡ˆä¾‹æ¸…å–®**ï¼ˆæ¯ç¨®æ„åœ–è‡³å°‘ 3 å€‹æ¸¬è©¦ï¼‰ï¼š

| æ„åœ– | æ¸¬è©¦æ¡ˆä¾‹ |
|------|---------|
| `query_projects_by_customer` | ã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€ã€Œåˆ—å‡º Samsung çš„å°ˆæ¡ˆã€ã€ŒADATA çš„å°ˆæ¡ˆã€ |
| `query_projects_by_controller` | ã€ŒSM2264 ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿã€ã€Œå“ªäº›å°ˆæ¡ˆç”¨ 2269 æ§åˆ¶å™¨ã€ã€ŒSM2264XT æ§åˆ¶å™¨ã€ |
| `query_project_detail` | ã€ŒDEMETER å°ˆæ¡ˆçš„è©³ç´°è³‡è¨Šã€ã€Œå‘Šè¨´æˆ‘ Garuda å°ˆæ¡ˆã€ã€ŒHelios å°ˆæ¡ˆè³‡è¨Šã€ |
| `query_project_summary` | ã€ŒDEMETER çš„æ¸¬è©¦çµæœã€ã€ŒGaruda æ¸¬è©¦ç‹€æ³ã€ã€ŒHelios æ¸¬è©¦çµæœå¦‚ä½•ã€ |
| `count_projects` | ã€Œæœ‰å¤šå°‘å°ˆæ¡ˆï¼Ÿã€ã€ŒWD æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿã€ã€ŒSamsung å°ˆæ¡ˆæ•¸é‡ã€ |
| `list_all_customers` | ã€Œæœ‰å“ªäº›å®¢æˆ¶ï¼Ÿã€ã€Œå®¢æˆ¶åˆ—è¡¨ã€ã€Œåˆ—å‡ºæ‰€æœ‰å®¢æˆ¶ã€ |
| `list_all_controllers` | ã€Œæœ‰å“ªäº›æ§åˆ¶å™¨ï¼Ÿã€ã€Œæ§åˆ¶å™¨åˆ—è¡¨ã€ã€Œæ”¯æ´çš„æ§åˆ¶å™¨å‹è™Ÿã€ |
| `unknown` | ã€Œä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿã€ã€Œä½ å¥½ã€ã€Œå¹«æˆ‘è¨‚ä¾¿ç•¶ã€ |

**Phase 1 é©—æ”¶æ¨™æº–**ï¼š
- [ ] 8 ç¨®æ„åœ–éƒ½èƒ½æ­£ç¢ºè­˜åˆ¥
- [ ] åƒæ•¸æå–æ­£ç¢ºï¼ˆcustomer, controller, project_nameï¼‰
- [ ] é™ç´šé‚è¼¯æ­£å¸¸é‹ä½œï¼ˆDify API å¤±æ•—æ™‚ï¼‰

---

### 6.3 Phase 2ï¼šæŸ¥è©¢è·¯ç”±å™¨èˆ‡ Handlersï¼ˆ2.5-3 å¤©ï¼‰

| æ­¥é©Ÿ | ä»»å‹™ | ç”¢å‡ºæª”æ¡ˆ |
|------|------|---------|
| 2.1 | å¯¦ä½œ `BaseHandler` æŠ½è±¡é¡ | `query_handlers/base_handler.py` |
| 2.2 | å¯¦ä½œ `CustomerHandler` | `query_handlers/customer_handler.py` |
| 2.3 | å¯¦ä½œ `ControllerHandler` | `query_handlers/controller_handler.py` |
| 2.4 | å¯¦ä½œ `ProjectDetailHandler` | `query_handlers/project_detail_handler.py` |
| 2.5 | å¯¦ä½œ `ProjectSummaryHandler` | `query_handlers/project_summary_handler.py` |
| 2.6 | å¯¦ä½œ `StatisticsHandler`ï¼ˆcount + listï¼‰ | `query_handlers/statistics_handler.py` |
| 2.7 | å¯¦ä½œ `QueryRouter` è·¯ç”±å™¨ | `query_router.py` |
| 2.8 | æ’°å¯«æ•´åˆæ¸¬è©¦ | `tests/test_query_router.py` |

**Handler èˆ‡ SAF API å°æ‡‰è¡¨**ï¼š

| æ„åœ– | Handler | SAF API èª¿ç”¨ |
|------|---------|-------------|
| `query_projects_by_customer` | `CustomerHandler` | `GET /projects?customer={customer}` |
| `query_projects_by_controller` | `ControllerHandler` | `GET /projects?controller={controller}` |
| `query_project_detail` | `ProjectDetailHandler` | `GET /projects/{name}` |
| `query_project_summary` | `ProjectSummaryHandler` | `GET /projects/{name}/summary` |
| `count_projects` | `StatisticsHandler` | `GET /projects` â†’ çµ±è¨ˆæ•¸é‡ |
| `list_all_customers` | `StatisticsHandler` | `GET /projects` â†’ æå–å®¢æˆ¶åˆ—è¡¨ |
| `list_all_controllers` | `StatisticsHandler` | `GET /projects` â†’ æå–æ§åˆ¶å™¨åˆ—è¡¨ |
| `unknown` | ï¼ˆç„¡ Handlerï¼‰ | ç›´æ¥è¿”å›æç¤ºè¨Šæ¯ |

**Phase 2 é©—æ”¶æ¨™æº–**ï¼š
- [ ] æ¯å€‹ Handler èƒ½æ­£ç¢ºèª¿ç”¨ SAF API
- [ ] QueryRouter èƒ½æ ¹æ“šæ„åœ–é¸æ“‡æ­£ç¢ºçš„ Handler
- [ ] ä½¿ç”¨æ¸¬è©¦ç”¨ SAF API Server æ¸¬è©¦é€šé

---

### 6.4 Phase 3ï¼šAPI ç«¯é»æ•´åˆï¼ˆ1 å¤©ï¼‰

| æ­¥é©Ÿ | ä»»å‹™ | ç”¢å‡ºæª”æ¡ˆ |
|------|------|---------|
| 3.1 | å»ºç«‹ `SmartQueryView` | `backend/api/views/dify_saf_smart_views.py` |
| 3.2 | å®šç¾© Request/Response æ ¼å¼ | åºåˆ—åŒ–å™¨ï¼ˆå¯é¸ï¼‰ |
| 3.3 | é…ç½® URL è·¯ç”± | `backend/api/urls.py` |
| 3.4 | API æ¸¬è©¦ï¼ˆcurl / Postmanï¼‰ | æ¸¬è©¦å ±å‘Š |

**API è¦æ ¼**ï¼š

```
POST /api/dify/saf/smart-query/

Request:
{
    "query": "WD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ",
    "user_id": "optional-user-id"
}

Response:
{
    "success": true,
    "answer": "WD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆï¼š\n\n| å°ˆæ¡ˆåç¨± | æ§åˆ¶å™¨ | NAND é¡å‹ |\n|...",
    "table": [
        {"projectName": "DEMETER", "controller": "SM2264XT", "nand": "WDC BiCS5 TLC"},
        {"projectName": "Garuda", "controller": "SM2269XT", "nand": "WDC BiCS6 TLC"}
    ],
    "intent": {
        "type": "query_projects_by_customer",
        "parameters": {"customer": "WD"},
        "confidence": 0.95
    },
    "metadata": {
        "query_time_ms": 150,
        "source": "saf_api"
    }
}
```

**Phase 3 é©—æ”¶æ¨™æº–**ï¼š
- [ ] API ç«¯é» `/api/dify/saf/smart-query/` å¯æ­£å¸¸è¨ªå•
- [ ] è¿”å›æ ¼å¼åŒ…å« `answer`ï¼ˆè‡ªç„¶èªè¨€ + Tableï¼‰å’Œ `table`ï¼ˆçµæ§‹åŒ–è³‡æ–™ï¼‰
- [ ] éŒ¯èª¤è™•ç†æ­£å¸¸ï¼ˆ400, 500 ç‹€æ…‹ç¢¼ï¼‰

---

### 6.5 Phase 4ï¼šå›ç­”ç”Ÿæˆå™¨ - SAF_Analyzerï¼ˆ1.5 å¤©ï¼‰

| æ­¥é©Ÿ | ä»»å‹™ | ç”¢å‡ºæª”æ¡ˆ |
|------|------|---------|
| 4.1 | è¨­è¨ˆå›ç­”ç”Ÿæˆ Prompt | `response_generator.py` |
| 4.2 | å¯¦ä½œ `SAFResponseGenerator` é¡ | `response_generator.py` |
| 4.3 | å¯¦ä½œä¸åŒæ„åœ–çš„å›ç­”æ¨¡æ¿ | `response_generator.py` |
| 4.4 | å¯¦ä½œ Table æ ¼å¼åŒ–é‚è¼¯ï¼ˆMarkdown Tableï¼‰ | `response_generator.py` |
| 4.5 | æ•´åˆåˆ° `SmartQueryView` | `dify_saf_smart_views.py` |
| 4.6 | æ¸¬è©¦å›ç­”å“è³ª | æ¸¬è©¦å ±å‘Š |

**å›ç­”æ ¼å¼è¨­è¨ˆç¯„ä¾‹**ï¼š

**ç¯„ä¾‹ 1ï¼šæŒ‰å®¢æˆ¶æŸ¥è©¢å°ˆæ¡ˆ**
```
WD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆï¼š

| å°ˆæ¡ˆåç¨± | æ§åˆ¶å™¨ | NAND é¡å‹ | ç‹€æ…‹ |
|---------|--------|----------|------|
| DEMETER | SM2264XT | WDC BiCS5 TLC | Active |
| Demeter | SM2264XT | WDC BiCS5 TLC | Active |
| Garuda | SM2269XT | WDC BiCS6 TLC | Active |
```

**ç¯„ä¾‹ 2ï¼šçµ±è¨ˆæ•¸é‡**
```
WD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆã€‚

å¦‚éœ€æŸ¥çœ‹è©³ç´°åˆ—è¡¨ï¼Œå¯ä»¥è©¢å•ã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€
```

**ç¯„ä¾‹ 3ï¼šå°ˆæ¡ˆè©³æƒ…**
```
DEMETER å°ˆæ¡ˆè©³ç´°è³‡è¨Šï¼š

| é …ç›® | å…§å®¹ |
|------|------|
| å®¢æˆ¶ | WD |
| æ§åˆ¶å™¨ | SM2264XT |
| NAND | WDC BiCS5 TLC |
| è² è²¬äºº | ryder.lin |
| å»ºç«‹æ—¥æœŸ | 2024-01-15 |
| ç‹€æ…‹ | Active |
```

**ç¯„ä¾‹ 4ï¼šç„¡æ³•è­˜åˆ¥çš„æ„åœ–**
```
æŠ±æ­‰ï¼Œæˆ‘ç„¡æ³•ç†è§£æ‚¨çš„å•é¡Œã€‚

æˆ‘å¯ä»¥å¹«æ‚¨æŸ¥è©¢ä»¥ä¸‹è³‡è¨Šï¼š
- æŸå®¢æˆ¶çš„å°ˆæ¡ˆåˆ—è¡¨ï¼ˆå¦‚ï¼šã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€ï¼‰
- æŸæ§åˆ¶å™¨çš„å°ˆæ¡ˆï¼ˆå¦‚ï¼šã€ŒSM2264 ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿã€ï¼‰
- å°ˆæ¡ˆè©³ç´°è³‡è¨Šï¼ˆå¦‚ï¼šã€ŒDEMETER å°ˆæ¡ˆçš„è©³ç´°è³‡è¨Šã€ï¼‰
- å°ˆæ¡ˆæ¸¬è©¦çµæœï¼ˆå¦‚ï¼šã€ŒDEMETER çš„æ¸¬è©¦çµæœã€ï¼‰
- å°ˆæ¡ˆæ•¸é‡çµ±è¨ˆï¼ˆå¦‚ï¼šã€ŒWD æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿã€ï¼‰
- å®¢æˆ¶åˆ—è¡¨ï¼ˆå¦‚ï¼šã€Œæœ‰å“ªäº›å®¢æˆ¶ï¼Ÿã€ï¼‰
- æ§åˆ¶å™¨åˆ—è¡¨ï¼ˆå¦‚ï¼šã€Œæœ‰å“ªäº›æ§åˆ¶å™¨ï¼Ÿã€ï¼‰
```

**Phase 4 é©—æ”¶æ¨™æº–**ï¼š
- [ ] å›ç­”åŒ…å«è‡ªç„¶èªè¨€æè¿° + Markdown Table
- [ ] ä¸åŒæ„åœ–æœ‰å°æ‡‰çš„å›ç­”æ¨¡æ¿
- [ ] ç©ºçµæœæ™‚æœ‰å‹å–„æç¤ºï¼ˆã€Œæ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å°ˆæ¡ˆã€ï¼‰
- [ ] `unknown` æ„åœ–æœ‰å¼•å°æç¤º

---

### 6.6 Phase 5ï¼šæ¸¬è©¦èˆ‡å„ªåŒ–ï¼ˆ1.5-2 å¤©ï¼‰

| æ­¥é©Ÿ | ä»»å‹™ | ç”¢å‡º |
|------|------|------|
| 5.1 | E2E æ¸¬è©¦ï¼ˆå®Œæ•´æŸ¥è©¢æµç¨‹ï¼‰ | æ¸¬è©¦å ±å‘Š |
| 5.2 | Prompt å„ªåŒ–ï¼ˆæé«˜æ„åœ–è­˜åˆ¥æº–ç¢ºåº¦ï¼‰ | å„ªåŒ–å¾Œçš„ Prompt |
| 5.3 | éŒ¯èª¤è™•ç†å„ªåŒ– | éŒ¯èª¤è™•ç†é‚è¼¯ |
| 5.4 | åœ¨ Dify ä¸­å»ºç«‹æ¸¬è©¦ App | Dify App é…ç½® |
| 5.5 | æ•ˆèƒ½æ¸¬è©¦ï¼ˆå›æ‡‰æ™‚é–“ï¼‰ | æ•ˆèƒ½å ±å‘Š |
| 5.6 | æ›´æ–°æ–‡æª” | æ–‡æª”æ›´æ–° |

**E2E æ¸¬è©¦æ¡ˆä¾‹æ¸…å–®**ï¼š

| # | å•é¡Œ | é æœŸæ„åœ– | é æœŸå›ç­”å…§å®¹ |
|---|------|---------|-------------|
| 1 | ã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€ | `query_projects_by_customer` | åˆ—å‡º WD å°ˆæ¡ˆ + Table |
| 2 | ã€ŒSamsung æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿã€ | `count_projects` | æ•¸é‡ + æç¤ºæŸ¥çœ‹è©³æƒ… |
| 3 | ã€ŒSM2264 æ§åˆ¶å™¨ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿã€ | `query_projects_by_controller` | åˆ—å‡ºå°ˆæ¡ˆ + Table |
| 4 | ã€Œæœ‰å“ªäº›å®¢æˆ¶ï¼Ÿã€ | `list_all_customers` | å®¢æˆ¶åˆ—è¡¨ |
| 5 | ã€ŒDEMETER å°ˆæ¡ˆçš„è©³ç´°è³‡è¨Šã€ | `query_project_detail` | å°ˆæ¡ˆè©³æƒ… Table |
| 6 | ã€ŒDEMETER çš„æ¸¬è©¦çµæœã€ | `query_project_summary` | æ¸¬è©¦æ‘˜è¦ |
| 7 | ã€Œæœ‰å“ªäº›æ§åˆ¶å™¨ï¼Ÿã€ | `list_all_controllers` | æ§åˆ¶å™¨åˆ—è¡¨ |
| 8 | ã€Œä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿã€ | `unknown` | å‹å–„å¼•å°æç¤º |

**Phase 5 é©—æ”¶æ¨™æº–**ï¼š
- [ ] 8 å€‹ E2E æ¸¬è©¦æ¡ˆä¾‹å…¨éƒ¨é€šé
- [ ] å¹³å‡å›æ‡‰æ™‚é–“ < 3 ç§’
- [ ] åœ¨ Dify App ä¸­æ¸¬è©¦æˆåŠŸ
- [ ] æ–‡æª”å®Œæ•´æ›´æ–°

---

### 6.7 é–‹ç™¼æ™‚ç¨‹ç¸½è¦½

| Phase | ä»»å‹™ | é ä¼°æ™‚é–“ | ç´¯è¨ˆæ™‚é–“ |
|-------|------|----------|----------|
| Phase 0 | ç’°å¢ƒæº–å‚™èˆ‡é…ç½® | 0.5 å¤© | 0.5 å¤© |
| Phase 1 | æ„åœ–åˆ†æå™¨ï¼ˆ8 ç¨®æ„åœ–ï¼‰ | 1.5-2 å¤© | 2-2.5 å¤© |
| Phase 2 | æŸ¥è©¢è·¯ç”±å™¨èˆ‡ Handlers | 2.5-3 å¤© | 4.5-5.5 å¤© |
| Phase 3 | API ç«¯é»æ•´åˆ | 1 å¤© | 5.5-6.5 å¤© |
| Phase 4 | å›ç­”ç”Ÿæˆå™¨ï¼ˆè‡ªç„¶èªè¨€ + Tableï¼‰ | 1.5 å¤© | 7-8 å¤© |
| Phase 5 | æ¸¬è©¦èˆ‡å„ªåŒ– | 1.5-2 å¤© | 8.5-10 å¤© |

**ç¸½è¨ˆï¼šç´„ 8.5-10 å¤©**

---

### 6.8 æœ€çµ‚æª”æ¡ˆçµæ§‹

```
library/saf_integration/smart_query/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ config.py                        # SAF æ™ºèƒ½æŸ¥è©¢é…ç½®
â”œâ”€â”€ intent_types.py                  # IntentType Enumï¼ˆ8 ç¨®ï¼‰
â”œâ”€â”€ intent_analyzer.py               # SAFIntentAnalyzer
â”œâ”€â”€ query_router.py                  # QueryRouter
â”œâ”€â”€ response_generator.py            # SAFResponseGeneratorï¼ˆè‡ªç„¶èªè¨€ + Tableï¼‰
â””â”€â”€ query_handlers/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ base_handler.py              # BaseHandler æŠ½è±¡é¡
    â”œâ”€â”€ customer_handler.py          # æŒ‰å®¢æˆ¶æŸ¥è©¢
    â”œâ”€â”€ controller_handler.py        # æŒ‰æ§åˆ¶å™¨æŸ¥è©¢
    â”œâ”€â”€ project_detail_handler.py    # å°ˆæ¡ˆè©³æƒ…
    â”œâ”€â”€ project_summary_handler.py   # å°ˆæ¡ˆæ¸¬è©¦æ‘˜è¦
    â””â”€â”€ statistics_handler.py        # çµ±è¨ˆï¼ˆcount + list_customers + list_controllersï¼‰

backend/api/views/
â””â”€â”€ dify_saf_smart_views.py          # SmartQueryView

library/config/
â””â”€â”€ dify_config_manager.py           # æ·»åŠ  SAF App é…ç½®

tests/test_saf_smart_query/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ test_intent_analyzer.py          # 8 ç¨®æ„åœ–æ¸¬è©¦
â”œâ”€â”€ test_query_router.py
â”œâ”€â”€ test_response_generator.py
â””â”€â”€ test_handlers/
    â”œâ”€â”€ test_customer_handler.py
    â”œâ”€â”€ test_controller_handler.py
    â”œâ”€â”€ test_project_handlers.py
    â””â”€â”€ test_statistics_handler.py
```

---

## 7. æ¥­ç•Œåƒè€ƒæ¡ˆä¾‹

### 7.1 é€™ç¨®æ¶æ§‹çš„æ­£å¼åç¨±

| åç¨± | èªªæ˜ |
|------|------|
| **Function Calling / Tool Use** | OpenAIã€Claudeã€Gemini éƒ½æ”¯æ´ |
| **AI Agent with Tools** | LangChainã€AutoGPT çš„æ ¸å¿ƒæ¦‚å¿µ |
| **Intent-based Routing** | å‚³çµ± NLP + ç¾ä»£ LLM çµåˆ |
| **Semantic Router** | æ ¹æ“šèªç¾©è‡ªå‹•è·¯ç”±åˆ°å°æ‡‰åŠŸèƒ½ |

### 7.2 çŸ¥åç”¢å“ä½¿ç”¨æ¡ˆä¾‹

| ç”¢å“ | ä½¿ç”¨æ–¹å¼ |
|------|---------|
| **ChatGPT Plugins / GPTs** | GPT åˆ†ææ„åœ– â†’ é¸æ“‡ Plugin â†’ èª¿ç”¨ API |
| **Microsoft Copilot** | LLM åˆ¤æ–· â†’ é¸æ“‡ Microsoft 365 API â†’ åŸ·è¡Œ |
| **Google Gemini Extensions** | Gemini åˆ†æ â†’ é¸æ“‡ Extension â†’ èª¿ç”¨æœå‹™ |
| **Salesforce Einstein GPT** | æ„åœ–åˆ†æ â†’ CRM æ“ä½œ â†’ ç²¾æº–æŸ¥è©¢ |

### 7.3 é–‹æºæ¡†æ¶

| æ¡†æ¶ | èªªæ˜ |
|------|------|
| **LangChain Agents** | Python æ¡†æ¶ï¼Œæ”¯æ´ Tools + Router |
| **LlamaIndex** | æ”¯æ´ Query Router |
| **Semantic Kernel** | Microsoft çš„ AI æ¡†æ¶ |
| **Haystack** | deepset çš„ AI æ¡†æ¶ |

---

## 8. Dify é›™ App æ•´åˆè¨­è¨ˆï¼ˆå·²ç¢ºå®šæ–¹æ¡ˆï¼‰

### 8.1 æ•´åˆæ¶æ§‹ç¸½è¦½

æœ¬ç³»çµ±ä½¿ç”¨ **Dify Chat API** æ­é… **é›™ App å”ä½œ** æ¶æ§‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å·²ç¢ºå®šçš„æŠ€è¡“é¸æ“‡                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  LLM å¹³å°ï¼šDify Server (10.10.172.37)                                   â”‚
â”‚  æ¨¡å‹ï¼šgpt-oss:20b (CHAT)                                               â”‚
â”‚  API æ–¹å¼ï¼šDify Chat API                                                â”‚
â”‚                                                                          â”‚
â”‚  é›™ App æ¶æ§‹ï¼š                                                           â”‚
â”‚  â”œâ”€â”€ App 1: SAF_Intent_Analyzerï¼ˆæ„åœ–åˆ†æï¼‰                             â”‚
â”‚  â””â”€â”€ App 2: SAF_Analyzerï¼ˆå›ç­”ç”Ÿæˆï¼‰                                    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Dify App é…ç½®ï¼ˆâœ… å·²å®Œæˆï¼‰

| App åç¨± | API Key | ç”¨é€” | System Prompt |
|----------|---------|------|---------------|
| `SAF_Intent_Analyzer` | `app-vMNSUqgEIoejnXo3fuFvp1hC` | æ„åœ–åˆ†æ | æ¥µç°¡ï¼ˆç¨‹å¼ç¢¼æ§åˆ¶ï¼‰ |
| `SAF_Analyzer` | `app-0GyoZLrr4tDpT4EO2Kihuvux` | å›ç­”ç”Ÿæˆ | åœ¨ Dify ä¸­è¨­å®š |

---

### 8.3 SAF_Intent_Analyzer è©³ç´°è¨­è¨ˆ

#### 8.3.1 æ¶æ§‹æ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Django Smart Query API                                â”‚
â”‚                    POST /api/dify/saf/smart-query/                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ§  IntentAnalyzer                                     â”‚
â”‚                                                                          â”‚
â”‚  ä½¿ç”¨ç¾æœ‰çš„ DifyRequestManager èª¿ç”¨ Dify Chat API                        â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Dify App: ã€ŒSAF æ„åœ–åˆ†æå™¨ã€                                    â”‚    â”‚
â”‚  â”‚  - å°ˆé–€ç”¨æ–¼åˆ†ææ„åœ–ï¼Œè¼¸å‡º JSON                                   â”‚    â”‚
â”‚  â”‚  - System Prompt è¨­å®šç‚ºæ„åœ–åˆ†æå°ˆç”¨                              â”‚    â”‚
â”‚  â”‚  - è¼¸å‡ºæ ¼å¼ï¼š{"intent": "...", "parameters": {...}}              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ”€ QueryRouter + Handlers                             â”‚
â”‚                    ï¼ˆDjango æœ¬åœ°è™•ç†ï¼‰                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“¡ SAF API Server                                     â”‚
â”‚                    http://10.252.170.171:8080                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.3.2 æ„åœ–åˆ†æ Prompt è¨­è¨ˆ

**System Promptï¼ˆå·²åœ¨ Dify è¨­å®šï¼‰**ï¼š
```
ä½ æ˜¯ä¸€å€‹åŠ©æ‰‹ï¼Œè«‹æ ¹æ“šç”¨æˆ¶çš„æŒ‡ç¤ºå›ç­”ã€‚åªè¼¸å‡ºç”¨æˆ¶è¦æ±‚çš„æ ¼å¼ã€‚
```

**ç¨‹å¼ç¢¼ä¸­çš„å®Œæ•´ Promptï¼ˆ`INTENT_ANALYSIS_PROMPT`ï¼‰**ï¼š
```
ä½ æ˜¯ä¸€å€‹æ„åœ–åˆ†æå™¨ï¼Œå°ˆé–€åˆ†æç”¨æˆ¶é—œæ–¼ SAF å°ˆæ¡ˆç®¡ç†ç³»çµ±çš„å•é¡Œã€‚

ä½ å¿…é ˆè¼¸å‡º JSON æ ¼å¼ï¼Œä¸è¦è¼¸å‡ºå…¶ä»–å…§å®¹ã€‚

## å¯ç”¨çš„æ„åœ–é¡å‹

1. query_projects_by_customer - æŒ‰å®¢æˆ¶æŸ¥è©¢å°ˆæ¡ˆ
   - è§¸ç™¼è©ï¼šã€ŒXX æœ‰å“ªäº›å°ˆæ¡ˆã€ã€Œåˆ—å‡º XX çš„å°ˆæ¡ˆã€ã€ŒXX çš„å°ˆæ¡ˆã€
   - åƒæ•¸ï¼šcustomer (å®¢æˆ¶åç¨±)

2. query_projects_by_controller - æŒ‰æ§åˆ¶å™¨æŸ¥è©¢å°ˆæ¡ˆ
   - è§¸ç™¼è©ï¼šã€ŒSM2264 ç”¨åœ¨å“ªäº›å°ˆæ¡ˆã€ã€Œå“ªäº›å°ˆæ¡ˆç”¨ XX æ§åˆ¶å™¨ã€
   - åƒæ•¸ï¼šcontroller (æ§åˆ¶å™¨å‹è™Ÿ)

3. query_project_detail - æŸ¥è©¢å°ˆæ¡ˆè©³ç´°è³‡è¨Š
   - è§¸ç™¼è©ï¼šã€ŒXX å°ˆæ¡ˆçš„è©³ç´°è³‡è¨Šã€ã€Œå‘Šè¨´æˆ‘ XX å°ˆæ¡ˆã€
   - åƒæ•¸ï¼šproject_name (å°ˆæ¡ˆåç¨±)

4. query_project_summary - æŸ¥è©¢å°ˆæ¡ˆæ¸¬è©¦æ‘˜è¦
   - è§¸ç™¼è©ï¼šã€ŒXX çš„æ¸¬è©¦çµæœã€ã€ŒXX æ¸¬è©¦ç‹€æ³ã€
   - åƒæ•¸ï¼šproject_name (å°ˆæ¡ˆåç¨±)

5. count_projects - çµ±è¨ˆå°ˆæ¡ˆæ•¸é‡
   - è§¸ç™¼è©ï¼šã€Œæœ‰å¤šå°‘å°ˆæ¡ˆã€ã€Œå¹¾å€‹å°ˆæ¡ˆã€ã€Œå°ˆæ¡ˆæ•¸é‡ã€
   - åƒæ•¸ï¼šcustomer (å¯é¸ï¼Œè‹¥æŒ‡å®šå®¢æˆ¶)

6. list_all_customers - åˆ—å‡ºæ‰€æœ‰å®¢æˆ¶
   - è§¸ç™¼è©ï¼šã€Œæœ‰å“ªäº›å®¢æˆ¶ã€ã€Œå®¢æˆ¶åˆ—è¡¨ã€
   - åƒæ•¸ï¼šç„¡

7. list_all_controllers - åˆ—å‡ºæ‰€æœ‰æ§åˆ¶å™¨
   - è§¸ç™¼è©ï¼šã€Œæœ‰å“ªäº›æ§åˆ¶å™¨ã€ã€Œæ§åˆ¶å™¨åˆ—è¡¨ã€
   - åƒæ•¸ï¼šç„¡

8. unknown - ç„¡æ³•è­˜åˆ¥çš„æ„åœ–

## å·²çŸ¥å®¢æˆ¶åç¨±
WD, WDC, Western Digital, Samsung, Micron, Transcend, ADATA, UMIS, Biwin, Kioxia, SK Hynix

## å·²çŸ¥æ§åˆ¶å™¨å‹è™Ÿ
SM2263, SM2264, SM2267, SM2269, SM2264XT, SM2269XT

## è¼¸å‡ºæ ¼å¼ï¼ˆå¿…é ˆæ˜¯æœ‰æ•ˆçš„ JSONï¼‰

{
  "intent": "æ„åœ–é¡å‹ ID",
  "parameters": {
    // æå–çš„åƒæ•¸ï¼Œkey-value æ ¼å¼
  },
  "confidence": 0.0-1.0 ä¹‹é–“çš„æ•¸å€¼
}

## ç¯„ä¾‹

ç”¨æˆ¶ï¼šã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€
è¼¸å‡ºï¼š{"intent": "query_projects_by_customer", "parameters": {"customer": "WD"}, "confidence": 0.95}

ç”¨æˆ¶ï¼šã€ŒSM2264 æ§åˆ¶å™¨ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿã€
è¼¸å‡ºï¼š{"intent": "query_projects_by_controller", "parameters": {"controller": "SM2264"}, "confidence": 0.90}

ç”¨æˆ¶ï¼šã€Œç¸½å…±æœ‰å¤šå°‘å°ˆæ¡ˆï¼Ÿã€
è¼¸å‡ºï¼š{"intent": "count_projects", "parameters": {}, "confidence": 0.95}

ç”¨æˆ¶ï¼šã€ŒSamsung æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿã€
è¼¸å‡ºï¼š{"intent": "count_projects", "parameters": {"customer": "Samsung"}, "confidence": 0.93}

ç”¨æˆ¶ï¼šã€Œä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿã€
è¼¸å‡ºï¼š{"intent": "unknown", "parameters": {}, "confidence": 0.10}
```

#### 8.3.3 IntentAnalyzer å¯¦ä½œ

```python
# library/saf_integration/smart_query/intent_analyzer.py

import json
import logging
from typing import Optional
from dataclasses import dataclass

from library.config.dify_config_manager import get_saf_intent_analyzer_config
from library.dify_integration.dify_request_manager import DifyRequestManager

logger = logging.getLogger(__name__)

@dataclass
class IntentResult:
    """æ„åœ–åˆ†æçµæœ"""
    intent: str
    parameters: dict
    confidence: float
    raw_response: Optional[str] = None

class IntentAnalyzer:
    """
    ä½¿ç”¨ Dify Chat API é€²è¡Œæ„åœ–åˆ†æ
    """
    
    def __init__(self):
        self.config = get_saf_intent_analyzer_config()
        self.request_manager = DifyRequestManager(
            api_url=self.config.api_url,
            api_key=self.config.api_key,
            timeout=self.config.timeout
        )
    
    def analyze(self, query: str, user_id: str = "system") -> IntentResult:
        """
        åˆ†æç”¨æˆ¶å•é¡Œçš„æ„åœ–
        
        Args:
            query: ç”¨æˆ¶çš„å•é¡Œ
            user_id: ç”¨æˆ¶ IDï¼ˆç”¨æ–¼ Dify è¿½è¹¤ï¼‰
            
        Returns:
            IntentResult: åŒ…å«æ„åœ–ã€åƒæ•¸ã€ä¿¡å¿ƒåº¦
        """
        try:
            # èª¿ç”¨ Dify Chat API
            response = self.request_manager.send_chat_request(
                query=query,
                user_id=user_id,
                conversation_id=None  # æ¯æ¬¡éƒ½æ˜¯æ–°å°è©±
            )
            
            if not response.get('success'):
                logger.error(f"Dify API èª¿ç”¨å¤±æ•—: {response.get('error')}")
                return self._fallback_result(query)
            
            # è§£æ JSON å›æ‡‰
            answer = response.get('answer', '')
            return self._parse_intent_response(answer, query)
            
        except Exception as e:
            logger.error(f"æ„åœ–åˆ†æéŒ¯èª¤: {str(e)}")
            return self._fallback_result(query)
    
    def _parse_intent_response(self, answer: str, original_query: str) -> IntentResult:
        """è§£æ Dify è¿”å›çš„ JSON æ„åœ–"""
        try:
            # å˜—è©¦ç›´æ¥è§£æ JSON
            intent_data = json.loads(answer.strip())
            
            return IntentResult(
                intent=intent_data.get('intent', 'unknown'),
                parameters=intent_data.get('parameters', {}),
                confidence=intent_data.get('confidence', 0.5),
                raw_response=answer
            )
        except json.JSONDecodeError:
            # JSON è§£æå¤±æ•—ï¼Œå˜—è©¦å¾æ–‡å­—ä¸­æå– JSON
            logger.warning(f"JSON è§£æå¤±æ•—ï¼Œå˜—è©¦æå–: {answer[:100]}...")
            return self._extract_json_from_text(answer, original_query)
    
    def _extract_json_from_text(self, text: str, original_query: str) -> IntentResult:
        """å¾æ–‡å­—ä¸­æå– JSONï¼ˆè™•ç† LLM å¯èƒ½æ·»åŠ çš„é¡å¤–æ–‡å­—ï¼‰"""
        import re
        
        # å˜—è©¦æ‰¾åˆ° JSON éƒ¨åˆ†
        json_pattern = r'\{[^{}]*\}'
        matches = re.findall(json_pattern, text)
        
        for match in matches:
            try:
                intent_data = json.loads(match)
                if 'intent' in intent_data:
                    return IntentResult(
                        intent=intent_data.get('intent', 'unknown'),
                        parameters=intent_data.get('parameters', {}),
                        confidence=intent_data.get('confidence', 0.5),
                        raw_response=text
                    )
            except json.JSONDecodeError:
                continue
        
        # å®Œå…¨ç„¡æ³•è§£æ
        return self._fallback_result(original_query)
    
    def _fallback_result(self, query: str) -> IntentResult:
        """é™ç´šè™•ç†ï¼šä½¿ç”¨ç°¡å–®çš„é—œéµå­—åŒ¹é…"""
        query_lower = query.lower()
        
        # ç°¡å–®çš„é—œéµå­—åŒ¹é…ä½œç‚ºé™ç´šæ–¹æ¡ˆ
        if 'å®¢æˆ¶' in query or 'æœ‰å“ªäº›å®¢æˆ¶' in query:
            return IntentResult('list_all_customers', {}, 0.6)
        elif 'æ§åˆ¶å™¨' in query and ('åˆ—è¡¨' in query or 'æœ‰å“ªäº›' in query):
            return IntentResult('list_all_controllers', {}, 0.6)
        elif 'å¤šå°‘' in query or 'å¹¾å€‹' in query:
            return IntentResult('count_projects', {}, 0.6)
        
        return IntentResult('unknown', {}, 0.3, raw_response=f"Fallback for: {query}")
```

#### 8.3.4 èª¿ç”¨ç¯„ä¾‹

```python
# ä½¿ç”¨ç¯„ä¾‹

from library.saf_integration.smart_query.intent_analyzer import IntentAnalyzer

analyzer = IntentAnalyzer()

# åˆ†ææ„åœ–
result = analyzer.analyze("WD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ")

print(result.intent)      # "query_projects_by_customer"
print(result.parameters)  # {"customer": "WD"}
print(result.confidence)  # 0.95
```

---

### 8.4 å®Œæ•´ç¨‹å¼ç¢¼å¯¦ä½œè¨­è¨ˆï¼ˆSAFIntentAnalyzerï¼‰

**æ¶æ§‹åœ–**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Django Smart Query API                                â”‚
â”‚                    POST /api/dify/saf/smart-query/                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ§  IntentAnalyzer                                     â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç¨‹å¼ç¢¼ä¸­çš„å®Œæ•´ Promptï¼ˆINTENT_ANALYSIS_PROMPTï¼‰                 â”‚    â”‚
â”‚  â”‚  + ç”¨æˆ¶å•é¡Œ                                                      â”‚    â”‚
â”‚  â”‚  â†“                                                               â”‚    â”‚
â”‚  â”‚  çµ„åˆæˆ query ç™¼é€çµ¦ Dify                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  POST http://10.10.172.37/v1/chat-messages                               â”‚
â”‚  Authorization: Bearer {SAF_Intent_Analyzer çš„ API Key}                  â”‚
â”‚  {                                                                       â”‚
â”‚    "query": "[å®Œæ•´ Prompt]\n\nç”¨æˆ¶å•é¡Œï¼šWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ",               â”‚
â”‚    "response_mode": "blocking",                                          â”‚
â”‚    "user": "saf-smart-query"                                             â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“¡ Dify Server (gpt-oss:20b)                          â”‚
â”‚                                                                          â”‚
â”‚  ä½¿ç”¨ SAF_Intent_Analyzer App ç¶å®šçš„æ¨¡å‹è™•ç†è«‹æ±‚                         â”‚
â”‚  è¿”å› JSON æ ¼å¼çš„æ„åœ–åˆ†æçµæœ                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ”€ QueryRouter + Handlers â†’ SAF API                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Œæ•´ç¨‹å¼ç¢¼è¨­è¨ˆ**ï¼š

```python
# library/saf_integration/smart_query/intent_analyzer.py

import json
import logging
import requests
from typing import Optional
from dataclasses import dataclass

logger = logging.getLogger(__name__)

# ============================================================
# æ„åœ–åˆ†æ Promptï¼ˆå®Œå…¨åœ¨ç¨‹å¼ç¢¼ä¸­ç®¡ç†ï¼Œå¯ç‰ˆæœ¬æ§åˆ¶ï¼‰
# ============================================================
INTENT_ANALYSIS_PROMPT = """
ä½ æ˜¯ä¸€å€‹æ„åœ–åˆ†æå™¨ï¼Œå°ˆé–€åˆ†æç”¨æˆ¶é—œæ–¼ SAF å°ˆæ¡ˆç®¡ç†ç³»çµ±çš„å•é¡Œã€‚

ã€é‡è¦ã€‘ä½ å¿…é ˆåªè¼¸å‡º JSON æ ¼å¼ï¼Œä¸è¦è¼¸å‡ºä»»ä½•å…¶ä»–æ–‡å­—ã€è§£é‡‹æˆ–æ¨™è¨˜ã€‚

## å¯ç”¨çš„æ„åœ–é¡å‹

1. query_projects_by_customer - æŒ‰å®¢æˆ¶æŸ¥è©¢å°ˆæ¡ˆ
   - è§¸ç™¼è©ï¼šã€ŒXX æœ‰å“ªäº›å°ˆæ¡ˆã€ã€Œåˆ—å‡º XX çš„å°ˆæ¡ˆã€ã€ŒXX çš„å°ˆæ¡ˆã€
   - åƒæ•¸ï¼šcustomer (å®¢æˆ¶åç¨±)

2. query_projects_by_controller - æŒ‰æ§åˆ¶å™¨æŸ¥è©¢å°ˆæ¡ˆ
   - è§¸ç™¼è©ï¼šã€ŒSM2264 ç”¨åœ¨å“ªäº›å°ˆæ¡ˆã€ã€Œå“ªäº›å°ˆæ¡ˆç”¨ XX æ§åˆ¶å™¨ã€
   - åƒæ•¸ï¼šcontroller (æ§åˆ¶å™¨å‹è™Ÿ)

3. query_project_detail - æŸ¥è©¢å°ˆæ¡ˆè©³ç´°è³‡è¨Š
   - è§¸ç™¼è©ï¼šã€ŒXX å°ˆæ¡ˆçš„è©³ç´°è³‡è¨Šã€ã€Œå‘Šè¨´æˆ‘ XX å°ˆæ¡ˆã€
   - åƒæ•¸ï¼šproject_name (å°ˆæ¡ˆåç¨±)

4. query_project_summary - æŸ¥è©¢å°ˆæ¡ˆæ¸¬è©¦æ‘˜è¦
   - è§¸ç™¼è©ï¼šã€ŒXX çš„æ¸¬è©¦çµæœã€ã€ŒXX æ¸¬è©¦ç‹€æ³ã€
   - åƒæ•¸ï¼šproject_name (å°ˆæ¡ˆåç¨±)

5. count_projects - çµ±è¨ˆå°ˆæ¡ˆæ•¸é‡
   - è§¸ç™¼è©ï¼šã€Œæœ‰å¤šå°‘å°ˆæ¡ˆã€ã€Œå¹¾å€‹å°ˆæ¡ˆã€ã€Œå°ˆæ¡ˆæ•¸é‡ã€
   - åƒæ•¸ï¼šcustomer (å¯é¸ï¼Œè‹¥æŒ‡å®šå®¢æˆ¶)

6. list_all_customers - åˆ—å‡ºæ‰€æœ‰å®¢æˆ¶
   - è§¸ç™¼è©ï¼šã€Œæœ‰å“ªäº›å®¢æˆ¶ã€ã€Œå®¢æˆ¶åˆ—è¡¨ã€

7. list_all_controllers - åˆ—å‡ºæ‰€æœ‰æ§åˆ¶å™¨
   - è§¸ç™¼è©ï¼šã€Œæœ‰å“ªäº›æ§åˆ¶å™¨ã€ã€Œæ§åˆ¶å™¨åˆ—è¡¨ã€

8. unknown - ç„¡æ³•è­˜åˆ¥çš„æ„åœ–

## å·²çŸ¥è³‡è¨Š

å®¢æˆ¶åç¨±ï¼šWD, WDC, Western Digital, Samsung, Micron, Transcend, ADATA, UMIS, Biwin, Kioxia, SK Hynix
æ§åˆ¶å™¨å‹è™Ÿï¼šSM2263, SM2264, SM2267, SM2269, SM2264XT, SM2269XT

## è¼¸å‡ºæ ¼å¼

{"intent": "æ„åœ–ID", "parameters": {}, "confidence": 0.0-1.0}

## ç¯„ä¾‹

è¼¸å…¥ï¼šWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ
è¼¸å‡ºï¼š{"intent": "query_projects_by_customer", "parameters": {"customer": "WD"}, "confidence": 0.95}

è¼¸å…¥ï¼šSM2264 æ§åˆ¶å™¨ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿ
è¼¸å‡ºï¼š{"intent": "query_projects_by_controller", "parameters": {"controller": "SM2264"}, "confidence": 0.90}

è¼¸å…¥ï¼šç¸½å…±æœ‰å¤šå°‘å°ˆæ¡ˆï¼Ÿ
è¼¸å‡ºï¼š{"intent": "count_projects", "parameters": {}, "confidence": 0.95}

è¼¸å…¥ï¼šä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿ
è¼¸å‡ºï¼š{"intent": "unknown", "parameters": {}, "confidence": 0.10}

---

ç¾åœ¨åˆ†æä»¥ä¸‹å•é¡Œï¼š
"""


@dataclass
class IntentResult:
    """æ„åœ–åˆ†æçµæœ"""
    intent: str
    parameters: dict
    confidence: float
    raw_response: Optional[str] = None


class SAFIntentAnalyzer:
    """
    SAF æ„åœ–åˆ†æå™¨
    
    ä½¿ç”¨ Dify çš„ SAF_Intent_Analyzer App é€²è¡Œæ„åœ–åˆ†æ
    Prompt å®Œå…¨ç”±ç¨‹å¼ç¢¼æ§åˆ¶
    """
    
    # Dify é…ç½®
    DIFY_SERVER = "http://10.10.172.37"
    API_KEY = "app-vMNSUqgEIoejnXo3fuFvp1hC"  # SAF_Intent_Analyzer çš„ API Keyï¼ˆå·²å»ºç«‹ï¼‰
    TIMEOUT = 30
    
    def __init__(self, api_key: str = None):
        """
        åˆå§‹åŒ–æ„åœ–åˆ†æå™¨
        
        Args:
            api_key: å¯é¸ï¼Œè¦†è“‹é è¨­çš„ API Key
        """
        self.api_key = api_key or self.API_KEY
        self.api_url = f"{self.DIFY_SERVER}/v1/chat-messages"
    
    def analyze(self, query: str, user_id: str = "saf-smart-query") -> IntentResult:
        """
        åˆ†æç”¨æˆ¶å•é¡Œçš„æ„åœ–
        
        Args:
            query: ç”¨æˆ¶çš„å•é¡Œï¼ˆå¦‚ã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€ï¼‰
            user_id: ç”¨æˆ¶è­˜åˆ¥ç¢¼
            
        Returns:
            IntentResult: åŒ…å« intent, parameters, confidence
        """
        try:
            # çµ„åˆå®Œæ•´çš„ promptï¼ˆç¨‹å¼ç¢¼ä¸­çš„ Prompt + ç”¨æˆ¶å•é¡Œï¼‰
            full_query = f"{INTENT_ANALYSIS_PROMPT}\n{query}"
            
            # èª¿ç”¨ Dify Chat API
            response = requests.post(
                self.api_url,
                headers={
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                },
                json={
                    "inputs": {},
                    "query": full_query,
                    "response_mode": "blocking",
                    "conversation_id": "",  # æ¯æ¬¡éƒ½æ˜¯æ–°å°è©±
                    "user": user_id
                },
                timeout=self.TIMEOUT
            )
            
            if response.status_code != 200:
                logger.error(f"Dify API éŒ¯èª¤: {response.status_code} - {response.text}")
                return self._fallback_result(query)
            
            data = response.json()
            answer = data.get('answer', '')
            
            logger.info(f"æ„åœ–åˆ†æåŸå§‹å›æ‡‰: {answer[:200]}...")
            
            return self._parse_intent_response(answer, query)
            
        except requests.Timeout:
            logger.error("Dify API è¶…æ™‚")
            return self._fallback_result(query)
        except Exception as e:
            logger.error(f"æ„åœ–åˆ†æéŒ¯èª¤: {str(e)}")
            return self._fallback_result(query)
    
    def _parse_intent_response(self, answer: str, original_query: str) -> IntentResult:
        """è§£æ LLM è¿”å›çš„ JSON"""
        try:
            # æ¸…ç†å¯èƒ½çš„ markdown æ¨™è¨˜
            clean_answer = answer.strip()
            if clean_answer.startswith("```json"):
                clean_answer = clean_answer[7:]
            if clean_answer.startswith("```"):
                clean_answer = clean_answer[3:]
            if clean_answer.endswith("```"):
                clean_answer = clean_answer[:-3]
            clean_answer = clean_answer.strip()
            
            # è§£æ JSON
            intent_data = json.loads(clean_answer)
            
            return IntentResult(
                intent=intent_data.get('intent', 'unknown'),
                parameters=intent_data.get('parameters', {}),
                confidence=intent_data.get('confidence', 0.5),
                raw_response=answer
            )
            
        except json.JSONDecodeError:
            logger.warning(f"JSON è§£æå¤±æ•—ï¼Œå˜—è©¦æå–: {answer[:100]}...")
            return self._extract_json_from_text(answer, original_query)
    
    def _extract_json_from_text(self, text: str, original_query: str) -> IntentResult:
        """å¾æ–‡å­—ä¸­æå– JSONï¼ˆè™•ç† LLM å¯èƒ½æ·»åŠ çš„é¡å¤–æ–‡å­—ï¼‰"""
        import re
        
        # å˜—è©¦æ‰¾åˆ° JSON éƒ¨åˆ†
        json_pattern = r'\{[^{}]*"intent"[^{}]*\}'
        matches = re.findall(json_pattern, text)
        
        for match in matches:
            try:
                intent_data = json.loads(match)
                if 'intent' in intent_data:
                    return IntentResult(
                        intent=intent_data.get('intent', 'unknown'),
                        parameters=intent_data.get('parameters', {}),
                        confidence=intent_data.get('confidence', 0.5),
                        raw_response=text
                    )
            except json.JSONDecodeError:
                continue
        
        # å®Œå…¨ç„¡æ³•è§£æï¼Œä½¿ç”¨é™ç´šæ–¹æ¡ˆ
        logger.warning(f"ç„¡æ³•å¾å›æ‡‰ä¸­æå– JSONï¼Œä½¿ç”¨é™ç´šæ–¹æ¡ˆ")
        return self._fallback_result(original_query)
    
    def _fallback_result(self, query: str) -> IntentResult:
        """
        é™ç´šè™•ç†ï¼šä½¿ç”¨ç°¡å–®çš„é—œéµå­—åŒ¹é…
        ç•¶ LLM èª¿ç”¨å¤±æ•—æ™‚çš„å‚™ç”¨æ–¹æ¡ˆ
        """
        query_lower = query.lower()
        
        # å®¢æˆ¶é—œéµå­—åŒ¹é…
        customers = {
            'wd': 'WD', 'wdc': 'WDC', 'samsung': 'Samsung',
            'micron': 'Micron', 'transcend': 'Transcend',
            'adata': 'ADATA', 'umis': 'UMIS', 'biwin': 'Biwin'
        }
        
        for key, value in customers.items():
            if key in query_lower:
                if 'å¤šå°‘' in query or 'å¹¾å€‹' in query:
                    return IntentResult('count_projects', {'customer': value}, 0.6)
                elif 'å°ˆæ¡ˆ' in query or 'project' in query_lower:
                    return IntentResult('query_projects_by_customer', {'customer': value}, 0.6)
        
        # æ§åˆ¶å™¨é—œéµå­—åŒ¹é…
        controllers = ['sm2263', 'sm2264', 'sm2267', 'sm2269']
        for ctrl in controllers:
            if ctrl in query_lower:
                return IntentResult(
                    'query_projects_by_controller',
                    {'controller': ctrl.upper()},
                    0.6
                )
        
        # é€šç”¨æ•¸é‡æŸ¥è©¢
        if 'å¤šå°‘' in query or 'å¹¾å€‹' in query:
            return IntentResult('count_projects', {}, 0.6)
        
        # å®¢æˆ¶åˆ—è¡¨
        if 'å®¢æˆ¶' in query and ('æœ‰å“ªäº›' in query or 'åˆ—è¡¨' in query):
            return IntentResult('list_all_customers', {}, 0.6)
        
        # æ§åˆ¶å™¨åˆ—è¡¨
        if 'æ§åˆ¶å™¨' in query and ('æœ‰å“ªäº›' in query or 'åˆ—è¡¨' in query):
            return IntentResult('list_all_controllers', {}, 0.6)
        
        return IntentResult('unknown', {}, 0.3, raw_response=f"Fallback for: {query}")


# ============================================================
# ä½¿ç”¨ç¯„ä¾‹
# ============================================================
if __name__ == "__main__":
    analyzer = SAFIntentAnalyzer()
    
    # æ¸¬è©¦æ¡ˆä¾‹
    test_queries = [
        "WD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ",
        "Samsung æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿ",
        "SM2264 æ§åˆ¶å™¨ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿ",
        "æœ‰å“ªäº›å®¢æˆ¶ï¼Ÿ",
        "ä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿ"
    ]
    
    for query in test_queries:
        result = analyzer.analyze(query)
        print(f"\nå•é¡Œ: {query}")
        print(f"æ„åœ–: {result.intent}")
        print(f"åƒæ•¸: {result.parameters}")
        print(f"ä¿¡å¿ƒåº¦: {result.confidence}")
```

---

## 9. å„ªå…ˆå¯¦ä½œçš„æ„åœ–

**å»ºè­°å„ªå…ˆé †åº**ï¼š
1. `query_projects_by_customer` - æœ€å¸¸ç”¨
2. `count_projects` - é©—è­‰ç²¾æº–åº¦
3. `query_projects_by_controller` - å¸¸ç”¨
4. `list_all_customers` - ç°¡å–®ä½†å¯¦ç”¨

---

## ğŸ“… æ–‡æª”æ›´æ–°è¨˜éŒ„

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å…§å®¹ | ä½œè€… |
|------|------|---------|------|
| v1.0 | 2025-12-05 | åˆå§‹è¦åŠƒæ–‡æª” | AI Platform Team |
| v1.1 | 2025-12-05 | æ–°å¢ Dify LLM API æ•´åˆæ–¹æ¡ˆè©³ç´°è¨­è¨ˆ | AI Platform Team |
| v1.2 | 2025-12-05 | æ–°å¢ã€Œç„¡éœ€å»ºç«‹ Dify Appã€æ–¹æ¡ˆï¼ˆB-1b, B-1cï¼‰ | AI Platform Team |
| v1.3 | 2025-12-05 | è©³ç´°èªªæ˜ B-1b å¦‚ä½•èª¿ç”¨ Dify æ¨¡å‹ï¼ˆgpt-oss:20bï¼‰ | AI Platform Team |
| v1.4 | 2025-12-05 | å®Œæˆ B-1b-2 æ–¹æ¡ˆé…ç½®ï¼Œæ–°å¢é›™ App å”ä½œæ¶æ§‹è¨­è¨ˆ | AI Platform Team |
| v1.5 | 2025-12-05 | ç§»é™¤æ–¹æ¡ˆ A/Cï¼Œåªä¿ç•™æ–¹æ¡ˆ Bï¼ˆDjango æ™ºèƒ½è·¯ç”± APIï¼‰ | AI Platform Team |

### v1.5 æ›´æ–°è©³æƒ…

**æ–‡æª”æ•´ç†**ï¼š
- âŒ ç§»é™¤æ–¹æ¡ˆ Aï¼ˆDify Workflowï¼‰
- âŒ ç§»é™¤æ–¹æ¡ˆ Cï¼ˆDify Agent + Toolsï¼‰
- âŒ ç§»é™¤æ–¹æ¡ˆ B-1bï¼ˆDify Completion APIï¼‰ã€B-1cï¼ˆOpenAI/Claude ç›´æ¥èª¿ç”¨ï¼‰
- âœ… åªä¿ç•™æ–¹æ¡ˆ Bï¼ˆDjango æ™ºèƒ½è·¯ç”± APIï¼‰+ é›™ App å”ä½œæ¶æ§‹
- âœ… æ›´æ–°ç›®éŒ„çµæ§‹

**ç¢ºå®šçš„æŠ€è¡“æ¶æ§‹**ï¼š
- **æ„åœ–åˆ†æ**ï¼š`SAF_Intent_Analyzer` Appï¼ˆDify Chat APIï¼‰
- **å›ç­”ç”Ÿæˆ**ï¼š`SAF_Analyzer` Appï¼ˆDify Chat APIï¼‰
- **è·¯ç”±å™¨**ï¼šDjango `QueryRouter`
- **API ç«¯é»**ï¼š`POST /api/dify/saf/smart-query/`

---

## ğŸ”— ç›¸é—œæ–‡æª”

- [Dify SAF å¤–éƒ¨çŸ¥è­˜åº« API è¨­è¨ˆ](./dify-saf-external-knowledge-api-plan.md)
- [SAF API Server åˆ†æ](../features/dify-saf-external-knowledge-api-design.md)
