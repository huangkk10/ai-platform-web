# LLM æ™ºèƒ½ API è·¯ç”±ç³»çµ±è¨­è¨ˆæ–‡æª”

**æ–‡æª”ç‰ˆæœ¬**ï¼šv1.6  
**å‰µå»ºæ—¥æœŸ**ï¼š2025-12-05  
**æœ€å¾Œæ›´æ–°**ï¼š2025-12-06  
**ç‹€æ…‹**ï¼šğŸ“‹ Phase 1-2 å·²å®Œæˆï¼ŒPhase 3 è¦åŠƒä¸­  
**ä½œè€…**ï¼šAI Platform Team  
**ç¢ºå®šæ–¹æ¡ˆ**ï¼šDjango æ™ºèƒ½è·¯ç”± API + Dify é›™ App å”ä½œ

---

## ğŸ“‹ ç›®éŒ„

1. [å°ˆæ¡ˆæ¦‚è¿°](#1-å°ˆæ¡ˆæ¦‚è¿°)
2. [ç³»çµ±æ¶æ§‹è¨­è¨ˆ](#2-ç³»çµ±æ¶æ§‹è¨­è¨ˆ)
3. [æ„åœ–é¡å‹å®šç¾©](#3-æ„åœ–é¡å‹å®šç¾©)
4. [æŠ€è¡“å¯¦ä½œæ–¹æ¡ˆï¼šDjango æ™ºèƒ½è·¯ç”± API](#4-æŠ€è¡“å¯¦ä½œæ–¹æ¡ˆdjango-æ™ºèƒ½è·¯ç”±-api)
5. [æ ¸å¿ƒçµ„ä»¶è¨­è¨ˆ](#5-æ ¸å¿ƒçµ„ä»¶è¨­è¨ˆ)
6. [å¯¦ä½œéšæ®µè¦åŠƒï¼ˆè©³ç´°ç‰ˆï¼‰](#6-å¯¦ä½œéšæ®µè¦åŠƒè©³ç´°ç‰ˆ)
7. [æ¥­ç•Œåƒè€ƒæ¡ˆä¾‹](#7-æ¥­ç•Œåƒè€ƒæ¡ˆä¾‹)
8. [Dify é›™ App æ•´åˆè¨­è¨ˆï¼ˆå·²ç¢ºå®šæ–¹æ¡ˆï¼‰](#8-dify-é›™-app-æ•´åˆè¨­è¨ˆå·²ç¢ºå®šæ–¹æ¡ˆ)
9. [å„ªå…ˆå¯¦ä½œçš„æ„åœ–](#9-å„ªå…ˆå¯¦ä½œçš„æ„åœ–)
10. [Phase 3ï¼šTest Summary API æ•´åˆè¨­è¨ˆ](#10-phase-3test-summary-api-æ•´åˆè¨­è¨ˆ)

---

## 1. å°ˆæ¡ˆæ¦‚è¿°

### 1.1 èƒŒæ™¯

ç›®å‰ SAF å¤–éƒ¨çŸ¥è­˜åº«ä½¿ç”¨é—œéµå­—åŒ¹é…æ–¹å¼æœå°‹è³‡æ–™ï¼Œå­˜åœ¨ä»¥ä¸‹å•é¡Œï¼š
- è¿”å›å¤§é‡å¯èƒ½ç›¸é—œçš„è³‡æ–™ï¼Œä¾è³´ LLM å¾ä¸­ç¯©é¸
- ç„¡æ³•ç²¾æº–å›ç­”æ•¸é‡é¡å•é¡Œï¼ˆå¦‚ã€ŒWD æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿã€ï¼‰
- ä¸åŒé¡å‹çš„æŸ¥è©¢ç„¡æ³•æœ€ä½³åŒ–

### 1.2 ç›®æ¨™

å»ºç«‹ã€Œ**æ™ºèƒ½ API è·¯ç”±ç³»çµ±**ã€ï¼Œè®“ LLM èƒ½å¤ ï¼š
1. åˆ†æç”¨æˆ¶å•é¡Œçš„æ„åœ–
2. è‡ªå‹•é¸æ“‡æ­£ç¢ºçš„ API é€²è¡Œç²¾æº–æŸ¥è©¢
3. è¿”å›ç²¾ç¢ºçš„è³‡æ–™çµæœ
4. ç”Ÿæˆæº–ç¢ºçš„å›ç­”

### 1.3 æ ¸å¿ƒæ¦‚å¿µ

```
ç”¨æˆ¶å•é¡Œ â†’ LLM åˆ†ææ„åœ– â†’ é¸æ“‡æ­£ç¢º API â†’ ç²¾æº–æŸ¥è©¢ â†’ æ ¼å¼åŒ–å›ç­”
```

### 1.4 èˆ‡ç¾æœ‰æ–¹æ¡ˆæ¯”è¼ƒ

| æ¯”è¼ƒé …ç›® | ç¾æœ‰åšæ³•ï¼ˆå¤–éƒ¨çŸ¥è­˜åº«ï¼‰ | æ–°æ–¹æ¡ˆï¼ˆæ™ºèƒ½è·¯ç”±ï¼‰ |
|---------|----------------------|------------------|
| **æŸ¥è©¢æ–¹å¼** | é—œéµå­—åŒ¹é…æ‰€æœ‰è³‡æ–™ | LLM åˆ¤æ–·å¾Œç²¾æº–èª¿ç”¨ API |
| **è³‡æ–™é‡** | è¿”å›å¤§é‡å¯èƒ½ç›¸é—œçš„è³‡æ–™ | åªè¿”å›ç²¾æº–åŒ¹é…çš„è³‡æ–™ |
| **API èª¿ç”¨** | å›ºå®šèª¿ç”¨ /projects å†éæ¿¾ | æ ¹æ“šæ„åœ–èª¿ç”¨ä¸åŒ API |
| **å›ç­”å“è³ª** | ä¾è³´ LLM å¾å¤§é‡è³‡æ–™ä¸­ç¯©é¸ | è³‡æ–™æœ¬èº«å°±æ˜¯ç²¾æº–çš„ |
| **æ•¸é‡æŸ¥è©¢** | ä¸ç²¾æº– | ç²¾æº– |

---

## 2. ç³»çµ±æ¶æ§‹è¨­è¨ˆ

### 2.1 æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç”¨æˆ¶å•é¡Œ                                       â”‚
â”‚                    ã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ§  LLM æ„åœ–åˆ†æå™¨ (Intent Analyzer)                   â”‚
â”‚                                                                          â”‚
â”‚  è¼¸å…¥ï¼šç”¨æˆ¶å•é¡Œ                                                          â”‚
â”‚  è¼¸å‡ºï¼šJSON çµæ§‹åŒ–æ„åœ–                                                   â”‚
â”‚                                                                          â”‚
â”‚  {                                                                       â”‚
â”‚    "intent": "query_projects_by_customer",                              â”‚
â”‚    "parameters": {                                                       â”‚
â”‚      "customer": "WD"                                                    â”‚
â”‚    },                                                                    â”‚
â”‚    "confidence": 0.95                                                    â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ”€ API è·¯ç”±å™¨ (Query Router)                          â”‚
â”‚                                                                          â”‚
â”‚  æ ¹æ“š intent é¸æ“‡å°æ‡‰çš„ API Handlerï¼š                                    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ CustomerHandler â”‚  â”‚ ControllerHandlerâ”‚  â”‚ ProjectHandler â”‚          â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚          â”‚
â”‚  â”‚ GET /projects   â”‚  â”‚ GET /projects   â”‚  â”‚ GET /projects/  â”‚          â”‚
â”‚  â”‚ ?customer=WD    â”‚  â”‚ ?controller=    â”‚  â”‚ {name}/summary  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚                    â”‚
            â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“¡ SAF API Server                                     â”‚
â”‚                    http://10.252.170.171:8080                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“Š ç²¾æº–è³‡æ–™çµæœ                                        â”‚
â”‚                                                                          â”‚
â”‚  [                                                                       â”‚
â”‚    { "projectName": "DEMETER", "customer": "WD", ... },                 â”‚
â”‚    { "projectName": "Demeter", "customer": "WD", ... },                 â”‚
â”‚    { "projectName": "Garuda", "customer": "WD", ... }                   â”‚
â”‚  ]                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“ å›æ‡‰æ ¼å¼åŒ–å™¨ (Response Formatter)                   â”‚
â”‚                                                                          â”‚
â”‚  å°‡ API çµæœæ ¼å¼åŒ–ç‚ºè‡ªç„¶èªè¨€å›ç­”æˆ– Dify çŸ¥è­˜åº«æ ¼å¼                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ¤– æœ€çµ‚å›ç­”                                            â”‚
â”‚                                                                          â”‚
â”‚  ã€ŒWD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆï¼š                                                â”‚
â”‚   1. DEMETER - æ§åˆ¶å™¨ SM2264XT, NAND: WDC BiCS5 TLC                     â”‚
â”‚   2. Demeter - æ§åˆ¶å™¨ SM2264XT, NAND: WDC BiCS5 TLC                     â”‚
â”‚   3. Garuda - æ§åˆ¶å™¨ SM2269XT, NAND: WDC BiCS6 TLCã€                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¨¡çµ„çµæ§‹è¨­è¨ˆ

```
library/saf_integration/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ endpoint_registry.py      # ç¾æœ‰ - SAF API ç«¯é»å®šç¾©
â”œâ”€â”€ api_client.py             # ç¾æœ‰ - SAF API å®¢æˆ¶ç«¯
â”œâ”€â”€ auth_manager.py           # ç¾æœ‰ - èªè­‰ç®¡ç†
â”œâ”€â”€ cache_manager.py          # ç¾æœ‰ - å¿«å–ç®¡ç†
â”œâ”€â”€ data_transformer.py       # ç¾æœ‰ - è³‡æ–™è½‰æ›
â”œâ”€â”€ search_service.py         # ç¾æœ‰ - æœå°‹æœå‹™
â”œâ”€â”€ handler.py                # ç¾æœ‰ - Dify å¤–éƒ¨çŸ¥è­˜åº«è™•ç†å™¨
â”‚
â”‚   # ğŸ†• æ–°å¢æ™ºèƒ½è·¯ç”±æ¨¡çµ„
â””â”€â”€ smart_query/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ intent_analyzer.py    # ğŸ†• LLM æ„åœ–åˆ†æå™¨
    â”œâ”€â”€ intent_types.py       # ğŸ†• æ„åœ–é¡å‹å®šç¾©
    â”œâ”€â”€ query_router.py       # ğŸ†• æŸ¥è©¢è·¯ç”±å™¨
    â”œâ”€â”€ query_handlers/       # ğŸ†• å„ç¨®æŸ¥è©¢è™•ç†å™¨
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ base_handler.py
    â”‚   â”œâ”€â”€ customer_handler.py
    â”‚   â”œâ”€â”€ controller_handler.py
    â”‚   â”œâ”€â”€ project_handler.py
    â”‚   â””â”€â”€ statistics_handler.py
    â””â”€â”€ response_formatter.py # ğŸ†• å›æ‡‰æ ¼å¼åŒ–å™¨

backend/api/views/
â”œâ”€â”€ dify_saf_views.py         # ç¾æœ‰ - å¤–éƒ¨çŸ¥è­˜åº« API
â””â”€â”€ dify_saf_smart_views.py   # ğŸ†• æ™ºèƒ½æŸ¥è©¢ API
```

---

## 3. æ„åœ–é¡å‹å®šç¾©

### 3.1 Phase 1ï¼šåŸºç¤æŸ¥è©¢æ„åœ–

| æ„åœ– ID | ç”¨æˆ¶å•é¡Œç¯„ä¾‹ | API èª¿ç”¨ | åƒæ•¸ |
|---------|-------------|----------|------|
| `query_projects_by_customer` | ã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€ã€Œåˆ—å‡º Samsung çš„å°ˆæ¡ˆã€ | `GET /projects?customer={customer}` | customer |
| `query_projects_by_controller` | ã€ŒSM2264 ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿã€ã€Œ2269 æ§åˆ¶å™¨çš„å°ˆæ¡ˆã€ | `GET /projects?controller={controller}` | controller |
| `query_projects_by_nand` | ã€Œç”¨ BiCS5 çš„å°ˆæ¡ˆæœ‰å“ªäº›ï¼Ÿã€ | `GET /projects?nand={nand}` | nand |
| `query_project_detail` | ã€ŒDEMETER å°ˆæ¡ˆçš„è©³ç´°è³‡è¨Šã€ | `GET /projects/{name}` | project_name |
| `query_project_summary` | ã€ŒDEMETER çš„æ¸¬è©¦çµæœå¦‚ä½•ï¼Ÿã€ | `GET /projects/{name}/summary` | project_name |
| `list_all_customers` | ã€Œæœ‰å“ªäº›å®¢æˆ¶ï¼Ÿã€ã€Œå®¢æˆ¶åˆ—è¡¨ã€ | `GET /projects` â†’ çµ±è¨ˆ | - |
| `list_all_controllers` | ã€Œæœ‰å“ªäº›æ§åˆ¶å™¨å‹è™Ÿï¼Ÿã€ | `GET /projects` â†’ çµ±è¨ˆ | - |
| `count_projects` | ã€Œç¸½å…±æœ‰å¤šå°‘å°ˆæ¡ˆï¼Ÿã€ã€ŒWD æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿã€ | `GET /projects?customer={customer}` â†’ count | customer (optional) |

### 3.2 Phase 2ï¼šé€²éšæŸ¥è©¢æ„åœ–

| æ„åœ– ID | ç”¨æˆ¶å•é¡Œç¯„ä¾‹ | èªªæ˜ |
|---------|-------------|------|
| `query_projects_multi_filter` | ã€ŒWD ç”¨ SM2264 çš„å°ˆæ¡ˆã€ | å¤šæ¢ä»¶éæ¿¾ |
| `compare_projects` | ã€Œæ¯”è¼ƒ DEMETER å’Œ Garudaã€ | å¤šæ¬¡èª¿ç”¨ + æ¯”è¼ƒ |
| `query_project_status` | ã€Œå“ªäº›å°ˆæ¡ˆé‚„åœ¨é€²è¡Œä¸­ï¼Ÿã€ | ç‹€æ…‹éæ¿¾ |
| `query_recent_projects` | ã€Œæœ€è¿‘å»ºç«‹çš„å°ˆæ¡ˆã€ | æ™‚é–“æ’åº |
| `query_projects_by_pl` | ã€Œryder.lin è² è²¬å“ªäº›å°ˆæ¡ˆï¼Ÿã€ | æŒ‰è² è²¬äººæŸ¥è©¢ |

### 3.3 æ„åœ–åˆ†æ Prompt è¨­è¨ˆ

```
ä½ æ˜¯ä¸€å€‹æ„åœ–åˆ†æå™¨ï¼Œè² è²¬åˆ†æç”¨æˆ¶é—œæ–¼ SAF å°ˆæ¡ˆç®¡ç†ç³»çµ±çš„å•é¡Œã€‚

è«‹åˆ†æç”¨æˆ¶çš„å•é¡Œï¼Œä¸¦è¿”å› JSON æ ¼å¼çš„æ„åœ–çµæ§‹ã€‚

å¯ç”¨çš„æ„åœ–é¡å‹ï¼š
1. query_projects_by_customer - æŒ‰å®¢æˆ¶æŸ¥è©¢å°ˆæ¡ˆ
2. query_projects_by_controller - æŒ‰æ§åˆ¶å™¨æŸ¥è©¢å°ˆæ¡ˆ
3. query_projects_by_nand - æŒ‰ NAND é¡å‹æŸ¥è©¢å°ˆæ¡ˆ
4. query_project_detail - æŸ¥è©¢å°ˆæ¡ˆè©³ç´°è³‡è¨Š
5. query_project_summary - æŸ¥è©¢å°ˆæ¡ˆæ¸¬è©¦çµæœæ‘˜è¦
6. list_all_customers - åˆ—å‡ºæ‰€æœ‰å®¢æˆ¶
7. list_all_controllers - åˆ—å‡ºæ‰€æœ‰æ§åˆ¶å™¨
8. count_projects - çµ±è¨ˆå°ˆæ¡ˆæ•¸é‡
9. unknown - ç„¡æ³•è­˜åˆ¥çš„æ„åœ–

å·²çŸ¥çš„å®¢æˆ¶ï¼šWD, WDC, Samsung, Micron, Transcend, ADATA, UMIS, Biwin, ...
å·²çŸ¥çš„æ§åˆ¶å™¨ï¼šSM2263, SM2264, SM2267, SM2269, ...

ç”¨æˆ¶å•é¡Œï¼š{query}

è«‹è¿”å› JSONï¼š
{
  "intent": "æ„åœ–ID",
  "parameters": {
    // æå–çš„åƒæ•¸
  },
  "confidence": 0.0-1.0
}
```

---

## 4. æŠ€è¡“å¯¦ä½œæ–¹æ¡ˆï¼šDjango æ™ºèƒ½è·¯ç”± API

### 4.1 æ–¹æ¡ˆæ¦‚è¿°

**æ¶æ§‹**ï¼š
```python
# POST /api/dify/saf/smart-query/
{
    "query": "WD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ",
    "conversation_id": "xxx"
}

# å›æ‡‰
{
    "answer": "WD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆï¼š...",
    "intent": "query_projects_by_customer",
    "parameters": {"customer": "WD"},
    "data": [...],
    "source": "saf_api"
}
```

**å„ªé»**ï¼š
- âœ… å®Œå…¨æ§åˆ¶é‚è¼¯
- âœ… å¯ä»¥è™•ç†è¤‡é›œæŸ¥è©¢
- âœ… å¯æ•´åˆå¿«å–
- âœ… æ˜“æ–¼æ¸¬è©¦å’Œé™¤éŒ¯
- âœ… ç‰ˆæœ¬æ§åˆ¶å‹å¥½
- âœ… èˆ‡ç¾æœ‰æ¶æ§‹æ•´åˆ

**é¸æ“‡åŸå› **ï¼š
1. ç²¾æº–åº¦æœ€é«˜ - å®Œå…¨æ§åˆ¶ API èª¿ç”¨é‚è¼¯
2. å¯æ•´åˆç¾æœ‰æ¶æ§‹ - èˆ‡ç¾æœ‰ SAF æ•´åˆæ¨¡çµ„ç„¡ç¸«éŠœæ¥
3. æ˜“æ–¼æ“´å±• - æ–°å¢æ„åœ–åªéœ€æ·»åŠ  Handler
4. å¯æ¸¬è©¦ - æ¯å€‹çµ„ä»¶éƒ½å¯ä»¥å–®ç¨æ¸¬è©¦
5. æˆæœ¬å¯æ§ - LLM åªç”¨æ–¼æ„åœ–åˆ†æ

---

## 5. æ ¸å¿ƒçµ„ä»¶è¨­è¨ˆ

### 5.1 æ„åœ–åˆ†æå™¨ (IntentAnalyzer)

```python
# library/saf_integration/smart_query/intent_analyzer.py

class IntentAnalyzer:
    """LLM æ„åœ–åˆ†æå™¨"""
    
    def __init__(self, llm_client):
        self.llm_client = llm_client
        self.prompt_template = INTENT_ANALYSIS_PROMPT
    
    async def analyze(self, query: str) -> IntentResult:
        """
        åˆ†æç”¨æˆ¶å•é¡Œçš„æ„åœ–
        
        Args:
            query: ç”¨æˆ¶å•é¡Œ
            
        Returns:
            IntentResult: åŒ…å« intent, parameters, confidence
        """
        pass
```

### 5.2 æŸ¥è©¢è·¯ç”±å™¨ (QueryRouter)

```python
# library/saf_integration/smart_query/query_router.py

class QueryRouter:
    """æŸ¥è©¢è·¯ç”±å™¨"""
    
    def __init__(self):
        self.handlers = {
            'query_projects_by_customer': CustomerHandler(),
            'query_projects_by_controller': ControllerHandler(),
            'query_project_detail': ProjectHandler(),
            'count_projects': StatisticsHandler(),
            # ...
        }
    
    def route(self, intent_result: IntentResult) -> BaseHandler:
        """æ ¹æ“šæ„åœ–é¸æ“‡å°æ‡‰çš„ Handler"""
        return self.handlers.get(intent_result.intent)
```

### 5.3 æŸ¥è©¢è™•ç†å™¨ (Handler)

```python
# library/saf_integration/smart_query/query_handlers/customer_handler.py

class CustomerHandler(BaseHandler):
    """å®¢æˆ¶æŸ¥è©¢è™•ç†å™¨"""
    
    async def execute(self, parameters: dict) -> QueryResult:
        """
        åŸ·è¡Œå®¢æˆ¶æŸ¥è©¢
        
        Args:
            parameters: {"customer": "WD"}
            
        Returns:
            QueryResult: åŒ…å«ç²¾æº–çš„å°ˆæ¡ˆè³‡æ–™
        """
        customer = parameters.get('customer')
        projects = await self.api_client.get_projects_by_customer(customer)
        return QueryResult(
            data=projects,
            count=len(projects),
            query_type='customer',
            parameters=parameters
        )
```

### 5.4 API è¨­è¨ˆ

#### æ™ºèƒ½æŸ¥è©¢ API

```
POST /api/dify/saf/smart-query/
```

**Request**:
```json
{
    "query": "WD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ",
    "conversation_id": "optional-conversation-id",
    "options": {
        "include_details": true,
        "format": "natural_language"
    }
}
```

**Response**:
```json
{
    "success": true,
    "answer": "WD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆï¼š\n1. DEMETER - æ§åˆ¶å™¨ SM2264XT\n2. Demeter - æ§åˆ¶å™¨ SM2264XT\n3. Garuda - æ§åˆ¶å™¨ SM2269XT",
    "intent": {
        "type": "query_projects_by_customer",
        "parameters": {
            "customer": "WD"
        },
        "confidence": 0.95
    },
    "data": {
        "projects": [
            {
                "projectName": "DEMETER",
                "customer": "WD",
                "controller": "SM2264XT",
                "nand": "WDC BiCS5 TLC"
            }
        ],
        "count": 3
    },
    "metadata": {
        "query_time_ms": 150,
        "source": "saf_api",
        "cached": false
    }
}
```

---

## 6. å¯¦ä½œéšæ®µè¦åŠƒï¼ˆè©³ç´°ç‰ˆï¼‰

### 6.0 é–‹ç™¼ç¯„åœç¢ºèª

#### 6.0.1 æ„åœ–é¡å‹ï¼ˆ8 ç¨®ï¼Œå…¨éƒ¨å¯¦ä½œï¼‰

| # | æ„åœ– ID | èªªæ˜ | åƒæ•¸ |
|---|---------|------|------|
| 1 | `query_projects_by_customer` | æŒ‰å®¢æˆ¶æŸ¥è©¢å°ˆæ¡ˆ | customer |
| 2 | `query_projects_by_controller` | æŒ‰æ§åˆ¶å™¨æŸ¥è©¢å°ˆæ¡ˆ | controller |
| 3 | `query_project_detail` | æŸ¥è©¢å°ˆæ¡ˆè©³ç´°è³‡è¨Š | project_name |
| 4 | `query_project_summary` | æŸ¥è©¢å°ˆæ¡ˆæ¸¬è©¦æ‘˜è¦ | project_name |
| 5 | `count_projects` | çµ±è¨ˆå°ˆæ¡ˆæ•¸é‡ | customer (å¯é¸) |
| 6 | `list_all_customers` | åˆ—å‡ºæ‰€æœ‰å®¢æˆ¶ | ç„¡ |
| 7 | `list_all_controllers` | åˆ—å‡ºæ‰€æœ‰æ§åˆ¶å™¨ | ç„¡ |
| 8 | `unknown` | ç„¡æ³•è­˜åˆ¥çš„æ„åœ– | ç„¡ |

#### 6.0.2 å›ç­”æ ¼å¼

**ç¢ºå®šæ ¼å¼**ï¼šè‡ªç„¶èªè¨€ + Table

```
ç¯„ä¾‹å›ç­”ï¼š

WD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆï¼š

| å°ˆæ¡ˆåç¨± | æ§åˆ¶å™¨ | NAND é¡å‹ | ç‹€æ…‹ |
|---------|--------|----------|------|
| DEMETER | SM2264XT | WDC BiCS5 TLC | Active |
| Demeter | SM2264XT | WDC BiCS5 TLC | Active |
| Garuda | SM2269XT | WDC BiCS6 TLC | Active |
```

#### 6.0.3 é–‹ç™¼å‰ç½®éœ€æ±‚

| é …ç›® | ç‹€æ…‹ | å‚™è¨» |
|------|------|------|
| æ¸¬è©¦ç”¨ SAF API Server | â¬œ å¾…ç¢ºèª | éœ€è¦ç¨ç«‹æ¸¬è©¦ç’°å¢ƒ |
| `SAF_Intent_Analyzer` Dify App | âœ… å·²å»ºç«‹ | `app-vMNSUqgEIoejnXo3fuFvp1hC` |
| `SAF_Analyzer` Dify App | âœ… å·²å»ºç«‹ | `app-0GyoZLrr4tDpT4EO2Kihuvux` |

---

### 6.1 Phase 0ï¼šç’°å¢ƒæº–å‚™èˆ‡é…ç½®ï¼ˆ0.5 å¤©ï¼‰

| æ­¥é©Ÿ | ä»»å‹™ | ç”¢å‡ºæª”æ¡ˆ |
|------|------|---------|
| 0.1 | æ·»åŠ  `SAF_Intent_Analyzer` é…ç½® | `dify_config_manager.py` |
| 0.2 | æ·»åŠ  `SAF_Analyzer` é…ç½® | `dify_config_manager.py` |
| 0.3 | å»ºç«‹ `smart_query/` æ¨¡çµ„ç›®éŒ„çµæ§‹ | ç›®éŒ„çµæ§‹ |
| 0.4 | å®šç¾©æ„åœ–é¡å‹ Enumï¼ˆ8 ç¨®ï¼‰ | `intent_types.py` |
| 0.5 | ç¢ºèªæ¸¬è©¦ç”¨ SAF API Server ç’°å¢ƒ | ç’°å¢ƒæ–‡æª” |

**Phase 0 é©—æ”¶æ¨™æº–**ï¼š
- [ ] `get_saf_intent_analyzer_config()` å¯æ­£å¸¸èª¿ç”¨
- [ ] `get_saf_analyzer_config()` å¯æ­£å¸¸èª¿ç”¨
- [ ] æ¸¬è©¦ç”¨ SAF API Server å¯è¨ªå•

---

### 6.2 Phase 1ï¼šæ„åœ–åˆ†æå™¨é–‹ç™¼ï¼ˆ1.5-2 å¤©ï¼‰

| æ­¥é©Ÿ | ä»»å‹™ | ç”¢å‡ºæª”æ¡ˆ |
|------|------|---------|
| 1.1 | å¯¦ä½œ `IntentResult` dataclass | `intent_analyzer.py` |
| 1.2 | è¨­è¨ˆå®Œæ•´çš„ `INTENT_ANALYSIS_PROMPT`ï¼ˆæ”¯æ´ 8 ç¨®æ„åœ–ï¼‰ | `intent_analyzer.py` |
| 1.3 | å¯¦ä½œ `SAFIntentAnalyzer.analyze()` | `intent_analyzer.py` |
| 1.4 | å¯¦ä½œ JSON è§£æé‚è¼¯ | `intent_analyzer.py` |
| 1.5 | å¯¦ä½œé™ç´šé‚è¼¯ï¼ˆé—œéµå­—åŒ¹é…ï¼‰ | `intent_analyzer.py` |
| 1.6 | æ’°å¯«å–®å…ƒæ¸¬è©¦ï¼ˆ8 ç¨®æ„åœ– Ã— å¤šå€‹æ¸¬è©¦æ¡ˆä¾‹ï¼‰ | `tests/test_intent_analyzer.py` |

**æ¸¬è©¦æ¡ˆä¾‹æ¸…å–®**ï¼ˆæ¯ç¨®æ„åœ–è‡³å°‘ 3 å€‹æ¸¬è©¦ï¼‰ï¼š

| æ„åœ– | æ¸¬è©¦æ¡ˆä¾‹ |
|------|---------|
| `query_projects_by_customer` | ã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€ã€Œåˆ—å‡º Samsung çš„å°ˆæ¡ˆã€ã€ŒADATA çš„å°ˆæ¡ˆã€ |
| `query_projects_by_controller` | ã€ŒSM2264 ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿã€ã€Œå“ªäº›å°ˆæ¡ˆç”¨ 2269 æ§åˆ¶å™¨ã€ã€ŒSM2264XT æ§åˆ¶å™¨ã€ |
| `query_project_detail` | ã€ŒDEMETER å°ˆæ¡ˆçš„è©³ç´°è³‡è¨Šã€ã€Œå‘Šè¨´æˆ‘ Garuda å°ˆæ¡ˆã€ã€ŒHelios å°ˆæ¡ˆè³‡è¨Šã€ |
| `query_project_summary` | ã€ŒDEMETER çš„æ¸¬è©¦çµæœã€ã€ŒGaruda æ¸¬è©¦ç‹€æ³ã€ã€ŒHelios æ¸¬è©¦çµæœå¦‚ä½•ã€ |
| `count_projects` | ã€Œæœ‰å¤šå°‘å°ˆæ¡ˆï¼Ÿã€ã€ŒWD æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿã€ã€ŒSamsung å°ˆæ¡ˆæ•¸é‡ã€ |
| `list_all_customers` | ã€Œæœ‰å“ªäº›å®¢æˆ¶ï¼Ÿã€ã€Œå®¢æˆ¶åˆ—è¡¨ã€ã€Œåˆ—å‡ºæ‰€æœ‰å®¢æˆ¶ã€ |
| `list_all_controllers` | ã€Œæœ‰å“ªäº›æ§åˆ¶å™¨ï¼Ÿã€ã€Œæ§åˆ¶å™¨åˆ—è¡¨ã€ã€Œæ”¯æ´çš„æ§åˆ¶å™¨å‹è™Ÿã€ |
| `unknown` | ã€Œä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿã€ã€Œä½ å¥½ã€ã€Œå¹«æˆ‘è¨‚ä¾¿ç•¶ã€ |

**Phase 1 é©—æ”¶æ¨™æº–**ï¼š
- [ ] 8 ç¨®æ„åœ–éƒ½èƒ½æ­£ç¢ºè­˜åˆ¥
- [ ] åƒæ•¸æå–æ­£ç¢ºï¼ˆcustomer, controller, project_nameï¼‰
- [ ] é™ç´šé‚è¼¯æ­£å¸¸é‹ä½œï¼ˆDify API å¤±æ•—æ™‚ï¼‰

---

### 6.3 Phase 2ï¼šæŸ¥è©¢è·¯ç”±å™¨èˆ‡ Handlersï¼ˆ2.5-3 å¤©ï¼‰

| æ­¥é©Ÿ | ä»»å‹™ | ç”¢å‡ºæª”æ¡ˆ |
|------|------|---------|
| 2.1 | å¯¦ä½œ `BaseHandler` æŠ½è±¡é¡ | `query_handlers/base_handler.py` |
| 2.2 | å¯¦ä½œ `CustomerHandler` | `query_handlers/customer_handler.py` |
| 2.3 | å¯¦ä½œ `ControllerHandler` | `query_handlers/controller_handler.py` |
| 2.4 | å¯¦ä½œ `ProjectDetailHandler` | `query_handlers/project_detail_handler.py` |
| 2.5 | å¯¦ä½œ `ProjectSummaryHandler` | `query_handlers/project_summary_handler.py` |
| 2.6 | å¯¦ä½œ `StatisticsHandler`ï¼ˆcount + listï¼‰ | `query_handlers/statistics_handler.py` |
| 2.7 | å¯¦ä½œ `QueryRouter` è·¯ç”±å™¨ | `query_router.py` |
| 2.8 | æ’°å¯«æ•´åˆæ¸¬è©¦ | `tests/test_query_router.py` |

**Handler èˆ‡ SAF API å°æ‡‰è¡¨**ï¼š

| æ„åœ– | Handler | SAF API èª¿ç”¨ |
|------|---------|-------------|
| `query_projects_by_customer` | `CustomerHandler` | `GET /projects?customer={customer}` |
| `query_projects_by_controller` | `ControllerHandler` | `GET /projects?controller={controller}` |
| `query_project_detail` | `ProjectDetailHandler` | `GET /projects/{name}` |
| `query_project_summary` | `ProjectSummaryHandler` | `GET /projects/{name}/summary` |
| `count_projects` | `StatisticsHandler` | `GET /projects` â†’ çµ±è¨ˆæ•¸é‡ |
| `list_all_customers` | `StatisticsHandler` | `GET /projects` â†’ æå–å®¢æˆ¶åˆ—è¡¨ |
| `list_all_controllers` | `StatisticsHandler` | `GET /projects` â†’ æå–æ§åˆ¶å™¨åˆ—è¡¨ |
| `unknown` | ï¼ˆç„¡ Handlerï¼‰ | ç›´æ¥è¿”å›æç¤ºè¨Šæ¯ |

**Phase 2 é©—æ”¶æ¨™æº–**ï¼š
- [ ] æ¯å€‹ Handler èƒ½æ­£ç¢ºèª¿ç”¨ SAF API
- [ ] QueryRouter èƒ½æ ¹æ“šæ„åœ–é¸æ“‡æ­£ç¢ºçš„ Handler
- [ ] ä½¿ç”¨æ¸¬è©¦ç”¨ SAF API Server æ¸¬è©¦é€šé

---

### 6.4 Phase 3ï¼šAPI ç«¯é»æ•´åˆï¼ˆ1 å¤©ï¼‰

| æ­¥é©Ÿ | ä»»å‹™ | ç”¢å‡ºæª”æ¡ˆ |
|------|------|---------|
| 3.1 | å»ºç«‹ `SmartQueryView` | `backend/api/views/dify_saf_smart_views.py` |
| 3.2 | å®šç¾© Request/Response æ ¼å¼ | åºåˆ—åŒ–å™¨ï¼ˆå¯é¸ï¼‰ |
| 3.3 | é…ç½® URL è·¯ç”± | `backend/api/urls.py` |
| 3.4 | API æ¸¬è©¦ï¼ˆcurl / Postmanï¼‰ | æ¸¬è©¦å ±å‘Š |

**API è¦æ ¼**ï¼š

```
POST /api/dify/saf/smart-query/

Request:
{
    "query": "WD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ",
    "user_id": "optional-user-id"
}

Response:
{
    "success": true,
    "answer": "WD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆï¼š\n\n| å°ˆæ¡ˆåç¨± | æ§åˆ¶å™¨ | NAND é¡å‹ |\n|...",
    "table": [
        {"projectName": "DEMETER", "controller": "SM2264XT", "nand": "WDC BiCS5 TLC"},
        {"projectName": "Garuda", "controller": "SM2269XT", "nand": "WDC BiCS6 TLC"}
    ],
    "intent": {
        "type": "query_projects_by_customer",
        "parameters": {"customer": "WD"},
        "confidence": 0.95
    },
    "metadata": {
        "query_time_ms": 150,
        "source": "saf_api"
    }
}
```

**Phase 3 é©—æ”¶æ¨™æº–**ï¼š
- [ ] API ç«¯é» `/api/dify/saf/smart-query/` å¯æ­£å¸¸è¨ªå•
- [ ] è¿”å›æ ¼å¼åŒ…å« `answer`ï¼ˆè‡ªç„¶èªè¨€ + Tableï¼‰å’Œ `table`ï¼ˆçµæ§‹åŒ–è³‡æ–™ï¼‰
- [ ] éŒ¯èª¤è™•ç†æ­£å¸¸ï¼ˆ400, 500 ç‹€æ…‹ç¢¼ï¼‰

---

### 6.5 Phase 4ï¼šå›ç­”ç”Ÿæˆå™¨ - SAF_Analyzerï¼ˆ1.5 å¤©ï¼‰

| æ­¥é©Ÿ | ä»»å‹™ | ç”¢å‡ºæª”æ¡ˆ |
|------|------|---------|
| 4.1 | è¨­è¨ˆå›ç­”ç”Ÿæˆ Prompt | `response_generator.py` |
| 4.2 | å¯¦ä½œ `SAFResponseGenerator` é¡ | `response_generator.py` |
| 4.3 | å¯¦ä½œä¸åŒæ„åœ–çš„å›ç­”æ¨¡æ¿ | `response_generator.py` |
| 4.4 | å¯¦ä½œ Table æ ¼å¼åŒ–é‚è¼¯ï¼ˆMarkdown Tableï¼‰ | `response_generator.py` |
| 4.5 | æ•´åˆåˆ° `SmartQueryView` | `dify_saf_smart_views.py` |
| 4.6 | æ¸¬è©¦å›ç­”å“è³ª | æ¸¬è©¦å ±å‘Š |

**å›ç­”æ ¼å¼è¨­è¨ˆç¯„ä¾‹**ï¼š

**ç¯„ä¾‹ 1ï¼šæŒ‰å®¢æˆ¶æŸ¥è©¢å°ˆæ¡ˆ**
```
WD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆï¼š

| å°ˆæ¡ˆåç¨± | æ§åˆ¶å™¨ | NAND é¡å‹ | ç‹€æ…‹ |
|---------|--------|----------|------|
| DEMETER | SM2264XT | WDC BiCS5 TLC | Active |
| Demeter | SM2264XT | WDC BiCS5 TLC | Active |
| Garuda | SM2269XT | WDC BiCS6 TLC | Active |
```

**ç¯„ä¾‹ 2ï¼šçµ±è¨ˆæ•¸é‡**
```
WD ç›®å‰æ“æœ‰ 3 å€‹å°ˆæ¡ˆã€‚

å¦‚éœ€æŸ¥çœ‹è©³ç´°åˆ—è¡¨ï¼Œå¯ä»¥è©¢å•ã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€
```

**ç¯„ä¾‹ 3ï¼šå°ˆæ¡ˆè©³æƒ…**
```
DEMETER å°ˆæ¡ˆè©³ç´°è³‡è¨Šï¼š

| é …ç›® | å…§å®¹ |
|------|------|
| å®¢æˆ¶ | WD |
| æ§åˆ¶å™¨ | SM2264XT |
| NAND | WDC BiCS5 TLC |
| è² è²¬äºº | ryder.lin |
| å»ºç«‹æ—¥æœŸ | 2024-01-15 |
| ç‹€æ…‹ | Active |
```

**ç¯„ä¾‹ 4ï¼šç„¡æ³•è­˜åˆ¥çš„æ„åœ–**
```
æŠ±æ­‰ï¼Œæˆ‘ç„¡æ³•ç†è§£æ‚¨çš„å•é¡Œã€‚

æˆ‘å¯ä»¥å¹«æ‚¨æŸ¥è©¢ä»¥ä¸‹è³‡è¨Šï¼š
- æŸå®¢æˆ¶çš„å°ˆæ¡ˆåˆ—è¡¨ï¼ˆå¦‚ï¼šã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€ï¼‰
- æŸæ§åˆ¶å™¨çš„å°ˆæ¡ˆï¼ˆå¦‚ï¼šã€ŒSM2264 ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿã€ï¼‰
- å°ˆæ¡ˆè©³ç´°è³‡è¨Šï¼ˆå¦‚ï¼šã€ŒDEMETER å°ˆæ¡ˆçš„è©³ç´°è³‡è¨Šã€ï¼‰
- å°ˆæ¡ˆæ¸¬è©¦çµæœï¼ˆå¦‚ï¼šã€ŒDEMETER çš„æ¸¬è©¦çµæœã€ï¼‰
- å°ˆæ¡ˆæ•¸é‡çµ±è¨ˆï¼ˆå¦‚ï¼šã€ŒWD æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿã€ï¼‰
- å®¢æˆ¶åˆ—è¡¨ï¼ˆå¦‚ï¼šã€Œæœ‰å“ªäº›å®¢æˆ¶ï¼Ÿã€ï¼‰
- æ§åˆ¶å™¨åˆ—è¡¨ï¼ˆå¦‚ï¼šã€Œæœ‰å“ªäº›æ§åˆ¶å™¨ï¼Ÿã€ï¼‰
```

**Phase 4 é©—æ”¶æ¨™æº–**ï¼š
- [ ] å›ç­”åŒ…å«è‡ªç„¶èªè¨€æè¿° + Markdown Table
- [ ] ä¸åŒæ„åœ–æœ‰å°æ‡‰çš„å›ç­”æ¨¡æ¿
- [ ] ç©ºçµæœæ™‚æœ‰å‹å–„æç¤ºï¼ˆã€Œæ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å°ˆæ¡ˆã€ï¼‰
- [ ] `unknown` æ„åœ–æœ‰å¼•å°æç¤º

---

### 6.6 Phase 5ï¼šæ¸¬è©¦èˆ‡å„ªåŒ–ï¼ˆ1.5-2 å¤©ï¼‰

| æ­¥é©Ÿ | ä»»å‹™ | ç”¢å‡º |
|------|------|------|
| 5.1 | E2E æ¸¬è©¦ï¼ˆå®Œæ•´æŸ¥è©¢æµç¨‹ï¼‰ | æ¸¬è©¦å ±å‘Š |
| 5.2 | Prompt å„ªåŒ–ï¼ˆæé«˜æ„åœ–è­˜åˆ¥æº–ç¢ºåº¦ï¼‰ | å„ªåŒ–å¾Œçš„ Prompt |
| 5.3 | éŒ¯èª¤è™•ç†å„ªåŒ– | éŒ¯èª¤è™•ç†é‚è¼¯ |
| 5.4 | åœ¨ Dify ä¸­å»ºç«‹æ¸¬è©¦ App | Dify App é…ç½® |
| 5.5 | æ•ˆèƒ½æ¸¬è©¦ï¼ˆå›æ‡‰æ™‚é–“ï¼‰ | æ•ˆèƒ½å ±å‘Š |
| 5.6 | æ›´æ–°æ–‡æª” | æ–‡æª”æ›´æ–° |

**E2E æ¸¬è©¦æ¡ˆä¾‹æ¸…å–®**ï¼š

| # | å•é¡Œ | é æœŸæ„åœ– | é æœŸå›ç­”å…§å®¹ |
|---|------|---------|-------------|
| 1 | ã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€ | `query_projects_by_customer` | åˆ—å‡º WD å°ˆæ¡ˆ + Table |
| 2 | ã€ŒSamsung æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿã€ | `count_projects` | æ•¸é‡ + æç¤ºæŸ¥çœ‹è©³æƒ… |
| 3 | ã€ŒSM2264 æ§åˆ¶å™¨ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿã€ | `query_projects_by_controller` | åˆ—å‡ºå°ˆæ¡ˆ + Table |
| 4 | ã€Œæœ‰å“ªäº›å®¢æˆ¶ï¼Ÿã€ | `list_all_customers` | å®¢æˆ¶åˆ—è¡¨ |
| 5 | ã€ŒDEMETER å°ˆæ¡ˆçš„è©³ç´°è³‡è¨Šã€ | `query_project_detail` | å°ˆæ¡ˆè©³æƒ… Table |
| 6 | ã€ŒDEMETER çš„æ¸¬è©¦çµæœã€ | `query_project_summary` | æ¸¬è©¦æ‘˜è¦ |
| 7 | ã€Œæœ‰å“ªäº›æ§åˆ¶å™¨ï¼Ÿã€ | `list_all_controllers` | æ§åˆ¶å™¨åˆ—è¡¨ |
| 8 | ã€Œä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿã€ | `unknown` | å‹å–„å¼•å°æç¤º |

**Phase 5 é©—æ”¶æ¨™æº–**ï¼š
- [ ] 8 å€‹ E2E æ¸¬è©¦æ¡ˆä¾‹å…¨éƒ¨é€šé
- [ ] å¹³å‡å›æ‡‰æ™‚é–“ < 3 ç§’
- [ ] åœ¨ Dify App ä¸­æ¸¬è©¦æˆåŠŸ
- [ ] æ–‡æª”å®Œæ•´æ›´æ–°

---

### 6.7 é–‹ç™¼æ™‚ç¨‹ç¸½è¦½

| Phase | ä»»å‹™ | é ä¼°æ™‚é–“ | ç´¯è¨ˆæ™‚é–“ |
|-------|------|----------|----------|
| Phase 0 | ç’°å¢ƒæº–å‚™èˆ‡é…ç½® | 0.5 å¤© | 0.5 å¤© |
| Phase 1 | æ„åœ–åˆ†æå™¨ï¼ˆ8 ç¨®æ„åœ–ï¼‰ | 1.5-2 å¤© | 2-2.5 å¤© |
| Phase 2 | æŸ¥è©¢è·¯ç”±å™¨èˆ‡ Handlers | 2.5-3 å¤© | 4.5-5.5 å¤© |
| Phase 3 | API ç«¯é»æ•´åˆ | 1 å¤© | 5.5-6.5 å¤© |
| Phase 4 | å›ç­”ç”Ÿæˆå™¨ï¼ˆè‡ªç„¶èªè¨€ + Tableï¼‰ | 1.5 å¤© | 7-8 å¤© |
| Phase 5 | æ¸¬è©¦èˆ‡å„ªåŒ– | 1.5-2 å¤© | 8.5-10 å¤© |

**ç¸½è¨ˆï¼šç´„ 8.5-10 å¤©**

---

### 6.8 æœ€çµ‚æª”æ¡ˆçµæ§‹

```
library/saf_integration/smart_query/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ config.py                        # SAF æ™ºèƒ½æŸ¥è©¢é…ç½®
â”œâ”€â”€ intent_types.py                  # IntentType Enumï¼ˆ8 ç¨®ï¼‰
â”œâ”€â”€ intent_analyzer.py               # SAFIntentAnalyzer
â”œâ”€â”€ query_router.py                  # QueryRouter
â”œâ”€â”€ response_generator.py            # SAFResponseGeneratorï¼ˆè‡ªç„¶èªè¨€ + Tableï¼‰
â””â”€â”€ query_handlers/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ base_handler.py              # BaseHandler æŠ½è±¡é¡
    â”œâ”€â”€ customer_handler.py          # æŒ‰å®¢æˆ¶æŸ¥è©¢
    â”œâ”€â”€ controller_handler.py        # æŒ‰æ§åˆ¶å™¨æŸ¥è©¢
    â”œâ”€â”€ project_detail_handler.py    # å°ˆæ¡ˆè©³æƒ…
    â”œâ”€â”€ project_summary_handler.py   # å°ˆæ¡ˆæ¸¬è©¦æ‘˜è¦
    â””â”€â”€ statistics_handler.py        # çµ±è¨ˆï¼ˆcount + list_customers + list_controllersï¼‰

backend/api/views/
â””â”€â”€ dify_saf_smart_views.py          # SmartQueryView

library/config/
â””â”€â”€ dify_config_manager.py           # æ·»åŠ  SAF App é…ç½®

tests/test_saf_smart_query/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ test_intent_analyzer.py          # 8 ç¨®æ„åœ–æ¸¬è©¦
â”œâ”€â”€ test_query_router.py
â”œâ”€â”€ test_response_generator.py
â””â”€â”€ test_handlers/
    â”œâ”€â”€ test_customer_handler.py
    â”œâ”€â”€ test_controller_handler.py
    â”œâ”€â”€ test_project_handlers.py
    â””â”€â”€ test_statistics_handler.py
```

---

## 7. æ¥­ç•Œåƒè€ƒæ¡ˆä¾‹

### 7.1 é€™ç¨®æ¶æ§‹çš„æ­£å¼åç¨±

| åç¨± | èªªæ˜ |
|------|------|
| **Function Calling / Tool Use** | OpenAIã€Claudeã€Gemini éƒ½æ”¯æ´ |
| **AI Agent with Tools** | LangChainã€AutoGPT çš„æ ¸å¿ƒæ¦‚å¿µ |
| **Intent-based Routing** | å‚³çµ± NLP + ç¾ä»£ LLM çµåˆ |
| **Semantic Router** | æ ¹æ“šèªç¾©è‡ªå‹•è·¯ç”±åˆ°å°æ‡‰åŠŸèƒ½ |

### 7.2 çŸ¥åç”¢å“ä½¿ç”¨æ¡ˆä¾‹

| ç”¢å“ | ä½¿ç”¨æ–¹å¼ |
|------|---------|
| **ChatGPT Plugins / GPTs** | GPT åˆ†ææ„åœ– â†’ é¸æ“‡ Plugin â†’ èª¿ç”¨ API |
| **Microsoft Copilot** | LLM åˆ¤æ–· â†’ é¸æ“‡ Microsoft 365 API â†’ åŸ·è¡Œ |
| **Google Gemini Extensions** | Gemini åˆ†æ â†’ é¸æ“‡ Extension â†’ èª¿ç”¨æœå‹™ |
| **Salesforce Einstein GPT** | æ„åœ–åˆ†æ â†’ CRM æ“ä½œ â†’ ç²¾æº–æŸ¥è©¢ |

### 7.3 é–‹æºæ¡†æ¶

| æ¡†æ¶ | èªªæ˜ |
|------|------|
| **LangChain Agents** | Python æ¡†æ¶ï¼Œæ”¯æ´ Tools + Router |
| **LlamaIndex** | æ”¯æ´ Query Router |
| **Semantic Kernel** | Microsoft çš„ AI æ¡†æ¶ |
| **Haystack** | deepset çš„ AI æ¡†æ¶ |

---

## 8. Dify é›™ App æ•´åˆè¨­è¨ˆï¼ˆå·²ç¢ºå®šæ–¹æ¡ˆï¼‰

### 8.1 æ•´åˆæ¶æ§‹ç¸½è¦½

æœ¬ç³»çµ±ä½¿ç”¨ **Dify Chat API** æ­é… **é›™ App å”ä½œ** æ¶æ§‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å·²ç¢ºå®šçš„æŠ€è¡“é¸æ“‡                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  LLM å¹³å°ï¼šDify Server (10.10.172.37)                                   â”‚
â”‚  æ¨¡å‹ï¼šgpt-oss:20b (CHAT)                                               â”‚
â”‚  API æ–¹å¼ï¼šDify Chat API                                                â”‚
â”‚                                                                          â”‚
â”‚  é›™ App æ¶æ§‹ï¼š                                                           â”‚
â”‚  â”œâ”€â”€ App 1: SAF_Intent_Analyzerï¼ˆæ„åœ–åˆ†æï¼‰                             â”‚
â”‚  â””â”€â”€ App 2: SAF_Analyzerï¼ˆå›ç­”ç”Ÿæˆï¼‰                                    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Dify App é…ç½®ï¼ˆâœ… å·²å®Œæˆï¼‰

| App åç¨± | API Key | ç”¨é€” | System Prompt |
|----------|---------|------|---------------|
| `SAF_Intent_Analyzer` | `app-vMNSUqgEIoejnXo3fuFvp1hC` | æ„åœ–åˆ†æ | æ¥µç°¡ï¼ˆç¨‹å¼ç¢¼æ§åˆ¶ï¼‰ |
| `SAF_Analyzer` | `app-0GyoZLrr4tDpT4EO2Kihuvux` | å›ç­”ç”Ÿæˆ | åœ¨ Dify ä¸­è¨­å®š |

---

### 8.3 SAF_Intent_Analyzer è©³ç´°è¨­è¨ˆ

#### 8.3.1 æ¶æ§‹æ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Django Smart Query API                                â”‚
â”‚                    POST /api/dify/saf/smart-query/                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ§  IntentAnalyzer                                     â”‚
â”‚                                                                          â”‚
â”‚  ä½¿ç”¨ç¾æœ‰çš„ DifyRequestManager èª¿ç”¨ Dify Chat API                        â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Dify App: ã€ŒSAF æ„åœ–åˆ†æå™¨ã€                                    â”‚    â”‚
â”‚  â”‚  - å°ˆé–€ç”¨æ–¼åˆ†ææ„åœ–ï¼Œè¼¸å‡º JSON                                   â”‚    â”‚
â”‚  â”‚  - System Prompt è¨­å®šç‚ºæ„åœ–åˆ†æå°ˆç”¨                              â”‚    â”‚
â”‚  â”‚  - è¼¸å‡ºæ ¼å¼ï¼š{"intent": "...", "parameters": {...}}              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ”€ QueryRouter + Handlers                             â”‚
â”‚                    ï¼ˆDjango æœ¬åœ°è™•ç†ï¼‰                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“¡ SAF API Server                                     â”‚
â”‚                    http://10.252.170.171:8080                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.3.2 æ„åœ–åˆ†æ Prompt è¨­è¨ˆ

**System Promptï¼ˆå·²åœ¨ Dify è¨­å®šï¼‰**ï¼š
```
ä½ æ˜¯ä¸€å€‹åŠ©æ‰‹ï¼Œè«‹æ ¹æ“šç”¨æˆ¶çš„æŒ‡ç¤ºå›ç­”ã€‚åªè¼¸å‡ºç”¨æˆ¶è¦æ±‚çš„æ ¼å¼ã€‚
```

**ç¨‹å¼ç¢¼ä¸­çš„å®Œæ•´ Promptï¼ˆ`INTENT_ANALYSIS_PROMPT`ï¼‰**ï¼š
```
ä½ æ˜¯ä¸€å€‹æ„åœ–åˆ†æå™¨ï¼Œå°ˆé–€åˆ†æç”¨æˆ¶é—œæ–¼ SAF å°ˆæ¡ˆç®¡ç†ç³»çµ±çš„å•é¡Œã€‚

ä½ å¿…é ˆè¼¸å‡º JSON æ ¼å¼ï¼Œä¸è¦è¼¸å‡ºå…¶ä»–å…§å®¹ã€‚

## å¯ç”¨çš„æ„åœ–é¡å‹

1. query_projects_by_customer - æŒ‰å®¢æˆ¶æŸ¥è©¢å°ˆæ¡ˆ
   - è§¸ç™¼è©ï¼šã€ŒXX æœ‰å“ªäº›å°ˆæ¡ˆã€ã€Œåˆ—å‡º XX çš„å°ˆæ¡ˆã€ã€ŒXX çš„å°ˆæ¡ˆã€
   - åƒæ•¸ï¼šcustomer (å®¢æˆ¶åç¨±)

2. query_projects_by_controller - æŒ‰æ§åˆ¶å™¨æŸ¥è©¢å°ˆæ¡ˆ
   - è§¸ç™¼è©ï¼šã€ŒSM2264 ç”¨åœ¨å“ªäº›å°ˆæ¡ˆã€ã€Œå“ªäº›å°ˆæ¡ˆç”¨ XX æ§åˆ¶å™¨ã€
   - åƒæ•¸ï¼šcontroller (æ§åˆ¶å™¨å‹è™Ÿ)

3. query_project_detail - æŸ¥è©¢å°ˆæ¡ˆè©³ç´°è³‡è¨Š
   - è§¸ç™¼è©ï¼šã€ŒXX å°ˆæ¡ˆçš„è©³ç´°è³‡è¨Šã€ã€Œå‘Šè¨´æˆ‘ XX å°ˆæ¡ˆã€
   - åƒæ•¸ï¼šproject_name (å°ˆæ¡ˆåç¨±)

4. query_project_summary - æŸ¥è©¢å°ˆæ¡ˆæ¸¬è©¦æ‘˜è¦
   - è§¸ç™¼è©ï¼šã€ŒXX çš„æ¸¬è©¦çµæœã€ã€ŒXX æ¸¬è©¦ç‹€æ³ã€
   - åƒæ•¸ï¼šproject_name (å°ˆæ¡ˆåç¨±)

5. count_projects - çµ±è¨ˆå°ˆæ¡ˆæ•¸é‡
   - è§¸ç™¼è©ï¼šã€Œæœ‰å¤šå°‘å°ˆæ¡ˆã€ã€Œå¹¾å€‹å°ˆæ¡ˆã€ã€Œå°ˆæ¡ˆæ•¸é‡ã€
   - åƒæ•¸ï¼šcustomer (å¯é¸ï¼Œè‹¥æŒ‡å®šå®¢æˆ¶)

6. list_all_customers - åˆ—å‡ºæ‰€æœ‰å®¢æˆ¶
   - è§¸ç™¼è©ï¼šã€Œæœ‰å“ªäº›å®¢æˆ¶ã€ã€Œå®¢æˆ¶åˆ—è¡¨ã€
   - åƒæ•¸ï¼šç„¡

7. list_all_controllers - åˆ—å‡ºæ‰€æœ‰æ§åˆ¶å™¨
   - è§¸ç™¼è©ï¼šã€Œæœ‰å“ªäº›æ§åˆ¶å™¨ã€ã€Œæ§åˆ¶å™¨åˆ—è¡¨ã€
   - åƒæ•¸ï¼šç„¡

8. unknown - ç„¡æ³•è­˜åˆ¥çš„æ„åœ–

## å·²çŸ¥å®¢æˆ¶åç¨±
WD, WDC, Western Digital, Samsung, Micron, Transcend, ADATA, UMIS, Biwin, Kioxia, SK Hynix

## å·²çŸ¥æ§åˆ¶å™¨å‹è™Ÿ
SM2263, SM2264, SM2267, SM2269, SM2264XT, SM2269XT

## è¼¸å‡ºæ ¼å¼ï¼ˆå¿…é ˆæ˜¯æœ‰æ•ˆçš„ JSONï¼‰

{
  "intent": "æ„åœ–é¡å‹ ID",
  "parameters": {
    // æå–çš„åƒæ•¸ï¼Œkey-value æ ¼å¼
  },
  "confidence": 0.0-1.0 ä¹‹é–“çš„æ•¸å€¼
}

## ç¯„ä¾‹

ç”¨æˆ¶ï¼šã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€
è¼¸å‡ºï¼š{"intent": "query_projects_by_customer", "parameters": {"customer": "WD"}, "confidence": 0.95}

ç”¨æˆ¶ï¼šã€ŒSM2264 æ§åˆ¶å™¨ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿã€
è¼¸å‡ºï¼š{"intent": "query_projects_by_controller", "parameters": {"controller": "SM2264"}, "confidence": 0.90}

ç”¨æˆ¶ï¼šã€Œç¸½å…±æœ‰å¤šå°‘å°ˆæ¡ˆï¼Ÿã€
è¼¸å‡ºï¼š{"intent": "count_projects", "parameters": {}, "confidence": 0.95}

ç”¨æˆ¶ï¼šã€ŒSamsung æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿã€
è¼¸å‡ºï¼š{"intent": "count_projects", "parameters": {"customer": "Samsung"}, "confidence": 0.93}

ç”¨æˆ¶ï¼šã€Œä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿã€
è¼¸å‡ºï¼š{"intent": "unknown", "parameters": {}, "confidence": 0.10}
```

#### 8.3.3 IntentAnalyzer å¯¦ä½œ

```python
# library/saf_integration/smart_query/intent_analyzer.py

import json
import logging
from typing import Optional
from dataclasses import dataclass

from library.config.dify_config_manager import get_saf_intent_analyzer_config
from library.dify_integration.dify_request_manager import DifyRequestManager

logger = logging.getLogger(__name__)

@dataclass
class IntentResult:
    """æ„åœ–åˆ†æçµæœ"""
    intent: str
    parameters: dict
    confidence: float
    raw_response: Optional[str] = None

class IntentAnalyzer:
    """
    ä½¿ç”¨ Dify Chat API é€²è¡Œæ„åœ–åˆ†æ
    """
    
    def __init__(self):
        self.config = get_saf_intent_analyzer_config()
        self.request_manager = DifyRequestManager(
            api_url=self.config.api_url,
            api_key=self.config.api_key,
            timeout=self.config.timeout
        )
    
    def analyze(self, query: str, user_id: str = "system") -> IntentResult:
        """
        åˆ†æç”¨æˆ¶å•é¡Œçš„æ„åœ–
        
        Args:
            query: ç”¨æˆ¶çš„å•é¡Œ
            user_id: ç”¨æˆ¶ IDï¼ˆç”¨æ–¼ Dify è¿½è¹¤ï¼‰
            
        Returns:
            IntentResult: åŒ…å«æ„åœ–ã€åƒæ•¸ã€ä¿¡å¿ƒåº¦
        """
        try:
            # èª¿ç”¨ Dify Chat API
            response = self.request_manager.send_chat_request(
                query=query,
                user_id=user_id,
                conversation_id=None  # æ¯æ¬¡éƒ½æ˜¯æ–°å°è©±
            )
            
            if not response.get('success'):
                logger.error(f"Dify API èª¿ç”¨å¤±æ•—: {response.get('error')}")
                return self._fallback_result(query)
            
            # è§£æ JSON å›æ‡‰
            answer = response.get('answer', '')
            return self._parse_intent_response(answer, query)
            
        except Exception as e:
            logger.error(f"æ„åœ–åˆ†æéŒ¯èª¤: {str(e)}")
            return self._fallback_result(query)
    
    def _parse_intent_response(self, answer: str, original_query: str) -> IntentResult:
        """è§£æ Dify è¿”å›çš„ JSON æ„åœ–"""
        try:
            # å˜—è©¦ç›´æ¥è§£æ JSON
            intent_data = json.loads(answer.strip())
            
            return IntentResult(
                intent=intent_data.get('intent', 'unknown'),
                parameters=intent_data.get('parameters', {}),
                confidence=intent_data.get('confidence', 0.5),
                raw_response=answer
            )
        except json.JSONDecodeError:
            # JSON è§£æå¤±æ•—ï¼Œå˜—è©¦å¾æ–‡å­—ä¸­æå– JSON
            logger.warning(f"JSON è§£æå¤±æ•—ï¼Œå˜—è©¦æå–: {answer[:100]}...")
            return self._extract_json_from_text(answer, original_query)
    
    def _extract_json_from_text(self, text: str, original_query: str) -> IntentResult:
        """å¾æ–‡å­—ä¸­æå– JSONï¼ˆè™•ç† LLM å¯èƒ½æ·»åŠ çš„é¡å¤–æ–‡å­—ï¼‰"""
        import re
        
        # å˜—è©¦æ‰¾åˆ° JSON éƒ¨åˆ†
        json_pattern = r'\{[^{}]*\}'
        matches = re.findall(json_pattern, text)
        
        for match in matches:
            try:
                intent_data = json.loads(match)
                if 'intent' in intent_data:
                    return IntentResult(
                        intent=intent_data.get('intent', 'unknown'),
                        parameters=intent_data.get('parameters', {}),
                        confidence=intent_data.get('confidence', 0.5),
                        raw_response=text
                    )
            except json.JSONDecodeError:
                continue
        
        # å®Œå…¨ç„¡æ³•è§£æ
        return self._fallback_result(original_query)
    
    def _fallback_result(self, query: str) -> IntentResult:
        """é™ç´šè™•ç†ï¼šä½¿ç”¨ç°¡å–®çš„é—œéµå­—åŒ¹é…"""
        query_lower = query.lower()
        
        # ç°¡å–®çš„é—œéµå­—åŒ¹é…ä½œç‚ºé™ç´šæ–¹æ¡ˆ
        if 'å®¢æˆ¶' in query or 'æœ‰å“ªäº›å®¢æˆ¶' in query:
            return IntentResult('list_all_customers', {}, 0.6)
        elif 'æ§åˆ¶å™¨' in query and ('åˆ—è¡¨' in query or 'æœ‰å“ªäº›' in query):
            return IntentResult('list_all_controllers', {}, 0.6)
        elif 'å¤šå°‘' in query or 'å¹¾å€‹' in query:
            return IntentResult('count_projects', {}, 0.6)
        
        return IntentResult('unknown', {}, 0.3, raw_response=f"Fallback for: {query}")
```

#### 8.3.4 èª¿ç”¨ç¯„ä¾‹

```python
# ä½¿ç”¨ç¯„ä¾‹

from library.saf_integration.smart_query.intent_analyzer import IntentAnalyzer

analyzer = IntentAnalyzer()

# åˆ†ææ„åœ–
result = analyzer.analyze("WD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ")

print(result.intent)      # "query_projects_by_customer"
print(result.parameters)  # {"customer": "WD"}
print(result.confidence)  # 0.95
```

---

### 8.4 å®Œæ•´ç¨‹å¼ç¢¼å¯¦ä½œè¨­è¨ˆï¼ˆSAFIntentAnalyzerï¼‰

**æ¶æ§‹åœ–**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Django Smart Query API                                â”‚
â”‚                    POST /api/dify/saf/smart-query/                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ§  IntentAnalyzer                                     â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç¨‹å¼ç¢¼ä¸­çš„å®Œæ•´ Promptï¼ˆINTENT_ANALYSIS_PROMPTï¼‰                 â”‚    â”‚
â”‚  â”‚  + ç”¨æˆ¶å•é¡Œ                                                      â”‚    â”‚
â”‚  â”‚  â†“                                                               â”‚    â”‚
â”‚  â”‚  çµ„åˆæˆ query ç™¼é€çµ¦ Dify                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  POST http://10.10.172.37/v1/chat-messages                               â”‚
â”‚  Authorization: Bearer {SAF_Intent_Analyzer çš„ API Key}                  â”‚
â”‚  {                                                                       â”‚
â”‚    "query": "[å®Œæ•´ Prompt]\n\nç”¨æˆ¶å•é¡Œï¼šWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ",               â”‚
â”‚    "response_mode": "blocking",                                          â”‚
â”‚    "user": "saf-smart-query"                                             â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“¡ Dify Server (gpt-oss:20b)                          â”‚
â”‚                                                                          â”‚
â”‚  ä½¿ç”¨ SAF_Intent_Analyzer App ç¶å®šçš„æ¨¡å‹è™•ç†è«‹æ±‚                         â”‚
â”‚  è¿”å› JSON æ ¼å¼çš„æ„åœ–åˆ†æçµæœ                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ”€ QueryRouter + Handlers â†’ SAF API                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Œæ•´ç¨‹å¼ç¢¼è¨­è¨ˆ**ï¼š

```python
# library/saf_integration/smart_query/intent_analyzer.py

import json
import logging
import requests
from typing import Optional
from dataclasses import dataclass

logger = logging.getLogger(__name__)

# ============================================================
# æ„åœ–åˆ†æ Promptï¼ˆå®Œå…¨åœ¨ç¨‹å¼ç¢¼ä¸­ç®¡ç†ï¼Œå¯ç‰ˆæœ¬æ§åˆ¶ï¼‰
# ============================================================
INTENT_ANALYSIS_PROMPT = """
ä½ æ˜¯ä¸€å€‹æ„åœ–åˆ†æå™¨ï¼Œå°ˆé–€åˆ†æç”¨æˆ¶é—œæ–¼ SAF å°ˆæ¡ˆç®¡ç†ç³»çµ±çš„å•é¡Œã€‚

ã€é‡è¦ã€‘ä½ å¿…é ˆåªè¼¸å‡º JSON æ ¼å¼ï¼Œä¸è¦è¼¸å‡ºä»»ä½•å…¶ä»–æ–‡å­—ã€è§£é‡‹æˆ–æ¨™è¨˜ã€‚

## å¯ç”¨çš„æ„åœ–é¡å‹

1. query_projects_by_customer - æŒ‰å®¢æˆ¶æŸ¥è©¢å°ˆæ¡ˆ
   - è§¸ç™¼è©ï¼šã€ŒXX æœ‰å“ªäº›å°ˆæ¡ˆã€ã€Œåˆ—å‡º XX çš„å°ˆæ¡ˆã€ã€ŒXX çš„å°ˆæ¡ˆã€
   - åƒæ•¸ï¼šcustomer (å®¢æˆ¶åç¨±)

2. query_projects_by_controller - æŒ‰æ§åˆ¶å™¨æŸ¥è©¢å°ˆæ¡ˆ
   - è§¸ç™¼è©ï¼šã€ŒSM2264 ç”¨åœ¨å“ªäº›å°ˆæ¡ˆã€ã€Œå“ªäº›å°ˆæ¡ˆç”¨ XX æ§åˆ¶å™¨ã€
   - åƒæ•¸ï¼šcontroller (æ§åˆ¶å™¨å‹è™Ÿ)

3. query_project_detail - æŸ¥è©¢å°ˆæ¡ˆè©³ç´°è³‡è¨Š
   - è§¸ç™¼è©ï¼šã€ŒXX å°ˆæ¡ˆçš„è©³ç´°è³‡è¨Šã€ã€Œå‘Šè¨´æˆ‘ XX å°ˆæ¡ˆã€
   - åƒæ•¸ï¼šproject_name (å°ˆæ¡ˆåç¨±)

4. query_project_summary - æŸ¥è©¢å°ˆæ¡ˆæ¸¬è©¦æ‘˜è¦
   - è§¸ç™¼è©ï¼šã€ŒXX çš„æ¸¬è©¦çµæœã€ã€ŒXX æ¸¬è©¦ç‹€æ³ã€
   - åƒæ•¸ï¼šproject_name (å°ˆæ¡ˆåç¨±)

5. count_projects - çµ±è¨ˆå°ˆæ¡ˆæ•¸é‡
   - è§¸ç™¼è©ï¼šã€Œæœ‰å¤šå°‘å°ˆæ¡ˆã€ã€Œå¹¾å€‹å°ˆæ¡ˆã€ã€Œå°ˆæ¡ˆæ•¸é‡ã€
   - åƒæ•¸ï¼šcustomer (å¯é¸ï¼Œè‹¥æŒ‡å®šå®¢æˆ¶)

6. list_all_customers - åˆ—å‡ºæ‰€æœ‰å®¢æˆ¶
   - è§¸ç™¼è©ï¼šã€Œæœ‰å“ªäº›å®¢æˆ¶ã€ã€Œå®¢æˆ¶åˆ—è¡¨ã€

7. list_all_controllers - åˆ—å‡ºæ‰€æœ‰æ§åˆ¶å™¨
   - è§¸ç™¼è©ï¼šã€Œæœ‰å“ªäº›æ§åˆ¶å™¨ã€ã€Œæ§åˆ¶å™¨åˆ—è¡¨ã€

8. unknown - ç„¡æ³•è­˜åˆ¥çš„æ„åœ–

## å·²çŸ¥è³‡è¨Š

å®¢æˆ¶åç¨±ï¼šWD, WDC, Western Digital, Samsung, Micron, Transcend, ADATA, UMIS, Biwin, Kioxia, SK Hynix
æ§åˆ¶å™¨å‹è™Ÿï¼šSM2263, SM2264, SM2267, SM2269, SM2264XT, SM2269XT

## è¼¸å‡ºæ ¼å¼

{"intent": "æ„åœ–ID", "parameters": {}, "confidence": 0.0-1.0}

## ç¯„ä¾‹

è¼¸å…¥ï¼šWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ
è¼¸å‡ºï¼š{"intent": "query_projects_by_customer", "parameters": {"customer": "WD"}, "confidence": 0.95}

è¼¸å…¥ï¼šSM2264 æ§åˆ¶å™¨ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿ
è¼¸å‡ºï¼š{"intent": "query_projects_by_controller", "parameters": {"controller": "SM2264"}, "confidence": 0.90}

è¼¸å…¥ï¼šç¸½å…±æœ‰å¤šå°‘å°ˆæ¡ˆï¼Ÿ
è¼¸å‡ºï¼š{"intent": "count_projects", "parameters": {}, "confidence": 0.95}

è¼¸å…¥ï¼šä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿ
è¼¸å‡ºï¼š{"intent": "unknown", "parameters": {}, "confidence": 0.10}

---

ç¾åœ¨åˆ†æä»¥ä¸‹å•é¡Œï¼š
"""


@dataclass
class IntentResult:
    """æ„åœ–åˆ†æçµæœ"""
    intent: str
    parameters: dict
    confidence: float
    raw_response: Optional[str] = None


class SAFIntentAnalyzer:
    """
    SAF æ„åœ–åˆ†æå™¨
    
    ä½¿ç”¨ Dify çš„ SAF_Intent_Analyzer App é€²è¡Œæ„åœ–åˆ†æ
    Prompt å®Œå…¨ç”±ç¨‹å¼ç¢¼æ§åˆ¶
    """
    
    # Dify é…ç½®
    DIFY_SERVER = "http://10.10.172.37"
    API_KEY = "app-vMNSUqgEIoejnXo3fuFvp1hC"  # SAF_Intent_Analyzer çš„ API Keyï¼ˆå·²å»ºç«‹ï¼‰
    TIMEOUT = 30
    
    def __init__(self, api_key: str = None):
        """
        åˆå§‹åŒ–æ„åœ–åˆ†æå™¨
        
        Args:
            api_key: å¯é¸ï¼Œè¦†è“‹é è¨­çš„ API Key
        """
        self.api_key = api_key or self.API_KEY
        self.api_url = f"{self.DIFY_SERVER}/v1/chat-messages"
    
    def analyze(self, query: str, user_id: str = "saf-smart-query") -> IntentResult:
        """
        åˆ†æç”¨æˆ¶å•é¡Œçš„æ„åœ–
        
        Args:
            query: ç”¨æˆ¶çš„å•é¡Œï¼ˆå¦‚ã€ŒWD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿã€ï¼‰
            user_id: ç”¨æˆ¶è­˜åˆ¥ç¢¼
            
        Returns:
            IntentResult: åŒ…å« intent, parameters, confidence
        """
        try:
            # çµ„åˆå®Œæ•´çš„ promptï¼ˆç¨‹å¼ç¢¼ä¸­çš„ Prompt + ç”¨æˆ¶å•é¡Œï¼‰
            full_query = f"{INTENT_ANALYSIS_PROMPT}\n{query}"
            
            # èª¿ç”¨ Dify Chat API
            response = requests.post(
                self.api_url,
                headers={
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                },
                json={
                    "inputs": {},
                    "query": full_query,
                    "response_mode": "blocking",
                    "conversation_id": "",  # æ¯æ¬¡éƒ½æ˜¯æ–°å°è©±
                    "user": user_id
                },
                timeout=self.TIMEOUT
            )
            
            if response.status_code != 200:
                logger.error(f"Dify API éŒ¯èª¤: {response.status_code} - {response.text}")
                return self._fallback_result(query)
            
            data = response.json()
            answer = data.get('answer', '')
            
            logger.info(f"æ„åœ–åˆ†æåŸå§‹å›æ‡‰: {answer[:200]}...")
            
            return self._parse_intent_response(answer, query)
            
        except requests.Timeout:
            logger.error("Dify API è¶…æ™‚")
            return self._fallback_result(query)
        except Exception as e:
            logger.error(f"æ„åœ–åˆ†æéŒ¯èª¤: {str(e)}")
            return self._fallback_result(query)
    
    def _parse_intent_response(self, answer: str, original_query: str) -> IntentResult:
        """è§£æ LLM è¿”å›çš„ JSON"""
        try:
            # æ¸…ç†å¯èƒ½çš„ markdown æ¨™è¨˜
            clean_answer = answer.strip()
            if clean_answer.startswith("```json"):
                clean_answer = clean_answer[7:]
            if clean_answer.startswith("```"):
                clean_answer = clean_answer[3:]
            if clean_answer.endswith("```"):
                clean_answer = clean_answer[:-3]
            clean_answer = clean_answer.strip()
            
            # è§£æ JSON
            intent_data = json.loads(clean_answer)
            
            return IntentResult(
                intent=intent_data.get('intent', 'unknown'),
                parameters=intent_data.get('parameters', {}),
                confidence=intent_data.get('confidence', 0.5),
                raw_response=answer
            )
            
        except json.JSONDecodeError:
            logger.warning(f"JSON è§£æå¤±æ•—ï¼Œå˜—è©¦æå–: {answer[:100]}...")
            return self._extract_json_from_text(answer, original_query)
    
    def _extract_json_from_text(self, text: str, original_query: str) -> IntentResult:
        """å¾æ–‡å­—ä¸­æå– JSONï¼ˆè™•ç† LLM å¯èƒ½æ·»åŠ çš„é¡å¤–æ–‡å­—ï¼‰"""
        import re
        
        # å˜—è©¦æ‰¾åˆ° JSON éƒ¨åˆ†
        json_pattern = r'\{[^{}]*"intent"[^{}]*\}'
        matches = re.findall(json_pattern, text)
        
        for match in matches:
            try:
                intent_data = json.loads(match)
                if 'intent' in intent_data:
                    return IntentResult(
                        intent=intent_data.get('intent', 'unknown'),
                        parameters=intent_data.get('parameters', {}),
                        confidence=intent_data.get('confidence', 0.5),
                        raw_response=text
                    )
            except json.JSONDecodeError:
                continue
        
        # å®Œå…¨ç„¡æ³•è§£æï¼Œä½¿ç”¨é™ç´šæ–¹æ¡ˆ
        logger.warning(f"ç„¡æ³•å¾å›æ‡‰ä¸­æå– JSONï¼Œä½¿ç”¨é™ç´šæ–¹æ¡ˆ")
        return self._fallback_result(original_query)
    
    def _fallback_result(self, query: str) -> IntentResult:
        """
        é™ç´šè™•ç†ï¼šä½¿ç”¨ç°¡å–®çš„é—œéµå­—åŒ¹é…
        ç•¶ LLM èª¿ç”¨å¤±æ•—æ™‚çš„å‚™ç”¨æ–¹æ¡ˆ
        """
        query_lower = query.lower()
        
        # å®¢æˆ¶é—œéµå­—åŒ¹é…
        customers = {
            'wd': 'WD', 'wdc': 'WDC', 'samsung': 'Samsung',
            'micron': 'Micron', 'transcend': 'Transcend',
            'adata': 'ADATA', 'umis': 'UMIS', 'biwin': 'Biwin'
        }
        
        for key, value in customers.items():
            if key in query_lower:
                if 'å¤šå°‘' in query or 'å¹¾å€‹' in query:
                    return IntentResult('count_projects', {'customer': value}, 0.6)
                elif 'å°ˆæ¡ˆ' in query or 'project' in query_lower:
                    return IntentResult('query_projects_by_customer', {'customer': value}, 0.6)
        
        # æ§åˆ¶å™¨é—œéµå­—åŒ¹é…
        controllers = ['sm2263', 'sm2264', 'sm2267', 'sm2269']
        for ctrl in controllers:
            if ctrl in query_lower:
                return IntentResult(
                    'query_projects_by_controller',
                    {'controller': ctrl.upper()},
                    0.6
                )
        
        # é€šç”¨æ•¸é‡æŸ¥è©¢
        if 'å¤šå°‘' in query or 'å¹¾å€‹' in query:
            return IntentResult('count_projects', {}, 0.6)
        
        # å®¢æˆ¶åˆ—è¡¨
        if 'å®¢æˆ¶' in query and ('æœ‰å“ªäº›' in query or 'åˆ—è¡¨' in query):
            return IntentResult('list_all_customers', {}, 0.6)
        
        # æ§åˆ¶å™¨åˆ—è¡¨
        if 'æ§åˆ¶å™¨' in query and ('æœ‰å“ªäº›' in query or 'åˆ—è¡¨' in query):
            return IntentResult('list_all_controllers', {}, 0.6)
        
        return IntentResult('unknown', {}, 0.3, raw_response=f"Fallback for: {query}")


# ============================================================
# ä½¿ç”¨ç¯„ä¾‹
# ============================================================
if __name__ == "__main__":
    analyzer = SAFIntentAnalyzer()
    
    # æ¸¬è©¦æ¡ˆä¾‹
    test_queries = [
        "WD æœ‰å“ªäº›å°ˆæ¡ˆï¼Ÿ",
        "Samsung æœ‰å¹¾å€‹å°ˆæ¡ˆï¼Ÿ",
        "SM2264 æ§åˆ¶å™¨ç”¨åœ¨å“ªäº›å°ˆæ¡ˆï¼Ÿ",
        "æœ‰å“ªäº›å®¢æˆ¶ï¼Ÿ",
        "ä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿ"
    ]
    
    for query in test_queries:
        result = analyzer.analyze(query)
        print(f"\nå•é¡Œ: {query}")
        print(f"æ„åœ–: {result.intent}")
        print(f"åƒæ•¸: {result.parameters}")
        print(f"ä¿¡å¿ƒåº¦: {result.confidence}")
```

---

## 9. å„ªå…ˆå¯¦ä½œçš„æ„åœ–

**å»ºè­°å„ªå…ˆé †åº**ï¼š
1. `query_projects_by_customer` - æœ€å¸¸ç”¨
2. `count_projects` - é©—è­‰ç²¾æº–åº¦
3. `query_projects_by_controller` - å¸¸ç”¨
4. `list_all_customers` - ç°¡å–®ä½†å¯¦ç”¨

---

## ğŸ“… æ–‡æª”æ›´æ–°è¨˜éŒ„

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å…§å®¹ | ä½œè€… |
|------|------|---------|------|
| v1.0 | 2025-12-05 | åˆå§‹è¦åŠƒæ–‡æª” | AI Platform Team |
| v1.1 | 2025-12-05 | æ–°å¢ Dify LLM API æ•´åˆæ–¹æ¡ˆè©³ç´°è¨­è¨ˆ | AI Platform Team |
| v1.2 | 2025-12-05 | æ–°å¢ã€Œç„¡éœ€å»ºç«‹ Dify Appã€æ–¹æ¡ˆï¼ˆB-1b, B-1cï¼‰ | AI Platform Team |
| v1.3 | 2025-12-05 | è©³ç´°èªªæ˜ B-1b å¦‚ä½•èª¿ç”¨ Dify æ¨¡å‹ï¼ˆgpt-oss:20bï¼‰ | AI Platform Team |
| v1.4 | 2025-12-05 | å®Œæˆ B-1b-2 æ–¹æ¡ˆé…ç½®ï¼Œæ–°å¢é›™ App å”ä½œæ¶æ§‹è¨­è¨ˆ | AI Platform Team |
| v1.5 | 2025-12-05 | ç§»é™¤æ–¹æ¡ˆ A/Cï¼Œåªä¿ç•™æ–¹æ¡ˆ Bï¼ˆDjango æ™ºèƒ½è·¯ç”± APIï¼‰ | AI Platform Team |

### v1.5 æ›´æ–°è©³æƒ…

**æ–‡æª”æ•´ç†**ï¼š
- âŒ ç§»é™¤æ–¹æ¡ˆ Aï¼ˆDify Workflowï¼‰
- âŒ ç§»é™¤æ–¹æ¡ˆ Cï¼ˆDify Agent + Toolsï¼‰
- âŒ ç§»é™¤æ–¹æ¡ˆ B-1bï¼ˆDify Completion APIï¼‰ã€B-1cï¼ˆOpenAI/Claude ç›´æ¥èª¿ç”¨ï¼‰
- âœ… åªä¿ç•™æ–¹æ¡ˆ Bï¼ˆDjango æ™ºèƒ½è·¯ç”± APIï¼‰+ é›™ App å”ä½œæ¶æ§‹
- âœ… æ›´æ–°ç›®éŒ„çµæ§‹

**ç¢ºå®šçš„æŠ€è¡“æ¶æ§‹**ï¼š
- **æ„åœ–åˆ†æ**ï¼š`SAF_Intent_Analyzer` Appï¼ˆDify Chat APIï¼‰
- **å›ç­”ç”Ÿæˆ**ï¼š`SAF_Analyzer` Appï¼ˆDify Chat APIï¼‰
- **è·¯ç”±å™¨**ï¼šDjango `QueryRouter`
- **API ç«¯é»**ï¼š`POST /api/dify/saf/smart-query/`

---

## 10. Phase 3ï¼šTest Summary API æ•´åˆè¨­è¨ˆ

### 10.1 èƒŒæ™¯èˆ‡ç›®æ¨™

SAF API Server æ–°å¢äº† **Project Test Summary API**ï¼Œå¯ä»¥æŸ¥è©¢å°ˆæ¡ˆçš„è©³ç´°æ¸¬è©¦çµæœçµ±è¨ˆã€‚æ­¤ API æä¾›ï¼š
- æŒ‰æ¸¬è©¦é¡åˆ¥ï¼ˆPerformance, Function, Compatibility ç­‰ï¼‰çµ±è¨ˆ
- æŒ‰å®¹é‡è¦æ ¼ï¼ˆ256GB, 512GB, 1024GB ç­‰ï¼‰çµ±è¨ˆ
- å®Œæ•´çš„é€šé/å¤±æ•—/é€²è¡Œä¸­æ•¸æ“š

**ç›®æ¨™**ï¼šæ•´åˆæ­¤ API åˆ°æ™ºèƒ½è·¯ç”±ç³»çµ±ï¼Œè®“ç”¨æˆ¶å¯ä»¥è‡ªç„¶èªè¨€æŸ¥è©¢å°ˆæ¡ˆæ¸¬è©¦çµæœã€‚

### 10.2 Test Summary API è¦æ ¼

#### 10.2.1 API ç«¯é»

```
GET http://localhost:8080/api/v1/projects/{project_uid}/test-summary

Headersï¼ˆå¿…å¡«ï¼‰:
  Authorization: <user_id>           # ä½¿ç”¨è€… IDï¼Œä¾‹å¦‚: 150
  Authorization-Name: <username>     # ä½¿ç”¨è€…åç¨±ï¼Œä¾‹å¦‚: Chunwei.Huang
```

#### 10.2.2 å›æ‡‰æ ¼å¼

```json
{
  "success": true,
  "data": {
    "project_uid": "21c6db80a556449f8b026649b28858c9",
    "project_name": "Automotive_PCIe_WD_DEMETER_SM2264XT_WDC Bi...",
    "capacities": ["256GB", "512GB", "1024GB"],
    "categories": [
      {
        "name": "Performance",
        "results_by_capacity": {
          "256GB": {
            "pass": 5,
            "fail": 10,
            "ongoing": 0,
            "cancel": 0,
            "check": 0,
            "total": 15,
            "pass_rate": 33.33
          }
        },
        "total": {
          "pass": 5,
          "fail": 10,
          "ongoing": 0,
          "cancel": 0,
          "check": 0,
          "total": 15,
          "pass_rate": 33.33
        }
      }
    ],
    "summary": {
      "total_pass": 0,
      "total_fail": 68,
      "total_ongoing": 0,
      "total_cancel": 3,
      "total_check": 1,
      "overall_total": 72,
      "overall_pass_rate": 0.0
    }
  }
}
```

#### 10.2.3 å›æ‡‰æ¬„ä½èªªæ˜

| æ¬„ä½ | èªªæ˜ |
|------|------|
| `project_uid` | å°ˆæ¡ˆå”¯ä¸€è­˜åˆ¥ç¢¼ |
| `project_name` | å°ˆæ¡ˆåç¨± |
| `capacities` | æ‰€æœ‰æ¸¬è©¦å®¹é‡åˆ—è¡¨ (å¦‚ 256GB, 512GB, 1024GB) |
| `categories` | æ¸¬è©¦é¡åˆ¥åˆ—è¡¨ (å¦‚ Compatibility, Function, Performance ç­‰) |
| `categories[].name` | é¡åˆ¥åç¨± |
| `categories[].results_by_capacity` | å„å®¹é‡çš„æ¸¬è©¦çµæœ |
| `categories[].total` | è©²é¡åˆ¥çš„çµ±è¨ˆ |
| `summary.total_pass` | ç¸½é€šéæ•¸ |
| `summary.total_fail` | ç¸½å¤±æ•—æ•¸ |
| `summary.total_ongoing` | é€²è¡Œä¸­æ•¸é‡ |
| `summary.total_cancel` | å–æ¶ˆæ•¸é‡ |
| `summary.total_check` | å¾…ç¢ºèªæ•¸é‡ |
| `summary.overall_total` | ç¸½æ¸¬è©¦æ•¸ |
| `summary.overall_pass_rate` | æ•´é«”é€šéç‡ (%) |

### 10.3 æ–°å¢æ„åœ–é¡å‹

| # | æ„åœ– ID | èªªæ˜ | åƒæ•¸ | ç”¨æˆ¶å•é¡Œç¯„ä¾‹ |
|---|---------|------|------|-------------|
| 9 | `query_project_test_summary` | æŸ¥è©¢å°ˆæ¡ˆæ¸¬è©¦ç¸½è¦½ | project_name | ã€ŒDEMETER çš„æ¸¬è©¦é€šéç‡æ˜¯å¤šå°‘ï¼Ÿã€ã€ŒDEMETER æœ‰å¤šå°‘æ¸¬è©¦å¤±æ•—ï¼Ÿã€ |
| 10 | `query_project_test_by_category` | æŒ‰é¡åˆ¥æŸ¥è©¢æ¸¬è©¦çµæœ | project_name, category | ã€ŒDEMETER çš„ Performance æ¸¬è©¦çµæœã€ã€ŒDEMETER åŠŸèƒ½æ¸¬è©¦ã€ |
| 11 | `query_project_test_by_capacity` | æŒ‰å®¹é‡æŸ¥è©¢æ¸¬è©¦çµæœ | project_name, capacity | ã€ŒDEMETER 256GB æ¸¬è©¦çµæœã€ã€ŒDEMETER 512GB é€šéç‡ã€ |

### 10.4 èªè­‰æ–¹å¼

**æ²¿ç”¨ç¾æœ‰æ©Ÿåˆ¶**ï¼šTest Summary API ä½¿ç”¨èˆ‡ç¾æœ‰ SAF API ç›¸åŒçš„èªè­‰æ–¹å¼ã€‚

```python
# library/saf_integration/auth_manager.py

class SAFAuthManager:
    # é è¨­èªè­‰è³‡è¨Šï¼ˆèˆ‡ Test Summary API æ‰€éœ€ç›¸åŒï¼‰
    DEFAULT_USER_ID = "150"
    DEFAULT_USER_NAME = "Chunwei.Huang"
    
    def get_auth_headers(self) -> Dict[str, str]:
        return {
            "Authorization": self.user_id,
            "Authorization-Name": self.user_name
        }
```

**èªè­‰å–å€¼å„ªå…ˆé †åº**ï¼š
1. å‡½æ•¸åƒæ•¸å‚³å…¥
2. Django settings é…ç½®
3. ç’°å¢ƒè®Šæ•¸
4. é è¨­å€¼

### 10.5 Project UID å¿«å–è¨­è¨ˆ

ç”±æ–¼ Test Summary API éœ€è¦ `project_uid`ï¼Œä½†ç”¨æˆ¶é€šå¸¸åªçŸ¥é“ `project_name`ï¼Œéœ€è¦ä¸€å€‹è½‰æ›æ©Ÿåˆ¶ã€‚

#### 10.5.1 å¿«å–ç­–ç•¥

**æ²¿ç”¨ç¾æœ‰ `SAFCacheManager`**ï¼š
- **å¿«å– TTL**ï¼š5 åˆ†é˜ï¼ˆèˆ‡ç¾æœ‰ä¸€è‡´ï¼‰
- **å¿«å–å…§å®¹**ï¼š`project_name â†’ project_uid` æ˜ å°„
- **æ›´æ–°é »ç‡**ï¼šå°ˆæ¡ˆè³‡è¨Šç›¸å°ç©©å®šï¼Œ5 åˆ†é˜ TTL è¶³å¤ 

```python
# å¿«å– key æ ¼å¼
cache_key = f"project_uid:{project_name.lower()}"
```

#### 10.5.2 è½‰æ›æµç¨‹

```
ç”¨æˆ¶è¼¸å…¥ï¼šã€ŒDEMETER çš„æ¸¬è©¦çµæœã€
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TestSummaryHandler._get_project_uid()  â”‚
â”‚                                     â”‚
â”‚  1. æª¢æŸ¥å¿«å–                        â”‚
â”‚     cache_key = "project_uid:demeter"â”‚
â”‚                                     â”‚
â”‚  2. å¿«å–å‘½ä¸­ â†’ ç›´æ¥è¿”å› UID         â”‚
â”‚     å¿«å–æœªå‘½ä¸­ â†“                    â”‚
â”‚                                     â”‚
â”‚  3. èª¿ç”¨ /api/v1/projects           â”‚
â”‚     æœå°‹åŒ¹é…çš„å°ˆæ¡ˆåç¨±              â”‚
â”‚                                     â”‚
â”‚  4. æ‰¾åˆ° â†’ å­˜å…¥å¿«å– + è¿”å› UID      â”‚
â”‚     æ‰¾ä¸åˆ° â†’ è¿”å› None              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.6 å¯¦ä½œè¦åŠƒ

#### 10.6.1 éœ€è¦æ–°å¢çš„æª”æ¡ˆ

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `library/saf_integration/smart_query/query_handlers/test_summary_handler.py` | æ¸¬è©¦æ‘˜è¦è™•ç†å™¨ |
| `tests/test_saf_smart_query/test_handlers/test_test_summary_handler.py` | æ¸¬è©¦æ¡ˆä¾‹ |

#### 10.6.2 éœ€è¦ä¿®æ”¹çš„æª”æ¡ˆ

| æª”æ¡ˆ | ä¿®æ”¹å…§å®¹ |
|------|---------|
| `library/saf_integration/endpoint_registry.py` | æ–°å¢ `project_test_summary` ç«¯é» |
| `library/saf_integration/api_client.py` | æ–°å¢ `get_project_test_summary()`, `get_project_uid_by_name()` æ–¹æ³• |
| `library/saf_integration/smart_query/intent_types.py` | æ–°å¢ 3 å€‹æ„åœ–é¡å‹ + å·²çŸ¥é¡åˆ¥/å®¹é‡å¸¸æ•¸ |
| `library/saf_integration/smart_query/intent_analyzer.py` | æ›´æ–° Promptï¼Œæ”¯æ´æ–°æ„åœ– |
| `library/saf_integration/smart_query/query_router.py` | è¨»å†Š TestSummaryHandler |
| `library/saf_integration/smart_query/response_generator.py` | æ–°å¢æ¸¬è©¦çµæœå›æ‡‰æ¨¡æ¿ |

#### 10.6.3 Endpoint Registry æ›´æ–°

```python
# library/saf_integration/endpoint_registry.py

SAF_ENDPOINTS["project_test_summary"] = {
    "path": "/api/v1/projects/{project_uid}/test-summary",
    "method": "GET",
    "description": "æŸ¥è©¢å°ˆæ¡ˆæ¸¬è©¦çµæœæ‘˜è¦ï¼ˆæŒ‰é¡åˆ¥å’Œå®¹é‡ï¼‰",
    "path_params": ["project_uid"],
    "transformer": "test_summary_to_dify_record",
    "enabled": True
}
```

#### 10.6.4 API Client æ›´æ–°

```python
# library/saf_integration/api_client.py

def get_project_uid_by_name(self, project_name: str) -> Optional[str]:
    """
    æ ¹æ“šå°ˆæ¡ˆåç¨±ç²å–å°ˆæ¡ˆ UIDï¼ˆå¸¶å¿«å–ï¼‰
    
    Args:
        project_name: å°ˆæ¡ˆåç¨±
        
    Returns:
        å°ˆæ¡ˆ UIDï¼Œå¦‚æœæ‰¾ä¸åˆ°å‰‡è¿”å› None
    """
    # æª¢æŸ¥å¿«å–
    cache_key = f"project_uid:{project_name.lower()}"
    if self.cache_manager:
        cached_uid = self.cache_manager.get(cache_key)
        if cached_uid:
            return cached_uid
    
    # å¾å°ˆæ¡ˆåˆ—è¡¨ä¸­æŸ¥æ‰¾
    projects = self.get_all_projects()
    for project in projects:
        if project.get('projectName', '').lower() == project_name.lower():
            uid = project.get('projectUid')
            # å­˜å…¥å¿«å–
            if self.cache_manager and uid:
                self.cache_manager.set(cache_key, uid)
            return uid
    
    return None

def get_project_test_summary(self, project_uid: str) -> Optional[Dict[str, Any]]:
    """
    ç²å–å°ˆæ¡ˆæ¸¬è©¦æ‘˜è¦
    
    Args:
        project_uid: å°ˆæ¡ˆ UID
        
    Returns:
        æ¸¬è©¦æ‘˜è¦è³‡æ–™
    """
    # æ§‹å»º URLï¼ˆæ›¿æ› path_paramsï¼‰
    config = get_endpoint_config("project_test_summary")
    if not config:
        return None
    
    path = config['path'].replace('{project_uid}', project_uid)
    url = f"{self.base_url}{path}"
    
    # ç²å–èªè­‰ headers
    headers = self.auth_manager.get_auth_headers()
    
    try:
        response = requests.get(url, headers=headers, timeout=self.timeout)
        if response.status_code == 200:
            data = response.json()
            if data.get('success'):
                return data.get('data')
        return None
    except Exception as e:
        logger.error(f"ç²å–æ¸¬è©¦æ‘˜è¦å¤±æ•—: {str(e)}")
        return None
```

#### 10.6.5 Intent Types æ›´æ–°

```python
# library/saf_integration/smart_query/intent_types.py

class IntentType(Enum):
    # Phase 1-2 æ„åœ–ï¼ˆç¾æœ‰ï¼‰
    QUERY_PROJECTS_BY_CUSTOMER = "query_projects_by_customer"
    QUERY_PROJECTS_BY_CONTROLLER = "query_projects_by_controller"
    QUERY_PROJECT_DETAIL = "query_project_detail"
    QUERY_PROJECT_SUMMARY = "query_project_summary"
    COUNT_PROJECTS = "count_projects"
    LIST_ALL_CUSTOMERS = "list_all_customers"
    LIST_ALL_CONTROLLERS = "list_all_controllers"
    UNKNOWN = "unknown"
    
    # ğŸ†• Phase 3 æ„åœ–
    QUERY_PROJECT_TEST_SUMMARY = "query_project_test_summary"
    QUERY_PROJECT_TEST_BY_CATEGORY = "query_project_test_by_category"
    QUERY_PROJECT_TEST_BY_CAPACITY = "query_project_test_by_capacity"


# ğŸ†• å·²çŸ¥æ¸¬è©¦é¡åˆ¥
KNOWN_TEST_CATEGORIES = [
    "Performance",
    "Function", 
    "Compatibility",
    "Stress",
    "Reliability"
]

# ğŸ†• å·²çŸ¥å®¹é‡è¦æ ¼
KNOWN_CAPACITIES = [
    "128GB",
    "256GB", 
    "512GB",
    "1024GB",
    "2048GB"
]
```

#### 10.6.6 Intent Analyzer Prompt æ›´æ–°

```python
# æ–°å¢åˆ° INTENT_ANALYSIS_PROMPT

### 9. query_project_test_summary - æŸ¥è©¢å°ˆæ¡ˆæ¸¬è©¦ç¸½è¦½
ç”¨æˆ¶æƒ³çŸ¥é“å°ˆæ¡ˆçš„æ•´é«”æ¸¬è©¦çµæœçµ±è¨ˆæ™‚ä½¿ç”¨ã€‚
- å¸¸è¦‹å•æ³•ï¼š
  - ã€ŒXX çš„æ¸¬è©¦é€šéç‡æ˜¯å¤šå°‘ã€ã€ŒXX æœ‰å¤šå°‘æ¸¬è©¦ã€ã€ŒXX æ¸¬è©¦çµæœçµ±è¨ˆã€
  - ã€ŒXX æ¸¬è©¦ç‹€æ³å¦‚ä½•ã€ã€ŒXX çš„ QA å ±å‘Šã€ã€ŒXX æœ‰å¤šå°‘æ¸¬è©¦å¤±æ•—ã€
  - ã€ŒXX çš„æ¸¬è©¦çµ±è¨ˆã€ã€ŒXX ç›®å‰æ¸¬è©¦é€²åº¦ã€
- åƒæ•¸ï¼šproject_name (å°ˆæ¡ˆåç¨±)
- æ³¨æ„ï¼šé€™æ˜¯æŸ¥è©¢è©³ç´°æ¸¬è©¦æ•¸æ“šçµ±è¨ˆï¼Œèˆ‡ query_project_summaryï¼ˆåŸºæœ¬æ‘˜è¦ï¼‰ä¸åŒ

### 10. query_project_test_by_category - æŒ‰é¡åˆ¥æŸ¥è©¢æ¸¬è©¦çµæœ
ç”¨æˆ¶æƒ³çŸ¥é“å°ˆæ¡ˆæŸå€‹æ¸¬è©¦é¡åˆ¥çš„çµæœæ™‚ä½¿ç”¨ã€‚
- å¸¸è¦‹å•æ³•ï¼š
  - ã€ŒXX çš„ Performance æ¸¬è©¦ã€ã€ŒXX Performance çµæœã€
  - ã€ŒXX åŠŸèƒ½æ¸¬è©¦æ€éº¼æ¨£ã€ã€ŒXX çš„ Function æ¸¬è©¦çµæœã€
  - ã€ŒXX ç›¸å®¹æ€§æ¸¬è©¦ã€ã€ŒXX Compatibility æ¸¬è©¦ã€
  - ã€ŒXX Stress æ¸¬è©¦ã€ã€ŒXX å£“åŠ›æ¸¬è©¦çµæœã€
- åƒæ•¸ï¼šproject_name (å°ˆæ¡ˆåç¨±), category (æ¸¬è©¦é¡åˆ¥)
- å·²çŸ¥é¡åˆ¥ï¼šPerformance, Function, Compatibility, Stress, Reliability

### 11. query_project_test_by_capacity - æŒ‰å®¹é‡æŸ¥è©¢æ¸¬è©¦çµæœ
ç”¨æˆ¶æƒ³çŸ¥é“å°ˆæ¡ˆæŸå€‹å®¹é‡çš„æ¸¬è©¦çµæœæ™‚ä½¿ç”¨ã€‚
- å¸¸è¦‹å•æ³•ï¼š
  - ã€ŒXX 256GB æ¸¬è©¦çµæœã€ã€ŒXX 256GB é€šéç‡ã€
  - ã€ŒXX çš„ 512GB æ¸¬è©¦ã€ã€ŒXX 1024GB æ¸¬è©¦æ€éº¼æ¨£ã€
  - ã€ŒXX 1TB æ¸¬è©¦ã€ã€ŒXX 2TB çµæœã€
- åƒæ•¸ï¼šproject_name (å°ˆæ¡ˆåç¨±), capacity (å®¹é‡è¦æ ¼)
- å·²çŸ¥å®¹é‡ï¼š128GB, 256GB, 512GB, 1024GB, 2048GB

## æ–°å¢ç¯„ä¾‹

è¼¸å…¥ï¼šDEMETER çš„æ¸¬è©¦é€šéç‡æ˜¯å¤šå°‘ï¼Ÿ
è¼¸å‡ºï¼š{"intent": "query_project_test_summary", "parameters": {"project_name": "DEMETER"}, "confidence": 0.95}

è¼¸å…¥ï¼šDEMETER æœ‰å¤šå°‘æ¸¬è©¦å¤±æ•—
è¼¸å‡ºï¼š{"intent": "query_project_test_summary", "parameters": {"project_name": "DEMETER"}, "confidence": 0.93}

è¼¸å…¥ï¼šDEMETER çš„ Performance æ¸¬è©¦çµæœ
è¼¸å‡ºï¼š{"intent": "query_project_test_by_category", "parameters": {"project_name": "DEMETER", "category": "Performance"}, "confidence": 0.94}

è¼¸å…¥ï¼šDEMETER åŠŸèƒ½æ¸¬è©¦æ€éº¼æ¨£
è¼¸å‡ºï¼š{"intent": "query_project_test_by_category", "parameters": {"project_name": "DEMETER", "category": "Function"}, "confidence": 0.90}

è¼¸å…¥ï¼šDEMETER 256GB æ¸¬è©¦çµæœ
è¼¸å‡ºï¼š{"intent": "query_project_test_by_capacity", "parameters": {"project_name": "DEMETER", "capacity": "256GB"}, "confidence": 0.93}

è¼¸å…¥ï¼šDEMETER 512GB é€šéç‡
è¼¸å‡ºï¼š{"intent": "query_project_test_by_capacity", "parameters": {"project_name": "DEMETER", "capacity": "512GB"}, "confidence": 0.91}
```

#### 10.6.7 TestSummaryHandler è¨­è¨ˆ

```python
# library/saf_integration/smart_query/query_handlers/test_summary_handler.py

"""
TestSummaryHandler - å°ˆæ¡ˆæ¸¬è©¦æ‘˜è¦è™•ç†å™¨
========================================

è™•ç†ä»¥ä¸‹æ„åœ–ï¼š
- query_project_test_summary: æ¸¬è©¦ç¸½è¦½
- query_project_test_by_category: æŒ‰é¡åˆ¥æŸ¥è©¢
- query_project_test_by_capacity: æŒ‰å®¹é‡æŸ¥è©¢

ä½œè€…ï¼šAI Platform Team
å‰µå»ºæ—¥æœŸï¼š2025-12-06
"""

import logging
from typing import Dict, Any, Optional

from .base_handler import BaseHandler, QueryResult
from ..intent_types import IntentType

logger = logging.getLogger(__name__)


class TestSummaryHandler(BaseHandler):
    """
    å°ˆæ¡ˆæ¸¬è©¦æ‘˜è¦è™•ç†å™¨
    
    è™•ç† Project Test Summary API ç›¸é—œçš„æ„åœ–ã€‚
    """
    
    handler_name = "test_summary_handler"
    
    # æ”¯æ´çš„æ„åœ–é¡å‹
    SUPPORTED_INTENTS = [
        IntentType.QUERY_PROJECT_TEST_SUMMARY,
        IntentType.QUERY_PROJECT_TEST_BY_CATEGORY,
        IntentType.QUERY_PROJECT_TEST_BY_CAPACITY,
    ]
    
    def execute(self, parameters: Dict[str, Any], 
                intent_type: IntentType = None) -> QueryResult:
        """
        åŸ·è¡Œæ¸¬è©¦æ‘˜è¦æŸ¥è©¢
        
        Args:
            parameters: æŸ¥è©¢åƒæ•¸
            intent_type: æ„åœ–é¡å‹ï¼ˆç”¨æ–¼æ±ºå®šå›æ‡‰æ ¼å¼ï¼‰
            
        Returns:
            QueryResult: æŸ¥è©¢çµæœ
        """
        self._log_query(parameters)
        
        # é©—è­‰å¿…è¦åƒæ•¸
        error = self.validate_parameters(parameters, required=['project_name'])
        if error:
            return QueryResult.error(error, self.handler_name, parameters)
        
        project_name = parameters.get('project_name')
        
        try:
            # Step 1: project_name â†’ project_uid è½‰æ›
            project_uid = self._get_project_uid(project_name)
            
            if not project_uid:
                return QueryResult.no_results(
                    query_type=self.handler_name,
                    parameters=parameters,
                    message=f"æ‰¾ä¸åˆ°å°ˆæ¡ˆ '{project_name}'ï¼Œè«‹ç¢ºèªå°ˆæ¡ˆåç¨±æ˜¯å¦æ­£ç¢º"
                )
            
            # Step 2: èª¿ç”¨ Test Summary API
            test_data = self.api_client.get_project_test_summary(project_uid)
            
            if not test_data:
                return QueryResult.error(
                    f"ç„¡æ³•ç²å–å°ˆæ¡ˆ '{project_name}' çš„æ¸¬è©¦è³‡æ–™",
                    self.handler_name,
                    parameters
                )
            
            # Step 3: æ ¹æ“šæ„åœ–é¡å‹æ ¼å¼åŒ–çµæœ
            if intent_type == IntentType.QUERY_PROJECT_TEST_SUMMARY:
                return self._format_overall_summary(test_data, parameters)
            
            elif intent_type == IntentType.QUERY_PROJECT_TEST_BY_CATEGORY:
                category = parameters.get('category')
                return self._format_category_result(test_data, category, parameters)
            
            elif intent_type == IntentType.QUERY_PROJECT_TEST_BY_CAPACITY:
                capacity = parameters.get('capacity')
                return self._format_capacity_result(test_data, capacity, parameters)
            
            else:
                # é è¨­è¿”å›ç¸½è¦½
                return self._format_overall_summary(test_data, parameters)
            
        except Exception as e:
            return self._handle_api_error(e, parameters)
    
    def _get_project_uid(self, project_name: str) -> Optional[str]:
        """
        ç²å–å°ˆæ¡ˆ UIDï¼ˆä½¿ç”¨ API Client çš„å¿«å–æ©Ÿåˆ¶ï¼‰
        """
        return self.api_client.get_project_uid_by_name(project_name)
    
    def _format_overall_summary(self, data: Dict, 
                                 parameters: Dict) -> QueryResult:
        """æ ¼å¼åŒ–æ•´é«”æ¸¬è©¦æ‘˜è¦"""
        summary = data.get('summary', {})
        categories = data.get('categories', [])
        capacities = data.get('capacities', [])
        
        formatted_data = {
            'project_name': data.get('project_name', ''),
            'capacities': capacities,
            'summary': {
                'total': summary.get('overall_total', 0),
                'pass': summary.get('total_pass', 0),
                'fail': summary.get('total_fail', 0),
                'ongoing': summary.get('total_ongoing', 0),
                'cancel': summary.get('total_cancel', 0),
                'check': summary.get('total_check', 0),
                'pass_rate': summary.get('overall_pass_rate', 0),
            },
            'categories': [
                {
                    'name': cat.get('name', ''),
                    'total': cat.get('total', {}).get('total', 0),
                    'pass': cat.get('total', {}).get('pass', 0),
                    'fail': cat.get('total', {}).get('fail', 0),
                    'pass_rate': cat.get('total', {}).get('pass_rate', 0),
                }
                for cat in categories
            ]
        }
        
        return QueryResult.success(
            data=formatted_data,
            count=1,
            query_type=self.handler_name,
            parameters=parameters,
            message=f"å°ˆæ¡ˆ '{data.get('project_name')}' çš„æ¸¬è©¦æ‘˜è¦"
        )
    
    def _format_category_result(self, data: Dict, category: str,
                                  parameters: Dict) -> QueryResult:
        """æ ¼å¼åŒ–æŒ‰é¡åˆ¥çš„æ¸¬è©¦çµæœ"""
        categories = data.get('categories', [])
        
        # æŸ¥æ‰¾æŒ‡å®šé¡åˆ¥
        target_category = None
        for cat in categories:
            if cat.get('name', '').lower() == category.lower():
                target_category = cat
                break
        
        if not target_category:
            available = [cat.get('name') for cat in categories]
            return QueryResult.no_results(
                query_type=self.handler_name,
                parameters=parameters,
                message=f"æ‰¾ä¸åˆ°é¡åˆ¥ '{category}'ï¼Œå¯ç”¨é¡åˆ¥ï¼š{', '.join(available)}"
            )
        
        formatted_data = {
            'project_name': data.get('project_name', ''),
            'category': target_category.get('name', ''),
            'results_by_capacity': target_category.get('results_by_capacity', {}),
            'total': target_category.get('total', {})
        }
        
        return QueryResult.success(
            data=formatted_data,
            count=1,
            query_type=self.handler_name,
            parameters=parameters,
            message=f"å°ˆæ¡ˆ '{data.get('project_name')}' çš„ {category} æ¸¬è©¦çµæœ"
        )
    
    def _format_capacity_result(self, data: Dict, capacity: str,
                                  parameters: Dict) -> QueryResult:
        """æ ¼å¼åŒ–æŒ‰å®¹é‡çš„æ¸¬è©¦çµæœ"""
        capacities = data.get('capacities', [])
        categories = data.get('categories', [])
        
        # æ¨™æº–åŒ–å®¹é‡æ ¼å¼
        capacity_normalized = capacity.upper()
        
        if capacity_normalized not in capacities:
            return QueryResult.no_results(
                query_type=self.handler_name,
                parameters=parameters,
                message=f"æ‰¾ä¸åˆ°å®¹é‡ '{capacity}'ï¼Œå¯ç”¨å®¹é‡ï¼š{', '.join(capacities)}"
            )
        
        # æ”¶é›†è©²å®¹é‡åœ¨å„é¡åˆ¥çš„çµæœ
        capacity_results = []
        for cat in categories:
            results_by_cap = cat.get('results_by_capacity', {})
            if capacity_normalized in results_by_cap:
                capacity_results.append({
                    'category': cat.get('name', ''),
                    **results_by_cap[capacity_normalized]
                })
        
        formatted_data = {
            'project_name': data.get('project_name', ''),
            'capacity': capacity_normalized,
            'results': capacity_results
        }
        
        return QueryResult.success(
            data=formatted_data,
            count=len(capacity_results),
            query_type=self.handler_name,
            parameters=parameters,
            message=f"å°ˆæ¡ˆ '{data.get('project_name')}' çš„ {capacity} æ¸¬è©¦çµæœ"
        )
```

#### 10.6.8 Query Router æ›´æ–°

```python
# library/saf_integration/smart_query/query_router.py

# åœ¨ _register_handlers() ä¸­æ–°å¢

from .query_handlers import TestSummaryHandler

def _register_handlers(self):
    """è¨»å†Šæ‰€æœ‰è™•ç†å™¨"""
    self._test_summary_handler = TestSummaryHandler()
    
    self._handlers = {
        # ç¾æœ‰ handlers...
        
        # ğŸ†• Phase 3 handlers
        IntentType.QUERY_PROJECT_TEST_SUMMARY: self._test_summary_handler,
        IntentType.QUERY_PROJECT_TEST_BY_CATEGORY: self._test_summary_handler,
        IntentType.QUERY_PROJECT_TEST_BY_CAPACITY: self._test_summary_handler,
    }
```

### 10.7 å›æ‡‰æ ¼å¼è¨­è¨ˆ

#### 10.7.1 æ¸¬è©¦ç¸½è¦½å›æ‡‰

```markdown
ğŸ“Š DEMETER å°ˆæ¡ˆæ¸¬è©¦çµæœç¸½è¦½

| é …ç›® | æ•¸é‡ |
|------|------|
| ç¸½æ¸¬è©¦æ•¸ | 72 |
| âœ… é€šé (Pass) | 0 |
| âŒ å¤±æ•— (Fail) | 68 |
| ğŸ”„ é€²è¡Œä¸­ (Ongoing) | 0 |
| â¸ï¸ å–æ¶ˆ (Cancel) | 3 |
| â“ å¾…ç¢ºèª (Check) | 1 |
| **é€šéç‡** | **0.0%** |

ğŸ“ æ¸¬è©¦å®¹é‡ï¼š256GB, 512GB, 1024GB

ğŸ“‚ å„é¡åˆ¥æ‘˜è¦ï¼š
| é¡åˆ¥ | é€šé | å¤±æ•— | ç¸½æ•¸ | é€šéç‡ |
|------|------|------|------|--------|
| Performance | 5 | 10 | 15 | 33.33% |
| Function | 3 | 12 | 15 | 20.00% |
| Compatibility | 2 | 8 | 10 | 20.00% |

ğŸ’¡ æç¤ºï¼šå¯ä»¥é€²ä¸€æ­¥è©¢å•ã€ŒDEMETER Performance æ¸¬è©¦çµæœã€æˆ–ã€ŒDEMETER 256GB æ¸¬è©¦çµæœã€
```

#### 10.7.2 æŒ‰é¡åˆ¥æŸ¥è©¢å›æ‡‰

```markdown
ï¿½ DEMETER - Performance æ¸¬è©¦çµæœ

| å®¹é‡ | é€šé | å¤±æ•— | é€²è¡Œä¸­ | ç¸½æ•¸ | é€šéç‡ |
|------|------|------|--------|------|--------|
| 256GB | 5 | 10 | 0 | 15 | 33.33% |
| 512GB | 3 | 8 | 0 | 11 | 27.27% |
| 1024GB | 2 | 5 | 0 | 7 | 28.57% |
| **ç¸½è¨ˆ** | **10** | **23** | **0** | **33** | **30.30%** |
```

#### 10.7.3 æŒ‰å®¹é‡æŸ¥è©¢å›æ‡‰

```markdown
ğŸ“Š DEMETER - 256GB æ¸¬è©¦çµæœ

| é¡åˆ¥ | é€šé | å¤±æ•— | é€²è¡Œä¸­ | ç¸½æ•¸ | é€šéç‡ |
|------|------|------|--------|------|--------|
| Performance | 5 | 10 | 0 | 15 | 33.33% |
| Function | 3 | 5 | 0 | 8 | 37.50% |
| Compatibility | 2 | 4 | 0 | 6 | 33.33% |
| **ç¸½è¨ˆ** | **10** | **19** | **0** | **29** | **34.48%** |
```

### 10.8 å®Œæ•´æŸ¥è©¢æµç¨‹åœ–

```
ç”¨æˆ¶ï¼šã€ŒDEMETER çš„æ¸¬è©¦é€šéç‡æ˜¯å¤šå°‘ï¼Ÿã€
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ§  IntentAnalyzer.analyze()                          â”‚
â”‚                                                                          â”‚
â”‚  è¼¸å‡ºï¼š{                                                                 â”‚
â”‚    "intent": "query_project_test_summary",                              â”‚
â”‚    "parameters": {"project_name": "DEMETER"},                           â”‚
â”‚    "confidence": 0.95                                                    â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ”€ QueryRouter.route()                                â”‚
â”‚                                                                          â”‚
â”‚  é¸æ“‡ TestSummaryHandler                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“‹ TestSummaryHandler.execute()                       â”‚
â”‚                                                                          â”‚
â”‚  Step 1: å–å¾— project_uid                                               â”‚
â”‚          â”œâ”€ æª¢æŸ¥å¿«å– (TTL: 5min)                                        â”‚
â”‚          â””â”€ å¿«å–æœªå‘½ä¸­ â†’ èª¿ç”¨ GET /projects æœå°‹                        â”‚
â”‚                                                                          â”‚
â”‚  Step 2: èª¿ç”¨ Test Summary API                                          â”‚
â”‚          GET /api/v1/projects/{project_uid}/test-summary                â”‚
â”‚          Headers: Authorization: 150                                     â”‚
â”‚                   Authorization-Name: Chunwei.Huang                      â”‚
â”‚                                                                          â”‚
â”‚  Step 3: æ ¼å¼åŒ–çµæœ (_format_overall_summary)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“ ResponseGenerator.generate()                       â”‚
â”‚                                                                          â”‚
â”‚  è½‰æ›ç‚º Markdown Table æ ¼å¼                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    ğŸ“Š è¿”å›æ ¼å¼åŒ–çš„æ¸¬è©¦çµæœ
```

### 10.9 é ä¼°æ™‚ç¨‹

| æ­¥é©Ÿ | ä»»å‹™ | é ä¼°æ™‚é–“ |
|------|------|----------|
| 10.1 | æ›´æ–° `endpoint_registry.py` | 0.5 å°æ™‚ |
| 10.2 | æ›´æ–° `api_client.py`ï¼ˆæ–°å¢ 2 å€‹æ–¹æ³•ï¼‰ | 1 å°æ™‚ |
| 10.3 | æ›´æ–° `intent_types.py`ï¼ˆæ–°å¢æ„åœ– + å¸¸æ•¸ï¼‰ | 0.5 å°æ™‚ |
| 10.4 | æ›´æ–° `intent_analyzer.py`ï¼ˆæ›´æ–° Promptï¼‰ | 1 å°æ™‚ |
| 10.5 | æ–°å¢ `test_summary_handler.py` | 2 å°æ™‚ |
| 10.6 | æ›´æ–° `query_router.py`ï¼ˆè¨»å†Šæ–° Handlerï¼‰ | 0.5 å°æ™‚ |
| 10.7 | æ›´æ–° `response_generator.py`ï¼ˆæ–°å¢å›æ‡‰æ¨¡æ¿ï¼‰ | 1 å°æ™‚ |
| 10.8 | æ¸¬è©¦å’Œèª¿è©¦ | 1.5 å°æ™‚ |
| **ç¸½è¨ˆ** | | **ç´„ 8 å°æ™‚ï¼ˆ1 å¤©ï¼‰** |

### 10.10 Phase 3 å¯¦ä½œæª¢æŸ¥æ¸…å–®

- [ ] **Endpoint Registry**
  - [ ] æ–°å¢ `project_test_summary` ç«¯é»å®šç¾©

- [ ] **API Client**
  - [ ] æ–°å¢ `get_project_test_summary()` æ–¹æ³•
  - [ ] æ–°å¢ `get_project_uid_by_name()` æ–¹æ³•
  - [ ] è™•ç† path_params æ›¿æ›é‚è¼¯

- [ ] **Intent Types**
  - [ ] æ–°å¢ `QUERY_PROJECT_TEST_SUMMARY` æ„åœ–
  - [ ] æ–°å¢ `QUERY_PROJECT_TEST_BY_CATEGORY` æ„åœ–
  - [ ] æ–°å¢ `QUERY_PROJECT_TEST_BY_CAPACITY` æ„åœ–
  - [ ] æ–°å¢ `KNOWN_TEST_CATEGORIES` å¸¸æ•¸
  - [ ] æ–°å¢ `KNOWN_CAPACITIES` å¸¸æ•¸

- [ ] **Intent Analyzer**
  - [ ] æ›´æ–° `INTENT_ANALYSIS_PROMPT` æ·»åŠ  3 å€‹æ–°æ„åœ–èªªæ˜
  - [ ] æ·»åŠ æ–°æ„åœ–çš„ç¯„ä¾‹ï¼ˆè‡³å°‘å„ 2 å€‹ï¼‰

- [ ] **Test Summary Handler**
  - [ ] å¯¦ä½œ `execute()` æ–¹æ³•
  - [ ] å¯¦ä½œ `_get_project_uid()` æ–¹æ³•
  - [ ] å¯¦ä½œ `_format_overall_summary()` æ–¹æ³•
  - [ ] å¯¦ä½œ `_format_category_result()` æ–¹æ³•
  - [ ] å¯¦ä½œ `_format_capacity_result()` æ–¹æ³•

- [ ] **Query Router**
  - [ ] è¨»å†Š `TestSummaryHandler`
  - [ ] è™•ç† 3 å€‹æ–°æ„åœ–çš„è·¯ç”±

- [ ] **Response Generator**
  - [ ] æ–°å¢æ¸¬è©¦ç¸½è¦½å›æ‡‰æ¨¡æ¿
  - [ ] æ–°å¢æŒ‰é¡åˆ¥å›æ‡‰æ¨¡æ¿
  - [ ] æ–°å¢æŒ‰å®¹é‡å›æ‡‰æ¨¡æ¿

- [ ] **æ¸¬è©¦**
  - [ ] æ¸¬è©¦ project_name â†’ project_uid è½‰æ›
  - [ ] æ¸¬è©¦ 3 ç¨®æ–°æ„åœ–çš„è­˜åˆ¥
  - [ ] æ¸¬è©¦ Test Summary API èª¿ç”¨
  - [ ] æ¸¬è©¦å›æ‡‰æ ¼å¼åŒ–
  - [ ] æ¸¬è©¦éŒ¯èª¤è™•ç†ï¼ˆæ‰¾ä¸åˆ°å°ˆæ¡ˆã€æ‰¾ä¸åˆ°é¡åˆ¥/å®¹é‡ï¼‰

---

## ğŸ“… æ–‡æª”æ›´æ–°è¨˜éŒ„

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å…§å®¹ | ä½œè€… |
|------|------|---------|------|
| v1.0 | 2025-12-05 | åˆå§‹è¦åŠƒæ–‡æª” | AI Platform Team |
| v1.1 | 2025-12-05 | æ–°å¢ Dify LLM API æ•´åˆæ–¹æ¡ˆè©³ç´°è¨­è¨ˆ | AI Platform Team |
| v1.2 | 2025-12-05 | æ–°å¢ã€Œç„¡éœ€å»ºç«‹ Dify Appã€æ–¹æ¡ˆï¼ˆB-1b, B-1cï¼‰ | AI Platform Team |
| v1.3 | 2025-12-05 | è©³ç´°èªªæ˜ B-1b å¦‚ä½•èª¿ç”¨ Dify æ¨¡å‹ï¼ˆgpt-oss:20bï¼‰ | AI Platform Team |
| v1.4 | 2025-12-05 | å®Œæˆ B-1b-2 æ–¹æ¡ˆé…ç½®ï¼Œæ–°å¢é›™ App å”ä½œæ¶æ§‹è¨­è¨ˆ | AI Platform Team |
| v1.5 | 2025-12-05 | ç§»é™¤æ–¹æ¡ˆ A/Cï¼Œåªä¿ç•™æ–¹æ¡ˆ Bï¼ˆDjango æ™ºèƒ½è·¯ç”± APIï¼‰ | AI Platform Team |
| v1.6 | 2025-12-06 | æ–°å¢ Phase 3ï¼šTest Summary API æ•´åˆè¨­è¨ˆ | AI Platform Team |

### v1.6 æ›´æ–°è©³æƒ…

**æ–°å¢å…§å®¹**ï¼š
- âœ… æ–°å¢ç¬¬ 10 ç« ï¼šPhase 3 Test Summary API æ•´åˆè¨­è¨ˆ
- âœ… è©³ç´°è¨˜éŒ„ Test Summary API è¦æ ¼
- âœ… æ–°å¢ 3 å€‹æ„åœ–é¡å‹è¨­è¨ˆ
- âœ… å®Œæ•´çš„ TestSummaryHandler ç¨‹å¼ç¢¼è¨­è¨ˆ
- âœ… å›æ‡‰æ ¼å¼æ¨¡æ¿è¨­è¨ˆ
- âœ… å¯¦ä½œæª¢æŸ¥æ¸…å–®

**ç¢ºèªäº‹é …**ï¼š
- âœ… èªè­‰æ–¹å¼ï¼šæ²¿ç”¨ç¾æœ‰ SAFAuthManagerï¼ˆuser_id=150, username=Chunwei.Huangï¼‰
- âœ… å¿«å–ç­–ç•¥ï¼šæ²¿ç”¨ç¾æœ‰ SAFCacheManagerï¼ˆTTL=5 åˆ†é˜ï¼‰
- âœ… Phase 1-2 å·²å®Œæˆï¼Œå¯ç›´æ¥é–‹å§‹ Phase 3

---

## ï¿½ğŸ”— ç›¸é—œæ–‡æª”

- [Dify SAF å¤–éƒ¨çŸ¥è­˜åº« API è¨­è¨ˆ](./dify-saf-external-knowledge-api-plan.md)
- [SAF API Server åˆ†æ](../features/dify-saf-external-knowledge-api-design.md)
- [Project Test Summary API ä½¿ç”¨èªªæ˜](../../internal_api/docs/PLANNING_PROJECT_SUMMARY_API.md)
