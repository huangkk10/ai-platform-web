# 單一測試案例版本比較 - 架構流程圖

## 📐 系統架構全景圖

```
┌────────────────────────────────────────────────────────────────────┐
│                          前端層 (React)                             │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  UnifiedTestCasePage.js                                            │
│  ┌──────────────────────────────────────────────────────────┐     │
│  │  測試案例表格                                              │     │
│  │  ┌────┬──────────┬────────┬────────┬──────────┐          │     │
│  │  │ ID │ 問題      │ 難度    │ 狀態    │ 操作      │          │     │
│  │  ├────┼──────────┼────────┼────────┼──────────┤          │     │
│  │  │ 1  │ ULINK... │ easy   │ ✅     │ [👁️][✏️][🧪] │    │     │
│  │  │ 2  │ 如何安裝  │ easy   │ ✅     │ [👁️][✏️][🧪] │    │     │
│  │  └────┴──────────┴────────┴────────┴──────────┘          │     │
│  │                                        ↑                   │     │
│  │                                        │                   │     │
│  │                           點擊「版本比較」按鈕 (🧪)          │     │
│  └────────────────────────────────────────┼───────────────────┘     │
│                                           │                         │
│                                           ↓                         │
│  VersionComparisonModal.jsx                                         │
│  ┌──────────────────────────────────────────────────────────┐      │
│  │  🧪 版本比較測試 - ULINK 測試...                          │      │
│  │  ──────────────────────────────────────────────────────  │      │
│  │                                                           │      │
│  │  📊 測試資訊                                               │      │
│  │  問題：ULINK 測試的安裝程式和測試腳本...                    │      │
│  │  難度：easy  |  關鍵字：[20%] [100%] [33%]                │      │
│  │                                                           │      │
│  │  ⏳ 進度：[████████████████░░] 80% (4/5)                  │      │
│  │                                                           │      │
│  │  📋 測試結果表格                                           │      │
│  │  ┌────────────────────────────────────────────────┐      │      │
│  │  │ # │ 版本     │ P    │ R    │ F1   │ 狀態 │      │      │
│  │  ├───┼─────────┼──────┼──────┼──────┼──────┤      │      │
│  │  │ 1 │ V1-段落  │ 20%  │ 100% │ 33%  │ ✅   │      │      │
│  │  │ 2 │ V2-全文  │ 10%  │ 100% │ 18%  │ ✅   │      │      │
│  │  │ 3 │ V3-70-30 │ 10%  │ 100% │ 18%  │ ✅   │      │      │
│  │  │ 4 │ V4-50-50 │ 10%  │ 100% │ 18%  │ ✅   │      │      │
│  │  │ 5 │ V5-80-20 │ 測試中...            │ 🔄   │      │      │
│  │  └────────────────────────────────────────────────┘      │      │
│  │                                                           │      │
│  │  [💾 匯出]  [🔄 重測]                      [❌ 關閉]      │      │
│  └──────────────────────────────────────────────────────────┘      │
│                              │                                      │
│                              │ HTTP Request                         │
└──────────────────────────────┼──────────────────────────────────────┘
                               │
                               ↓
┌────────────────────────────────────────────────────────────────────┐
│                        API 層 (Django REST)                         │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  UnifiedBenchmarkTestCaseViewSet                                   │
│  ┌──────────────────────────────────────────────────────────┐     │
│  │                                                           │     │
│  │  @action(detail=True, methods=['post'])                  │     │
│  │  def version_comparison(self, request, pk):              │     │
│  │      """單一測試案例的版本比較測試"""                       │     │
│  │                                                           │     │
│  │      # 1. 獲取測試案例                                     │     │
│  │      test_case = self.get_object()                       │     │
│  │                                                           │     │
│  │      # 2. 創建測試器                                       │     │
│  │      tester = SingleCaseVersionTester(                   │     │
│  │          test_case_id=test_case.id,                      │     │
│  │          version_ids=[1, 2, 3, 4, 5]                     │     │
│  │      )                                                    │     │
│  │                                                           │     │
│  │      # 3. 執行測試                                         │     │
│  │      result = tester.run_comparison()                    │     │
│  │                                                           │     │
│  │      # 4. 返回結果                                         │     │
│  │      return Response({                                    │     │
│  │          'success': True,                                │     │
│  │          'results': result['results'],                   │     │
│  │          'summary': result['summary']                    │     │
│  │      })                                                   │     │
│  │                                                           │     │
│  └──────────────────────────────────────────────────────────┘     │
│                              │                                      │
└──────────────────────────────┼──────────────────────────────────────┘
                               │
                               ↓
┌────────────────────────────────────────────────────────────────────┐
│                    業務邏輯層 (Library)                             │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  SingleCaseVersionTester                                           │
│  ┌──────────────────────────────────────────────────────────┐     │
│  │                                                           │     │
│  │  def run_comparison(self):                               │     │
│  │      """執行版本比較測試"""                                 │     │
│  │                                                           │     │
│  │      results = []                                        │     │
│  │                                                           │     │
│  │      # 獲取測試案例                                        │     │
│  │      test_case = UnifiedBenchmarkTestCase.objects.get(   │     │
│  │          id=self.test_case_id                            │     │
│  │      )                                                    │     │
│  │                                                           │     │
│  │      # 獲取所有活躍版本                                    │     │
│  │      versions = SearchAlgorithmVersion.objects.filter(   │     │
│  │          is_active=True                                  │     │
│  │      )                                                    │     │
│  │                                                           │     │
│  │      # 逐個測試版本                                        │     │
│  │      for version in versions:                            │     │
│  │          ┌────────────────────────────────────┐          │     │
│  │          │ _test_single_version()             │          │     │
│  │          │                                    │          │     │
│  │          │ 1. 配置搜尋參數                     │          │     │
│  │          │    (從 version.parameters)         │          │     │
│  │          │                                    │          │     │
│  │          │ 2. 執行搜尋                         │          │     │
│  │          │    search_service.search(          │          │     │
│  │          │        query=test_case.question,   │          │     │
│  │          │        **search_params             │          │     │
│  │          │    )                               │          │     │
│  │          │                                    │          │     │
│  │          │ 3. 評估結果                         │          │     │
│  │          │    evaluator.evaluate(             │          │     │
│  │          │        results=search_results,     │          │     │
│  │          │        keywords=answer_keywords    │          │     │
│  │          │    )                               │          │     │
│  │          │    → 計算 P/R/F1                   │          │     │
│  │          │                                    │          │     │
│  │          │ 4. 儲存結果                         │          │     │
│  │          │    BenchmarkTestResult.create()    │          │     │
│  │          │                                    │          │     │
│  │          └────────────────────────────────────┘          │     │
│  │                                                           │     │
│  │          result = {                                      │     │
│  │              'version_id': version.id,                   │     │
│  │              'version_name': version.version_name,       │     │
│  │              'metrics': {                                │     │
│  │                  'precision': 0.20,                      │     │
│  │                  'recall': 1.00,                         │     │
│  │                  'f1_score': 0.33                        │     │
│  │              },                                          │     │
│  │              'status': 'success'                         │     │
│  │          }                                               │     │
│  │          results.append(result)                          │     │
│  │                                                           │     │
│  │      return {                                            │     │
│  │          'success': True,                                │     │
│  │          'results': results,                             │     │
│  │          'summary': self._generate_summary()             │     │
│  │      }                                                    │     │
│  │                                                           │     │
│  └──────────────────────────────────────────────────────────┘     │
│                              │                                      │
│          ┌──────────────────┼──────────────────┐                   │
│          │                  │                  │                   │
│          ↓                  ↓                  ↓                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │ V1 測試       │  │ V2 測試       │  │ ... V5 測試   │            │
│  │              │  │              │  │              │            │
│  │ 段落搜尋      │  │ 全文搜尋      │  │ 混合 80-20    │            │
│  │ title=95%    │  │ title=10%    │  │ section=80%  │            │
│  │ content=5%   │  │ content=90%  │  │ document=20% │            │
│  │              │  │              │  │              │            │
│  │ P: 20%       │  │ P: 10%       │  │ P: 10%       │            │
│  │ R: 100%      │  │ R: 100%      │  │ R: 100%      │            │
│  │ F1: 33%      │  │ F1: 18%      │  │ F1: 18%      │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
                               │
                               ↓
┌────────────────────────────────────────────────────────────────────┐
│                      資料庫層 (PostgreSQL)                          │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  UnifiedBenchmarkTestCase                                          │
│  ┌─────────────────────────────────────────────────────┐          │
│  │ id: 1                                                │          │
│  │ question: "ULINK 測試的安裝程式..."                   │          │
│  │ difficulty_level: "easy"                             │          │
│  │ answer_keywords: ["20%", "100%", "33%"]              │          │
│  │ test_type: "vsa"                                     │          │
│  └─────────────────────────────────────────────────────┘          │
│                                                                    │
│  SearchAlgorithmVersion                                            │
│  ┌─────────────────────────────────────────────────────┐          │
│  │ id: 1                                                │          │
│  │ version_name: "V1 - 純段落向量搜尋"                   │          │
│  │ version_code: "v3.1-section-only"                   │          │
│  │ parameters: {                                        │          │
│  │     "search_mode": "section_only",                  │          │
│  │     "stage": 1,                                     │          │
│  │     "threshold": 0.75                               │          │
│  │ }                                                    │          │
│  │ is_active: true                                      │          │
│  └─────────────────────────────────────────────────────┘          │
│                                                                    │
│  BenchmarkTestRun                                                  │
│  ┌─────────────────────────────────────────────────────┐          │
│  │ id: 456                                              │          │
│  │ test_type: "vsa"                                     │          │
│  │ batch_name: "單案例測試 - ULINK 測試..."              │          │
│  │ notes: "版本比較測試"                                 │          │
│  │ created_from: "single_case_comparison" ← 標記        │          │
│  │ created_at: 2025-11-28 10:30:00                      │          │
│  └─────────────────────────────────────────────────────┘          │
│                                                                    │
│  BenchmarkTestResult                                               │
│  ┌─────────────────────────────────────────────────────┐          │
│  │ id: 1001                                             │          │
│  │ test_run_id: 456                                     │          │
│  │ test_case_id: 1                                      │          │
│  │ version_id: 1                                        │          │
│  │ precision: 0.20                                      │          │
│  │ recall: 1.00                                         │          │
│  │ f1_score: 0.33                                       │          │
│  │ response_time: 1.23                                  │          │
│  │ status: "success"                                    │          │
│  └─────────────────────────────────────────────────────┘          │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 執行流程時序圖

```
用戶                前端               API               業務邏輯              資料庫
 │                  │                 │                   │                   │
 │  點擊「版本比較」   │                 │                   │                   │
 │─────────────────>│                 │                   │                   │
 │                  │                 │                   │                   │
 │                  │ 彈出 Modal       │                   │                   │
 │<─────────────────│                 │                   │                   │
 │                  │                 │                   │                   │
 │                  │ POST /version_comparison/           │                   │
 │                  │────────────────>│                   │                   │
 │                  │                 │                   │                   │
 │                  │                 │ 創建 SingleCaseVersionTester          │
 │                  │                 │──────────────────>│                   │
 │                  │                 │                   │                   │
 │                  │                 │                   │ 獲取測試案例       │
 │                  │                 │                   │──────────────────>│
 │                  │                 │                   │<──────────────────│
 │                  │                 │                   │ test_case data    │
 │                  │                 │                   │                   │
 │                  │                 │                   │ 獲取所有版本       │
 │                  │                 │                   │──────────────────>│
 │                  │                 │                   │<──────────────────│
 │                  │                 │                   │ versions [V1-V5]  │
 │                  │                 │                   │                   │
 │                  │ 顯示進度 20%     │                   │ 測試 V1           │
 │<─────────────────│                 │                   │ ↓                 │
 │                  │                 │                   │ 執行搜尋           │
 │                  │                 │                   │ 評估結果 (P/R/F1) │
 │                  │                 │                   │ 儲存結果           │
 │                  │                 │                   │──────────────────>│
 │                  │                 │                   │                   │
 │                  │ 顯示進度 40%     │                   │ 測試 V2           │
 │<─────────────────│                 │                   │ ↓                 │
 │                  │                 │                   │ (重複流程)         │
 │                  │                 │                   │──────────────────>│
 │                  │                 │                   │                   │
 │                  │ 顯示進度 60%     │                   │ 測試 V3           │
 │<─────────────────│                 │                   │ ↓                 │
 │                  │                 │                   │──────────────────>│
 │                  │                 │                   │                   │
 │                  │ 顯示進度 80%     │                   │ 測試 V4           │
 │<─────────────────│                 │                   │ ↓                 │
 │                  │                 │                   │──────────────────>│
 │                  │                 │                   │                   │
 │                  │ 顯示進度 100%    │                   │ 測試 V5           │
 │<─────────────────│                 │                   │ ↓                 │
 │                  │                 │                   │──────────────────>│
 │                  │                 │                   │                   │
 │                  │                 │                   │ 生成摘要           │
 │                  │                 │                   │ (best_version,    │
 │                  │                 │                   │  avg_time)        │
 │                  │                 │                   │                   │
 │                  │                 │<──────────────────│                   │
 │                  │                 │ result = {        │                   │
 │                  │                 │   success: true,  │                   │
 │                  │                 │   results: [...], │                   │
 │                  │                 │   summary: {...}  │                   │
 │                  │                 │ }                 │                   │
 │                  │<────────────────│                   │                   │
 │                  │ Response 200    │                   │                   │
 │                  │                 │                   │                   │
 │                  │ 顯示結果表格     │                   │                   │
 │<─────────────────│                 │                   │                   │
 │                  │                 │                   │                   │
 │  查看結果、排序   │                 │                   │                   │
 │  匯出報告        │                 │                   │                   │
 │─────────────────>│                 │                   │                   │
 │                  │                 │                   │                   │
```

---

## 📦 資料流向圖

```
┌─────────────────────────────────────────────────────────────────┐
│                         Input (輸入)                             │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ↓
                    ┌────────────────────────┐
                    │  測試案例 ID: 1         │
                    │  問題: "ULINK 測試..." │
                    │  關鍵字: [20%, 100%]   │
                    └────────────────────────┘
                                 │
                                 ↓
┌─────────────────────────────────────────────────────────────────┐
│                  Processing (處理流程)                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────┐      ┌─────────┐      ┌─────────┐               │
│  │ Version │      │ Version │      │ Version │               │
│  │   V1    │      │   V2    │      │ ... V5  │               │
│  └────┬────┘      └────┬────┘      └────┬────┘               │
│       │                │                │                     │
│       ↓                ↓                ↓                     │
│  ┌─────────────────────────────────────────────────┐          │
│  │  搜尋執行器 (Search Executor)                    │          │
│  │  ─────────────────────────────────────────────  │          │
│  │  • 段落搜尋 (Section Search)                    │          │
│  │  • 全文搜尋 (Document Search)                   │          │
│  │  • 混合權重搜尋 (Hybrid Search)                  │          │
│  └─────────────────────┬───────────────────────────┘          │
│                        │                                       │
│                        ↓                                       │
│  ┌─────────────────────────────────────────────────┐          │
│  │  搜尋結果 (Search Results)                       │          │
│  │  ─────────────────────────────────────────────  │          │
│  │  [                                              │          │
│  │    {                                            │          │
│  │      id: 45,                                    │          │
│  │      title: "Protocol 測試指南",                │          │
│  │      section_title: "ULINK 測試步驟",           │          │
│  │      similarity: 0.85                           │          │
│  │    },                                           │          │
│  │    ...                                          │          │
│  │  ]                                              │          │
│  └─────────────────────┬───────────────────────────┘          │
│                        │                                       │
│                        ↓                                       │
│  ┌─────────────────────────────────────────────────┐          │
│  │  結果評估器 (Result Evaluator)                   │          │
│  │  ─────────────────────────────────────────────  │          │
│  │  • 比對答案關鍵字                                │          │
│  │  • 計算 Precision (精準度)                      │          │
│  │  • 計算 Recall (召回率)                         │          │
│  │  • 計算 F1 Score                                │          │
│  └─────────────────────┬───────────────────────────┘          │
│                        │                                       │
│                        ↓                                       │
│  ┌─────────────────────────────────────────────────┐          │
│  │  測試結果 (Test Metrics)                         │          │
│  │  ─────────────────────────────────────────────  │          │
│  │  {                                              │          │
│  │    version_id: 1,                               │          │
│  │    version_name: "V1 - 純段落搜尋",             │          │
│  │    metrics: {                                   │          │
│  │      precision: 0.20,    ← 找到的正確 / 找到的全部│          │
│  │      recall: 1.00,       ← 找到的正確 / 應該找的 │          │
│  │      f1_score: 0.33      ← 2PR / (P+R)         │          │
│  │    },                                           │          │
│  │    response_time: 1.23,                         │          │
│  │    status: "success"                            │          │
│  │  }                                              │          │
│  └─────────────────────┬───────────────────────────┘          │
│                        │                                       │
│                        ↓                                       │
│  ┌─────────────────────────────────────────────────┐          │
│  │  結果儲存 (Save to Database)                     │          │
│  │  ─────────────────────────────────────────────  │          │
│  │  • 創建 BenchmarkTestRun                        │          │
│  │  • 創建 BenchmarkTestResult (×5 個版本)         │          │
│  │  • 標記 created_from = "single_case_comparison" │          │
│  └─────────────────────┬───────────────────────────┘          │
│                        │                                       │
└────────────────────────┼───────────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│                         Output (輸出)                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  {                                                              │
│    "success": true,                                             │
│    "task_id": "uuid-1234-5678",                                 │
│    "results": [                                                 │
│      {                                                          │
│        "version_id": 1,                                         │
│        "version_name": "V1 - 純段落向量搜尋",                    │
│        "version_code": "v3.1-section-only",                     │
│        "metrics": {                                             │
│          "precision": 0.20,     ← 20%                           │
│          "recall": 1.00,        ← 100%                          │
│          "f1_score": 0.33       ← 33%                           │
│        },                                                       │
│        "response_time": 1.23,                                   │
│        "status": "success"                                      │
│      },                                                         │
│      {                                                          │
│        "version_id": 2,                                         │
│        "version_name": "V2 - 純全文向量搜尋",                    │
│        "metrics": {                                             │
│          "precision": 0.10,     ← 10%                           │
│          "recall": 1.00,        ← 100%                          │
│          "f1_score": 0.18       ← 18%                           │
│        },                                                       │
│        ...                                                      │
│      },                                                         │
│      // ... V3, V4, V5                                          │
│    ],                                                           │
│    "summary": {                                                 │
│      "total_versions": 5,                                       │
│      "best_version": {                                          │
│        "version_name": "V1 - 純段落向量搜尋",                    │
│        "f1_score": 0.33                                         │
│      },                                                         │
│      "avg_response_time": 1.5,                                  │
│      "completed_at": "2025-11-28 10:30:45"                      │
│    }                                                            │
│  }                                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 關鍵指標計算公式

```
┌─────────────────────────────────────────────────────────────┐
│                   Precision (精準度)                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Precision = 找到的正確答案數 / 總共找到的答案數              │
│                                                             │
│  範例：                                                      │
│  • 答案關鍵字：["NAS", "路徑", "測試腳本"]                   │
│  • 搜尋返回 5 個結果                                         │
│  • 其中 1 個包含所有關鍵字                                   │
│                                                             │
│  Precision = 1 / 5 = 0.20 = 20%                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    Recall (召回率)                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Recall = 找到的正確答案數 / 應該找到的答案數                 │
│                                                             │
│  範例：                                                      │
│  • 資料庫中有 3 篇文章包含所有答案關鍵字                      │
│  • 搜尋找到了這 3 篇中的 3 篇                                │
│                                                             │
│  Recall = 3 / 3 = 1.00 = 100%                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     F1 Score (綜合指標)                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  F1 = 2 × (Precision × Recall) / (Precision + Recall)      │
│                                                             │
│  範例：                                                      │
│  • Precision = 0.20 (20%)                                   │
│  • Recall = 1.00 (100%)                                     │
│                                                             │
│  F1 = 2 × (0.20 × 1.00) / (0.20 + 1.00)                     │
│     = 2 × 0.20 / 1.20                                       │
│     = 0.40 / 1.20                                           │
│     = 0.33 = 33%                                            │
│                                                             │
│  ⚖️ F1 平衡了精準度和召回率                                  │
│     • 高 Precision + 低 Recall = 低 F1                      │
│     • 低 Precision + 高 Recall = 低 F1                      │
│     • 只有兩者都高，F1 才會高                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

**文檔版本**: v1.0  
**創建日期**: 2025-11-28  
**用途**: 系統架構視覺化參考
