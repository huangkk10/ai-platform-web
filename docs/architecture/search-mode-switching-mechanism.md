# å…¨æ–‡çº§æœç´¢ vs æ®µè½å‘é‡æœç´¢ï¼šåˆ‡æ¢æœºåˆ¶è¯¦è§£

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒç†è§£](#æ ¸å¿ƒç†è§£)
2. [å¸¸è§è¯¯è§£](#å¸¸è§è¯¯è§£)
3. [å®é™…è¿ä½œæœºåˆ¶](#å®é™…è¿ä½œæœºåˆ¶)
4. [æœç´¢ä¼˜å…ˆçº§](#æœç´¢ä¼˜å…ˆçº§)
5. [Dify çš„ä½œç”¨](#dify-çš„ä½œç”¨)
6. [ä»£ç å®ç°](#ä»£ç å®ç°)
7. [æ—¥å¿—è¿½è¸ª](#æ—¥å¿—è¿½è¸ª)
8. [ä¼˜åŒ–å»ºè®®](#ä¼˜åŒ–å»ºè®®)

---

## æ ¸å¿ƒç†è§£

### âš ï¸ é‡è¦äº‹å®

**ç³»ç»Ÿå¹¶ä¸ä¼šåœ¨"å…¨æ–‡æœç´¢"å’Œ"æ®µè½æœç´¢"ä¹‹é—´ä¸»åŠ¨åˆ‡æ¢**

å®é™…æƒ…å†µæ˜¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœç´¢æœåŠ¡çš„å›ºå®šæ‰§è¡Œæµç¨‹ï¼ˆæ¯æ¬¡éƒ½ç›¸åŒï¼‰                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1ï¸âƒ£ ä¼˜å…ˆï¼šæ®µè½å‘é‡æœç´¢                                    â”‚
â”‚    â”œâ”€ æœç´¢ document_section_embeddings è¡¨               â”‚
â”‚    â”œâ”€ è¿”å›åŒ¹é…çš„æ®µè½                                     â”‚
â”‚    â””â”€ å¦‚æœæˆåŠŸ â†’ è¿”å›ç»“æœ                                â”‚
â”‚                                                         â”‚
â”‚ 2ï¸âƒ£ å¤‡ç”¨ï¼šæ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢ï¼ˆä»…å½“æ®µè½æœç´¢å¤±è´¥ï¼‰             â”‚
â”‚    â”œâ”€ æœç´¢ document_embeddings è¡¨                       â”‚
â”‚    â”œâ”€ è¿”å›å®Œæ•´æ–‡æ¡£                                       â”‚
â”‚    â””â”€ threshold ç¨ä½ï¼ˆthreshold * 0.85ï¼‰                â”‚
â”‚                                                         â”‚
â”‚ 3ï¸âƒ£ è¡¥å……ï¼šå…³é”®å­—æœç´¢ï¼ˆå¦‚æœå‘é‡ç»“æœä¸è¶³ï¼‰                   â”‚
â”‚    â”œâ”€ Django ORM æŸ¥è¯¢                                   â”‚
â”‚    â”œâ”€ è¡¥å……é—æ¼çš„ç»“æœ                                     â”‚
â”‚    â””â”€ threshold æ›´ä½ï¼ˆthreshold * 0.5ï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“Š çœŸå®çš„"åˆ‡æ¢"æ˜¯ä»€ä¹ˆï¼Ÿ

**ä¸æ˜¯æœç´¢æ–¹å¼çš„åˆ‡æ¢ï¼Œè€Œæ˜¯ç»“æœç±»å‹çš„è‡ªç„¶é™çº§**ï¼š

| æƒ…å†µ | æ®µè½æœç´¢ç»“æœ | å®é™…è¿”å› | æè¿° |
|------|-------------|---------|------|
| âœ… **æ­£å¸¸** | æ‰¾åˆ°è¶³å¤Ÿæ®µè½ï¼ˆâ‰¥ limitï¼‰ | æ®µè½å†…å®¹ | æœ€å¸¸è§çš„æƒ…å†µ |
| âš ï¸ **é™çº§ 1** | æ®µè½æœç´¢å¤±è´¥ï¼ˆå¼‚å¸¸ï¼‰ | å®Œæ•´æ–‡æ¡£ | æ®µè½è¡¨æœ‰é—®é¢˜ |
| âš ï¸ **é™çº§ 2** | å‘é‡ç»“æœä¸è¶³ï¼ˆ< limitï¼‰ | æ®µè½ + å…³é”®å­— | è¡¥å……ç»“æœ |

---

## å¸¸è§è¯¯è§£

### âŒ è¯¯è§£ 1ï¼šæ·»åŠ "å®Œæ•´"ä¼šåˆ‡æ¢åˆ°å…¨æ–‡æœç´¢

**çœŸç›¸**ï¼š
- âœ… æ·»åŠ "å®Œæ•´"ä¼šå½±å“ **Dify å¦‚ä½•è§£é‡Šç»“æœ**
- âŒ ä½†**ä¸ä¼šæ”¹å˜ Python æœç´¢æœåŠ¡çš„è¡Œä¸º**
- âœ… æœç´¢æœåŠ¡æ°¸è¿œå…ˆæ‰§è¡Œæ®µè½æœç´¢

```python
# library/common/knowledge_base/base_search_service.py
def search_with_vectors(self, query, limit, threshold):
    """
    è¿™ä¸ªæ–¹æ³•ä¸ç®¡ query æ˜¯å¦å«"å®Œæ•´"
    æ°¸è¿œå…ˆæ‰§è¡Œæ®µè½æœç´¢
    """
    # ğŸ¯ ç¬¬ä¸€æ­¥ï¼šæ€»æ˜¯å…ˆæ®µè½æœç´¢
    section_results = section_service.search_sections(query, ...)
    
    if section_results:
        return section_results  # â† æˆåŠŸå°±è¿”å›æ®µè½
    
    # ğŸ”„ ç¬¬äºŒæ­¥ï¼šæ®µè½å¤±è´¥æ‰æ‰§è¡Œæ•´ç¯‡æ–‡æ¡£æœç´¢
    doc_results = search_with_vectors_generic(query, ...)
    return doc_results
```

### âŒ è¯¯è§£ 2ï¼šæ¨¡å¼ B çš„é˜¶æ®µ 2 ä¼šä½¿ç”¨ä¸åŒçš„æœç´¢ç®—æ³•

**çœŸç›¸**ï¼š
- âœ… é˜¶æ®µ 1 å’Œé˜¶æ®µ 2 è°ƒç”¨çš„æ˜¯**åŒä¸€ä¸ªæœç´¢å‡½æ•°**
- âœ… ä¸¤è€…çš„æœç´¢æµç¨‹**å®Œå…¨ç›¸åŒ**
- âœ… å”¯ä¸€åŒºåˆ«æ˜¯**ä¼ ç»™ Dify çš„æŸ¥è¯¢å­—ç¬¦ä¸²**

```python
# library/protocol_guide/two_tier_handler.py

# é˜¶æ®µ 1ï¼šæŸ¥è¯¢ = "Cup å¦‚ä½•æµ‹è¯•?"
stage_1_response = self._request_dify_chat(
    query="Cup å¦‚ä½•æµ‹è¯•?",  # åŸæŸ¥è¯¢
    is_full_search=False
)

# é˜¶æ®µ 2ï¼šæŸ¥è¯¢ = "Cup å¦‚ä½•æµ‹è¯•? å®Œæ•´"
stage_2_response = self._request_dify_chat(
    query="Cup å¦‚ä½•æµ‹è¯•?",  # åŸæŸ¥è¯¢
    is_full_search=True      # ä¼šæ·»åŠ "å®Œæ•´"
)

# âš ï¸ ä½†ä¸¤æ¬¡éƒ½ä¼šè°ƒç”¨åŒä¸€ä¸ªæœç´¢æœåŠ¡
# æœç´¢æµç¨‹éƒ½æ˜¯ï¼šæ®µè½ â†’ æ–‡æ¡£ â†’ å…³é”®å­—
```

### âŒ è¯¯è§£ 3ï¼šDify ä¼šå‘Šè¯‰æœç´¢æœåŠ¡ä½¿ç”¨å…¨æ–‡è¿˜æ˜¯æ®µè½

**çœŸç›¸**ï¼š
- âŒ Dify **ä¸ä¼šå‘é€æŒ‡ä»¤**å‘Šè¯‰æœç´¢æœåŠ¡å¦‚ä½•æœç´¢
- âœ… Dify åªæ˜¯**ä¼ é€’æŸ¥è¯¢å­—ç¬¦ä¸²**
- âœ… æœç´¢æœåŠ¡**ç‹¬ç«‹å†³å®š**å¦‚ä½•æœç´¢ï¼ˆå›ºå®šæµç¨‹ï¼‰

```
Dify è¯·æ±‚ 1:
  query: "Cup å¦‚ä½•æµ‹è¯•?"
  â†’ å¤–éƒ¨çŸ¥è¯†åº“ API
    â†’ æœç´¢æœåŠ¡ï¼šæ®µè½ â†’ æ–‡æ¡£ â†’ å…³é”®å­—
      â†’ è¿”å›ï¼š2 æ®µè½ + 1 å…³é”®å­—ç»“æœ

Dify è¯·æ±‚ 2:
  query: "Cup å¦‚ä½•æµ‹è¯•? å®Œæ•´"
  â†’ å¤–éƒ¨çŸ¥è¯†åº“ API
    â†’ æœç´¢æœåŠ¡ï¼šæ®µè½ â†’ æ–‡æ¡£ â†’ å…³é”®å­—  â† å®Œå…¨ç›¸åŒï¼
      â†’ è¿”å›ï¼š2 æ®µè½ + 1 å…³é”®å­—ç»“æœ  â† å¯èƒ½ç›¸åŒï¼
```

---

## å®é™…è¿ä½œæœºåˆ¶

### ğŸ“Š å®Œæ•´æœç´¢æµç¨‹

```
ç”¨æˆ·æŸ¥è¯¢: "Cup å¦‚ä½•æµ‹è¯•?"
    â†“
Dify Chat API
    â†“
POST /api/dify/knowledge/retrieval
{
  "query": "Cup å¦‚ä½•æµ‹è¯•?",  # æˆ– "Cup å¦‚ä½•æµ‹è¯•? å®Œæ•´"
  "top_k": 3,
  "score_threshold": 0.75
}
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DifyKnowledgeSearchHandler.search()                     â”‚
â”‚ library/dify_knowledge/__init__.py                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ ¹æ® knowledge_id é€‰æ‹©æœç´¢æœåŠ¡                         â”‚
â”‚ â€¢ è°ƒç”¨ ProtocolGuideSearchService.search_knowledge()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BaseKnowledgeBaseSearchService.search_knowledge()       â”‚
â”‚ library/common/knowledge_base/base_search_service.py   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ def search_knowledge(query, limit, threshold):          â”‚
â”‚     results = []                                        â”‚
â”‚                                                         â”‚
â”‚     # ä¼˜å…ˆï¼šå‘é‡æœç´¢                                     â”‚
â”‚     vector_results = self.search_with_vectors(...)      â”‚
â”‚     results.extend(vector_results)                      â”‚
â”‚                                                         â”‚
â”‚     # å¦‚æœç»“æœä¸è¶³ï¼Œè¡¥å……å…³é”®å­—æœç´¢                       â”‚
â”‚     if len(results) < limit:                            â”‚
â”‚         keyword_results = self.search_with_keywords(...)â”‚
â”‚         results.extend(keyword_results)                 â”‚
â”‚                                                         â”‚
â”‚     return results[:limit]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘ BaseKnowledgeBaseSearchService.search_with_vectors()    â•‘
â•‘ âš ï¸ å…³é”®æ–¹æ³•ï¼šå›ºå®šçš„ä¼˜å…ˆçº§æµç¨‹                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ æ­¥éª¤ 1ï¼šæ®µè½å‘é‡æœç´¢ï¼ˆæ€»æ˜¯å…ˆæ‰§è¡Œï¼‰                       â•‘
â•‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â•‘
â•‘ try:                                                    â•‘
â•‘     section_service = SectionSearchService()            â•‘
â•‘     section_results = section_service.search_sections(  â•‘
â•‘         query=query,                                    â•‘
â•‘         source_table='protocol_guide',                  â•‘
â•‘         limit=limit,                                    â•‘
â•‘         threshold=threshold  # 0.75                     â•‘
â•‘     )                                                   â•‘
â•‘                                                         â•‘
â•‘     if section_results:                                 â•‘
â•‘         logger.info("âœ… æ®µè½å‘é‡æœç´¢æˆåŠŸ")                â•‘
â•‘         return section_results  # â† æˆåŠŸå°±è¿”å›æ®µè½       â•‘
â•‘                                                         â•‘
â•‘ except Exception as e:                                  â•‘
â•‘     logger.warning("âš ï¸ æ®µè½æœç´¢å¤±è´¥ï¼Œä½¿ç”¨æ•´ç¯‡æ–‡æ¡£")      â•‘
â•‘     # ç»§ç»­æ‰§è¡Œæ­¥éª¤ 2                                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ æ­¥éª¤ 2ï¼šæ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢ï¼ˆä»…å½“æ­¥éª¤ 1 å¤±è´¥ï¼‰              â•‘
â•‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â•‘
â•‘ # é™ä½ thresholdï¼ˆæ›´å®½æ¾ï¼‰                              â•‘
â•‘ doc_threshold = max(threshold * 0.85, 0.5)              â•‘
â•‘ # 0.75 * 0.85 = 0.6375                                 â•‘
â•‘                                                         â•‘
â•‘ doc_results = search_with_vectors_generic(              â•‘
â•‘     query=query,                                        â•‘
â•‘     source_table='protocol_guide',                      â•‘
â•‘     threshold=doc_threshold,  # 0.6375                  â•‘
â•‘     use_1024=True  # ä½¿ç”¨ document_embeddings è¡¨        â•‘
â•‘ )                                                       â•‘
â•‘                                                         â•‘
â•‘ logger.info("ğŸ“„ æ•´ç¯‡æ–‡æ¡£æœç´¢è¿”å›ç»“æœ")                    â•‘
â•‘ return doc_results  # â† è¿”å›å®Œæ•´æ–‡æ¡£                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    â†“
è¿”å›ç»“æœç»™ Dify
```

### ğŸ” æ•°æ®åº“æŸ¥è¯¢å·®å¼‚

#### æ®µè½å‘é‡æœç´¢ï¼ˆä¼˜å…ˆï¼‰

```sql
-- è¡¨ï¼šdocument_section_embeddings
-- ç‰¹ç‚¹ï¼šæ¯ä¸ªæ®µè½ç‹¬ç«‹å‘é‡åŒ–

SELECT 
    section_id,
    source_id,           -- æ–‡æ¡£ ID
    heading_text,        -- æ®µè½æ ‡é¢˜
    content,             -- æ®µè½å†…å®¹
    parent_section_id,   -- çˆ¶æ®µè½ ID
    (1 - (embedding <=> $query_vector)) AS similarity
FROM document_section_embeddings
WHERE source_table = 'protocol_guide'
  AND (1 - (embedding <=> $query_vector)) >= 0.75  -- threshold
ORDER BY similarity DESC
LIMIT 6;  -- limit * 2

-- ç»“æœç¤ºä¾‹ï¼š
-- | section_id | source_id | heading_text   | content          | similarity |
-- |------------|-----------|----------------|------------------|------------|
-- | 20-2-1     | 20        | Cup æµ‹è¯•å‡†å¤‡   | ç¡®ä¿æµ‹è¯•ç¯å¢ƒ...   | 0.86       |
-- | 20-3-1     | 20        | æµ‹è¯•æ­¥éª¤       | 1. å‡†å¤‡æµ‹è¯•...    | 0.82       |
```

#### æ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢ï¼ˆå¤‡ç”¨ï¼‰

```sql
-- è¡¨ï¼šdocument_embeddings
-- ç‰¹ç‚¹ï¼šæ•´ç¯‡æ–‡æ¡£ä¸€ä¸ªå‘é‡

SELECT 
    id,
    source_table,
    source_id,           -- æ–‡æ¡£ ID
    text_content,        -- å®Œæ•´æ–‡æ¡£å†…å®¹
    (1 - (embedding <=> $query_vector)) AS similarity
FROM document_embeddings
WHERE source_table = 'protocol_guide'
  AND (1 - (embedding <=> $query_vector)) >= 0.6375  -- threshold * 0.85
ORDER BY similarity DESC
LIMIT 3;  -- limit

-- ç»“æœç¤ºä¾‹ï¼š
-- | id  | source_id | similarity | text_content                    |
-- |-----|-----------|------------|---------------------------------|
-- | 120 | 20        | 0.78       | # Cup æµ‹è¯•æŒ‡å—\n\n## ç›®çš„\n...   |
```

---

## æœç´¢ä¼˜å…ˆçº§

### ğŸ“Š ä¼˜å…ˆçº§è¯¦è§£

```
ä¼˜å…ˆçº§ 1ï¼šæ®µè½å‘é‡æœç´¢
â”œâ”€ æ•°æ®åº“è¡¨ï¼šdocument_section_embeddings
â”œâ”€ æœç´¢ç²’åº¦ï¼šæ®µè½çº§ï¼ˆç²¾ç¡®ï¼‰
â”œâ”€ Thresholdï¼šåŸå§‹å€¼ï¼ˆ0.75ï¼‰
â”œâ”€ è¿”å›å†…å®¹ï¼šç›¸å…³æ®µè½
â”œâ”€ ä¼˜ç‚¹ï¼šå¿«é€Ÿã€ç²¾ç¡®ã€ç›¸å…³æ€§é«˜
â””â”€ ç¼ºç‚¹ï¼šå¯èƒ½é—æ¼ä¸Šä¸‹æ–‡

    â†“ (å¦‚æœå¤±è´¥æˆ–å¼‚å¸¸)

ä¼˜å…ˆçº§ 2ï¼šæ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢
â”œâ”€ æ•°æ®åº“è¡¨ï¼šdocument_embeddings
â”œâ”€ æœç´¢ç²’åº¦ï¼šæ–‡æ¡£çº§ï¼ˆå…¨é¢ï¼‰
â”œâ”€ Thresholdï¼šé™ä½ï¼ˆ0.75 * 0.85 = 0.6375ï¼‰
â”œâ”€ è¿”å›å†…å®¹ï¼šå®Œæ•´æ–‡æ¡£
â”œâ”€ ä¼˜ç‚¹ï¼šåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
â””â”€ ç¼ºç‚¹ï¼šå†…å®¹å†—é•¿ã€ç›¸å…³æ€§å¯èƒ½è¾ƒä½

    â†“ (è¿”å›åï¼Œå¦‚æœç»“æœ < limit)

ä¼˜å…ˆçº§ 3ï¼šå…³é”®å­—æœç´¢ï¼ˆè¡¥å……ï¼‰
â”œâ”€ æœç´¢æ–¹å¼ï¼šDjango ORM æ¨¡ç³ŠåŒ¹é…
â”œâ”€ æœç´¢å­—æ®µï¼štitle, content
â”œâ”€ Thresholdï¼šæ›´ä½ï¼ˆ0.75 * 0.5 = 0.375ï¼‰
â”œâ”€ è¯„åˆ†æ–¹å¼ï¼šä½ç½® + é¢‘ç‡ + å­—æ®µæƒé‡
â”œâ”€ ä¼˜ç‚¹ï¼šæ•è·å‘é‡é—æ¼çš„ç»“æœ
â””â”€ ç¼ºç‚¹ï¼šå‡†ç¡®ç‡è¾ƒä½
```

### ğŸ¯ å®é™…æ‰§è¡Œç¤ºä¾‹

#### åœºæ™¯ 1ï¼šæ®µè½æœç´¢æˆåŠŸï¼ˆæœ€å¸¸è§ï¼‰

```
æŸ¥è¯¢: "Cup å¦‚ä½•æµ‹è¯•?"
threshold: 0.75

æ‰§è¡Œæµç¨‹ï¼š
1ï¸âƒ£ æ®µè½å‘é‡æœç´¢
   â†’ æ‰¾åˆ° 2 ä¸ªæ®µè½ï¼ˆscore: 0.86, 0.82ï¼‰
   â†’ âœ… æˆåŠŸï¼è¿”å›æ®µè½ç»“æœ
   â†’ âŒ è·³è¿‡æ•´ç¯‡æ–‡æ¡£æœç´¢
   â†’ âŒ è·³è¿‡å…³é”®å­—æœç´¢

è¿”å›ç»“æœï¼š
[
  {
    "content": "## Cup æµ‹è¯•å‡†å¤‡\nç¡®ä¿æµ‹è¯•ç¯å¢ƒ...",
    "score": 0.86,
    "title": "Cup æµ‹è¯•æŒ‡å—"
  },
  {
    "content": "## æµ‹è¯•æ­¥éª¤\n1. å‡†å¤‡æµ‹è¯•...",
    "score": 0.82,
    "title": "Cup æµ‹è¯•æŒ‡å—"
  }
]
```

#### åœºæ™¯ 2ï¼šæ®µè½æœç´¢å¤±è´¥ï¼Œé™çº§åˆ°æ–‡æ¡£æœç´¢

```
æŸ¥è¯¢: "Cup å¦‚ä½•æµ‹è¯•?"
threshold: 0.75

æ‰§è¡Œæµç¨‹ï¼š
1ï¸âƒ£ æ®µè½å‘é‡æœç´¢
   â†’ æŠ›å‡ºå¼‚å¸¸ï¼ˆdocument_section_embeddings è¡¨ä¸å­˜åœ¨ï¼‰
   â†’ âš ï¸ å¤±è´¥ï¼è¿›å…¥é™çº§æµç¨‹

2ï¸âƒ£ æ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢
   â†’ é™ä½ threshold åˆ° 0.6375
   â†’ æ‰¾åˆ° 1 ä¸ªå®Œæ•´æ–‡æ¡£ï¼ˆscore: 0.78ï¼‰
   â†’ âœ… æˆåŠŸï¼è¿”å›å®Œæ•´æ–‡æ¡£

è¿”å›ç»“æœï¼š
[
  {
    "content": "# Cup æµ‹è¯•æŒ‡å—\n\n## æµ‹è¯•ç›®çš„\n...\n## æµ‹è¯•æ­¥éª¤\n...",
    "score": 0.78,
    "title": "Cup æµ‹è¯•æŒ‡å—ï¼ˆå®Œæ•´ç‰ˆï¼‰"
  }
]
```

#### åœºæ™¯ 3ï¼šå‘é‡ç»“æœä¸è¶³ï¼Œè¡¥å……å…³é”®å­—æœç´¢

```
æŸ¥è¯¢: "Cup"
threshold: 0.75
limit: 3

æ‰§è¡Œæµç¨‹ï¼š
1ï¸âƒ£ æ®µè½å‘é‡æœç´¢
   â†’ æ‰¾åˆ° 1 ä¸ªæ®µè½ï¼ˆscore: 0.80ï¼‰
   â†’ âš ï¸ ç»“æœä¸è¶³ï¼ˆ1 < 3ï¼‰

2ï¸âƒ£ å…³é”®å­—æœç´¢è¡¥å……
   â†’ é™ä½ threshold åˆ° 0.375
   â†’ æœç´¢ title å’Œ content å« "Cup"
   â†’ æ‰¾åˆ° 2 ä¸ªé¢å¤–ç»“æœï¼ˆscore: 0.65, 0.55ï¼‰
   â†’ âœ… è¡¥å……æˆåŠŸ

è¿”å›ç»“æœï¼š
[
  {
    "content": "## Cup æµ‹è¯•å‡†å¤‡...",
    "score": 0.80,
    "source": "æ®µè½å‘é‡"
  },
  {
    "content": "Cup æ˜¯ä¸€ä¸ªæµ‹è¯•é¡¹ç›®...",
    "score": 0.65,
    "source": "å…³é”®å­—æœç´¢"
  },
  {
    "content": "æ–°èˆŠå„å€‹ç‰ˆæœ¬ä¸»æ¿ Cup...",
    "score": 0.55,
    "source": "å…³é”®å­—æœç´¢"
  }
]
```

---

## Dify çš„ä½œç”¨

### ğŸ¤” Dify å¦‚ä½•å½±å“æœç´¢ï¼Ÿ

**ç­”æ¡ˆï¼šDify ä¸ç›´æ¥æ§åˆ¶æœç´¢æ–¹å¼ï¼Œä½†å½±å“ç»“æœçš„ä½¿ç”¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dify çš„èŒè´£åˆ†å·¥                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Dify è´Ÿè´£ï¼š                                           â”‚
â”‚   â€¢ æ¥æ”¶ç”¨æˆ·æŸ¥è¯¢                                         â”‚
â”‚   â€¢ è¯»å– Prompt é…ç½®                                    â”‚
â”‚   â€¢ è°ƒç”¨å¤–éƒ¨çŸ¥è¯†åº“ API                                   â”‚
â”‚   â€¢ æ¥æ”¶æœç´¢ç»“æœ                                         â”‚
â”‚   â€¢ å°†ç»“æœä¼ é€’ç»™ LLM                                     â”‚
â”‚   â€¢ æ ¹æ® Prompt å†³å®šå¦‚ä½•ç»„ç»‡ç­”æ¡ˆ                         â”‚
â”‚                                                         â”‚
â”‚ âŒ Dify ä¸è´Ÿè´£ï¼š                                         â”‚
â”‚   â€¢ å†³å®šä½¿ç”¨æ®µè½è¿˜æ˜¯å…¨æ–‡æœç´¢                             â”‚
â”‚   â€¢ æ‰§è¡Œå®é™…çš„å‘é‡æœç´¢                                   â”‚
â”‚   â€¢ æ§åˆ¶æœç´¢ä¼˜å…ˆçº§                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“ Dify Prompt é…ç½®çš„ä½œç”¨

```
Dify å·¥ä½œå®¤ Prompt é…ç½®ç¤ºä¾‹ï¼š

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä½ æ˜¯ Protocol æµ‹è¯•ä¸“å®¶ï¼Œè´Ÿè´£å›ç­”æµ‹è¯•ç›¸å…³é—®é¢˜ã€‚

**å¦‚ä½•ä½¿ç”¨æœç´¢ç»“æœ**ï¼š

1. å½“ç”¨æˆ·æŸ¥è¯¢åŒ…å«ã€Œå®Œæ•´ã€ã€ã€Œå…¨éƒ¨ã€ã€ã€Œè¯¦ç»†ã€ç­‰å…³é”®å­—ï¼š
   â†’ ä¼˜å…ˆä½¿ç”¨ã€å®Œæ•´æ–‡æ¡£å†…å®¹ã€‘å›ç­”
   â†’ å°½å¯èƒ½è¯¦ç»†åœ°å±•å¼€è¯´æ˜
   â†’ åŒ…å«æ‰€æœ‰ç›¸å…³æ­¥éª¤å’Œæ³¨æ„äº‹é¡¹

2. å½“ç”¨æˆ·æŸ¥è¯¢ä¸åŒ…å«ä¸Šè¿°å…³é”®å­—ï¼š
   â†’ ä½¿ç”¨ã€æ®µè½æ‘˜è¦ã€‘å›ç­”
   â†’ ç®€æ´ç²¾å‡†åœ°å›ç­”é—®é¢˜æ ¸å¿ƒ
   â†’ é¿å…å†—é•¿çš„å†…å®¹

3. å¦‚æœæœç´¢ç»“æœä¸è¶³ï¼š
   â†’ æ˜ç¡®å‘ŠçŸ¥ã€Œæ‰¾ä¸åˆ°ç›¸å…³èµ„æ–™ã€
   â†’ ä¸è¦ç¼–é€ å†…å®¹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âš ï¸ é‡ç‚¹ï¼š
- Prompt ä¸ä¼šæ”¹å˜æœç´¢æœåŠ¡çš„è¡Œä¸º
- åªæ˜¯å‘Šè¯‰ LLM å¦‚ä½•ä½¿ç”¨æœç´¢ç»“æœ
- æœç´¢æœåŠ¡è¿”å›çš„ä»ç„¶æ˜¯æ®µè½ï¼ˆä¼˜å…ˆï¼‰
```

### ğŸ”„ "å®Œæ•´"å…³é”®å­—çš„å®Œæ•´æµç¨‹

```
ç”¨æˆ·æŸ¥è¯¢: "Cup å®Œæ•´æµ‹è¯•æµç¨‹"
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¨¡å¼ Aï¼šå…³é”®å­—ä¼˜å…ˆå…¨æ–‡æœç´¢                               â”‚
â”‚ (å› ä¸ºå«"å®Œæ•´"å…³é”®å­—)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 1: æ™ºèƒ½è·¯ç”±æ£€æµ‹åˆ°"å®Œæ•´" â†’ mode_a                   â”‚
â”‚ Step 2: å‘é€æŸ¥è¯¢ç»™ Dify: "Cup å®Œæ•´æµ‹è¯•æµç¨‹"             â”‚
â”‚ Step 3: Dify è¯»å– Prompt é…ç½®                           â”‚
â”‚         â†’ æ£€æµ‹åˆ°"å®Œæ•´"å…³é”®å­—                             â”‚
â”‚         â†’ å‡†å¤‡ä½¿ç”¨è¯¦ç»†æ¨¡å¼å›ç­”                           â”‚
â”‚ Step 4: Dify è°ƒç”¨å¤–éƒ¨çŸ¥è¯†åº“ API                         â”‚
â”‚         POST /api/dify/knowledge/retrieval              â”‚
â”‚         query: "Cup å®Œæ•´æµ‹è¯•æµç¨‹"                        â”‚
â”‚ Step 5: æœç´¢æœåŠ¡æ‰§è¡Œï¼ˆå›ºå®šæµç¨‹ï¼‰                         â”‚
â”‚         â”œâ”€ æ®µè½å‘é‡æœç´¢ â†’ æ‰¾åˆ° 2 æ®µè½                   â”‚
â”‚         â”œâ”€ å…³é”®å­—æœç´¢è¡¥å…… â†’ æ‰¾åˆ° 1 ç»“æœ                 â”‚
â”‚         â””â”€ è¿”å› 3 æ¡ç»“æœç»™ Dify                         â”‚
â”‚ Step 6: Dify å°†ç»“æœä¼ ç»™ LLM                             â”‚
â”‚         â€¢ ä¸Šä¸‹æ–‡ï¼š3 æ¡æœç´¢ç»“æœ                           â”‚
â”‚         â€¢ Prompt æŒ‡ç¤ºï¼šè¯¦ç»†å±•å¼€ï¼ˆå› ä¸ºå«"å®Œæ•´"ï¼‰          â”‚
â”‚ Step 7: LLM ç”Ÿæˆå›ç­”                                    â”‚
â”‚         â†’ åŸºäº 3 æ¡ç»“æœï¼ˆéƒ½æ˜¯æ®µè½ï¼‰                      â”‚
â”‚         â†’ ä½†æŒ‰ç…§"è¯¦ç»†æ¨¡å¼"ç»„ç»‡ç­”æ¡ˆ                       â”‚
â”‚         â†’ ç”Ÿæˆå®Œæ•´è¯¦ç»†çš„å›ç­”                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ç†è§£ï¼š
âœ… æœç´¢æœåŠ¡è¿”å›çš„ä»ç„¶æ˜¯æ®µè½ï¼ˆä¼˜å…ˆçº§ 1ï¼‰
âœ… "å®Œæ•´"å½±å“çš„æ˜¯ LLM å¦‚ä½•ç»„ç»‡ç­”æ¡ˆ
âœ… ä¸æ˜¯"åˆ‡æ¢åˆ°å…¨æ–‡æœç´¢"ï¼Œè€Œæ˜¯"è¯¦ç»†å±•å¼€æ®µè½å†…å®¹"
```

---

## ä»£ç å®ç°

### ğŸ“ å…³é”®ä»£ç ä½ç½®

#### 1. æœç´¢ä¼˜å…ˆçº§å®ç°

**æ–‡ä»¶**ï¼š`library/common/knowledge_base/base_search_service.py`

```python
def search_with_vectors(self, query, limit=5, threshold=0.7):
    """
    å‘é‡æœç´¢å®ç°ï¼ˆå›ºå®šä¼˜å…ˆçº§ï¼‰
    
    ä¼˜å…ˆçº§ 1ï¼šæ®µè½å‘é‡æœç´¢
    ä¼˜å…ˆçº§ 2ï¼šæ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢ï¼ˆé™çº§ï¼‰
    """
    try:
        # ğŸ¯ ä¼˜å…ˆçº§ 1ï¼šæ®µè½å‘é‡æœç´¢
        try:
            from .section_search_service import SectionSearchService
            section_service = SectionSearchService()
            
            section_results = section_service.search_sections(
                query=query,
                source_table=self.source_table,
                limit=limit,
                threshold=threshold
            )
            
            if section_results:
                self.logger.info(
                    f"âœ… æ®µè½å‘é‡æœç´¢æˆåŠŸ: {len(section_results)} ä¸ªç»“æœ "
                    f"(threshold={threshold})"
                )
                return self._format_section_results_to_standard(
                    section_results, limit
                )
        
        except Exception as section_error:
            self.logger.warning(
                f"âš ï¸ æ®µè½å‘é‡æœç´¢å¤±è´¥ï¼Œä½¿ç”¨æ•´ç¯‡æ–‡æ¡£æœç´¢: "
                f"{str(section_error)}"
            )
        
        # ğŸ”„ ä¼˜å…ˆçº§ 2ï¼šæ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢ï¼ˆé™çº§ï¼‰
        from .vector_search_helper import search_with_vectors_generic
        
        # é™ä½ thresholdï¼ˆæ›´å®½æ¾ï¼‰
        doc_threshold = max(threshold * 0.85, 0.5)
        
        results = search_with_vectors_generic(
            query=query,
            model_class=self.model_class,
            source_table=self.source_table,
            limit=limit,
            threshold=doc_threshold,
            use_1024=True,
            content_formatter=self._get_item_content
        )
        
        self.logger.info(
            f"ğŸ“„ æ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢è¿”å› {len(results)} ä¸ªç»“æœ "
            f"(threshold={doc_threshold:.2f})"
        )
        return results
        
    except Exception as e:
        self.logger.error(f"å‘é‡æœç´¢é”™è¯¯: {str(e)}")
        return []
```

#### 2. å…³é”®å­—æœç´¢è¡¥å……

**æ–‡ä»¶**ï¼š`library/common/knowledge_base/base_search_service.py`

```python
def search_knowledge(self, query, limit=5, use_vector=True, threshold=0.7):
    """
    æœç´¢çŸ¥è¯†åº“ä¸»å…¥å£
    
    æ™ºèƒ½æœç´¢ç­–ç•¥ï¼š
    1. ä¼˜å…ˆï¼šå‘é‡æœç´¢ï¼ˆæ®µè½ â†’ æ–‡æ¡£ï¼‰
    2. è¡¥å……ï¼šå…³é”®å­—æœç´¢ï¼ˆå¦‚æœç»“æœä¸è¶³ï¼‰
    """
    try:
        results = []
        
        # ğŸ¯ æ­¥éª¤ 1ï¼šå°è¯•å‘é‡æœç´¢
        if use_vector:
            try:
                vector_results = self.search_with_vectors(
                    query, limit, threshold
                )
                if vector_results:
                    results.extend(vector_results)
                    self.logger.info(
                        f"å‘é‡æœç´¢è¿”å› {len(vector_results)} æ¡ç»“æœ "
                        f"(threshold={threshold})"
                    )
            except Exception as e:
                self.logger.warning(f"å‘é‡æœç´¢å¤±è´¥: {str(e)}")
        
        # ğŸ”„ æ­¥éª¤ 2ï¼šå¦‚æœç»“æœä¸è¶³ï¼Œè¡¥å……å…³é”®å­—æœç´¢
        if len(results) < limit:
            remaining = limit - len(results)
            
            # å…³é”®å­—æœç´¢ä½¿ç”¨è¾ƒä½çš„ threshold
            keyword_threshold = max(threshold * 0.5, 0.3)
            
            keyword_results = self.search_with_keywords(
                query, remaining, keyword_threshold
            )
            
            # å»é‡
            existing_ids = {
                r.get('metadata', {}).get('id') for r in results
            }
            for kr in keyword_results:
                kr_id = kr.get('metadata', {}).get('id')
                if kr_id not in existing_ids:
                    results.append(kr)
                    existing_ids.add(kr_id)
            
            self.logger.info(
                f"å…³é”®å­—æœç´¢è¡¥å…… {len(keyword_results)} æ¡ç»“æœ "
                f"(threshold={keyword_threshold:.2f})"
            )
        
        return results[:limit]
        
    except Exception as e:
        self.logger.error(f"æœç´¢å¤±è´¥: {str(e)}")
        return []
```

---

## æ—¥å¿—è¿½è¸ª

### ğŸ“Š å¦‚ä½•é€šè¿‡æ—¥å¿—åˆ¤æ–­ä½¿ç”¨äº†å“ªç§æœç´¢ï¼Ÿ

#### æ­£å¸¸æƒ…å†µï¼šæ®µè½æœç´¢æˆåŠŸ

```log
[INFO] library.common.knowledge_base.section_search_service: 
  ğŸ“Š æ®µè½æœç´¢: source=protocol_guide, æŸ¥è¯¢='Cup å¦‚ä½•æµ‹è¯•', threshold=0.75

[INFO] library.common.knowledge_base.section_search_service: 
  âœ… æ‰¾åˆ° 2 ä¸ªæ®µè½ï¼Œç›¸ä¼¼åº¦èŒƒå›´: 0.86 ~ 0.82

[INFO] library.common.knowledge_base.base_search_service: 
  âœ… æ®µè½å‘é‡æœç´¢æˆåŠŸ: 2 ä¸ªç»“æœ (threshold=0.75)

[INFO] library.common.knowledge_base.base_search_service: 
  å‘é‡æœç´¢è¿”å› 2 æ¡ç»“æœ (threshold=0.75)

[INFO] library.dify_knowledge.DifyKnowledgeSearchHandler: 
  Protocol Guide æœç´¢ç»“æœ: 2 æ¡
```

#### é™çº§æƒ…å†µï¼šæ®µè½æœç´¢å¤±è´¥ â†’ æ•´ç¯‡æ–‡æ¡£æœç´¢

```log
[WARNING] library.common.knowledge_base.base_search_service: 
  âš ï¸ æ®µè½å‘é‡æœç´¢å¤±è´¥ï¼Œä½¿ç”¨æ•´ç¯‡æ–‡æ¡£æœç´¢: 
  relation "document_section_embeddings" does not exist

[INFO] library.common.knowledge_base.base_search_service: 
  ğŸ“„ æ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢è¿”å› 1 ä¸ªç»“æœ (threshold=0.64)

[INFO] library.common.knowledge_base.base_search_service: 
  å‘é‡æœç´¢è¿”å› 1 æ¡ç»“æœ (threshold=0.75)

[INFO] library.dify_knowledge.DifyKnowledgeSearchHandler: 
  Protocol Guide æœç´¢ç»“æœ: 1 æ¡
```

#### è¡¥å……æƒ…å†µï¼šå‘é‡ç»“æœä¸è¶³ â†’ å…³é”®å­—è¡¥å……

```log
[INFO] library.common.knowledge_base.base_search_service: 
  âœ… æ®µè½å‘é‡æœç´¢æˆåŠŸ: 1 ä¸ªç»“æœ (threshold=0.75)

[INFO] library.common.knowledge_base.base_search_service: 
  å‘é‡æœç´¢è¿”å› 1 æ¡ç»“æœ (threshold=0.75)

[INFO] library.common.knowledge_base.base_search_service: 
  ğŸ” å…³é”®å­—æœç´¢: æŸ¥è¯¢ 'Cup' è¿”å› 5 ä¸ªåŒ¹é…é¡¹

[INFO] library.common.knowledge_base.base_search_service: 
  ğŸ“Š å…³é”®å­—æœç´¢ç»“æœ: 2 æ¡ (threshold=0.38) | 
  åˆ†æ•°èŒƒå›´: 0.65 ~ 0.55

[INFO] library.common.knowledge_base.base_search_service: 
  å…³é”®å­—æœç´¢è¡¥å…… 2 æ¡ç»“æœ (threshold=0.38)

[INFO] library.dify_knowledge.DifyKnowledgeSearchHandler: 
  Protocol Guide æœç´¢ç»“æœ: 3 æ¡
```

### ğŸ” æ—¥å¿—å…³é”®è¯è¯†åˆ«

| æ—¥å¿—å†…å®¹ | å«ä¹‰ | æœç´¢ç±»å‹ |
|---------|------|---------|
| `âœ… æ®µè½å‘é‡æœç´¢æˆåŠŸ` | æ®µè½æœç´¢æˆåŠŸ | æ®µè½å‘é‡ï¼ˆä¼˜å…ˆçº§ 1ï¼‰ |
| `âš ï¸ æ®µè½å‘é‡æœç´¢å¤±è´¥` | æ®µè½æœç´¢å¤±è´¥ï¼Œå°†é™çº§ | - |
| `ğŸ“„ æ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢` | ä½¿ç”¨æ•´ç¯‡æ–‡æ¡£æœç´¢ | æ–‡æ¡£å‘é‡ï¼ˆä¼˜å…ˆçº§ 2ï¼‰ |
| `å…³é”®å­—æœç´¢è¡¥å……` | å‘é‡ç»“æœä¸è¶³ï¼Œè¡¥å……å…³é”®å­— | å…³é”®å­—æœç´¢ï¼ˆä¼˜å…ˆçº§ 3ï¼‰ |
| `threshold=0.75` | åŸå§‹ threshold | æ®µè½æœç´¢ |
| `threshold=0.64` | é™ä½çš„ threshold (0.75*0.85) | æ–‡æ¡£æœç´¢ |
| `threshold=0.38` | æ›´ä½çš„ threshold (0.75*0.5) | å…³é”®å­—æœç´¢ |

---

## ä¼˜åŒ–å»ºè®®

### ğŸ¯ å½“å‰æœºåˆ¶çš„é—®é¢˜

1. **æ— æ³•çœŸæ­£åˆ‡æ¢æœç´¢æ¨¡å¼**
   - é—®é¢˜ï¼šæ·»åŠ "å®Œæ•´"ä¸ä¼šæ”¹å˜æœç´¢è¡Œä¸º
   - å½±å“ï¼šç”¨æˆ·æœŸæœ›å…¨æ–‡æœç´¢ï¼Œä½†ä»ç„¶å¾—åˆ°æ®µè½

2. **é™çº§é€»è¾‘ä¸é€æ˜**
   - é—®é¢˜ï¼šç”¨æˆ·ä¸çŸ¥é“ä½•æ—¶ä½¿ç”¨äº†å“ªç§æœç´¢
   - å½±å“ï¼šéš¾ä»¥ç†è§£ä¸ºä½•ç»“æœä¸åŒ

3. **Threshold è°ƒæ•´ä¸å¤Ÿæ™ºèƒ½**
   - é—®é¢˜ï¼šå›ºå®šçš„å€ç‡è°ƒæ•´ï¼ˆ0.85, 0.5ï¼‰
   - å½±å“ï¼šå¯èƒ½è¿‡ä¸¥æˆ–è¿‡å®½

### ğŸ’¡ å»ºè®®çš„æ”¹è¿›æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1ï¼šæ˜¾å¼çš„æœç´¢æ¨¡å¼å‚æ•°

```python
# åœ¨ Dify è¯·æ±‚ä¸­æ·»åŠ  search_mode å‚æ•°
POST /api/dify/knowledge/retrieval
{
  "query": "Cup å¦‚ä½•æµ‹è¯•?",
  "search_mode": "section",  # æˆ– "document", "hybrid"
  "retrieval_setting": {
    "top_k": 3,
    "score_threshold": 0.75
  }
}

# æœç´¢æœåŠ¡æ ¹æ® search_mode å†³å®šè¡Œä¸º
def search_knowledge(query, search_mode='auto', ...):
    if search_mode == 'section':
        return self.search_with_vectors(...)  # åªæ®µè½
    elif search_mode == 'document':
        return self._search_documents_only(...)  # åªæ–‡æ¡£
    elif search_mode == 'hybrid':
        return self._search_hybrid(...)  # æ®µè½ + æ–‡æ¡£
    else:  # 'auto'
        return self._search_auto(...)  # å½“å‰é€»è¾‘
```

#### æ–¹æ¡ˆ 2ï¼šåŸºäºæŸ¥è¯¢åˆ†æçš„æ™ºèƒ½åˆ‡æ¢

```python
from library.common.query_analysis import analyze_query_intent

def search_knowledge(query, ...):
    # åˆ†ææŸ¥è¯¢æ„å›¾
    intent = analyze_query_intent(query)
    # {
    #   'needs_complete': True/False,
    #   'is_specific': True/False,
    #   'keywords': ['å®Œæ•´', 'è¯¦ç»†'],
    # }
    
    if intent['needs_complete']:
        # ä¼˜å…ˆæ–‡æ¡£æœç´¢
        doc_results = self._search_documents_first(...)
        if len(doc_results) >= limit:
            return doc_results
        # ä¸è¶³æ—¶è¡¥å……æ®µè½
        section_results = self._search_sections(...)
        return doc_results + section_results
    else:
        # ä¼˜å…ˆæ®µè½æœç´¢ï¼ˆå½“å‰é€»è¾‘ï¼‰
        return self._search_sections_first(...)
```

#### æ–¹æ¡ˆ 3ï¼šè¿”å›æœç´¢å…ƒæ•°æ®

```python
def search_knowledge(query, ...):
    results = []
    metadata = {
        'search_methods_used': [],
        'primary_method': None,
        'threshold_adjustments': {}
    }
    
    # æ®µè½æœç´¢
    section_results = self.search_with_vectors(...)
    if section_results:
        results.extend(section_results)
        metadata['search_methods_used'].append('section_vector')
        metadata['primary_method'] = 'section_vector'
    
    # æ–‡æ¡£æœç´¢ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if not results:
        doc_results = self._search_documents(...)
        results.extend(doc_results)
        metadata['search_methods_used'].append('document_vector')
        metadata['primary_method'] = 'document_vector'
    
    # å…³é”®å­—æœç´¢ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if len(results) < limit:
        keyword_results = self.search_with_keywords(...)
        results.extend(keyword_results)
        metadata['search_methods_used'].append('keyword')
    
    return {
        'results': results,
        'metadata': metadata  # â† å‘Šè¯‰ç”¨æˆ·ä½¿ç”¨äº†å“ªäº›æ–¹æ³•
    }
```

---

## æ€»ç»“

### âœ… æ ¸å¿ƒè¦ç‚¹

1. **æ²¡æœ‰çœŸæ­£çš„"åˆ‡æ¢"**
   - æœç´¢æœåŠ¡ä½¿ç”¨å›ºå®šçš„ä¼˜å…ˆçº§æµç¨‹
   - æ®µè½ â†’ æ–‡æ¡£ â†’ å…³é”®å­—
   - æ¯æ¬¡éƒ½æ‰§è¡Œç›¸åŒçš„é€»è¾‘

2. **"å®Œæ•´"çš„ä½œç”¨**
   - âœ… å½±å“ Dify çš„ Prompt è¡Œä¸º
   - âœ… å‘Šè¯‰ LLM å¦‚ä½•ç»„ç»‡ç­”æ¡ˆ
   - âŒ ä¸æ”¹å˜æœç´¢æœåŠ¡çš„è¡Œä¸º

3. **é™çº§æ˜¯è‡ªåŠ¨çš„**
   - æ®µè½æœç´¢å¤±è´¥ â†’ è‡ªåŠ¨é™çº§åˆ°æ–‡æ¡£æœç´¢
   - å‘é‡ç»“æœä¸è¶³ â†’ è‡ªåŠ¨è¡¥å……å…³é”®å­—æœç´¢
   - Threshold è‡ªåŠ¨è°ƒæ•´ï¼ˆ0.85, 0.5 å€ç‡ï¼‰

4. **é€æ˜åº¦ä¸è¶³**
   - ç”¨æˆ·ä¸çŸ¥é“ä½¿ç”¨äº†å“ªç§æœç´¢
   - éœ€è¦æŸ¥çœ‹æ—¥å¿—æ‰èƒ½ç¡®è®¤
   - å»ºè®®æ·»åŠ æœç´¢å…ƒæ•°æ®è¿”å›

### ğŸ¯ å®ç”¨å»ºè®®

1. **ç›‘æ§æ—¥å¿—**ï¼šå®šæœŸæ£€æŸ¥æœç´¢æ—¥å¿—ï¼Œäº†è§£é™çº§é¢‘ç‡
2. **è°ƒæ•´ Threshold**ï¼šæ ¹æ®å®é™…æ•ˆæœè°ƒæ•´åŸºç¡€ threshold
3. **ä¼˜åŒ–æ®µè½å‘é‡**ï¼šç¡®ä¿æ®µè½å‘é‡è¡¨æ•°æ®å®Œæ•´ä¸”å‡†ç¡®
4. **æ”¹è¿› Prompt**ï¼šä¼˜åŒ– Dify Prompt ä»¥æ›´å¥½åœ°ä½¿ç”¨æœç´¢ç»“æœ

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æ›´æ–°æ—¥æœŸ**ï¼š2025-11-12  
**ä½œè€…**ï¼šAI Platform Team  
**ç›¸å…³æ–‡æ¡£**ï¼š
- `docs/architecture/mode-b-two-tier-search-complete-flow.md`
- `docs/vector-search/vector-search-guide.md`
