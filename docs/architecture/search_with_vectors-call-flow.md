# search_with_vectors() è°ƒç”¨æµç¨‹å®Œæ•´è§£æ

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒè°ƒç”¨é“¾](#æ ¸å¿ƒè°ƒç”¨é“¾)
2. [å®Œæ•´æµç¨‹å›¾](#å®Œæ•´æµç¨‹å›¾)
3. [å„å±‚çº§è¯¦è§£](#å„å±‚çº§è¯¦è§£)
4. [å®é™…ä½¿ç”¨åœºæ™¯](#å®é™…ä½¿ç”¨åœºæ™¯)
5. [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)

---

## æ ¸å¿ƒè°ƒç”¨é“¾

### ğŸ¯ ä¸»è¦è°ƒç”¨è·¯å¾„

```
ç”¨æˆ·æŸ¥è¯¢ "Cup å¦‚ä½•æµ‹è¯•?"
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±‚çº§ 1ï¼šDify Chat API                                   â”‚
â”‚ http://10.10.172.37/v1/chat-messages                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±‚çº§ 2ï¼šDjango API ç«¯ç‚¹                                 â”‚
â”‚ POST /api/dify/knowledge/retrieval                      â”‚
â”‚ backend/api/views/dify_knowledge_views.py               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±‚çº§ 3ï¼šçŸ¥è¯†åº“æœç´¢å¤„ç†å™¨                                 â”‚
â”‚ DifyKnowledgeSearchHandler.search()                     â”‚
â”‚ library/dify_knowledge/__init__.py                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±‚çº§ 4ï¼šæœç´¢æœåŠ¡å…¥å£                                     â”‚
â”‚ BaseKnowledgeBaseSearchService.search_knowledge()       â”‚
â”‚ library/common/knowledge_base/base_search_service.py    â”‚
â”‚ (line 48-95)                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘ å±‚çº§ 5ï¼šå‘é‡æœç´¢æ–¹æ³• â­ æ ¸å¿ƒç„¦ç‚¹                         â•‘
â•‘ BaseKnowledgeBaseSearchService.search_with_vectors()    â•‘
â•‘ library/common/knowledge_base/base_search_service.py    â•‘
â•‘ (line 99-157) â† æ‚¨å½“å‰æŸ¥çœ‹çš„æ–¹æ³•                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ å­æµç¨‹ 5.1ï¼šæ®µè½å‘é‡æœç´¢ï¼ˆä¼˜å…ˆï¼‰                         â•‘
â•‘   â†’ SectionSearchService.search_sections()              â•‘
â•‘      library/common/knowledge_base/                     â•‘
â•‘      section_search_service.py                          â•‘
â•‘                                                         â•‘
â•‘ å­æµç¨‹ 5.2ï¼šæ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢ï¼ˆé™çº§ï¼‰                     â•‘
â•‘   â†’ search_with_vectors_generic()                       â•‘
â•‘      library/common/knowledge_base/                     â•‘
â•‘      vector_search_helper.py                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±‚çº§ 6ï¼šæ•°æ®åº“å‘é‡æœç´¢                                   â”‚
â”‚ PostgreSQL + pgvector                                   â”‚
â”‚ â€¢ document_section_embeddings (æ®µè½å‘é‡è¡¨)              â”‚
â”‚ â€¢ document_embeddings (æ•´ç¯‡æ–‡æ¡£å‘é‡è¡¨)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®Œæ•´æµç¨‹å›¾

### ğŸ“Š è¯¦ç»†è°ƒç”¨æµç¨‹ï¼ˆå¸¦å‚æ•°ä¼ é€’ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Dify Chat API è¯·æ±‚                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST http://10.10.172.37/v1/chat-messages              â”‚
â”‚ {                                                       â”‚
â”‚   "query": "Cup å¦‚ä½•æµ‹è¯•?",                             â”‚
â”‚   "inputs": {...},                                      â”‚
â”‚   "user": "user_123"                                    â”‚
â”‚ }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Dify å†…éƒ¨å¤„ç†ï¼ˆé»‘ç›’ï¼‰                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è¯»å– Prompt é…ç½®                                      â”‚
â”‚ â€¢ åˆ†ææŸ¥è¯¢æ„å›¾                                          â”‚
â”‚ â€¢ å†³å®šæ˜¯å¦è°ƒç”¨å¤–éƒ¨çŸ¥è¯†åº“                                 â”‚
â”‚ â€¢ æ„é€ çŸ¥è¯†åº“æŸ¥è¯¢è¯·æ±‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å¤–éƒ¨çŸ¥è¯†åº“ API è°ƒç”¨                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST /api/dify/knowledge/retrieval                      â”‚
â”‚ {                                                       â”‚
â”‚   "knowledge_id": "protocol_database",                  â”‚
â”‚   "query": "Cup å¦‚ä½•æµ‹è¯•?",                             â”‚
â”‚   "retrieval_setting": {                                â”‚
â”‚     "top_k": 3,            â† limit å‚æ•°                 â”‚
â”‚     "score_threshold": 0.75 â† threshold å‚æ•°            â”‚
â”‚   }                                                     â”‚
â”‚ }                                                       â”‚
â”‚                                                         â”‚
â”‚ æ–‡ä»¶ï¼šbackend/api/views/dify_knowledge_views.py         â”‚
â”‚ å‡½æ•°ï¼šexternal_knowledge_api()                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. çŸ¥è¯†åº“æœç´¢å¤„ç†å™¨                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DifyKnowledgeSearchHandler.search()                     â”‚
â”‚                                                         â”‚
â”‚ æ ¹æ® knowledge_id è·¯ç”±åˆ°å¯¹åº”æœåŠ¡ï¼š                      â”‚
â”‚ â€¢ "protocol_database" â†’ ProtocolGuideSearchService      â”‚
â”‚ â€¢ "rvt_guide" â†’ RvtGuideSearchService                   â”‚
â”‚                                                         â”‚
â”‚ æ–‡ä»¶ï¼šlibrary/dify_knowledge/__init__.py                â”‚
â”‚ è¡Œæ•°ï¼š399                                               â”‚
â”‚ ä»£ç ï¼š                                                  â”‚
â”‚   search_results = self.search_knowledge_by_type(       â”‚
â”‚       knowledge_type=knowledge_type,                    â”‚
â”‚       query=query,                                      â”‚
â”‚       limit=top_k,        # 3                           â”‚
â”‚       threshold=threshold # 0.75                        â”‚
â”‚   )                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æœç´¢æœåŠ¡ï¼šsearch_knowledge()                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BaseKnowledgeBaseSearchService.search_knowledge()       â”‚
â”‚                                                         â”‚
â”‚ æ–‡ä»¶ï¼šlibrary/common/knowledge_base/base_search_service.pyâ”‚
â”‚ è¡Œæ•°ï¼š48-95                                             â”‚
â”‚                                                         â”‚
â”‚ å‚æ•°ä¼ é€’ï¼š                                              â”‚
â”‚   query = "Cup å¦‚ä½•æµ‹è¯•?"                               â”‚
â”‚   limit = 3                                             â”‚
â”‚   use_vector = True                                     â”‚
â”‚   threshold = 0.75                                      â”‚
â”‚                                                         â”‚
â”‚ ä¸»è¦é€»è¾‘ï¼š                                              â”‚
â”‚   if use_vector:                                        â”‚
â”‚       vector_results = self.search_with_vectors(        â”‚
â”‚           query=query,       # "Cup å¦‚ä½•æµ‹è¯•?"          â”‚
â”‚           limit=limit,       # 3                        â”‚
â”‚           threshold=threshold # 0.75                    â”‚
â”‚       )                                                 â”‚
â”‚       results.extend(vector_results)                    â”‚
â”‚                                                         â”‚
â”‚   # å¦‚æœç»“æœä¸è¶³ï¼Œè¡¥å……å…³é”®å­—æœç´¢                          â”‚
â”‚   if len(results) < limit:                              â”‚
â”‚       keyword_results = self.search_with_keywords(...)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘ 6. å‘é‡æœç´¢æ–¹æ³•ï¼šsearch_with_vectors() â­ æ ¸å¿ƒ          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ BaseKnowledgeBaseSearchService.search_with_vectors()    â•‘
â•‘                                                         â•‘
â•‘ æ–‡ä»¶ï¼šlibrary/common/knowledge_base/base_search_service.pyâ•‘
â•‘ è¡Œæ•°ï¼š99-157                                            â•‘
â•‘                                                         â•‘
â•‘ å‚æ•°ï¼š                                                  â•‘
â•‘   query = "Cup å¦‚ä½•æµ‹è¯•?"                               â•‘
â•‘   limit = 3                                             â•‘
â•‘   threshold = 0.75                                      â•‘
â•‘                                                         â•‘
â•‘ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘ â”‚ æ­¥éª¤ 6.1ï¼šä¼˜å…ˆå°è¯•æ®µè½å‘é‡æœç´¢                   â”‚   â•‘
â•‘ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â•‘
â•‘ â”‚ try:                                            â”‚   â•‘
â•‘ â”‚     section_service = SectionSearchService()    â”‚   â•‘
â•‘ â”‚     section_results = section_service.          â”‚   â•‘
â•‘ â”‚         search_sections(                        â”‚   â•‘
â•‘ â”‚             query="Cup å¦‚ä½•æµ‹è¯•?",              â”‚   â•‘
â•‘ â”‚             source_table='protocol_guide',      â”‚   â•‘
â•‘ â”‚             limit=3,                            â”‚   â•‘
â•‘ â”‚             threshold=0.75                      â”‚   â•‘
â•‘ â”‚         )                                       â”‚   â•‘
â•‘ â”‚                                                 â”‚   â•‘
â•‘ â”‚     if section_results:                         â”‚   â•‘
â•‘ â”‚         logger.info("âœ… æ®µè½å‘é‡æœç´¢æˆåŠŸ")        â”‚   â•‘
â•‘ â”‚         return section_results  # â† æˆåŠŸè¿”å›    â”‚   â•‘
â•‘ â”‚                                                 â”‚   â•‘
â•‘ â”‚ except Exception as e:                          â”‚   â•‘
â•‘ â”‚     logger.warning("âš ï¸ æ®µè½æœç´¢å¤±è´¥ï¼Œé™çº§...")  â”‚   â•‘
â•‘ â”‚     # ç»§ç»­æ‰§è¡Œæ­¥éª¤ 6.2                          â”‚   â•‘
â•‘ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘     â†“                                                   â•‘
â•‘ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘ â”‚ æ­¥éª¤ 6.2ï¼šé™çº§åˆ°æ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢                 â”‚   â•‘
â•‘ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â•‘
â•‘ â”‚ # é™ä½ thresholdï¼ˆæ›´å®½æ¾çš„åŒ¹é…ï¼‰                â”‚   â•‘
â•‘ â”‚ doc_threshold = max(threshold * 0.85, 0.5)      â”‚   â•‘
â•‘ â”‚ # 0.75 * 0.85 = 0.6375                         â”‚   â•‘
â•‘ â”‚                                                 â”‚   â•‘
â•‘ â”‚ from .vector_search_helper import \             â”‚   â•‘
â•‘ â”‚     search_with_vectors_generic                 â”‚   â•‘
â•‘ â”‚                                                 â”‚   â•‘
â•‘ â”‚ results = search_with_vectors_generic(          â”‚   â•‘
â•‘ â”‚     query="Cup å¦‚ä½•æµ‹è¯•?",                      â”‚   â•‘
â•‘ â”‚     model_class=ProtocolGuide,                  â”‚   â•‘
â•‘ â”‚     source_table='protocol_guide',              â”‚   â•‘
â•‘ â”‚     limit=3,                                    â”‚   â•‘
â•‘ â”‚     threshold=0.6375,  # â† é™ä½çš„é˜ˆå€¼           â”‚   â•‘
â•‘ â”‚     use_1024=True,     # ä½¿ç”¨ 1024 ç»´å‘é‡      â”‚   â•‘
â•‘ â”‚     content_formatter=self._get_item_content    â”‚   â•‘
â•‘ â”‚ )                                               â”‚   â•‘
â•‘ â”‚                                                 â”‚   â•‘
â•‘ â”‚ logger.info("ğŸ“„ æ•´ç¯‡æ–‡æ¡£æœç´¢è¿”å›ç»“æœ")           â”‚   â•‘
â•‘ â”‚ return results  # â† è¿”å›æ–‡æ¡£çº§ç»“æœ              â”‚   â•‘
â•‘ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. æ•°æ®åº“å‘é‡æœç´¢æ‰§è¡Œ                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 7.1 æ®µè½å‘é‡æœç´¢ï¼ˆå¦‚æœæ­¥éª¤ 6.1 æˆåŠŸï¼‰                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ SQL:                                                    â”‚
â”‚   SELECT                                                â”‚
â”‚       section_id,                                       â”‚
â”‚       source_id,                                        â”‚
â”‚       heading_text,                                     â”‚
â”‚       content,                                          â”‚
â”‚       (1 - (embedding <=> $query_vector)) AS similarity â”‚
â”‚   FROM document_section_embeddings                      â”‚
â”‚   WHERE source_table = 'protocol_guide'                 â”‚
â”‚     AND (1 - (embedding <=> $query_vector)) >= 0.75     â”‚
â”‚   ORDER BY similarity DESC                              â”‚
â”‚   LIMIT 6;  -- limit * 2                                â”‚
â”‚                                                         â”‚
â”‚ 7.2 æ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢ï¼ˆå¦‚æœæ­¥éª¤ 6.2 æ‰§è¡Œï¼‰               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ SQL:                                                    â”‚
â”‚   SELECT                                                â”‚
â”‚       id,                                               â”‚
â”‚       source_id,                                        â”‚
â”‚       text_content,                                     â”‚
â”‚       (1 - (embedding <=> $query_vector)) AS similarity â”‚
â”‚   FROM document_embeddings                              â”‚
â”‚   WHERE source_table = 'protocol_guide'                 â”‚
â”‚     AND (1 - (embedding <=> $query_vector)) >= 0.6375   â”‚
â”‚   ORDER BY similarity DESC                              â”‚
â”‚   LIMIT 3;                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. ç»“æœè¿”å›ï¼ˆé€å±‚å›ä¼ ï¼‰                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ•°æ®åº“ â†’ search_with_vectors() â†’ search_knowledge() â†’  â”‚
â”‚ DifyKnowledgeSearchHandler â†’ Django API â†’              â”‚
â”‚ Dify Chat API â†’ ç”¨æˆ·                                    â”‚
â”‚                                                         â”‚
â”‚ æœ€ç»ˆè¿”å›æ ¼å¼ï¼š                                          â”‚
â”‚ {                                                       â”‚
â”‚   "records": [                                          â”‚
â”‚     {                                                   â”‚
â”‚       "content": "## Cup æµ‹è¯•å‡†å¤‡\nç¡®ä¿æµ‹è¯•ç¯å¢ƒ...",    â”‚
â”‚       "score": 0.86,                                    â”‚
â”‚       "title": "Cup æµ‹è¯•æŒ‡å—",                          â”‚
â”‚       "metadata": {...}                                 â”‚
â”‚     },                                                  â”‚
â”‚     {...}                                               â”‚
â”‚   ]                                                     â”‚
â”‚ }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å„å±‚çº§è¯¦è§£

### å±‚çº§ 1ï¼šDify Chat API

**èŒè´£**ï¼šæ¥æ”¶ç”¨æˆ·æŸ¥è¯¢ï¼Œåè°ƒæ•´ä¸ª AI å¯¹è¯æµç¨‹

**æ–‡ä»¶ä½ç½®**ï¼šå¤–éƒ¨æœåŠ¡ï¼ˆDify Studioï¼‰

**å…³é”®é…ç½®**ï¼š
- Base URL: `http://10.10.172.37`
- Endpoint: `/v1/chat-messages`
- å¤–éƒ¨çŸ¥è¯†åº“é…ç½®åœ¨ Dify Studio ä¸­è®¾ç½®

---

### å±‚çº§ 2ï¼šDjango API ç«¯ç‚¹

**èŒè´£**ï¼šä½œä¸º Dify çš„å¤–éƒ¨çŸ¥è¯†åº“ API

**æ–‡ä»¶**ï¼š`backend/api/views/dify_knowledge_views.py`

**å…³é”®ä»£ç **ï¼š
```python
@csrf_exempt
def external_knowledge_api(request):
    """
    Dify å¤–éƒ¨çŸ¥è­˜åº« API (ç¬¦åˆå®˜æ–¹è¦æ ¼)
    
    æ¥æ”¶ Dify çš„æŸ¥è©¢è«‹æ±‚ï¼š
    - knowledge_id: çŸ¥è­˜åº« ID
    - query: æŸ¥è©¢æ–‡æœ¬
    - retrieval_setting: {top_k, score_threshold}
    """
    # è§£æè¯·æ±‚
    knowledge_id = data.get('knowledge_id')
    query = data.get('query')
    top_k = retrieval_setting.get('top_k', 5)
    threshold = retrieval_setting.get('score_threshold', 0.7)
    
    # è°ƒç”¨æœç´¢å¤„ç†å™¨
    search_results = search_handler.search(
        knowledge_id=knowledge_id,
        query=query,
        limit=top_k,
        threshold=threshold
    )
```

---

### å±‚çº§ 3ï¼šçŸ¥è¯†åº“æœç´¢å¤„ç†å™¨

**èŒè´£**ï¼šæ ¹æ® knowledge_id è·¯ç”±åˆ°å¯¹åº”çš„æœç´¢æœåŠ¡

**æ–‡ä»¶**ï¼š`library/dify_knowledge/__init__.py`

**å…³é”®ä»£ç **ï¼š
```python
class DifyKnowledgeSearchHandler:
    def search(self, knowledge_id, query, limit, threshold):
        """æ ¹æ® knowledge_id è·¯ç”±æœç´¢"""
        
        # æ˜ å°„ knowledge_id åˆ°çŸ¥è¯†ç±»å‹
        knowledge_mapping = {
            'protocol_database': 'protocol_guide',
            'rvt_guide': 'rvt_guide',
            # ...
        }
        
        knowledge_type = knowledge_mapping.get(knowledge_id)
        
        # è°ƒç”¨å¯¹åº”çš„æœç´¢æœåŠ¡
        return self.search_knowledge_by_type(
            knowledge_type=knowledge_type,
            query=query,
            limit=limit,
            threshold=threshold
        )
    
    def search_knowledge_by_type(self, knowledge_type, query, limit, threshold):
        """è°ƒç”¨å…·ä½“çš„æœç´¢æœåŠ¡"""
        if knowledge_type == 'protocol_guide':
            return self.search_protocol_guide_knowledge(
                query, limit, use_vector=True, threshold=threshold
            )
        elif knowledge_type == 'rvt_guide':
            return self.search_rvt_guide_knowledge(
                query, limit, use_vector=True, threshold=threshold
            )
```

---

### å±‚çº§ 4ï¼šæœç´¢æœåŠ¡å…¥å£

**èŒè´£**ï¼šç»Ÿä¸€çš„æœç´¢å…¥å£ï¼Œåè°ƒå‘é‡æœç´¢å’Œå…³é”®å­—æœç´¢

**æ–‡ä»¶**ï¼š`library/common/knowledge_base/base_search_service.py`

**æ–¹æ³•**ï¼š`search_knowledge()` (line 48-95)

**å…³é”®é€»è¾‘**ï¼š
```python
def search_knowledge(self, query, limit, use_vector, threshold):
    """
    æ™ºèƒ½æœç´¢ç­–ç•¥ï¼š
    1. ä¼˜å…ˆå°è¯•å‘é‡æœç´¢
    2. å¦‚æœç»“æœä¸è¶³ï¼Œè¡¥å……å…³é”®å­—æœç´¢
    """
    results = []
    
    # æ­¥éª¤ 1ï¼šå°è¯•å‘é‡æœç´¢
    if use_vector:
        vector_results = self.search_with_vectors(
            query=query,
            limit=limit,
            threshold=threshold  # â† ä¼ é€’ threshold
        )
        results.extend(vector_results)
    
    # æ­¥éª¤ 2ï¼šå¦‚æœç»“æœä¸è¶³ï¼Œè¡¥å……å…³é”®å­—æœç´¢
    if len(results) < limit:
        keyword_threshold = max(threshold * 0.5, 0.3)
        keyword_results = self.search_with_keywords(
            query=query,
            limit=remaining,
            threshold=keyword_threshold
        )
        results.extend(keyword_results)
    
    return results[:limit]
```

**é‡è¦ç‰¹æ€§**ï¼š
- âœ… å‘é‡æœç´¢ä¼˜å…ˆ
- âœ… å…³é”®å­—æœç´¢ä½œä¸ºè¡¥å……
- âœ… è‡ªåŠ¨å»é‡
- âœ… Threshold å®Œå…¨å‚æ•°åŒ–ï¼ˆæ¥è‡ª Dify Studioï¼‰

---

### â­ å±‚çº§ 5ï¼šå‘é‡æœç´¢æ ¸å¿ƒæ–¹æ³•

**èŒè´£**ï¼šæ‰§è¡Œå®é™…çš„å‘é‡æœç´¢ï¼Œå›ºå®šä¼˜å…ˆçº§æµç¨‹

**æ–‡ä»¶**ï¼š`library/common/knowledge_base/base_search_service.py`

**æ–¹æ³•**ï¼š`search_with_vectors()` (line 99-157)

**è¿™å°±æ˜¯æ‚¨å½“å‰æŸ¥çœ‹çš„æ–¹æ³•ï¼**

#### è¯¦ç»†æ‰§è¡Œæµç¨‹

```python
def search_with_vectors(self, query, limit=5, threshold=0.7):
    """
    å‘é‡æœç´¢å®ç°ï¼ˆå›ºå®šä¼˜å…ˆçº§ï¼‰
    
    ä¼˜å…ˆçº§ 1ï¼šæ®µè½å‘é‡æœç´¢
    ä¼˜å…ˆçº§ 2ï¼šæ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢ï¼ˆé™çº§ï¼‰
    
    Args:
        query: æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆå¦‚ "Cup å¦‚ä½•æµ‹è¯•?"ï¼‰
        limit: è¿”å›ç»“æœæ•°é‡ï¼ˆå¦‚ 3ï¼‰
        threshold: ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆå¦‚ 0.75ï¼Œæ¥è‡ª Dify Studioï¼‰
    """
    
    # ========================================
    # æ­¥éª¤ 1ï¼šä¼˜å…ˆå°è¯•æ®µè½å‘é‡æœç´¢
    # ========================================
    try:
        from .section_search_service import SectionSearchService
        section_service = SectionSearchService()
        
        section_results = section_service.search_sections(
            query=query,              # "Cup å¦‚ä½•æµ‹è¯•?"
            source_table=self.source_table,  # 'protocol_guide'
            limit=limit,              # 3
            threshold=threshold       # 0.75
        )
        
        if section_results:
            # ğŸ‰ æ®µè½æœç´¢æˆåŠŸï¼
            self.logger.info(
                f"âœ… æ®µè½å‘é‡æœç´¢æˆåŠŸ: {len(section_results)} ä¸ªç»“æœ "
                f"(threshold={threshold})"
            )
            
            # è½¬æ¢æ®µè½ç»“æœä¸ºæ ‡å‡†æ ¼å¼å¹¶è¿”å›
            return self._format_section_results_to_standard(
                section_results, limit
            )
    
    except Exception as section_error:
        # æ®µè½æœç´¢å¤±è´¥ï¼Œè®°å½•è­¦å‘Š
        self.logger.warning(
            f"âš ï¸ æ®µè½å‘é‡æœç´¢å¤±è´¥ï¼Œä½¿ç”¨æ•´ç¯‡æ–‡æ¡£æœç´¢: "
            f"{str(section_error)}"
        )
        # ç»§ç»­æ‰§è¡Œæ­¥éª¤ 2
    
    # ========================================
    # æ­¥éª¤ 2ï¼šé™çº§åˆ°æ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢
    # ========================================
    from .vector_search_helper import search_with_vectors_generic
    
    # é™ä½ thresholdï¼ˆæ›´å®½æ¾çš„åŒ¹é…æ¡ä»¶ï¼‰
    doc_threshold = max(threshold * 0.85, 0.5)
    # ä¾‹å¦‚ï¼š0.75 * 0.85 = 0.6375
    
    results = search_with_vectors_generic(
        query=query,                  # "Cup å¦‚ä½•æµ‹è¯•?"
        model_class=self.model_class, # ProtocolGuide
        source_table=self.source_table, # 'protocol_guide'
        limit=limit,                  # 3
        threshold=doc_threshold,      # 0.6375ï¼ˆé™ä½åï¼‰
        use_1024=True,                # ä½¿ç”¨ 1024 ç»´å‘é‡
        content_formatter=self._get_item_content  # å†…å®¹æ ¼å¼åŒ–å‡½æ•°
    )
    
    self.logger.info(
        f"ğŸ“„ æ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢è¿”å› {len(results)} ä¸ªç»“æœ "
        f"(threshold={doc_threshold:.2f})"
    )
    
    return results
```

#### å…³é”®å†³ç­–ç‚¹

| å†³ç­–ç‚¹ | æ¡ä»¶ | ç»“æœ |
|--------|------|------|
| **æ˜¯å¦æ‰§è¡Œæ®µè½æœç´¢ï¼Ÿ** | æ€»æ˜¯æ‰§è¡Œï¼ˆtry å—ï¼‰ | æ‰§è¡Œ `search_sections()` |
| **æ®µè½æœç´¢æ˜¯å¦æˆåŠŸï¼Ÿ** | `section_results` ä¸ä¸ºç©º | âœ… è¿”å›æ®µè½ç»“æœï¼Œç»“æŸ |
| **æ®µè½æœç´¢å¤±è´¥ï¼Ÿ** | æŠ›å‡ºå¼‚å¸¸æˆ–è¿”å›ç©º | âš ï¸ ç»§ç»­æ‰§è¡Œæ–‡æ¡£æœç´¢ |
| **æ–‡æ¡£æœç´¢é˜ˆå€¼ï¼Ÿ** | `threshold * 0.85` | ä½¿ç”¨æ›´å®½æ¾çš„é˜ˆå€¼ |
| **æ–‡æ¡£æœç´¢è¡¨ï¼Ÿ** | `document_embeddings` | ä½¿ç”¨ 1024 ç»´å‘é‡è¡¨ |

---

### å±‚çº§ 6ï¼šæ•°æ®åº“å‘é‡æœç´¢

**èŒè´£**ï¼šæ‰§è¡Œå®é™…çš„ SQL æŸ¥è¯¢ï¼Œä½¿ç”¨ pgvector æ‰©å±•

#### 6.1 æ®µè½å‘é‡æœç´¢

**æ–‡ä»¶**ï¼š`library/common/knowledge_base/section_search_service.py`

**æ–¹æ³•**ï¼š`search_sections()`

**SQL æŸ¥è¯¢**ï¼š
```sql
SELECT 
    section_id,
    source_id,
    heading_text,
    content,
    parent_section_id,
    (1 - (embedding <=> %s::vector)) AS similarity
FROM document_section_embeddings
WHERE source_table = %s
  AND (1 - (embedding <=> %s::vector)) >= %s
ORDER BY similarity DESC
LIMIT %s;

-- å‚æ•°ç»‘å®šï¼š
-- %s (1) = query_vector (1024 ç»´å‘é‡)
-- %s (2) = 'protocol_guide'
-- %s (3) = query_vector (å†æ¬¡)
-- %s (4) = 0.75 (threshold)
-- %s (5) = 6 (limit * 2)
```

**è¿”å›ç¤ºä¾‹**ï¼š
```python
[
    {
        'section_id': '20-2-1',
        'source_id': 20,
        'heading_text': 'Cup æµ‹è¯•å‡†å¤‡',
        'content': 'ç¡®ä¿æµ‹è¯•ç¯å¢ƒå·²è®¾ç½®...',
        'similarity': 0.86
    },
    {
        'section_id': '20-3-1',
        'source_id': 20,
        'heading_text': 'æµ‹è¯•æ­¥éª¤',
        'content': '1. å‡†å¤‡æµ‹è¯•...',
        'similarity': 0.82
    }
]
```

#### 6.2 æ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢

**æ–‡ä»¶**ï¼š`library/common/knowledge_base/vector_search_helper.py`

**æ–¹æ³•**ï¼š`search_with_vectors_generic()`

**SQL æŸ¥è¯¢**ï¼š
```sql
SELECT 
    id,
    source_table,
    source_id,
    text_content,
    (1 - (embedding <=> %s::vector)) AS similarity
FROM document_embeddings
WHERE source_table = %s
  AND (1 - (embedding <=> %s::vector)) >= %s
ORDER BY similarity DESC
LIMIT %s;

-- å‚æ•°ç»‘å®šï¼š
-- %s (1) = query_vector (1024 ç»´å‘é‡)
-- %s (2) = 'protocol_guide'
-- %s (3) = query_vector (å†æ¬¡)
-- %s (4) = 0.6375 (doc_threshold)
-- %s (5) = 3 (limit)
```

**è¿”å›ç¤ºä¾‹**ï¼š
```python
[
    {
        'id': 120,
        'source_id': 20,
        'similarity': 0.78,
        'text_content': '# Cup æµ‹è¯•æŒ‡å—\n\n## æµ‹è¯•ç›®çš„\n...\n## æµ‹è¯•æ­¥éª¤\n...'
    }
]
```

---

## å®é™…ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šæ­£å¸¸æƒ…å†µ - æ®µè½æœç´¢æˆåŠŸ

```
ç”¨æˆ·æŸ¥è¯¢: "Cup å¦‚ä½•æµ‹è¯•?"
threshold: 0.75
limit: 3

æ‰§è¡Œæµç¨‹ï¼š
1ï¸âƒ£ search_knowledge() è°ƒç”¨ search_with_vectors()
2ï¸âƒ£ search_with_vectors() å°è¯•æ®µè½æœç´¢
3ï¸âƒ£ search_sections() åœ¨ document_section_embeddings è¡¨ä¸­æŸ¥è¯¢
4ï¸âƒ£ æ‰¾åˆ° 2 ä¸ªæ®µè½ï¼ˆscore: 0.86, 0.82ï¼‰
5ï¸âƒ£ âœ… è¿”å›æ®µè½ç»“æœï¼Œç»“æŸ

ç»“æœï¼š
- è¿”å› 2 ä¸ªæ®µè½å†…å®¹
- æœªæ‰§è¡Œæ•´ç¯‡æ–‡æ¡£æœç´¢
- æœªæ‰§è¡Œå…³é”®å­—æœç´¢ï¼ˆç»“æœå·²æ»¡è¶³ï¼‰

æ—¥å¿—ï¼š
[INFO] âœ… æ®µè½å‘é‡æœç´¢æˆåŠŸ: 2 ä¸ªç»“æœ (threshold=0.75)
[INFO] å‘é‡æœç´¢è¿”å› 2 æ¡ç»“æœ (threshold=0.75)
```

---

### åœºæ™¯ 2ï¼šé™çº§æƒ…å†µ - æ®µè½æœç´¢å¤±è´¥

```
ç”¨æˆ·æŸ¥è¯¢: "Cup å¦‚ä½•æµ‹è¯•?"
threshold: 0.75
limit: 3

æ‰§è¡Œæµç¨‹ï¼š
1ï¸âƒ£ search_knowledge() è°ƒç”¨ search_with_vectors()
2ï¸âƒ£ search_with_vectors() å°è¯•æ®µè½æœç´¢
3ï¸âƒ£ search_sections() æŠ›å‡ºå¼‚å¸¸ï¼ˆè¡¨ä¸å­˜åœ¨ï¼‰
4ï¸âƒ£ âš ï¸ æ•è·å¼‚å¸¸ï¼Œé™çº§åˆ°æ•´ç¯‡æ–‡æ¡£æœç´¢
5ï¸âƒ£ search_with_vectors_generic() åœ¨ document_embeddings è¡¨ä¸­æŸ¥è¯¢
6ï¸âƒ£ ä½¿ç”¨é™ä½çš„ threshold = 0.6375
7ï¸âƒ£ æ‰¾åˆ° 1 ä¸ªå®Œæ•´æ–‡æ¡£ï¼ˆscore: 0.78ï¼‰
8ï¸âƒ£ âœ… è¿”å›æ–‡æ¡£ç»“æœ

ç»“æœï¼š
- è¿”å› 1 ä¸ªå®Œæ•´æ–‡æ¡£å†…å®¹
- ä½¿ç”¨äº†é™ä½çš„ threshold

æ—¥å¿—ï¼š
[WARNING] âš ï¸ æ®µè½å‘é‡æœç´¢å¤±è´¥ï¼Œä½¿ç”¨æ•´ç¯‡æ–‡æ¡£æœç´¢: 
          relation "document_section_embeddings" does not exist
[INFO] ğŸ“„ æ•´ç¯‡æ–‡æ¡£å‘é‡æœç´¢è¿”å› 1 ä¸ªç»“æœ (threshold=0.64)
[INFO] å‘é‡æœç´¢è¿”å› 1 æ¡ç»“æœ (threshold=0.75)
```

---

### åœºæ™¯ 3ï¼šè¡¥å……æƒ…å†µ - å‘é‡ç»“æœä¸è¶³

```
ç”¨æˆ·æŸ¥è¯¢: "Cup"
threshold: 0.75
limit: 3

æ‰§è¡Œæµç¨‹ï¼š
1ï¸âƒ£ search_knowledge() è°ƒç”¨ search_with_vectors()
2ï¸âƒ£ search_with_vectors() æ‰§è¡Œæ®µè½æœç´¢
3ï¸âƒ£ æ‰¾åˆ° 1 ä¸ªæ®µè½ï¼ˆscore: 0.80ï¼‰
4ï¸âƒ£ è¿”å›åˆ° search_knowledge()
5ï¸âƒ£ æ£€æµ‹åˆ°ç»“æœä¸è¶³ï¼ˆ1 < 3ï¼‰
6ï¸âƒ£ âš ï¸ è°ƒç”¨ search_with_keywords() è¡¥å……
7ï¸âƒ£ å…³é”®å­—æœç´¢æ‰¾åˆ° 2 ä¸ªç»“æœï¼ˆscore: 0.65, 0.55ï¼‰
8ï¸âƒ£ âœ… åˆå¹¶ç»“æœï¼ˆå»é‡åï¼‰

ç»“æœï¼š
- 1 ä¸ªæ®µè½å‘é‡ç»“æœ + 2 ä¸ªå…³é”®å­—ç»“æœ
- æ€»å…± 3 ä¸ªç»“æœ

æ—¥å¿—ï¼š
[INFO] âœ… æ®µè½å‘é‡æœç´¢æˆåŠŸ: 1 ä¸ªç»“æœ (threshold=0.75)
[INFO] å‘é‡æœç´¢è¿”å› 1 æ¡ç»“æœ (threshold=0.75)
[INFO] ğŸ” å…³é”®å­—æœç´¢: æŸ¥è¯¢ 'Cup' è¿”å› 5 ä¸ªåŒ¹é…é¡¹
[INFO] ğŸ“Š å…³é”®å­—æœç´¢ç»“æœ: 2 æ¡ (threshold=0.38)
[INFO] å…³é”®å­—æœç´¢è¡¥å…… 2 æ¡ç»“æœ (threshold=0.38)
```

---

## ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šç›´æ¥è°ƒç”¨ search_with_vectors()

```python
from library.protocol_guide.search_service import ProtocolGuideSearchService

# åˆå§‹åŒ–æœç´¢æœåŠ¡
service = ProtocolGuideSearchService()

# ç›´æ¥è°ƒç”¨ search_with_vectors()
results = service.search_with_vectors(
    query="Cup å¦‚ä½•æµ‹è¯•?",
    limit=3,
    threshold=0.75
)

# æŸ¥çœ‹ç»“æœ
for i, result in enumerate(results, 1):
    print(f"\nç»“æœ {i}:")
    print(f"  æ ‡é¢˜: {result['title']}")
    print(f"  åˆ†æ•°: {result['score']:.2f}")
    print(f"  å†…å®¹: {result['content'][:100]}...")
```

**é¢„æœŸè¾“å‡º**ï¼š
```
ç»“æœ 1:
  æ ‡é¢˜: Cup æµ‹è¯•æŒ‡å—
  åˆ†æ•°: 0.86
  å†…å®¹: ## Cup æµ‹è¯•å‡†å¤‡
ç¡®ä¿æµ‹è¯•ç¯å¢ƒå·²è®¾ç½®...

ç»“æœ 2:
  æ ‡é¢˜: Cup æµ‹è¯•æŒ‡å—
  åˆ†æ•°: 0.82
  å†…å®¹: ## æµ‹è¯•æ­¥éª¤
1. å‡†å¤‡æµ‹è¯•...
```

---

### ç¤ºä¾‹ 2ï¼šé€šè¿‡ search_knowledge() è°ƒç”¨

```python
from library.protocol_guide.search_service import ProtocolGuideSearchService

# åˆå§‹åŒ–æœç´¢æœåŠ¡
service = ProtocolGuideSearchService()

# é€šè¿‡ search_knowledge() è°ƒç”¨ï¼ˆæ¨èæ–¹å¼ï¼‰
results = service.search_knowledge(
    query="Cup å¦‚ä½•æµ‹è¯•?",
    limit=3,
    use_vector=True,
    threshold=0.75
)

# è¿™ä¼šè‡ªåŠ¨è°ƒç”¨ search_with_vectors()
# å¦‚æœç»“æœä¸è¶³ï¼Œè¿˜ä¼šè¡¥å……å…³é”®å­—æœç´¢
```

---

### ç¤ºä¾‹ 3ï¼šDify å¤–éƒ¨çŸ¥è¯†åº“ API è°ƒç”¨

```bash
# é€šè¿‡ Dify å¤–éƒ¨çŸ¥è¯†åº“ API è°ƒç”¨
curl -X POST "http://localhost/api/dify/knowledge/retrieval" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_id": "protocol_database",
    "query": "Cup å¦‚ä½•æµ‹è¯•?",
    "retrieval_setting": {
      "top_k": 3,
      "score_threshold": 0.75
    }
  }'
```

**è°ƒç”¨é“¾**ï¼š
```
curl â†’ Django API â†’ DifyKnowledgeSearchHandler â†’
search_knowledge() â†’ search_with_vectors() â†’
search_sections() / search_with_vectors_generic()
```

---

## æ€»ç»“

### ğŸ¯ æ ¸å¿ƒè¦ç‚¹

1. **search_with_vectors() çš„ä½ç½®**ï¼š
   - åœ¨è°ƒç”¨é“¾çš„ç¬¬ 5 å±‚
   - æ˜¯å‘é‡æœç´¢çš„æ ¸å¿ƒæ‰§è¡Œæ–¹æ³•
   - è¢« `search_knowledge()` è°ƒç”¨

2. **è°ƒç”¨æ—¶æœº**ï¼š
   - æ¯æ¬¡ Dify æŸ¥è¯¢å¤–éƒ¨çŸ¥è¯†åº“æ—¶
   - `search_knowledge()` ä¸­ `use_vector=True` æ—¶
   - åœ¨å…³é”®å­—æœç´¢ä¹‹å‰æ‰§è¡Œ

3. **æ‰§è¡Œé€»è¾‘**ï¼š
   - å›ºå®šä¼˜å…ˆçº§ï¼šæ®µè½ â†’ æ–‡æ¡£
   - è‡ªåŠ¨é™çº§æœºåˆ¶
   - Threshold åŠ¨æ€è°ƒæ•´

4. **å‚æ•°æ¥æº**ï¼š
   - `query`: ç”¨æˆ·è¾“å…¥
   - `limit`: Dify `top_k` è®¾ç½®
   - `threshold`: Dify `score_threshold` è®¾ç½®

5. **ç»“æœç”¨é€”**ï¼š
   - è¿”å›ç»™ `search_knowledge()`
   - å¯èƒ½è¡¥å……å…³é”®å­—æœç´¢
   - æœ€ç»ˆè¿”å›ç»™ Dify Chat API
   - ä½œä¸º LLM çš„ä¸Šä¸‹æ–‡

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-12  
**ä½œè€…**ï¼šAI Platform Team  
**ç›¸å…³æ–‡æ¡£**ï¼š
- `docs/architecture/search-mode-switching-mechanism.md`
- `docs/architecture/mode-b-two-tier-search-complete-flow.md`
