# æ–¹æ¡ˆ Bï¼šæŸ¥è©¢é‡å¯«ç­–ç•¥ + å…©éšæ®µæ™ºèƒ½è·¯ç”±

## ğŸ“‹ æ¦‚è¿°

**æ–¹æ¡ˆ B** æ˜¯å°ç¾æœ‰å…©éšæ®µæœå°‹æ¶æ§‹çš„æ”¹é€²ç‰ˆæœ¬ï¼Œæ ¸å¿ƒç†å¿µæ˜¯ï¼š
- âœ… **ä¿ç•™**å…©éšæ®µæ™ºèƒ½è·¯ç”±é‚è¼¯ï¼ˆæ®µè½ â†’ å…¨æ–‡ï¼‰
- âœ… **ä¿ç•™** Mode A/B å€åˆ†ï¼ˆé—œéµå­—è§¸ç™¼ vs æ™ºèƒ½è·¯ç”±ï¼‰
- âœ… **ç§»é™¤**æœå°‹çµæœä¸Šä¸‹æ–‡å‚³éçµ¦ Dify
- âœ… **æ”¹ç”¨**æŸ¥è©¢é‡å¯«ç­–ç•¥å¼•å° Dify æœå°‹

---

## ğŸ¯ æ ¸å¿ƒè¨­è¨ˆç†å¿µ

### å•é¡Œæ ¹æº
**èˆŠæ¶æ§‹**ï¼šProtocol Assistant æœå°‹ â†’ æ ¼å¼åŒ–çµæœ â†’ å‚³çµ¦ Dify â†’ Dify å†æœå°‹ â†’ å¼•ç”¨ä¾†æºè¡çª

### è§£æ±ºæ–¹æ¡ˆ
**æ–°æ¶æ§‹**ï¼šProtocol Assistant åªè² è²¬è·¯ç”±æ±ºç­– â†’ Dify è² è²¬å¯¦éš›æœå°‹å’Œå¼•ç”¨ â†’ å¼•ç”¨ä¾†æºä¸€è‡´

---

## ğŸ”„ å®Œæ•´æµç¨‹è¨­è¨ˆ

### **Mode Aï¼šé—œéµå­—è§¸ç™¼å…¨æ–‡æœå°‹**

```
ç”¨æˆ¶æŸ¥è©¢: "Cup å®Œæ•´å…§å®¹"
    â†“
æª¢æ¸¬åˆ°å…¨æ–‡é—œéµå­—ï¼ˆâœ… é—œéµå­—æª¢æ¸¬å™¨ï¼‰
    â†“
ç™¼é€çµ¦ Dify: "Cup å®Œæ•´å…§å®¹"ï¼ˆä¿æŒåŸæŸ¥è©¢ï¼‰
    â†“
Dify è‡ªå·±çš„çŸ¥è­˜åº«æœå°‹ï¼ˆsemantic_search, top_k=3-5ï¼‰
    â†“
Dify è¿”å›: AI å›ç­” + å¼•ç”¨ä¾†æºï¼ˆmetadata.retriever_resourcesï¼‰
    â†“
å¦‚æœ AI ä¸ç¢ºå®šï¼ˆâœ… ä¸ç¢ºå®šæ€§æª¢æ¸¬å™¨ï¼‰
    â†“
è¿”å›ï¼šã€Œè«‹åƒè€ƒä»¥ä¸‹æ–‡ä»¶ã€‚ã€+ ä¿æŒå¼•ç”¨ä¾†æº
```

**ç‰¹é»**ï¼š
- ç”¨æˆ¶æŸ¥è©¢å·²åŒ…å«å…¨æ–‡é—œéµå­—ï¼ˆã€Œå®Œæ•´ã€ã€ã€Œå…¨æ–‡ã€ã€ã€Œæ‰€æœ‰æ­¥é©Ÿã€ï¼‰
- ç›´æ¥ç™¼é€åŸæŸ¥è©¢çµ¦ Difyï¼Œè§¸ç™¼å…¨æ–‡ç´šæœå°‹
- å–®éšæ®µåŸ·è¡Œï¼Œç„¡é™ç´š

---

### **Mode Bï¼šå…©éšæ®µæ™ºèƒ½æœå°‹**

#### **Stage 1ï¼šæ®µè½æœå°‹éšæ®µ**

```
ç”¨æˆ¶æŸ¥è©¢: "Cup é¡è‰²"
    â†“
æœªæª¢æ¸¬åˆ°å…¨æ–‡é—œéµå­— â†’ Mode Bï¼ˆâœ… æ™ºèƒ½è·¯ç”±å™¨ï¼‰
    â†“
ç™¼é€çµ¦ Dify: "Cup é¡è‰²"ï¼ˆä¿æŒåŸæŸ¥è©¢ï¼‰
    â†“
Dify è‡ªå·±çš„çŸ¥è­˜åº«æœå°‹ï¼ˆæ®µè½ç´šå‘é‡ï¼Œtop_k=3-5ï¼‰
    â†“
Dify è¿”å›: AI å›ç­” + å¼•ç”¨ä¾†æº
    â†“
æª¢æ¸¬ AI å›ç­”ï¼ˆâœ… ä¸ç¢ºå®šæ€§æª¢æ¸¬å™¨ï¼‰:
    - å¦‚æœç¢ºå®šï¼ˆç„¡ã€Œä¸ç¢ºå®šã€é—œéµå­—ï¼‰â†’ ç›´æ¥è¿”å›
    - å¦‚æœä¸ç¢ºå®šï¼ˆå«ã€Œæˆ‘ä¸å¤ªç¢ºå®šã€ï¼‰â†’ é€²å…¥ Stage 2
```

#### **Stage 2ï¼šå…¨æ–‡æœå°‹éšæ®µï¼ˆé™ç´šï¼‰**

```
AI å›ç­”ä¸ç¢ºå®š
    â†“
æŸ¥è©¢é‡å¯«: "Cup é¡è‰² å®Œæ•´å…§å®¹"  # âœ… æ·»åŠ å…¨æ–‡è§¸ç™¼è©
    â†“
ç™¼é€çµ¦ Dify: "Cup é¡è‰² å®Œæ•´å…§å®¹"
    â†“
Dify è‡ªå·±çš„çŸ¥è­˜åº«æœå°‹ï¼ˆå…¨æ–‡ç´šå‘é‡ï¼Œtop_k=3-5ï¼‰
    â†“
Dify è¿”å›: æ›´å®Œæ•´çš„ AI å›ç­” + å¼•ç”¨ä¾†æº
    â†“
æª¢æ¸¬ AI å›ç­”:
    - å¦‚æœç¢ºå®š â†’ è¿”å›ï¼ˆæ¨™è¨˜ç‚º Stage 2 æˆåŠŸï¼‰
    - å¦‚æœä¸ç¢ºå®š â†’ è¿”å›ã€Œè«‹åƒè€ƒä»¥ä¸‹æ–‡ä»¶ã€‚ã€ï¼ˆä¿æŒå¼•ç”¨ä¾†æºï¼‰
```

---

## ğŸ”‘ é—œéµæŠ€è¡“å¯¦ä½œ

### 1. **æŸ¥è©¢é‡å¯«ç­–ç•¥**

```python
def _request_dify_chat(
    self,
    query: str,
    conversation_id: str,
    user_id: str,
    is_full_search: bool = False
) -> Dict[str, Any]:
    """
    è«‹æ±‚ Dify AI å›ç­”ï¼ˆæ–¹æ¡ˆ Bï¼šæŸ¥è©¢é‡å¯«ç­–ç•¥ï¼‰
    
    Args:
        query: ç”¨æˆ¶æŸ¥è©¢
        conversation_id: å°è©± ID
        user_id: ç”¨æˆ¶ ID
        is_full_search: æ˜¯å¦ç‚ºå…¨æ–‡æœå°‹éšæ®µï¼ˆStage 2ï¼‰
        
    Returns:
        Dict: Dify å›æ‡‰
    """
    if is_full_search:
        # Stage 2ï¼šæ·»åŠ å…¨æ–‡è§¸ç™¼è©
        rewritten_query = f"{query} å®Œæ•´å…§å®¹"
        logger.info(f"ğŸ“ Stage 2 æŸ¥è©¢é‡å¯«: {query} â†’ {rewritten_query}")
    else:
        # Stage 1ï¼šä¿æŒåŸæŸ¥è©¢
        rewritten_query = query
    
    # âœ… åªå‚³æŸ¥è©¢ï¼Œä¸å‚³æœå°‹çµæœä¸Šä¸‹æ–‡
    response = self.dify_client.chat(
        question=rewritten_query,
        conversation_id=conversation_id if conversation_id else "",
        user=user_id,
        verbose=False
    )
    
    return response
```

### 2. **å…©éšæ®µå‘¼å«**

```python
# Stage 1ï¼šæ®µè½æœå°‹
stage_1_response = self._request_dify_chat(
    query=user_query,
    conversation_id=conversation_id,
    user_id=user_id,
    is_full_search=False  # âœ… æ®µè½ç´šæœå°‹
)

# æª¢æ¸¬ä¸ç¢ºå®šæ€§
is_uncertain, keyword = is_uncertain_response(stage_1_response['answer'])

if is_uncertain:
    # Stage 2ï¼šå…¨æ–‡æœå°‹
    stage_2_response = self._request_dify_chat(
        query=user_query,
        conversation_id=conversation_id,
        user_id=user_id,
        is_full_search=True  # âœ… å…¨æ–‡ç´šæœå°‹ï¼ˆæ·»åŠ ã€Œå®Œæ•´å…§å®¹ã€ï¼‰
    )
```

---

## ğŸ¨ Protocol Assistant çš„è§’è‰²å®šä½

### **æ–¹æ¡ˆ B ä¸­ï¼ŒProtocol Assistant è² è²¬**ï¼š
1. âœ… **é—œéµå­—æª¢æ¸¬**ï¼šåˆ¤æ–·æ˜¯å¦åŒ…å«å…¨æ–‡é—œéµå­— â†’ æ±ºå®š Mode A/B
2. âœ… **ä¸ç¢ºå®šæ€§æª¢æ¸¬**ï¼šåˆ¤æ–· AI å›ç­”æ˜¯å¦ä¸ç¢ºå®š â†’ æ±ºå®šæ˜¯å¦é™ç´š
3. âœ… **æŸ¥è©¢é‡å¯«**ï¼šStage 2 æ™‚æ·»åŠ ã€Œå®Œæ•´å…§å®¹ã€è§¸ç™¼è©
4. âœ… **æµç¨‹ç·¨æ’**ï¼šç®¡ç†å…©éšæ®µåŸ·è¡Œé‚è¼¯
5. âœ… **å›æ‡‰æ ¼å¼åŒ–**ï¼šçµ±ä¸€å›æ‡‰æ ¼å¼ï¼ˆmode, stage, is_fallbackï¼‰

### **Protocol Assistant ä¸å†è² è²¬**ï¼š
1. âŒ **å‘é‡æœå°‹åŸ·è¡Œ**ï¼šä¸å†å‘¼å« `search_service`
2. âŒ **æœå°‹çµæœæ ¼å¼åŒ–**ï¼šä¸å†å‘¼å« `_format_search_context()`
3. âŒ **ä¸Šä¸‹æ–‡å‚³é**ï¼šä¸å†å°‡æœå°‹çµæœå‚³çµ¦ Dify
4. âŒ **å¼•ç”¨ä¾†æºç®¡ç†**ï¼šå®Œå…¨äº¤çµ¦ Dify çŸ¥è­˜åº«

---

## ğŸ“Š Dify çŸ¥è­˜åº«é…ç½®è¦æ±‚

### **å¿…è¦è¨­å®š**ï¼ˆDify Studio æ‰‹å‹•é…ç½®ï¼‰

```yaml
knowledge_base:
  # åŸºæœ¬è¨­å®š
  retrieval_mode: "semantic_search"  # èªç¾©æœå°‹
  top_k: 3-5  # è¿”å› 3-5 å€‹å¼•ç”¨ä¾†æºï¼ˆè€Œé 1ï¼‰
  score_threshold: 0.5-0.6  # ç›¸ä¼¼åº¦é–¾å€¼
  
  # é—œéµï¼šDify éœ€èƒ½å€åˆ†æ®µè½ vs å…¨æ–‡æœå°‹
  # æ–¹æ³• 1ï¼šé€éã€Œå®Œæ•´å…§å®¹ã€é—œéµå­—è§¸ç™¼å…¨æ–‡æœå°‹æ¨¡å¼
  # æ–¹æ³• 2ï¼šé€éä¸åŒçš„æª¢ç´¢è¨­å®šï¼ˆéœ€åœ¨ Dify é…ç½®ï¼‰
```

### **é…ç½®æ­¥é©Ÿ**
1. ç™»å…¥ Dify Studioï¼š`http://10.10.172.37`
2. é€²å…¥ Protocol Guide æ‡‰ç”¨
3. Knowledge Base â†’ External API è¨­å®š
4. **ä¿®æ”¹ `top_k` å¾ 1 â†’ 3~5**
5. èª¿æ•´ `score_threshold`ï¼ˆå¦‚éœ€è¦ï¼‰
6. å„²å­˜ä¸¦é‡æ–°ç™¼å¸ƒ

---

## ğŸ” Protocol Assistant å‘é‡æœå°‹çš„å­˜ç•™å•é¡Œ

### **é¸é … 1ï¼šå®Œå…¨ç§»é™¤**
- **å„ªé»**ï¼šç¨‹å¼ç¢¼æœ€ç°¡åŒ–ï¼Œç¶­è­·æˆæœ¬ä½
- **ç¼ºé»**ï¼šå¤±å»å‚™ä»½æœå°‹èƒ½åŠ›ã€ç„¡æ³•é€²è¡Œæœå°‹æ•ˆèƒ½åˆ†æ

### **é¸é … 2ï¼šä¿ç•™ç”¨æ–¼åˆ†æ**
- **å„ªé»**ï¼šå¯ç”¨æ–¼æœå°‹å“è³ªç›£æ§ã€A/B æ¸¬è©¦ã€é™ç´šåˆ†æ
- **ç¼ºé»**ï¼šä¿ç•™å†—é¤˜ç¨‹å¼ç¢¼

### **å»ºè­°**ï¼š
**ä¿ç•™æœå°‹é‚è¼¯ï¼Œä½†ç§»é™¤ `_format_search_context()` æ–¹æ³•**
- `search_service.py`ï¼šä¿ç•™ï¼ˆç”¨æ–¼åˆ†æå’Œç›£æ§ï¼‰
- `_section_search()`, `_full_document_search()`ï¼šä¿ç•™ï¼ˆç”¨æ–¼è¨˜éŒ„ï¼‰
- `_format_search_context()`ï¼šç§»é™¤ï¼ˆä¸å†éœ€è¦ï¼‰

---

## âœ… æ–¹æ¡ˆ B çš„å„ªå‹¢

### **ç›¸æ¯”èˆŠæ¶æ§‹**ï¼š
1. âœ… **å¼•ç”¨ä¾†æºä¸€è‡´**ï¼šæ‰€æœ‰å¼•ç”¨éƒ½ä¾†è‡ª Dify çŸ¥è­˜åº«
2. âœ… **é¿å…é›™é‡æœå°‹**ï¼šåªæœ‰ Dify åŸ·è¡Œå¯¦éš›æœå°‹
3. âœ… **æ•ˆèƒ½æå‡**ï¼šæ¸›å°‘ Protocol Assistant å‘é‡æœå°‹è€—æ™‚
4. âœ… **ç¶­è­·ç°¡åŒ–**ï¼šæœå°‹é‚è¼¯çµ±ä¸€åœ¨ Dify

### **ç›¸æ¯”æ–¹æ¡ˆ Aï¼ˆå®Œå…¨ç°¡åŒ–ï¼‰**ï¼š
1. âœ… **ä¿ç•™æ™ºèƒ½è·¯ç”±**ï¼šä»èƒ½å€åˆ†æ®µè½ vs å…¨æ–‡æœå°‹éœ€æ±‚
2. âœ… **ä¿ç•™å…©éšæ®µç­–ç•¥**ï¼šæ®µè½æœå°‹å¿«é€Ÿå›ç­”ç°¡å–®å•é¡Œ
3. âœ… **ä¿ç•™ä¸ç¢ºå®šæ€§æª¢æ¸¬**ï¼šAI ä¸ç¢ºå®šæ™‚è‡ªå‹•å‡ç´šåˆ°å…¨æ–‡æœå°‹
4. âœ… **ä¿ç•™ Mode A/B å€åˆ†**ï¼šé—œéµå­—è§¸ç™¼æœ‰æ˜ç¢ºèªç¾©

---

## ğŸ§ª æ¸¬è©¦è¨ˆåŠƒ

### **æ¸¬è©¦æ¡ˆä¾‹ 1ï¼šç°¡å–®æŸ¥è©¢ï¼ˆStage 1 æˆåŠŸï¼‰**
```
è¼¸å…¥: "Cup é¡è‰²"
é æœŸ:
  - Mode: mode_b
  - Stage: 1
  - is_fallback: False
  - å¼•ç”¨ä¾†æº: Cup æ–‡æª”ï¼ˆä¾†è‡ª Difyï¼‰
  - AI å›ç­”: ç¢ºå®šçš„ç­”æ¡ˆ
```

### **æ¸¬è©¦æ¡ˆä¾‹ 2ï¼šè¤‡é›œæŸ¥è©¢ï¼ˆStage 1 â†’ Stage 2ï¼‰**
```
è¼¸å…¥: "Cup æ‰€æœ‰æ¸¬è©¦æ­¥é©Ÿ"
é æœŸ:
  - Mode: mode_b
  - Stage: 2ï¼ˆStage 1 ä¸ç¢ºå®šï¼Œé€²å…¥ Stage 2ï¼‰
  - is_fallback: False
  - å¼•ç”¨ä¾†æº: Cup æ–‡æª”ï¼ˆä¾†è‡ª Difyï¼Œæ›´å®Œæ•´ï¼‰
  - AI å›ç­”: å®Œæ•´çš„æ¸¬è©¦æ­¥é©Ÿ
```

### **æ¸¬è©¦æ¡ˆä¾‹ 3ï¼šå…¨æ–‡é—œéµå­—ï¼ˆMode Aï¼‰**
```
è¼¸å…¥: "Cup å®Œæ•´å…§å®¹"
é æœŸ:
  - Mode: mode_a
  - Stage: N/Aï¼ˆå–®éšæ®µï¼‰
  - is_fallback: False
  - å¼•ç”¨ä¾†æº: Cup æ–‡æª”ï¼ˆä¾†è‡ª Difyï¼‰
  - AI å›ç­”: å®Œæ•´æ–‡æª”å…§å®¹
```

### **æ¸¬è©¦æ¡ˆä¾‹ 4ï¼šä¸ç¢ºå®šé™ç´šï¼ˆMode B Stage 2ï¼‰**
```
è¼¸å…¥: "ä¸å­˜åœ¨çš„æ–‡æª”"
é æœŸ:
  - Mode: mode_b
  - Stage: 2
  - is_fallback: True
  - AI å›ç­”: ã€Œè«‹åƒè€ƒä»¥ä¸‹æ–‡ä»¶ã€‚ã€
  - å¼•ç”¨ä¾†æº: ç›¸é—œä½†å¯èƒ½ä¸æº–ç¢ºçš„æ–‡æª”
```

---

## ğŸ“ˆ é æœŸæ•ˆæœ

### **å¼•ç”¨æº–ç¢ºæ€§**
- âœ… Cup æŸ¥è©¢æ‡‰è©²è¿”å› Cup æ–‡æª”ä½œç‚ºå¼•ç”¨ä¾†æº
- âœ… å¼•ç”¨ä¾†æºèˆ‡ Dify çŸ¥è­˜åº«æœå°‹çµæœä¸€è‡´
- âœ… å¤šå€‹å¼•ç”¨ä¾†æºï¼ˆtop_k=3-5ï¼‰æé«˜è¦†è“‹ç‡

### **æ•ˆèƒ½æ”¹å–„**
- â¬‡ï¸ **éŸ¿æ‡‰æ™‚é–“æ¸›å°‘**ï¼šç§»é™¤ Protocol Assistant å‘é‡æœå°‹è€—æ™‚
- â¬‡ï¸ **ç³»çµ±è² è¼‰é™ä½**ï¼šåªæœ‰ Dify åŸ·è¡Œæœå°‹

### **ç¶­è­·æ€§**
- âœ… **ç¨‹å¼ç¢¼ç°¡åŒ–**ï¼šç§»é™¤ `_format_search_context()` æ–¹æ³•
- âœ… **é‚è¼¯æ¸…æ™°**ï¼šæœå°‹å’Œå¼•ç”¨çµ±ä¸€ç”± Dify ç®¡ç†
- âœ… **æ˜“æ–¼æ¸¬è©¦**ï¼šæ¸›å°‘æ¸¬è©¦æ¡ˆä¾‹æ•¸é‡

---

## ğŸš€ å¯¦ä½œç‹€æ…‹

### **å·²å®Œæˆ**ï¼š
- âœ… `two_tier_handler.py` ä¿®æ”¹å®Œæˆ
  - `_request_dify_chat()` æ”¹ç‚ºæŸ¥è©¢é‡å¯«ç­–ç•¥
  - Stage 1 å‘¼å«ï¼š`is_full_search=False`
  - Stage 2 å‘¼å«ï¼š`is_full_search=True`ï¼ˆæ·»åŠ ã€Œå®Œæ•´å…§å®¹ã€ï¼‰
  
- âœ… `keyword_triggered_handler.py` ä¿®æ”¹å®Œæˆ
  - `_request_dify_chat()` æ”¹ç‚ºåªå‚³æŸ¥è©¢ï¼ˆä¸å‚³ä¸Šä¸‹æ–‡ï¼‰

### **å¾…è™•ç†**ï¼š
- [ ] ç§»é™¤ `_format_search_context()` æ–¹æ³•ï¼ˆå…©å€‹æª”æ¡ˆï¼‰
- [ ] æ›´æ–° Dify Studio é…ç½®ï¼ˆ`top_k` 1 â†’ 3-5ï¼‰
- [ ] åŸ·è¡Œå®Œæ•´æ¸¬è©¦ï¼ˆ4 å€‹æ¸¬è©¦æ¡ˆä¾‹ï¼‰
- [ ] æ›´æ–°æ–‡æª”ï¼ˆ`two-tier-search-fallback-strategy.md`ï¼‰
- [ ] å‰ç«¯æ•´åˆï¼ˆè™•ç†æ–°çš„ metadata æ ¼å¼ï¼‰

---

## ğŸ“š ç›¸é—œæ–‡æª”

- **èˆŠæ¶æ§‹èªªæ˜**ï¼š`/docs/refactoring-reports/two-tier-search-fallback-strategy.md`
- **ä¸ç¢ºå®šæ€§æª¢æ¸¬**ï¼š`library/common/ai_response/uncertainty_detector.py`
- **é—œéµå­—æª¢æ¸¬**ï¼š`library/common/search_patterns/keyword_detector.py`
- **Dify æ•´åˆ**ï¼š`library/dify_integration/chat_client.py`

---

**æ›´æ–°æ—¥æœŸ**: 2025-11-11  
**ç‰ˆæœ¬**: v1.0  
**ç‹€æ…‹**: ğŸš§ å¯¦ä½œä¸­ï¼ˆç¨‹å¼ç¢¼å·²ä¿®æ”¹ï¼Œç­‰å¾…æ¸¬è©¦ï¼‰  
**ä½œè€…**: AI Platform Team
