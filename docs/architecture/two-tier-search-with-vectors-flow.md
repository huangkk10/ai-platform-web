# 两阶段搜索策略与 search_with_vectors 完整流程分析

## 📋 目录

1. [两阶段搜索策略概述](#两阶段搜索策略概述)
2. [完整执行流程](#完整执行流程)
3. [search_with_vectors 在两阶段中的作用](#search_with_vectors-在两阶段中的作用)
4. [可能遇到的状况](#可能遇到的状况)
5. [日志追踪示例](#日志追踪示例)
6. [优化建议](#优化建议)

---

## 两阶段搜索策略概述

### 🎯 模式 B：两阶段搜索（查询重写策略）

**核心理念**：
- **阶段 1**：使用原查询 → 段落级搜索 → 快速精准回答
- **阶段 2**：查询 + "完整" → 全文级搜索 → 详细完整回答
- **降级模式**：阶段 2 仍不确定 → 组合 AI 回答 + 友善提示

```
用户查询: "Cup 如何测试?"
    ↓
┌─────────────────────────────────────────────────────────┐
│ 智能路由器判断：不含全文关键字                           │
│ → 选择模式 B（两阶段搜索）                               │
└─────────────────────────────────────────────────────────┘
    ↓
┌═════════════════════════════════════════════════════════┐
║ 阶段 1：段落级搜索                                       ║
╠═════════════════════════════════════════════════════════╣
║ 查询: "Cup 如何测试?"                                   ║
║ Dify 调用外部知识库 API                                 ║
║   ↓                                                     ║
║ search_with_vectors(query="Cup 如何测试?", threshold=0.75)║
║   ├─ 优先：段落向量搜索                                  ║
║   └─ 备用：整篇文档向量搜索                              ║
║   ↓                                                     ║
║ 返回：2 个段落结果                                       ║
║ AI 回答："根据段落内容，Cup 测试步骤是..."              ║
║   ↓                                                     ║
║ 不确定性检测：检查回答是否含有 47+ 不确定关键字          ║
╚═════════════════════════════════════════════════════════╝
    ↓
   是否确定？
    ↓
  ✅ 确定 → 返回阶段 1 结果
    ↓
  ⚠️ 不确定 → 进入阶段 2
    ↓
┌═════════════════════════════════════════════════════════┐
║ 阶段 2：全文级搜索                                       ║
╠═════════════════════════════════════════════════════════╣
║ 查询重写: "Cup 如何测试? 完整"  ← 添加触发词            ║
║ Dify 调用外部知识库 API                                 ║
║   ↓                                                     ║
║ search_with_vectors(query="Cup 如何测试? 完整", threshold=0.75)║
║   ├─ 优先：段落向量搜索（查询含"完整"）                  ║
║   └─ 备用：整篇文档向量搜索                              ║
║   ↓                                                     ║
║ 返回：可能相同的 2 个段落结果（向量搜索不识别"完整"）    ║
║ AI 回答：根据 Dify Prompt 配置，使用详细模式组织答案     ║
║   ↓                                                     ║
║ 不确定性检测：再次检查回答                               ║
╚═════════════════════════════════════════════════════════╝
    ↓
   是否确定？
    ↓
  ✅ 确定 → 返回阶段 2 结果
    ↓
  ⚠️ 仍不确定 → 进入降级模式
    ↓
┌─────────────────────────────────────────────────────────┐
│ 降级模式：组合回答                                       │
├─────────────────────────────────────────────────────────┤
│ 保留 AI 原始分析 + 添加友善提示                         │
│ "根据文档内容...                                        │
│  ---                                                    │
│  💡 建议您参考以下文件以获取更准确的信息。"              │
└─────────────────────────────────────────────────────────┘
```

---

## 完整执行流程

### 📊 详细流程图（带代码位置）

```
用户提问: "Cup 如何测试?"
    ↓
┌─────────────────────────────────────────────────────────┐
│ 1. 智能路由判断                                          │
│    文件: library/protocol_guide/smart_search_router.py  │
│    方法: route_search_strategy()                        │
├─────────────────────────────────────────────────────────┤
│    检查查询是否含全文关键字：                            │
│    ['完整', '全部', '詳細', ...]                        │
│    ↓                                                    │
│    "Cup 如何测试?" → 无全文关键字                       │
│    ↓                                                    │
│    选择：模式 B（两阶段搜索）                            │
└─────────────────────────────────────────────────────────┘
    ↓
┌═════════════════════════════════════════════════════════┐
║ 2. 阶段 1：段落级搜索                                    ║
║    文件: library/protocol_guide/two_tier_handler.py     ║
║    方法: handle_two_tier_search()                       ║
╠═════════════════════════════════════════════════════════╣
║ 2.1 发送原查询给 Dify                                   ║
║ ─────────────────────────────────────────────────────  ║
║ query = "Cup 如何测试?"  # 原查询，无修改               ║
║ is_full_search = False   # 阶段 1                       ║
║                                                         ║
║ dify_client.chat(                                       ║
║     question="Cup 如何测试?",                           ║
║     conversation_id=conversation_id,                    ║
║     user=user_id                                        ║
║ )                                                       ║
╚═════════════════════════════════════════════════════════╝
    ↓
┌─────────────────────────────────────────────────────────┐
│ 3. Dify 处理查询                                         │
│    外部服务: Dify Chat API                              │
│    http://10.10.172.37/v1/chat-messages                │
├─────────────────────────────────────────────────────────┤
│ 3.1 Dify 读取 Prompt 配置                               │
│ ─────────────────────────────────────────────────────  │
│     • 检测查询不含"完整"等关键字                         │
│     • 决定使用段落模式回答（简洁精准）                   │
│                                                         │
│ 3.2 Dify 调用外部知识库 API                             │
│ ─────────────────────────────────────────────────────  │
│     POST /api/dify/knowledge/retrieval                  │
│     {                                                   │
│       "knowledge_id": "protocol_database",              │
│       "query": "Cup 如何测试?",                         │
│       "retrieval_setting": {                            │
│         "top_k": 3,                                     │
│         "score_threshold": 0.75                         │
│       }                                                 │
│     }                                                   │
└─────────────────────────────────────────────────────────┘
    ↓
┌═════════════════════════════════════════════════════════┐
║ 4. 外部知识库 API 处理 ⭐ search_with_vectors 登场      ║
║    文件: backend/api/views/dify_knowledge_views.py      ║
╠═════════════════════════════════════════════════════════╣
║ 4.1 路由到搜索服务                                      ║
║ ─────────────────────────────────────────────────────  ║
║     DifyKnowledgeSearchHandler.search()                 ║
║       → ProtocolGuideSearchService.search_knowledge()   ║
║         → search_with_vectors(                          ║
║             query="Cup 如何测试?",                      ║
║             limit=3,                                    ║
║             threshold=0.75                              ║
║           )                                             ║
║                                                         ║
║ 4.2 search_with_vectors 执行流程                        ║
║ ─────────────────────────────────────────────────────  ║
║ try:                                                    ║
║     # 步骤 1：优先段落向量搜索                          ║
║     section_service.search_sections(                    ║
║         query="Cup 如何测试?",                          ║
║         source_table='protocol_guide',                  ║
║         limit=3,                                        ║
║         threshold=0.75                                  ║
║     )                                                   ║
║     ↓                                                   ║
║     SQL: SELECT ... FROM document_section_embeddings    ║
║          WHERE similarity >= 0.75                       ║
║     ↓                                                   ║
║     结果：找到 2 个段落                                  ║
║     - 段落 1: "Cup 测试准备..." (score: 0.86)           ║
║     - 段落 2: "测试步骤..." (score: 0.82)               ║
║     ↓                                                   ║
║     ✅ 成功返回段落结果（不会执行整篇文档搜索）          ║
║                                                         ║
║ except Exception:                                       ║
║     # 步骤 2：降级到整篇文档向量搜索                    ║
║     # （阶段 1 正常情况下不会执行到这里）               ║
║     search_with_vectors_generic(...)                    ║
╚═════════════════════════════════════════════════════════╝
    ↓
┌─────────────────────────────────────────────────────────┐
│ 5. 返回搜索结果给 Dify                                   │
├─────────────────────────────────────────────────────────┤
│ {                                                       │
│   "records": [                                          │
│     {                                                   │
│       "content": "## Cup 测试准备\n确保测试环境...",    │
│       "score": 0.86,                                    │
│       "title": "Cup 测试指南"                           │
│     },                                                  │
│     {                                                   │
│       "content": "## 测试步骤\n1. 准备测试...",        │
│       "score": 0.82,                                    │
│       "title": "Cup 测试指南"                           │
│     }                                                   │
│   ]                                                     │
│ }                                                       │
└─────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────┐
│ 6. Dify LLM 生成回答                                     │
├─────────────────────────────────────────────────────────┤
│ 上下文：2 个段落内容                                     │
│ Prompt 指示：使用段落模式（简洁精准）                   │
│ ↓                                                       │
│ AI 回答：                                               │
│ "根据文档，Cup 测试流程包括：                           │
│  1. 测试准备：确保测试环境已设置...                     │
│  2. 测试步骤：准备测试..."                              │
└─────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────┐
│ 7. 不确定性检测（阶段 1）                                │
│    文件: library/common/ai_response/                    │
│          uncertainty_detector.py                        │
├─────────────────────────────────────────────────────────┤
│ is_uncertain_response(stage_1_answer)                   │
│ ↓                                                       │
│ 检查回答是否含 47+ 不确定关键字：                        │
│ ['无法确定', '不清楚', '无相关资料', ...]               │
│ ↓                                                       │
│ 情况 A：✅ 不含 → is_uncertain = False                  │
│         → 返回阶段 1 结果，结束                         │
│                                                         │
│ 情况 B：⚠️ 含 → is_uncertain = True                     │
│         → 继续阶段 2                                    │
└─────────────────────────────────────────────────────────┘
    ↓ (情况 B)
┌═════════════════════════════════════════════════════════┐
║ 8. 阶段 2：全文级搜索（查询重写）                        ║
║    文件: library/protocol_guide/two_tier_handler.py     ║
╠═════════════════════════════════════════════════════════╣
║ 8.1 查询重写                                            ║
║ ─────────────────────────────────────────────────────  ║
║ 原查询: "Cup 如何测试?"                                 ║
║ 重写后: "Cup 如何测试? 完整"  ← 添加"完整"触发词       ║
║                                                         ║
║ is_full_search = True  # 阶段 2                         ║
║                                                         ║
║ dify_client.chat(                                       ║
║     question="Cup 如何测试? 完整",  # 重写后查询        ║
║     conversation_id=conversation_id,                    ║
║     user=user_id                                        ║
║ )                                                       ║
╚═════════════════════════════════════════════════════════╝
    ↓
┌─────────────────────────────────────────────────────────┐
│ 9. Dify 处理重写后的查询                                 │
├─────────────────────────────────────────────────────────┤
│ 9.1 Dify 读取 Prompt 配置                               │
│ ─────────────────────────────────────────────────────  │
│     • 检测到查询含"完整"关键字                           │
│     • 决定使用详细模式回答（完整展开）                   │
│                                                         │
│ 9.2 Dify 调用外部知识库 API                             │
│ ─────────────────────────────────────────────────────  │
│     POST /api/dify/knowledge/retrieval                  │
│     {                                                   │
│       "knowledge_id": "protocol_database",              │
│       "query": "Cup 如何测试? 完整",  ← 含"完整"       │
│       "retrieval_setting": {                            │
│         "top_k": 3,                                     │
│         "score_threshold": 0.75                         │
│       }                                                 │
│     }                                                   │
└─────────────────────────────────────────────────────────┘
    ↓
┌═════════════════════════════════════════════════════════┐
║ 10. 外部知识库 API 处理（阶段 2）⭐ 关键差异            ║
╠═════════════════════════════════════════════════════════╣
║ search_with_vectors(                                    ║
║     query="Cup 如何测试? 完整",  ← 查询含"完整"         ║
║     limit=3,                                            ║
║     threshold=0.75                                      ║
║ )                                                       ║
║                                                         ║
║ ⚠️ 关键点：Python 搜索服务不识别"完整"关键字！          ║
║                                                         ║
║ 执行流程：                                              ║
║ try:                                                    ║
║     # 步骤 1：段落向量搜索                              ║
║     section_service.search_sections(                    ║
║         query="Cup 如何测试? 完整",                     ║
║         threshold=0.75                                  ║
║     )                                                   ║
║     ↓                                                   ║
║     向量化: embedding("Cup 如何测试? 完整")            ║
║     ↓                                                   ║
║     SQL: SELECT ... FROM document_section_embeddings    ║
║          WHERE similarity >= 0.75                       ║
║     ↓                                                   ║
║     可能的结果：                                         ║
║     情况 1: 找到相同的 2 个段落（最常见）                ║
║             - "完整"对向量匹配影响很小                  ║
║             - 相似度可能稍低（0.84, 0.80）              ║
║                                                         ║
║     情况 2: 找到不同的段落                              ║
║             - "完整"改变了向量方向                      ║
║             - 匹配到其他相关段落                        ║
║                                                         ║
║     情况 3: 未找到段落（threshold 过高）                ║
║             - 降级到整篇文档搜索                        ║
║             - threshold = 0.6375                        ║
║                                                         ║
║     ✅ 返回搜索结果（可能与阶段 1 相同）                 ║
║                                                         ║
║ except Exception:                                       ║
║     # 降级到整篇文档搜索                                ║
║     search_with_vectors_generic(...)                    ║
╚═════════════════════════════════════════════════════════╝
    ↓
┌─────────────────────────────────────────────────────────┐
│ 11. Dify LLM 生成回答（阶段 2）                          │
├─────────────────────────────────────────────────────────┤
│ 上下文：可能与阶段 1 相同的 2 个段落                     │
│ Prompt 指示：使用详细模式（因为含"完整"）                │
│ ↓                                                       │
│ AI 回答（更详细）：                                      │
│ "Cup 测试的完整流程如下：                               │
│  1. 测试准备阶段：                                      │
│     - 确保测试环境已经正确设置                          │
│     - 准备所有必要的测试工具和设备                      │
│     - ...（展开详细说明）                               │
│  2. 测试执行阶段：                                      │
│     - 按照测试步骤依次执行                              │
│     - ...（展开详细说明）"                              │
└─────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────┐
│ 12. 不确定性检测（阶段 2）                               │
├─────────────────────────────────────────────────────────┤
│ is_uncertain_response(stage_2_answer)                   │
│ ↓                                                       │
│ 情况 A：✅ 不含不确定关键字                             │
│         → 返回阶段 2 结果，结束                         │
│                                                         │
│ 情况 B：⚠️ 仍含不确定关键字                             │
│         → 进入降级模式                                  │
└─────────────────────────────────────────────────────────┘
    ↓ (情况 B)
┌─────────────────────────────────────────────────────────┐
│ 13. 降级模式：组合回答                                   │
├─────────────────────────────────────────────────────────┤
│ 保留 AI 原始分析                                         │
│ +                                                       │
│ 友善提示                                                │
│ ↓                                                       │
│ 最终回答：                                              │
│ "{AI 原始回答}                                          │
│  ---                                                    │
│  💡 建议您参考以下文件以获取更准确的信息。"              │
└─────────────────────────────────────────────────────────┘
```

---

## search_with_vectors 在两阶段中的作用

### 🎯 关键理解

**search_with_vectors 在阶段 1 和阶段 2 的执行逻辑完全相同**

唯一的差异是**传入的查询字符串**：
- 阶段 1：`query = "Cup 如何测试?"`
- 阶段 2：`query = "Cup 如何测试? 完整"`

### 📊 两阶段对比表

| 方面 | 阶段 1 | 阶段 2 | 差异说明 |
|------|--------|--------|----------|
| **查询字符串** | `"Cup 如何测试?"` | `"Cup 如何测试? 完整"` | ✅ 唯一差异 |
| **search_with_vectors** | 执行 | 执行 | ⚠️ 逻辑完全相同 |
| **段落搜索** | 优先执行 | 优先执行 | ⚠️ 无差异 |
| **文档搜索** | 降级执行 | 降级执行 | ⚠️ 无差异 |
| **threshold** | 0.75 | 0.75 | ⚠️ 无差异 |
| **limit** | 3 | 3 | ⚠️ 无差异 |
| **向量化** | embedding("Cup 如何测试?") | embedding("Cup 如何测试? 完整") | ✅ 向量略有不同 |
| **搜索结果** | 可能：2 段落 | 可能：相同的 2 段落 | ⚠️ 通常相同 |
| **Dify Prompt** | 段落模式（简洁） | 详细模式（展开） | ✅ 回答风格不同 |

### 🔍 为什么阶段 2 的搜索结果通常与阶段 1 相同？

```python
# 阶段 1 向量化
query_1 = "Cup 如何测试?"
embedding_1 = [0.234, 0.567, 0.123, ...]  # 1024 维向量

# 阶段 2 向量化
query_2 = "Cup 如何测试? 完整"
embedding_2 = [0.236, 0.565, 0.125, ...]  # 1024 维向量

# 向量相似度
cosine_similarity(embedding_1, embedding_2) ≈ 0.99

# 结果：
# - 两个向量非常相似（"完整"两个字影响很小）
# - 搜索到的段落通常相同
# - 但相似度可能稍低（0.86 → 0.84）
```

**为什么"完整"影响小？**
1. **向量维度高**：1024 维向量，2 个字的影响被稀释
2. **主要语义**：向量主要捕获"Cup"和"测试"的语义
3. **"完整"的泛化性**："完整"是通用词，不影响专业术语匹配

---

## 可能遇到的状况

### 场景 1：两阶段搜索结果完全相同（最常见）⭐

```
阶段 1：
  查询: "Cup 如何测试?"
  search_with_vectors() 执行：
    ├─ 段落搜索 → 找到 2 段落 (0.86, 0.82)
    └─ 返回段落结果
  AI 回答: "根据文档，Cup 测试步骤..."
  不确定性: 含"可能"关键字 → 进入阶段 2

阶段 2：
  查询: "Cup 如何测试? 完整"
  search_with_vectors() 执行：
    ├─ 段落搜索 → 找到相同的 2 段落 (0.84, 0.80)
    └─ 返回段落结果
  AI 回答: "Cup 测试的完整流程如下..."（更详细）
  不确定性: 不含 → 返回阶段 2 结果

分析：
✅ 搜索结果相同
✅ 但 AI 回答更详细（Dify Prompt 影响）
✅ 阶段 2 解决了不确定性
```

**日志示例**：
```log
[INFO] 🔄 模式 B: 两阶段搜索
[INFO]    阶段 1: 发送原查询...
[INFO] ✅ 段落向量搜索成功: 2 个结果 (threshold=0.75)
[INFO] ⚠️ 阶段 1 回答不确定 (含关键字: 可能)
[INFO] 🔄 进入阶段 2: 发送「原查询 + 完整」...
[INFO] ✅ 段落向量搜索成功: 2 个结果 (threshold=0.75)
[INFO] ✅ 阶段 2 回答确定
[INFO]    响应时间: 12.5 秒
```

---

### 场景 2：阶段 1 段落搜索成功，阶段 2 降级到文档搜索

```
阶段 1：
  查询: "Cup 测试"
  search_with_vectors() 执行：
    ├─ 段落搜索 → 找到 2 段落 (0.78, 0.76)
    └─ 返回段落结果
  AI 回答: "无法确定完整的 Cup 测试流程"
  不确定性: 含"无法确定" → 进入阶段 2

阶段 2：
  查询: "Cup 测试 完整"
  search_with_vectors() 执行：
    ├─ 段落搜索 → 未找到段落（threshold=0.75）
    │  - "完整"改变了向量方向
    │  - 相似度降低到 0.72, 0.68（< 0.75）
    ├─ ⚠️ 段落搜索失败，降级
    ├─ 文档搜索 (threshold=0.6375)
    │  → 找到 1 个完整文档 (0.74)
    └─ 返回文档结果
  AI 回答: "根据完整文档，Cup 测试包括..."
  不确定性: 不含 → 返回阶段 2 结果

分析：
⚠️ 阶段 2 触发了降级
✅ 文档搜索提供了更完整的内容
✅ AI 基于完整文档回答
```

**日志示例**：
```log
[INFO] 🔄 模式 B: 两阶段搜索
[INFO]    阶段 1: 发送原查询...
[INFO] ✅ 段落向量搜索成功: 2 个结果 (threshold=0.75)
[INFO] ⚠️ 阶段 1 回答不确定 (含关键字: 无法确定)
[INFO] 🔄 进入阶段 2: 发送「原查询 + 完整」...
[WARNING] ⚠️ 段落向量搜索失败，使用整篇文档搜索: 未找到匹配段落
[INFO] 📄 整篇文档向量搜索返回 1 个结果 (threshold=0.64)
[INFO] ✅ 阶段 2 回答确定
```

---

### 场景 3：阶段 1 降级，阶段 2 也降级

```
阶段 1：
  查询: "罕见的测试项目"
  search_with_vectors() 执行：
    ├─ 段落搜索 → 未找到（threshold=0.75）
    ├─ ⚠️ 降级到文档搜索 (threshold=0.6375)
    └─ 找到 1 个文档 (0.68)
  AI 回答: "我不太清楚这个测试项目"
  不确定性: 含"不太清楚" → 进入阶段 2

阶段 2：
  查询: "罕见的测试项目 完整"
  search_with_vectors() 执行：
    ├─ 段落搜索 → 未找到（threshold=0.75）
    ├─ ⚠️ 降级到文档搜索 (threshold=0.6375)
    └─ 找到 1 个文档 (0.65)
  AI 回答: "根据现有资料，无法提供准确信息"
  不确定性: 含"无法提供" → 进入降级模式

降级模式：
  组合回答 = AI 原始回答 + 友善提示
  "根据现有资料，无法提供准确信息。
   ---
   💡 建议您参考以下文件以获取更准确的信息。"

分析：
⚠️ 两阶段都触发了降级（段落→文档）
⚠️ 阶段 2 仍不确定
✅ 降级模式保持透明度
```

**日志示例**：
```log
[INFO] 🔄 模式 B: 两阶段搜索
[INFO]    阶段 1: 发送原查询...
[WARNING] ⚠️ 段落向量搜索失败，使用整篇文档搜索
[INFO] 📄 整篇文档向量搜索返回 1 个结果 (threshold=0.64)
[INFO] ⚠️ 阶段 1 回答不确定
[INFO] 🔄 进入阶段 2: 发送「原查询 + 完整」...
[WARNING] ⚠️ 段落向量搜索失败，使用整篇文档搜索
[INFO] 📄 整篇文档向量搜索返回 1 个结果 (threshold=0.64)
[INFO] ⚠️ 阶段 2 回答不确定
[INFO] 🔄 进入降级模式：组合回答
```

---

### 场景 4：阶段 1 段落搜索失败（表不存在）

```
阶段 1：
  查询: "Cup 如何测试?"
  search_with_vectors() 执行：
    ├─ 段落搜索 → 抛出异常
    │  PostgreSQL Error: relation "document_section_embeddings" 
    │                     does not exist
    ├─ ❌ 异常被捕获
    ├─ 文档搜索 (threshold=0.6375)
    └─ 找到 1 个文档 (0.78)
  AI 回答: "Cup 测试步骤如下..."
  不确定性: 不含 → 返回阶段 1 结果

分析：
❌ 段落表不存在
✅ 自动降级到文档搜索
✅ 阶段 1 就得到确定答案
⚠️ 不会进入阶段 2
```

**日志示例**：
```log
[INFO] 🔄 模式 B: 两阶段搜索
[INFO]    阶段 1: 发送原查询...
[WARNING] ⚠️ 段落向量搜索失败，使用整篇文档搜索: 
          relation "document_section_embeddings" does not exist
[INFO] 📄 整篇文档向量搜索返回 1 个结果 (threshold=0.64)
[INFO] ✅ 阶段 1 回答确定
[INFO]    响应时间: 6.2 秒
```

---

### 场景 5：阶段 1 和阶段 2 都无搜索结果

```
阶段 1：
  查询: "完全不存在的内容"
  search_with_vectors() 执行：
    ├─ 段落搜索 → 未找到（[]）
    ├─ 文档搜索 → 未找到（[]）
    └─ 返回空列表
  Dify 无知识库结果
  AI 回答: "抱歉，我无法找到相关资料"
  不确定性: 含"无法找到" → 进入阶段 2

阶段 2：
  查询: "完全不存在的内容 完整"
  search_with_vectors() 执行：
    ├─ 段落搜索 → 未找到（[]）
    ├─ 文档搜索 → 未找到（[]）
    └─ 返回空列表
  Dify 无知识库结果
  AI 回答: "很抱歉，无法提供相关信息"
  不确定性: 含"无法提供" → 进入降级模式

降级模式：
  组合回答 = AI 原始回答 + 友善提示

分析：
❌ 数据库中确实无相关内容
⚠️ 两阶段都无搜索结果
✅ 降级模式提供友善反馈
```

**日志示例**：
```log
[INFO] 🔄 模式 B: 两阶段搜索
[INFO]    阶段 1: 发送原查询...
[INFO] ✅ 段落向量搜索成功: 0 个结果
[INFO] 📄 整篇文档向量搜索返回 0 个结果
[INFO] 向量搜索返回 0 条结果
[INFO] ⚠️ 阶段 1 回答不确定
[INFO] 🔄 进入阶段 2...
[INFO] ✅ 段落向量搜索成功: 0 个结果
[INFO] 📄 整篇文档向量搜索返回 0 个结果
[INFO] ⚠️ 阶段 2 回答不确定
[INFO] 🔄 进入降级模式
```

---

## 日志追踪示例

### 完整的两阶段日志（场景 1）

```log
2025-11-12 15:30:00,123 [INFO] library.protocol_guide.smart_search_router:
  🔍 智能路由检测: 查询='Cup 如何测试'

2025-11-12 15:30:00,145 [INFO] library.protocol_guide.smart_search_router:
  ✅ 未检测到全文关键字，使用模式 B（两阶段搜索）

2025-11-12 15:30:00,167 [INFO] library.protocol_guide.two_tier_handler:
  🔄 模式 B: 两阶段搜索（方案 B）
     查询: Cup 如何测试

2025-11-12 15:30:00,189 [INFO] library.protocol_guide.two_tier_handler:
     阶段 1: 发送原查询给 Dify（段落级搜索）...

2025-11-12 15:30:00,234 [INFO] library.dify_integration.chat_client:
  📤 发送 Dify Chat 请求
     查询: Cup 如何测试
     conversation_id: 12345-abc

2025-11-12 15:30:00,456 [INFO] library.dify_knowledge:
  🔍 Dify 调用外部知识库 API
     knowledge_id: protocol_database
     query: Cup 如何测试

2025-11-12 15:30:00,478 [INFO] library.common.knowledge_base.section_search_service:
  📊 段落搜索: source=protocol_guide, 查询='Cup 如何测试', threshold=0.75

2025-11-12 15:30:00,512 [INFO] library.common.knowledge_base.section_search_service:
  ✅ 找到 2 个段落，相似度范围: 0.86 ~ 0.82

2025-11-12 15:30:00,534 [INFO] library.common.knowledge_base.base_search_service:
  ✅ 段落向量搜索成功: 2 个结果 (threshold=0.75)

2025-11-12 15:30:00,556 [INFO] library.common.knowledge_base.base_search_service:
  向量搜索返回 2 条结果 (threshold=0.75)

2025-11-12 15:30:05,678 [INFO] library.dify_integration.chat_client:
  📥 收到 Dify 回应
     answer: 根据文档，Cup 测试流程可能包括...
     message_id: msg-xyz

2025-11-12 15:30:05,723 [INFO] library.common.ai_response.uncertainty_detector:
  🔍 不确定性检测: 检测到关键字 '可能'

2025-11-12 15:30:05,745 [INFO] library.protocol_guide.two_tier_handler:
     ⚠️ 阶段 1 回答不确定 (含关键字: 可能)
     🔄 进入阶段 2: 发送「原查询 + 完整」给 Dify（全文级搜索）...

2025-11-12 15:30:05,767 [INFO] library.protocol_guide.two_tier_handler:
     📝 Stage 2 查询重写: Cup 如何测试 → Cup 如何测试 完整

2025-11-12 15:30:05,812 [INFO] library.dify_integration.chat_client:
  📤 发送 Dify Chat 请求
     查询: Cup 如何测试 完整
     conversation_id: 12345-abc

2025-11-12 15:30:05,945 [INFO] library.dify_knowledge:
  🔍 Dify 调用外部知识库 API
     knowledge_id: protocol_database
     query: Cup 如何测试 完整

2025-11-12 15:30:05,967 [INFO] library.common.knowledge_base.section_search_service:
  📊 段落搜索: source=protocol_guide, 查询='Cup 如何测试 完整', threshold=0.75

2025-11-12 15:30:06,001 [INFO] library.common.knowledge_base.section_search_service:
  ✅ 找到 2 个段落，相似度范围: 0.84 ~ 0.80

2025-11-12 15:30:06,023 [INFO] library.common.knowledge_base.base_search_service:
  ✅ 段落向量搜索成功: 2 个结果 (threshold=0.75)

2025-11-12 15:30:06,045 [INFO] library.common.knowledge_base.base_search_service:
  向量搜索返回 2 条结果 (threshold=0.75)

2025-11-12 15:30:11,234 [INFO] library.dify_integration.chat_client:
  📥 收到 Dify 回应
     answer: Cup 测试的完整流程如下：1. 测试准备...
     message_id: msg-abc

2025-11-12 15:30:11,267 [INFO] library.common.ai_response.uncertainty_detector:
  ✅ 未检测到不确定关键字

2025-11-12 15:30:11,289 [INFO] library.protocol_guide.two_tier_handler:
     ✅ 阶段 2 回答确定
     响应时间: 11.17 秒
```

---

## 优化建议

### 🎯 针对 search_with_vectors 的优化

#### 1. 优化段落向量数据质量

**问题**：段落表为空或数据不完整
```bash
# 检查段落数据量
docker exec postgres_db psql -U postgres -d ai_platform -c "
SELECT source_table, COUNT(*) 
FROM document_section_embeddings 
WHERE source_table = 'protocol_guide'
GROUP BY source_table;"

# 如果数据量为 0，生成段落向量
docker exec ai-django python manage.py shell
>>> from api.services.section_generation_service import generate_all_sections
>>> generate_all_sections('protocol_guide')
```

#### 2. 调整 threshold 策略

**当前问题**：阶段 2 添加"完整"后，相似度可能降低

**解决方案**：
```python
# 在 two_tier_handler.py 中
# 阶段 2 使用稍低的 threshold
if is_full_search:
    threshold = max(threshold * 0.95, 0.7)  # 降低 5%
```

#### 3. 监控降级频率

```python
# 添加统计日志
def search_with_vectors(self, query, limit, threshold):
    # ... 现有代码
    
    if section_results:
        logger.info("✅ 段落搜索成功 (未降级)")
    else:
        logger.warning("⚠️ 触发降级到文档搜索")
        # 统计降级次数
        metrics.increment('vector_search_fallback')
```

#### 4. 优化查询重写策略

**当前策略**：直接添加"完整"
```python
rewritten_query = f"{query} 完整"
```

**改进策略**：根据查询类型智能重写
```python
def rewrite_query_for_stage_2(query):
    """智能查询重写"""
    if '如何' in query:
        return f"{query} 详细步骤"
    elif '是什么' in query:
        return f"{query} 完整定义"
    else:
        return f"{query} 完整"
```

---

## 总结

### 🎯 核心要点

1. **search_with_vectors 的角色**：
   - 在两阶段中都被调用
   - 执行逻辑完全相同
   - 唯一差异是输入的查询字符串

2. **阶段 1 vs 阶段 2**：
   - 阶段 1：原查询 → 段落搜索优先
   - 阶段 2：查询+"完整" → 段落搜索优先（逻辑相同）
   - 差异在 Dify Prompt 如何解释结果

3. **常见执行路径**（按频率）：
   1. ⭐⭐⭐ 阶段 1 段落搜索成功 → 阶段 1 返回
   2. ⭐⭐ 阶段 1 和阶段 2 都段落搜索成功 → 阶段 2 返回
   3. ⭐ 阶段 2 触发降级（段落→文档）→ 阶段 2 返回
   4. ⭐ 阶段 1 触发降级 → 阶段 1 返回（不进阶段 2）
   5. ⭐ 两阶段都降级 → 降级模式返回

4. **可能遇到的状况**：
   - ✅ 搜索结果相同（最常见）
   - ⚠️ 阶段 2 降级（"完整"改变向量）
   - ⚠️ 段落表不存在（自动降级）
   - ⚠️ 数据库无相关内容（返回空）
   - ❌ 数据库连接失败（异常）

5. **优化方向**：
   - 确保段落向量数据完整
   - 调整阶段 2 的 threshold
   - 监控降级频率
   - 优化查询重写策略

---

**文档版本**：v1.0  
**创建日期**：2025-11-12  
**作者**：AI Platform Team  
**相关文档**：
- `docs/architecture/mode-b-two-tier-search-complete-flow.md`
- `docs/architecture/search_with_vectors-call-flow.md`
- `docs/architecture/vector-search-fallback-mechanism.md`
