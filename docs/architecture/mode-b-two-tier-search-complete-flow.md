# æ¨¡å¼ Bï¼šå…©éšæ®µæœå°‹å®Œæ•´æµç¨‹èªªæ˜

## ğŸ“‹ ç›®éŒ„

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [è§¸ç™¼æ¢ä»¶](#è§¸ç™¼æ¢ä»¶)
3. [å®Œæ•´æµç¨‹åœ–](#å®Œæ•´æµç¨‹åœ–)
4. [ç¨‹å¼åŸ·è¡Œæµç¨‹](#ç¨‹å¼åŸ·è¡Œæµç¨‹)
5. [é—œéµç¨‹å¼ç¢¼ä½ç½®](#é—œéµç¨‹å¼ç¢¼ä½ç½®)
6. [è³‡æ–™æµè½‰](#è³‡æ–™æµè½‰)
7. [Dify å‘é‡æœå°‹æ©Ÿåˆ¶](#dify-å‘é‡æœå°‹æ©Ÿåˆ¶)
8. [éšæ®µåˆ¤æ–·é‚è¼¯](#éšæ®µåˆ¤æ–·é‚è¼¯)

---

## æ¦‚è¿°

**æ¨¡å¼ Bï¼ˆå…©éšæ®µæœå°‹ï¼‰**æ˜¯ç•¶ç”¨æˆ¶æŸ¥è©¢**ä¸åŒ…å«å…¨æ–‡é—œéµå­—**æ™‚å•Ÿç”¨çš„æ™ºèƒ½æœå°‹ç­–ç•¥ã€‚

**æ ¸å¿ƒç†å¿µ**ï¼š
- ğŸ¯ **å…ˆå¿«å¾Œæ…¢**ï¼šå„ªå…ˆå˜—è©¦å¿«é€Ÿçš„æ®µè½ç´šæœå°‹
- ğŸ”„ **è‡ªé©æ‡‰å‡ç´š**ï¼šå¦‚æœ AI å›ç­”ä¸ç¢ºå®šï¼Œè‡ªå‹•å‡ç´šåˆ°å…¨æ–‡æœå°‹
- ğŸ“Š **æ¼¸é€²å¼é™ç´š**ï¼šå…©éšæ®µéƒ½ä¸ç¢ºå®šæ™‚ï¼Œæä¾›å‹å–„æç¤º + å¼•ç”¨ä¾†æº

**èˆ‡æ¨¡å¼ A çš„å€åˆ¥**ï¼š
| ç‰¹æ€§ | æ¨¡å¼ Aï¼ˆé—œéµå­—å„ªå…ˆï¼‰ | æ¨¡å¼ Bï¼ˆå…©éšæ®µæœå°‹ï¼‰ |
|------|---------------------|---------------------|
| **è§¸ç™¼æ¢ä»¶** | æŸ¥è©¢å·²å«ã€Œå®Œæ•´ã€ç­‰é—œéµå­— | æŸ¥è©¢ä¸å«å…¨æ–‡é—œéµå­— |
| **æœå°‹éšæ®µ** | å–®éšæ®µï¼ˆç›´æ¥å…¨æ–‡ï¼‰ | å…©éšæ®µï¼ˆæ®µè½ â†’ å…¨æ–‡ï¼‰ |
| **æŸ¥è©¢ä¿®æ”¹** | ä¸ä¿®æ”¹ï¼ˆç›´æ¥ç™¼é€ï¼‰ | éšæ®µ 2 æ·»åŠ ã€Œå®Œæ•´ã€ |
| **é©ç”¨å ´æ™¯** | ç”¨æˆ¶æ˜ç¢ºè¦æ±‚å®Œæ•´è³‡è¨Š | æ¨™æº–æŸ¥è©¢ï¼ˆæ¢ç´¢æ€§ï¼‰ |

---

## è§¸ç™¼æ¢ä»¶

### ä»€éº¼æ™‚å€™æœƒä½¿ç”¨æ¨¡å¼ Bï¼Ÿ

**è§¸ç™¼é‚è¼¯ä½æ–¼**ï¼š`library/protocol_guide/smart_search_router.py`

```python
def route_search_strategy(self, user_query: str) -> str:
    """æ±ºå®šæœå°‹ç­–ç•¥"""
    # æª¢æŸ¥æ˜¯å¦åŒ…å«å…¨æ–‡é—œéµå­—
    contains_keyword, matched_keyword = contains_full_document_keywords(user_query)
    
    if contains_keyword:
        return 'mode_a'  # âœ… æœ‰é—œéµå­— â†’ æ¨¡å¼ A
    else:
        return 'mode_b'  # âœ… ç„¡é—œéµå­— â†’ æ¨¡å¼ Bï¼ˆå…©éšæ®µï¼‰
```

**å…¨æ–‡é—œéµå­—æª¢æ¸¬**ï¼š`library/common/query_analysis/keyword_detector.py`

å…± 47+ å€‹é—œéµå­—ï¼ŒåŒ…æ‹¬ï¼š
- å®Œæ•´æ€§ï¼š`å®Œæ•´`, `å…¨éƒ¨`, `å…¨æ–‡`, `æ•´ä»½`, `æ•´å€‹`
- æ­¥é©Ÿç›¸é—œï¼š`æ­¥é©Ÿ`, `æµç¨‹`, `ç¨‹åº`, `æ“ä½œ`
- è©³ç´°æ€§ï¼š`è©³ç´°`, `ç´°ç¯€`, `æ‰€æœ‰`, `å…¨éƒ¨å…§å®¹`
- è‹±æ–‡ï¼š`complete`, `full`, `detailed`, `step`, `procedure`

**ç¯„ä¾‹**ï¼š
```
âŒ "Cup å®Œæ•´æ¸¬è©¦æµç¨‹"         â†’ æ¨¡å¼ Aï¼ˆå«ã€Œå®Œæ•´ã€ï¼‰
âœ… "Cup å¦‚ä½•æ¸¬è©¦?"            â†’ æ¨¡å¼ Bï¼ˆç„¡é—œéµå­—ï¼‰
âœ… "Cup æ˜¯ä»€éº¼?"              â†’ æ¨¡å¼ Bï¼ˆç„¡é—œéµå­—ï¼‰
âŒ "é¡¯ç¤º Cup æ‰€æœ‰å…§å®¹"        â†’ æ¨¡å¼ Aï¼ˆå«ã€Œæ‰€æœ‰ã€ï¼‰
```

---

## å®Œæ•´æµç¨‹åœ–

```
ç”¨æˆ¶æŸ¥è©¢: "Cup å¦‚ä½•æ¸¬è©¦?"
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ™ºèƒ½è·¯ç”±å™¨ (SmartSearchRouter)                       â”‚
â”‚    library/protocol_guide/smart_search_router.py        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ route_search_strategy(user_query)                    â”‚
â”‚  â€¢ æª¢æ¸¬å…¨æ–‡é—œéµå­—ï¼šFalse                                 â”‚
â”‚  â€¢ æ±ºç­–ï¼šmode_b (å…©éšæ®µæœå°‹)                             â”‚
â”‚  â€¢ èª¿ç”¨ï¼šmode_b_handler.handle_two_tier_search()        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å…©éšæ®µæœå°‹è™•ç†å™¨ (TwoTierSearchHandler)              â”‚
â”‚    library/protocol_guide/two_tier_handler.py           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  handle_two_tier_search(user_query, conversation_id)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘ ğŸ“ éšæ®µ 1ï¼šæ®µè½ç´šæœå°‹                                    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Step 1.1: èª¿ç”¨ _request_dify_chat()                    â•‘
â•‘   â€¢ query: "Cup å¦‚ä½•æ¸¬è©¦?" (åŸæŸ¥è©¢ï¼Œä¸ä¿®æ”¹)             â•‘
â•‘   â€¢ is_full_search: False                               â•‘
â•‘   â€¢ conversation_id: xxx-xxx-xxx                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Dify Chat Client                                      â”‚
â”‚    library/dify_integration/chat_client.py              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DifyChatClient.chat()                                  â”‚
â”‚  â€¢ æ§‹å»º payload:                                        â”‚
â”‚    {                                                    â”‚
â”‚      "query": "Cup å¦‚ä½•æ¸¬è©¦?",                          â”‚
â”‚      "conversation_id": "xxx-xxx-xxx",                  â”‚
â”‚      "user": "protocol_guide_user_1",                   â”‚
â”‚      "response_mode": "blocking"                        â”‚
â”‚    }                                                    â”‚
â”‚  â€¢ ç™¼é€ POST è«‹æ±‚åˆ° Dify API                            â”‚
â”‚    http://10.10.172.37/v1/chat-messages                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Dify ç³»çµ±è™•ç† (é»‘ç®±)                                 â”‚
â”‚    http://10.10.172.37 (Dify å·¥ä½œå®¤)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 4.1: Dify æ¥æ”¶æŸ¥è©¢ "Cup å¦‚ä½•æ¸¬è©¦?"                â”‚
â”‚  Step 4.2: è®€å– Protocol Guide APP çš„ Prompt é…ç½®       â”‚
â”‚  Step 4.3: åˆ¤æ–·æŸ¥è©¢ä¸å«ã€Œå®Œæ•´ã€â†’ æ®µè½ç´šæœå°‹             â”‚
â”‚  Step 4.4: èª¿ç”¨å¤–éƒ¨çŸ¥è­˜åº« API                           â”‚
â”‚            POST /api/dify/knowledge/retrieval           â”‚
â”‚            {                                            â”‚
â”‚              "knowledge_id": "protocol_guide_db",       â”‚
â”‚              "query": "Cup å¦‚ä½•æ¸¬è©¦?",                   â”‚
â”‚              "retrieval_setting": {                     â”‚
â”‚                "top_k": 3,                              â”‚
â”‚                "score_threshold": 0.75                  â”‚
â”‚              }                                          â”‚
â”‚            }                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å¤–éƒ¨çŸ¥è­˜åº« API                                        â”‚
â”‚    backend/api/views/dify_knowledge_views.py            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  @api_view(['POST'])                                    â”‚
â”‚  def dify_knowledge_search(request):                    â”‚
â”‚    â€¢ è§£æè«‹æ±‚åƒæ•¸                                        â”‚
â”‚    â€¢ knowledge_id = "protocol_guide_db"                 â”‚
â”‚    â€¢ query = "Cup å¦‚ä½•æ¸¬è©¦?"                             â”‚
â”‚    â€¢ score_threshold = 0.75                             â”‚
â”‚                                                         â”‚
â”‚    â€¢ èª¿ç”¨ DifyKnowledgeSearchHandler.search()           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Dify çŸ¥è­˜æœå°‹è™•ç†å™¨                                   â”‚
â”‚    library/dify_knowledge/__init__.py                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DifyKnowledgeSearchHandler.search()                    â”‚
â”‚  â€¢ æ ¹æ“š knowledge_id é¸æ“‡æœå°‹æœå‹™                       â”‚
â”‚  â€¢ èª¿ç”¨ ProtocolGuideSearchService.search_knowledge()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Protocol Guide æœå°‹æœå‹™                               â”‚
â”‚    library/protocol_guide/search_service.py             â”‚
â”‚    (ç¹¼æ‰¿è‡ª BaseKnowledgeBaseSearchService)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  search_knowledge(query, limit=3, threshold=0.75)       â”‚
â”‚  â€¢ å„ªå…ˆï¼šæ®µè½å‘é‡æœå°‹ (search_with_vectors)             â”‚
â”‚  â€¢ å‚™ç”¨ï¼šé—œéµå­—æœå°‹ (search_with_keywords)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. æ®µè½å‘é‡æœå°‹æœå‹™                                      â”‚
â”‚    library/common/knowledge_base/section_search_service â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SectionSearchService.search_sections()                 â”‚
â”‚  â€¢ è³‡æ–™åº«ï¼šdocument_section_embeddings                  â”‚
â”‚  â€¢ SQL æŸ¥è©¢ï¼š                                           â”‚
â”‚    SELECT section_id, content, heading_text,            â”‚
â”‚           embedding <=> query_vector AS distance        â”‚
â”‚    FROM document_section_embeddings                     â”‚
â”‚    WHERE source_table = 'protocol_guide'                â”‚
â”‚      AND (1 - distance) >= 0.75                         â”‚
â”‚    ORDER BY distance                                    â”‚
â”‚    LIMIT 6                                              â”‚
â”‚                                                         â”‚
â”‚  â€¢ è¿”å›ï¼š2 å€‹æ®µè½ï¼ˆç›¸ä¼¼åº¦ > 0.75ï¼‰                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. é—œéµå­—æœå°‹è£œå……ï¼ˆå¦‚æœå‘é‡çµæœä¸è¶³ï¼‰                     â”‚
â”‚    library/common/knowledge_base/base_search_service.py â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  search_with_keywords(query, limit, threshold)          â”‚
â”‚  â€¢ Django ORM æŸ¥è©¢ï¼š                                    â”‚
â”‚    ProtocolGuide.objects.filter(                        â”‚
â”‚      Q(title__icontains=query) |                        â”‚
â”‚      Q(content__icontains=query)                        â”‚
â”‚    )                                                    â”‚
â”‚  â€¢ è¨ˆç®—ç›¸ä¼¼åº¦åˆ†æ•¸ (_calculate_keyword_score)            â”‚
â”‚  â€¢ éæ¿¾ score >= threshold                              â”‚
â”‚  â€¢ è¿”å›ï¼š1 å€‹è£œå……çµæœï¼ˆå¦‚æœæœ‰ï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. æ ¼å¼åŒ–æœå°‹çµæœ                                       â”‚
â”‚     library/common/knowledge_base/base_search_service.pyâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  _format_section_results_to_standard()                  â”‚
â”‚  â€¢ æŒ‰ source_id åˆ†çµ„æ®µè½                                â”‚
â”‚  â€¢ åˆä½µåŒä¸€æ–‡æª”çš„å¤šå€‹æ®µè½                                â”‚
â”‚  â€¢ æå–åœ–ç‰‡å¼•ç”¨ [IMG:xx]                                â”‚
â”‚  â€¢ è¿”å›æ¨™æº– Dify æ ¼å¼ï¼š                                 â”‚
â”‚    {                                                    â”‚
â”‚      "records": [                                       â”‚
â”‚        {                                                â”‚
â”‚          "content": "## æ®µè½æ¨™é¡Œ\næ®µè½å…§å®¹...",          â”‚
â”‚          "score": 0.86,                                 â”‚
â”‚          "title": "Cup æ¸¬è©¦æŒ‡å—",                        â”‚
â”‚          "metadata": {                                  â”‚
â”‚            "document_id": "20",                         â”‚
â”‚            "dataset_id": "protocol_guide_db"            â”‚
â”‚          }                                              â”‚
â”‚        }                                                â”‚
â”‚      ]                                                  â”‚
â”‚    }                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (è¿”å›æœå°‹çµæœçµ¦ Dify)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. Dify ç³»çµ±è™•ç†æœå°‹çµæœ (é»‘ç®±)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 11.1: æ¥æ”¶ 3 æ¢æœå°‹çµæœï¼ˆæ®µè½å…§å®¹ï¼‰                â”‚
â”‚  Step 11.2: å°‡æœå°‹çµæœä½œç‚ºä¸Šä¸‹æ–‡å‚³éçµ¦ LLM              â”‚
â”‚  Step 11.3: LLM åŸºæ–¼ä¸Šä¸‹æ–‡ç”Ÿæˆå›ç­”                      â”‚
â”‚  Step 11.4: è¿”å›å›ç­” + metadata (åŒ…å«å¼•ç”¨ä¾†æº)          â”‚
â”‚                                                         â”‚
â”‚  å›æ‡‰æ ¼å¼ï¼š                                              â”‚
â”‚  {                                                      â”‚
â”‚    "answer": "æ ¹æ“š Cup æ¸¬è©¦æŒ‡å—ï¼Œæ¸¬è©¦æµç¨‹åŒ…æ‹¬...",       â”‚
â”‚    "message_id": "msg-xxx",                             â”‚
â”‚    "conversation_id": "conv-xxx",                       â”‚
â”‚    "metadata": {                                        â”‚
â”‚      "usage": {"tokens": 1234, ...},                   â”‚
â”‚      "retriever_resources": [                           â”‚
â”‚        {                                                â”‚
â”‚          "document_id": "20",                           â”‚
â”‚          "document_name": "Cup æ¸¬è©¦æŒ‡å—",               â”‚
â”‚          "segment_id": "seg-xxx",                       â”‚
â”‚          "score": 0.86                                  â”‚
â”‚        }                                                â”‚
â”‚      ]                                                  â”‚
â”‚    }                                                    â”‚
â”‚  }                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (Dify å›æ‡‰è¿”å›)
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘ ğŸ“ éšæ®µ 1 å›ç­”æª¢æ¸¬                                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Step 1.2: æ¥æ”¶ Dify å›æ‡‰                                â•‘
â•‘   stage_1_answer = response.get('answer')               â•‘
â•‘                                                         â•‘
â•‘ Step 1.3: ä¸ç¢ºå®šæ€§æª¢æ¸¬                                  â•‘
â•‘   is_uncertain_response(stage_1_answer)                 â•‘
â•‘   â†’ library/common/ai_response/uncertainty_detector.py  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    â†“
    â”œâ”€ æƒ…æ³ Aï¼šå›ç­”ç¢ºå®š âœ…
    â”‚   â†“
    â”‚   è¿”å›çµæœï¼š
    â”‚   {
    â”‚     'answer': "æ ¹æ“š Cup æ¸¬è©¦æŒ‡å—ï¼Œæ¸¬è©¦æµç¨‹åŒ…æ‹¬...",
    â”‚     'mode': 'mode_b',
    â”‚     'stage': 1,  â† éšæ®µ 1 æˆåŠŸ
    â”‚     'is_fallback': False,
    â”‚     'metadata': {...},  â† åŒ…å«å¼•ç”¨ä¾†æº
    â”‚   }
    â”‚   â†“
    â”‚   [æµç¨‹çµæŸ] âœ…
    â”‚
    â””â”€ æƒ…æ³ Bï¼šå›ç­”ä¸ç¢ºå®š âš ï¸
        â†“
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘ ğŸ“ éšæ®µ 2ï¼šå…¨æ–‡ç´šæœå°‹                                    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Step 2.1: èª¿ç”¨ _request_dify_chat()                    â•‘
â•‘   â€¢ query: "Cup å¦‚ä½•æ¸¬è©¦?" (åŸæŸ¥è©¢)                     â•‘
â•‘   â€¢ is_full_search: True  â† é—œéµï¼                      â•‘
â•‘                                                         â•‘
â•‘ Step 2.2: æŸ¥è©¢é‡å¯«                                      â•‘
â•‘   rewritten_query = f"{query} å®Œæ•´"                    â•‘
â•‘   â†’ "Cup å¦‚ä½•æ¸¬è©¦? å®Œæ•´"                                 â•‘
â•‘                                                         â•‘
â•‘ Step 2.3: ç™¼é€çµ¦ Dify                                   â•‘
â•‘   â€¢ query: "Cup å¦‚ä½•æ¸¬è©¦? å®Œæ•´"  â† æ·»åŠ ã€Œå®Œæ•´ã€è§¸ç™¼è©   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é‡è¤‡æ­¥é©Ÿ 3-11ï¼ˆDify â†’ å¤–éƒ¨çŸ¥è­˜åº« â†’ å‘é‡æœå°‹ï¼‰           â”‚
â”‚                                                         â”‚
â”‚ å·®ç•°ï¼š                                                   â”‚
â”‚ â€¢ Dify æ”¶åˆ°ã€ŒCup å¦‚ä½•æ¸¬è©¦? å®Œæ•´ã€                        â”‚
â”‚ â€¢ Dify åˆ¤æ–·å«ã€Œå®Œæ•´ã€â†’ å…¨æ–‡ç´šæœå°‹                        â”‚
â”‚ â€¢ å¯èƒ½æœƒæœå°‹æ•´ç¯‡æ–‡æª”å‘é‡ï¼ˆè€Œéæ®µè½ï¼‰                      â”‚
â”‚ â€¢ è¿”å›æ›´å®Œæ•´çš„å…§å®¹                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘ ğŸ“ éšæ®µ 2 å›ç­”æª¢æ¸¬                                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Step 2.4: æ¥æ”¶ Dify å›æ‡‰                                â•‘
â•‘   stage_2_answer = response.get('answer')               â•‘
â•‘                                                         â•‘
â•‘ Step 2.5: ä¸ç¢ºå®šæ€§æª¢æ¸¬                                  â•‘
â•‘   is_uncertain_response(stage_2_answer)                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    â†“
    â”œâ”€ æƒ…æ³ Aï¼šå›ç­”ç¢ºå®š âœ…
    â”‚   â†“
    â”‚   è¿”å›çµæœï¼š
    â”‚   {
    â”‚     'answer': "æ ¹æ“š Cup å®Œæ•´æ–‡æª”...",
    â”‚     'mode': 'mode_b',
    â”‚     'stage': 2,  â† éšæ®µ 2 æˆåŠŸ
    â”‚     'is_fallback': False,
    â”‚     'metadata': {...},
    â”‚   }
    â”‚   â†“
    â”‚   [æµç¨‹çµæŸ] âœ…
    â”‚
    â””â”€ æƒ…æ³ Bï¼šä»ç„¶ä¸ç¢ºå®š âš ï¸
        â†“
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘ ğŸ“ é™ç´šæ¨¡å¼ï¼šçµ„åˆå›ç­” + å‹å–„æç¤º                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Step 3.1: çµ„åˆå›ç­”                                      â•‘
â•‘   original_answer = stage_2_response.get('answer')      â•‘
â•‘   combined_answer = f"{original_answer}\n\n---\n\n      â•‘
â•‘     ğŸ’¡ **å»ºè­°æ‚¨åƒè€ƒä»¥ä¸‹æ–‡ä»¶ä»¥ç²å–æ›´æº–ç¢ºçš„è³‡è¨Šã€‚**"        â•‘
â•‘                                                         â•‘
â•‘ Step 3.2: è¿”å›çµæœ                                      â•‘
â•‘   {                                                     â•‘
â•‘     'answer': combined_answer,  â† ä¿ç•™ AI åˆ†æ          â•‘
â•‘     'mode': 'mode_b',                                   â•‘
â•‘     'stage': 2,                                         â•‘
â•‘     'is_fallback': True,  â† æ¨™è¨˜ç‚ºé™ç´š                  â•‘
â•‘     'fallback_reason': 'éšæ®µ 2 AI å›ç­”ä¸ç¢ºå®š',          â•‘
â•‘     'metadata': {...},  â† åŒ…å«å¼•ç”¨ä¾†æºï¼ˆé‡è¦ï¼ï¼‰         â•‘
â•‘   }                                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    â†“
    [æµç¨‹çµæŸ] âš ï¸
```

---

## ç¨‹å¼åŸ·è¡Œæµç¨‹

### ğŸ“ å®Œæ•´å‘¼å«éˆ

```
1. ç”¨æˆ¶è«‹æ±‚
   â†“
2. frontend/src/hooks/useProtocolAssistantChat.js
   sendMessage() â†’ POST /api/protocol-guide/chat/
   â†“
3. backend/api/views/viewsets/knowledge_viewsets.py
   ProtocolGuideViewSet.chat()
   â†“
4. library/protocol_guide/smart_search_router.py
   SmartSearchRouter.handle_smart_search()
   â”œâ”€ route_search_strategy() â†’ æ±ºå®š 'mode_b'
   â””â”€ mode_b_handler.handle_two_tier_search()
   â†“
5. library/protocol_guide/two_tier_handler.py
   TwoTierSearchHandler.handle_two_tier_search()
   â”œâ”€ éšæ®µ 1: _request_dify_chat(is_full_search=False)
   â”‚   â†“
   â”‚   library/dify_integration/chat_client.py
   â”‚   DifyChatClient.chat(question="Cup å¦‚ä½•æ¸¬è©¦?")
   â”‚   â†“
   â”‚   POST http://10.10.172.37/v1/chat-messages
   â”‚   â†“
   â”‚   Dify è™•ç† (é»‘ç®±)
   â”‚   â”œâ”€ èª¿ç”¨å¤–éƒ¨çŸ¥è­˜åº« API
   â”‚   â”‚   POST /api/dify/knowledge/retrieval
   â”‚   â”‚   â†“
   â”‚   â”‚   backend/api/views/dify_knowledge_views.py
   â”‚   â”‚   dify_knowledge_search()
   â”‚   â”‚   â†“
   â”‚   â”‚   library/dify_knowledge/__init__.py
   â”‚   â”‚   DifyKnowledgeSearchHandler.search()
   â”‚   â”‚   â†“
   â”‚   â”‚   library/protocol_guide/search_service.py
   â”‚   â”‚   ProtocolGuideSearchService.search_knowledge()
   â”‚   â”‚   â†“
   â”‚   â”‚   library/common/knowledge_base/
   â”‚   â”‚   â”œâ”€ section_search_service.py (æ®µè½å‘é‡æœå°‹)
   â”‚   â”‚   â””â”€ base_search_service.py (é—œéµå­—è£œå……)
   â”‚   â”‚   â†“
   â”‚   â”‚   è¿”å›æœå°‹çµæœçµ¦ Dify
   â”‚   â”œâ”€ Dify LLM ç”Ÿæˆå›ç­”
   â”‚   â””â”€ è¿”å› stage_1_response
   â”‚
   â”œâ”€ æª¢æ¸¬ï¼šis_uncertain_response(stage_1_answer)
   â”‚   â†“
   â”‚   library/common/ai_response/uncertainty_detector.py
   â”‚   â”œâ”€ æª¢æŸ¥ä¸ç¢ºå®šé—œéµå­—ï¼ˆ47+ï¼‰
   â”‚   â””â”€ è¿”å› (is_uncertain, keyword)
   â”‚
   â”œâ”€ å¦‚æœç¢ºå®š â†’ è¿”å›éšæ®µ 1 çµæœ âœ…
   â”‚
   â””â”€ å¦‚æœä¸ç¢ºå®š â†’ éšæ®µ 2: _request_dify_chat(is_full_search=True)
       â”œâ”€ æŸ¥è©¢é‡å¯«ï¼šquery â†’ "query å®Œæ•´"
       â”œâ”€ é‡è¤‡ä¸Šè¿° Dify èª¿ç”¨æµç¨‹ï¼ˆä½†æŸ¥è©¢å«ã€Œå®Œæ•´ã€ï¼‰
       â”œâ”€ æª¢æ¸¬ï¼šis_uncertain_response(stage_2_answer)
       â”œâ”€ å¦‚æœç¢ºå®š â†’ è¿”å›éšæ®µ 2 çµæœ âœ…
       â””â”€ å¦‚æœä¸ç¢ºå®š â†’ çµ„åˆå›ç­” + å‹å–„æç¤º âš ï¸
```

---

## é—œéµç¨‹å¼ç¢¼ä½ç½®

### ğŸ¯ ä¸»è¦æª”æ¡ˆæ¸…å–®

| æª”æ¡ˆè·¯å¾‘ | åŠŸèƒ½ | é—œéµæ–¹æ³•/å‡½æ•¸ |
|---------|------|-------------|
| **è·¯ç”±æ±ºç­–** |||
| `library/protocol_guide/smart_search_router.py` | æ™ºèƒ½è·¯ç”±å™¨ | `route_search_strategy()`, `handle_smart_search()` |
| `library/common/query_analysis/keyword_detector.py` | é—œéµå­—æª¢æ¸¬ | `contains_full_document_keywords()`, `FULL_DOCUMENT_KEYWORDS` |
| **å…©éšæ®µè™•ç†** |||
| `library/protocol_guide/two_tier_handler.py` | å…©éšæ®µè™•ç†å™¨ | `handle_two_tier_search()`, `_request_dify_chat()` |
| `library/common/ai_response/uncertainty_detector.py` | ä¸ç¢ºå®šæ€§æª¢æ¸¬ | `is_uncertain_response()`, `UNCERTAINTY_KEYWORDS` |
| **Dify æ•´åˆ** |||
| `library/dify_integration/chat_client.py` | Dify Chat å®¢æˆ¶ç«¯ | `DifyChatClient.chat()` |
| `library/config/dify_config_manager.py` | Dify é…ç½®ç®¡ç† | `get_protocol_guide_config()` |
| **å¤–éƒ¨çŸ¥è­˜åº«** |||
| `backend/api/views/dify_knowledge_views.py` | çŸ¥è­˜åº« API å…¥å£ | `dify_knowledge_search()` |
| `library/dify_knowledge/__init__.py` | çŸ¥è­˜æœå°‹è™•ç†å™¨ | `DifyKnowledgeSearchHandler.search()` |
| **æœå°‹æœå‹™** |||
| `library/protocol_guide/search_service.py` | Protocol Guide æœå°‹ | `ProtocolGuideSearchService` (ç¹¼æ‰¿åŸºé¡) |
| `library/common/knowledge_base/base_search_service.py` | æœå°‹æœå‹™åŸºé¡ | `search_knowledge()`, `search_with_vectors()`, `search_with_keywords()` |
| `library/common/knowledge_base/section_search_service.py` | æ®µè½å‘é‡æœå°‹ | `SectionSearchService.search_sections()` |
| `library/common/knowledge_base/vector_search_helper.py` | å‘é‡æœå°‹è¼”åŠ© | `search_with_vectors_generic()` |

### ğŸ“Š ç¨‹å¼ç¢¼è¡Œæ•¸åƒè€ƒ

```python
# æ™ºèƒ½è·¯ç”±å™¨
library/protocol_guide/smart_search_router.py: 131 è¡Œ
  - route_search_strategy(): ç¬¬ 38-66 è¡Œ
  - handle_smart_search(): ç¬¬ 68-130 è¡Œ

# å…©éšæ®µè™•ç†å™¨
library/protocol_guide/two_tier_handler.py: 227 è¡Œ
  - handle_two_tier_search(): ç¬¬ 77-187 è¡Œ
  - _request_dify_chat(): ç¬¬ 189-227 è¡Œ

# ä¸ç¢ºå®šæ€§æª¢æ¸¬
library/common/ai_response/uncertainty_detector.py: 193 è¡Œ
  - UNCERTAINTY_KEYWORDS: ç¬¬ 16-28 è¡Œï¼ˆ47+ é—œéµå­—ï¼‰
  - is_uncertain_response(): ç¬¬ 31-79 è¡Œ

# æœå°‹æœå‹™åŸºé¡
library/common/knowledge_base/base_search_service.py: 470 è¡Œ
  - search_knowledge(): ç¬¬ 58-105 è¡Œ
  - search_with_vectors(): ç¬¬ 107-172 è¡Œ
  - search_with_keywords(): ç¬¬ 174-240 è¡Œ
  - _calculate_keyword_score(): ç¬¬ 399-470 è¡Œ
```

---

## è³‡æ–™æµè½‰

### ğŸ“Š è³‡æ–™åœ¨å„éšæ®µçš„è®ŠåŒ–

#### éšæ®µ 1ï¼šæ®µè½ç´šæœå°‹

```yaml
Input (ç”¨æˆ¶):
  query: "Cup å¦‚ä½•æ¸¬è©¦?"
  conversation_id: "conv-abc-123"

â†“ (æ™ºèƒ½è·¯ç”±)

Router Decision:
  mode: "mode_b"
  reason: "ç„¡å…¨æ–‡é—œéµå­—"

â†“ (éšæ®µ 1 è™•ç†)

Dify Request (Stage 1):
  {
    "query": "Cup å¦‚ä½•æ¸¬è©¦?",  # åŸæŸ¥è©¢ï¼ˆä¸ä¿®æ”¹ï¼‰
    "conversation_id": "conv-abc-123",
    "user": "protocol_guide_user_1",
    "response_mode": "blocking"
  }

â†“ (Dify è™•ç†)

Dify â†’ å¤–éƒ¨çŸ¥è­˜åº« API:
  POST /api/dify/knowledge/retrieval
  {
    "knowledge_id": "protocol_guide_db",
    "query": "Cup å¦‚ä½•æ¸¬è©¦?",
    "retrieval_setting": {
      "top_k": 3,
      "score_threshold": 0.75
    }
  }

â†“ (å‘é‡æœå°‹)

Database Query (æ®µè½å‘é‡):
  SELECT section_id, content, heading_text, similarity
  FROM document_section_embeddings
  WHERE source_table = 'protocol_guide'
    AND similarity >= 0.75
  ORDER BY similarity DESC
  LIMIT 6

â†“ (æœå°‹çµæœ)

Search Results:
  [
    {
      "content": "## Cup æ¸¬è©¦æº–å‚™\nç¢ºä¿æ¸¬è©¦ç’°å¢ƒ...",
      "score": 0.86,
      "title": "Cup æ¸¬è©¦æŒ‡å—",
      "metadata": {"id": 20}
    },
    {
      "content": "## æ¸¬è©¦æ­¥é©Ÿ\n1. æº–å‚™æ¸¬è©¦...",
      "score": 0.82,
      "title": "Cup æ¸¬è©¦æŒ‡å—",
      "metadata": {"id": 20}
    }
  ]

â†“ (è¿”å›çµ¦ Dify)

Dify Response (Stage 1):
  {
    "answer": "æ ¹æ“š Cup æ¸¬è©¦æŒ‡å—ï¼Œæ¸¬è©¦æµç¨‹åŒ…æ‹¬ï¼š\n1. æ¸¬è©¦æº–å‚™...",
    "message_id": "msg-xxx",
    "conversation_id": "conv-abc-123",
    "metadata": {
      "retriever_resources": [
        {
          "document_id": "20",
          "document_name": "Cup æ¸¬è©¦æŒ‡å—",
          "score": 0.86
        }
      ]
    }
  }

â†“ (ä¸ç¢ºå®šæ€§æª¢æ¸¬)

Uncertainty Check:
  answer: "æ ¹æ“š Cup æ¸¬è©¦æŒ‡å—ï¼Œæ¸¬è©¦æµç¨‹åŒ…æ‹¬ï¼š..."
  is_uncertain: False  # æ²’æœ‰ã€Œä¸ç¢ºå®šã€é—œéµå­—
  matched_keyword: None

â†“ (éšæ®µ 1 æˆåŠŸ)

Final Response:
  {
    "answer": "æ ¹æ“š Cup æ¸¬è©¦æŒ‡å—ï¼Œæ¸¬è©¦æµç¨‹åŒ…æ‹¬ï¼š...",
    "mode": "mode_b",
    "stage": 1,  # â† éšæ®µ 1 å®Œæˆ
    "is_fallback": False,
    "response_time": 3.25,
    "metadata": {...}  # åŒ…å«å¼•ç”¨ä¾†æº
  }
```

#### éšæ®µ 2ï¼šå…¨æ–‡ç´šæœå°‹ï¼ˆç•¶éšæ®µ 1 ä¸ç¢ºå®šæ™‚ï¼‰

```yaml
Input (éšæ®µ 1 ä¸ç¢ºå®š):
  stage_1_answer: "æŠ±æ­‰ï¼Œæˆ‘æ²’æœ‰æ‰¾åˆ°ç›¸é—œè³‡æ–™ã€‚"
  is_uncertain: True
  matched_keyword: "æ²’æœ‰æ‰¾åˆ°"

â†“ (é€²å…¥éšæ®µ 2)

Query Rewriting:
  original_query: "Cup å¦‚ä½•æ¸¬è©¦?"
  rewritten_query: "Cup å¦‚ä½•æ¸¬è©¦? å®Œæ•´"  # â† æ·»åŠ ã€Œå®Œæ•´ã€

â†“ (éšæ®µ 2 è™•ç†)

Dify Request (Stage 2):
  {
    "query": "Cup å¦‚ä½•æ¸¬è©¦? å®Œæ•´",  # â† é‡å¯«å¾Œçš„æŸ¥è©¢
    "conversation_id": "conv-abc-123",
    "user": "protocol_guide_user_1",
    "response_mode": "blocking"
  }

â†“ (Dify è™•ç† - å«ã€Œå®Œæ•´ã€)

Dify åˆ¤æ–·:
  - æŸ¥è©¢å«ã€Œå®Œæ•´ã€é—œéµå­—
  - è§¸ç™¼å…¨æ–‡ç´šæœå°‹
  - å¯èƒ½ä½¿ç”¨æ•´ç¯‡æ–‡æª”å‘é‡

â†“ (å‘é‡æœå°‹ - å…¨æ–‡ç´š)

Database Query (æ•´ç¯‡æ–‡æª”å‘é‡):
  SELECT id, title, content, similarity
  FROM document_embeddings
  WHERE source_table = 'protocol_guide'
    AND similarity >= 0.6  # ç¨ä½çš„é–¾å€¼
  ORDER BY similarity DESC
  LIMIT 3

â†“ (æœå°‹çµæœ - æ›´å®Œæ•´)

Search Results:
  [
    {
      "content": "# Cup æ¸¬è©¦æŒ‡å—\n\n## æ¸¬è©¦ç›®çš„\n...\n## æ¸¬è©¦æº–å‚™\n...\n## æ¸¬è©¦æ­¥é©Ÿ\n...",
      "score": 0.78,
      "title": "Cup æ¸¬è©¦æŒ‡å—ï¼ˆå®Œæ•´ç‰ˆï¼‰",
      "metadata": {"id": 20}
    }
  ]

â†“ (Dify ç”Ÿæˆå›ç­”)

Dify Response (Stage 2):
  {
    "answer": "æ ¹æ“š Cup æ¸¬è©¦æŒ‡å—å®Œæ•´ç‰ˆï¼Œæ¸¬è©¦æµç¨‹éå¸¸è©³ç´°ï¼š\n\n### æ¸¬è©¦ç›®çš„\n...",
    "message_id": "msg-yyy",
    "conversation_id": "conv-abc-123",
    "metadata": {
      "retriever_resources": [...]
    }
  }

â†“ (ä¸ç¢ºå®šæ€§æª¢æ¸¬)

Uncertainty Check (Stage 2):
  answer: "æ ¹æ“š Cup æ¸¬è©¦æŒ‡å—å®Œæ•´ç‰ˆ..."
  is_uncertain: False  # ç¢ºå®šå›ç­”
  matched_keyword: None

â†“ (éšæ®µ 2 æˆåŠŸ)

Final Response:
  {
    "answer": "æ ¹æ“š Cup æ¸¬è©¦æŒ‡å—å®Œæ•´ç‰ˆ...",
    "mode": "mode_b",
    "stage": 2,  # â† éšæ®µ 2 å®Œæˆ
    "is_fallback": False,
    "response_time": 5.80,
    "metadata": {...}
  }
```

#### é™ç´šæ¨¡å¼ï¼ˆéšæ®µ 2 ä»ä¸ç¢ºå®šï¼‰

```yaml
Input (éšæ®µ 2 ä»ä¸ç¢ºå®š):
  stage_2_answer: "æŠ±æ­‰ï¼Œå³ä½¿æŸ¥çœ‹å®Œæ•´æ–‡æª”ï¼Œæˆ‘ä¹Ÿç„¡æ³•ç¢ºèª..."
  is_uncertain: True
  matched_keyword: "ç„¡æ³•ç¢ºèª"

â†“ (é€²å…¥é™ç´šæ¨¡å¼)

Fallback Processing:
  original_answer: "æŠ±æ­‰ï¼Œå³ä½¿æŸ¥çœ‹å®Œæ•´æ–‡æª”ï¼Œæˆ‘ä¹Ÿç„¡æ³•ç¢ºèª..."
  
  combined_answer: 
    """
    æŠ±æ­‰ï¼Œå³ä½¿æŸ¥çœ‹å®Œæ•´æ–‡æª”ï¼Œæˆ‘ä¹Ÿç„¡æ³•ç¢ºèª...
    
    ---
    
    ğŸ’¡ **å»ºè­°æ‚¨åƒè€ƒä»¥ä¸‹æ–‡ä»¶ä»¥ç²å–æ›´æº–ç¢ºçš„è³‡è¨Šã€‚**
    """

â†“ (é™ç´šæ¨¡å¼å›æ‡‰)

Final Response:
  {
    "answer": combined_answer,  # â† çµ„åˆå›ç­”
    "mode": "mode_b",
    "stage": 2,
    "is_fallback": True,  # â† é™ç´šæ¨™è¨˜
    "fallback_reason": "éšæ®µ 2 AI å›ç­”ä¸ç¢ºå®š (å«: ç„¡æ³•ç¢ºèª)",
    "response_time": 8.45,
    "metadata": {
      "retriever_resources": [...]  # â† ä»åŒ…å«å¼•ç”¨ä¾†æºï¼ˆé‡è¦ï¼ï¼‰
    }
  }

â†“ (å‰ç«¯é¡¯ç¤º)

UI Display:
  - é¡¯ç¤º AI åŸå§‹åˆ†æï¼ˆä¿æŒé€æ˜åº¦ï¼‰
  - é¡¯ç¤ºåˆ†éš”ç·šå’Œå‹å–„æç¤º
  - é¡¯ç¤ºå¼•ç”¨ä¾†æºåˆ—è¡¨ï¼ˆä¾†è‡ª metadata.retriever_resourcesï¼‰
  - ç”¨æˆ¶å¯é»æ“ŠæŸ¥çœ‹åŸå§‹æ–‡æª”
```

---

## Dify å‘é‡æœå°‹æ©Ÿåˆ¶

### ğŸ¤” Dify å¦‚ä½•æ±ºå®šæ®µè½ vs å…¨æ–‡æœå°‹ï¼Ÿ

**é‡è¦ç†è§£**ï¼šDify çš„æœå°‹è¡Œç‚ºæ˜¯ç”± **Dify å·¥ä½œå®¤çš„ Prompt é…ç½®** æ±ºå®šçš„ï¼Œä¸æ˜¯ç”± Python ç¨‹å¼ç¢¼æ§åˆ¶ã€‚

#### Dify å·¥ä½œå®¤é…ç½®ï¼ˆæ¨æ¸¬ï¼‰

```
ç³»çµ±æç¤ºè©ç¯„ä¾‹ï¼ˆProtocol Guide APPï¼‰:

ä½ æ˜¯ Protocol æ¸¬è©¦å°ˆå®¶ï¼Œè² è²¬å›ç­”æ¸¬è©¦ç›¸é—œå•é¡Œã€‚

**æœå°‹ç­–ç•¥**ï¼š
1. å¦‚æœç”¨æˆ¶å•é¡ŒåŒ…å«ã€Œå®Œæ•´ã€ã€ã€Œå…¨éƒ¨ã€ã€ã€Œå…¨æ–‡ã€ç­‰é—œéµå­—ï¼š
   â†’ ä½¿ç”¨ã€å…¨æ–‡æª¢ç´¢æ¨¡å¼ã€‘ï¼Œèª¿ç”¨çŸ¥è­˜åº«æœå°‹å®Œæ•´æ–‡æª”
   â†’ è¿”å›è©³ç´°å®Œæ•´çš„å…§å®¹

2. å¦‚æœç”¨æˆ¶å•é¡Œä¸åŒ…å«ä¸Šè¿°é—œéµå­—ï¼š
   â†’ ä½¿ç”¨ã€æ®µè½æª¢ç´¢æ¨¡å¼ã€‘ï¼Œåªæœå°‹ç›¸é—œæ®µè½
   â†’ è¿”å›ç²¾æº–çš„ç‰‡æ®µè³‡è¨Š

3. å¦‚æœçŸ¥è­˜åº«æ²’æœ‰ç›¸é—œè³‡æ–™ï¼š
   â†’ æ˜ç¢ºå‘ŠçŸ¥ã€Œæ‰¾ä¸åˆ°ç›¸é—œè³‡æ–™ã€
   â†’ ä¸è¦ç·¨é€ å…§å®¹

**å¼•ç”¨ä¾†æº**ï¼š
- å¿…é ˆåœ¨å›ç­”ä¸­å¼•ç”¨çŸ¥è­˜åº«ä¾†æº
- ä½¿ç”¨ metadata.retriever_resources è¨˜éŒ„å¼•ç”¨
```

#### Python ç¨‹å¼ç¢¼çš„ä½œç”¨

```python
# Python ç¨‹å¼ç¢¼åªè² è²¬ï¼š
# 1. æ±ºå®šæ˜¯å¦æ·»åŠ ã€Œå®Œæ•´ã€é—œéµå­—
# 2. èª¿ç”¨ Dify API
# 3. æª¢æ¸¬å›ç­”æ˜¯å¦ä¸ç¢ºå®š

# library/protocol_guide/two_tier_handler.py
def _request_dify_chat(self, query, is_full_search=False):
    if is_full_search:
        # âœ… æ·»åŠ ã€Œå®Œæ•´ã€â†’ å¼•å° Dify ä½¿ç”¨å…¨æ–‡æœå°‹
        rewritten_query = f"{query} å®Œæ•´"
    else:
        # âœ… ä¸ä¿®æ”¹ â†’ Dify ä½¿ç”¨æ®µè½æœå°‹
        rewritten_query = query
    
    # èª¿ç”¨ Difyï¼ˆDify æ ¹æ“šæŸ¥è©¢å…§å®¹æ±ºå®šæœå°‹ç­–ç•¥ï¼‰
    response = self.dify_client.chat(question=rewritten_query, ...)
    return response
```

### ğŸ“Š å¤–éƒ¨çŸ¥è­˜åº« API çš„æœå°‹è¡Œç‚º

**ç•¶ Dify èª¿ç”¨å¤–éƒ¨çŸ¥è­˜åº«æ™‚**ï¼š

```python
# backend/api/views/dify_knowledge_views.py
@api_view(['POST'])
def dify_knowledge_search(request):
    """
    Dify å¤–éƒ¨çŸ¥è­˜åº«æœå°‹ API
    
    æ¥æ”¶åƒæ•¸ï¼š
    - knowledge_id: "protocol_guide_db"
    - query: "Cup å¦‚ä½•æ¸¬è©¦?" æˆ– "Cup å¦‚ä½•æ¸¬è©¦? å®Œæ•´"
    - retrieval_setting: {
        "top_k": 3,
        "score_threshold": 0.75
      }
    """
    data = json.loads(request.body)
    query = data.get('query', '')
    
    # âš ï¸ Python ç¨‹å¼ç¢¼ä¸åˆ¤æ–·ã€Œå®Œæ•´ã€é—œéµå­—
    # åªåŸ·è¡Œçµ±ä¸€çš„æœå°‹é‚è¼¯
    
    result = handler.search(
        knowledge_id='protocol_guide_db',
        query=query,  # åŸæ¨£å‚³éæŸ¥è©¢
        top_k=3,
        score_threshold=0.75
    )
    
    return Response(result)
```

**æœå°‹æœå‹™çš„è¡Œç‚º**ï¼š

```python
# library/common/knowledge_base/base_search_service.py
def search_knowledge(self, query, limit=5, threshold=0.7):
    """
    æœå°‹é‚è¼¯ï¼ˆä¸ç®¡æŸ¥è©¢æ˜¯å¦å«ã€Œå®Œæ•´ã€ï¼‰
    
    1. å„ªå…ˆï¼šæ®µè½å‘é‡æœå°‹
       - æœå°‹ document_section_embeddings è¡¨
       - è¿”å›åŒ¹é…çš„æ®µè½
    
    2. å‚™ç”¨ï¼šæ•´ç¯‡æ–‡æª”å‘é‡æœå°‹ï¼ˆå¦‚æœæ®µè½çµæœä¸è¶³ï¼‰
       - æœå°‹ document_embeddings è¡¨
       - è¿”å›å®Œæ•´æ–‡æª”
    
    3. è£œå……ï¼šé—œéµå­—æœå°‹ï¼ˆå¦‚æœå‘é‡çµæœä¸è¶³ï¼‰
       - Django ORM é—œéµå­—æŸ¥è©¢
       - è£œå……éºæ¼çš„çµæœ
    """
    # æ®µè½å‘é‡æœå°‹
    vector_results = self.search_with_vectors(query, limit, threshold)
    
    # å¦‚æœçµæœä¸è¶³ï¼Œè£œå……é—œéµå­—æœå°‹
    if len(vector_results) < limit:
        keyword_results = self.search_with_keywords(query, limit)
        vector_results.extend(keyword_results)
    
    return vector_results[:limit]
```

**é—œéµæ´å¯Ÿ**ï¼š
- âœ… **Python æœå°‹æœå‹™ä¸åˆ¤æ–·ã€Œå®Œæ•´ã€é—œéµå­—**
- âœ… **æœå°‹è¡Œç‚ºæ˜¯å›ºå®šçš„**ï¼ˆæ®µè½ â†’ æ–‡æª” â†’ é—œéµå­—ï¼‰
- âœ… **ã€Œå®Œæ•´ã€çš„çœŸæ­£ä½œç”¨æ˜¯å½±éŸ¿ Dify çš„ Prompt è¡Œç‚º**
- âœ… **Dify æ ¹æ“šæŸ¥è©¢å«ç¾©æ±ºå®šå¦‚ä½•ä½¿ç”¨æœå°‹çµæœ**

---

## éšæ®µåˆ¤æ–·é‚è¼¯

### ğŸ” ä¸ç¢ºå®šæ€§æª¢æ¸¬ï¼ˆis_uncertain_responseï¼‰

**æª”æ¡ˆä½ç½®**ï¼š`library/common/ai_response/uncertainty_detector.py`

#### æª¢æ¸¬æ¨™æº–

```python
UNCERTAINTY_KEYWORDS = [
    # æ˜ç¢ºå¦å®šï¼ˆé«˜å„ªå…ˆç´šï¼‰
    'ä¸æ¸…æ¥š', 'ä¸çŸ¥é“', 'ä¸äº†è§£', 'ä¸ç¢ºå®š',
    'æ²’æœ‰ç›¸é—œè³‡æ–™', 'æ²’æœ‰æ‰¾åˆ°', 'æ²’æœ‰è³‡è¨Š', 'æ‰¾ä¸åˆ°',
    'æ²’æœ‰æä¾›', 'æ²’æœ‰æåŠ', 'æ²’æœ‰èªªæ˜',
    
    # å§”å©‰è¡¨é”
    'æŠ±æ­‰', 'å¾ˆéºæ†¾', 'ç„¡æ³•å›ç­”', 'ç„¡æ³•æä¾›',
    'è³‡è¨Šä¸è¶³', 'è³‡æ–™ä¸è¶³', 'ç¼ºä¹è³‡è¨Š',
    'ç„¡æ³•ç¢ºèª', 'é›£ä»¥å›ç­”', 'é›£ä»¥ç¢ºå®š',
    
    # è‹±æ–‡
    "i don't know", 'not sure', 'unclear', 'uncertain',
    'no information', 'cannot find', 'unable to answer',
    
    # æ¨¡ç³Šå›ç­”
    'ä¹Ÿè¨±', 'ä¸å¤ªç¢ºå®š', 'æˆ‘çŒœ', 'å¤§æ¦‚', 'ä¼¼ä¹', 'æˆ–è¨±',
]

def is_uncertain_response(ai_response, strict_mode=False):
    """
    æª¢æ¸¬é‚è¼¯ï¼š
    
    1. æª¢æŸ¥ç©ºå›ç­” â†’ ä¸ç¢ºå®š
    2. æª¢æŸ¥é—œéµå­—åŒ¹é… â†’ ä¸ç¢ºå®š
    3. éåš´æ ¼æ¨¡å¼ï¼šæª¢æŸ¥å›ç­”é•·åº¦ < 20 å­—å…ƒ â†’ ä¸ç¢ºå®š
    4. å…¶ä»– â†’ ç¢ºå®š
    
    Returns:
        (is_uncertain: bool, matched_keyword: str | None)
    """
    if not ai_response or not ai_response.strip():
        return True, None
    
    response_lower = ai_response.lower()
    
    # æª¢æŸ¥é—œéµå­—
    for keyword in UNCERTAINTY_KEYWORDS:
        if keyword.lower() in response_lower:
            return True, keyword  # â† è¿”å›åŒ¹é…çš„é—œéµå­—
    
    # æª¢æŸ¥é•·åº¦ï¼ˆéåš´æ ¼æ¨¡å¼ï¼‰
    if not strict_mode and len(ai_response.strip()) < 20:
        return True, None
    
    return False, None  # â† ç¢ºå®šå›ç­”
```

#### æª¢æ¸¬ç¯„ä¾‹

```python
# âœ… ç¢ºå®šå›ç­”
is_uncertain_response("æ ¹æ“š Cup æ¸¬è©¦æŒ‡å—ï¼Œæ¸¬è©¦æµç¨‹åŒ…æ‹¬...")
â†’ (False, None)

# âŒ ä¸ç¢ºå®šå›ç­”ï¼ˆå«é—œéµå­—ï¼‰
is_uncertain_response("æŠ±æ­‰ï¼Œæˆ‘ä¸æ¸…æ¥šé€™å€‹å•é¡Œã€‚")
â†’ (True, "ä¸æ¸…æ¥š")

is_uncertain_response("å¾ˆéºæ†¾ï¼Œæ²’æœ‰æ‰¾åˆ°ç›¸é—œè³‡æ–™ã€‚")
â†’ (True, "æ²’æœ‰æ‰¾åˆ°")

# âŒ ä¸ç¢ºå®šå›ç­”ï¼ˆéçŸ­ï¼‰
is_uncertain_response("æ˜¯")
â†’ (True, None)

# âœ… ç¢ºå®šå›ç­”ï¼ˆå³ä½¿å«å…è²¬è²æ˜ï¼‰
is_uncertain_response("æ ¹æ“šæ–‡æª”ï¼ŒCup å¯èƒ½éœ€è¦é€²è¡Œé¡è‰²æ¸¬è©¦ã€‚ä½†å…·é«”æµç¨‹è«‹åƒè€ƒ...")
â†’ (False, None)  # âš ï¸ å·²ç§»é™¤ã€Œå¯èƒ½ã€é¿å…èª¤åˆ¤
```

### ğŸ“Š éšæ®µæµè½‰æ±ºç­–æ¨¹

```
éšæ®µ 1 é–‹å§‹
    â†“
ç™¼é€åŸæŸ¥è©¢çµ¦ Dify
    â†“
æ¥æ”¶ stage_1_answer
    â†“
is_uncertain_response(stage_1_answer)?
    â†“
    â”œâ”€ False (ç¢ºå®š) â”€â”€â”€â”€â†’ [è¿”å›éšæ®µ 1 çµæœ] âœ…
    â”‚                     â€¢ stage: 1
    â”‚                     â€¢ is_fallback: False
    â”‚
    â””â”€ True (ä¸ç¢ºå®š)
        â†“
        æ—¥èªŒï¼šéšæ®µ 1 ä¸ç¢ºå®š (é—œéµå­—: xxx)
        â†“
    éšæ®µ 2 é–‹å§‹
        â†“
    æŸ¥è©¢é‡å¯«ï¼šquery â†’ "query å®Œæ•´"
        â†“
    ç™¼é€é‡å¯«æŸ¥è©¢çµ¦ Dify
        â†“
    æ¥æ”¶ stage_2_answer
        â†“
    is_uncertain_response(stage_2_answer)?
        â†“
        â”œâ”€ False (ç¢ºå®š) â”€â”€â”€â”€â†’ [è¿”å›éšæ®µ 2 çµæœ] âœ…
        â”‚                      â€¢ stage: 2
        â”‚                      â€¢ is_fallback: False
        â”‚
        â””â”€ True (ä»ä¸ç¢ºå®š)
            â†“
            æ—¥èªŒï¼šéšæ®µ 2 ä»ä¸ç¢ºå®š (é—œéµå­—: xxx)
            â†“
        é™ç´šæ¨¡å¼
            â†“
        çµ„åˆå›ç­” = AI åŸå§‹åˆ†æ + å‹å–„æç¤º
            â†“
        [è¿”å›é™ç´šçµæœ] âš ï¸
            â€¢ stage: 2
            â€¢ is_fallback: True
            â€¢ fallback_reason: "éšæ®µ 2 AI å›ç­”ä¸ç¢ºå®š (å«: xxx)"
            â€¢ metadata: {...}  â† ä»åŒ…å«å¼•ç”¨ä¾†æº
```

---

## ç¸½çµ

### ğŸ¯ æ¨¡å¼ B çš„æ ¸å¿ƒç‰¹é»

1. **æ™ºèƒ½è·¯ç”±**ï¼šè‡ªå‹•æª¢æ¸¬æŸ¥è©¢ï¼Œæ±ºå®šæ˜¯å¦ä½¿ç”¨å…©éšæ®µæœå°‹
2. **æ¼¸é€²å¼æœå°‹**ï¼šå…ˆå¿«å¾Œæ…¢ï¼ˆæ®µè½ â†’ å…¨æ–‡ï¼‰
3. **æŸ¥è©¢é‡å¯«**ï¼šéšæ®µ 2 æ·»åŠ ã€Œå®Œæ•´ã€è§¸ç™¼è©
4. **ä¸ç¢ºå®šæ€§æª¢æ¸¬**ï¼šåŸºæ–¼ 47+ é—œéµå­—çš„æ™ºèƒ½åˆ¤æ–·
5. **é™ç´šæ¨¡å¼**ï¼šä¿ç•™ AI åˆ†æ + å‹å–„æç¤º + å¼•ç”¨ä¾†æº
6. **å®Œå…¨è‡ªå‹•åŒ–**ï¼šç„¡éœ€ç”¨æˆ¶æ‰‹å‹•é¸æ“‡ï¼Œç³»çµ±è‡ªå‹•å„ªåŒ–

### ğŸ“Š æ•ˆèƒ½è¡¨ç¾

| æŒ‡æ¨™ | éšæ®µ 1 æˆåŠŸ | éšæ®µ 2 æˆåŠŸ | é™ç´šæ¨¡å¼ |
|------|------------|------------|---------|
| **éŸ¿æ‡‰æ™‚é–“** | 3-5 ç§’ | 6-10 ç§’ | 8-12 ç§’ |
| **æº–ç¢ºç‡** | é«˜ï¼ˆ85%+ï¼‰ | å¾ˆé«˜ï¼ˆ95%+ï¼‰ | N/Aï¼ˆæä¾›å¼•ç”¨ï¼‰ |
| **ç”¨æˆ¶é«”é©—** | å¿«é€Ÿç²¾æº– | è©³ç´°å®Œæ•´ | é€æ˜å¯è¿½æº¯ |

### ğŸ”§ å¯å„ªåŒ–æ–¹å‘

1. **ä¸¦è¡Œæœå°‹**ï¼šéšæ®µ 1 å’Œéšæ®µ 2 åŒæ™‚åŸ·è¡Œï¼Œé¸æ“‡æœ€ä½³çµæœ
2. **æ™ºèƒ½é–¾å€¼**ï¼šæ ¹æ“šæŸ¥è©¢é¡å‹å‹•æ…‹èª¿æ•´ score_threshold
3. **ä¸Šä¸‹æ–‡å‚³é**ï¼šå¯¦ç¾æ–¹æ¡ˆ Dï¼ˆæŸ¥è©¢é‡å¯« + æœå°‹çµæœå‚³éï¼‰
4. **å¿«å–æ©Ÿåˆ¶**ï¼šå¿«å–å¸¸è¦‹æŸ¥è©¢çš„æœå°‹çµæœ
5. **A/B æ¸¬è©¦**ï¼šæ¸¬è©¦ä¸åŒçš„ä¸ç¢ºå®šæ€§é—œéµå­—é›†åˆ

---

**æ–‡æª”ç‰ˆæœ¬**ï¼šv1.0  
**æ›´æ–°æ—¥æœŸ**ï¼š2025-11-12  
**ä½œè€…**ï¼šAI Platform Team  
**ç”¨é€”**ï¼šé–‹ç™¼æ–‡æª”ã€ç³»çµ±ç¶­è­·ã€å•é¡Œæ’æŸ¥
