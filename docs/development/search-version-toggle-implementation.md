# ğŸ¯ æœå°‹ç‰ˆæœ¬åˆ‡æ›åŠŸèƒ½å¯¦ä½œæŒ‡å—

**åŠŸèƒ½**: V1/V2 æœå°‹ç‰ˆæœ¬åˆ‡æ›ï¼ˆæ¨£å¼ 1 - é ‚éƒ¨ Toggle Barï¼‰  
**å¯¦ä½œæ—¥æœŸ**: 2025-11-09  
**é è¨ˆå®Œæˆ**: 1-2 å¤©  
**é©ç”¨æ–¼**: RVT Assistant, Protocol Assistant

---

## ğŸ“‹ ç›®éŒ„

1. [åŠŸèƒ½æ¦‚è¿°](#1-åŠŸèƒ½æ¦‚è¿°)
2. [å¾Œç«¯å¯¦ä½œ](#2-å¾Œç«¯å¯¦ä½œ)
3. [å‰ç«¯å¯¦ä½œ](#3-å‰ç«¯å¯¦ä½œ)
4. [æ¸¬è©¦æŒ‡å—](#4-æ¸¬è©¦æŒ‡å—)
5. [éƒ¨ç½²æª¢æŸ¥æ¸…å–®](#5-éƒ¨ç½²æª¢æŸ¥æ¸…å–®)

---

## 1. åŠŸèƒ½æ¦‚è¿°

### ğŸ¯ åŠŸèƒ½æè¿°

åœ¨ RVT Assistant å’Œ Protocol Assistant çš„èŠå¤©ä»‹é¢ä¸­ï¼Œæ·»åŠ ä¸€å€‹ **Toggle åˆ‡æ›é–‹é—œ**ï¼Œè®“ç”¨æˆ¶å¯ä»¥è‡ªç”±åˆ‡æ›ï¼š
- **V1 (åŸºç¤æœå°‹)**: ç¾æœ‰çš„å‘é‡æœå°‹æ–¹æ³•
- **V2 (ä¸Šä¸‹æ–‡å¢å¼·)**: æ–°çš„ä¸Šä¸‹æ–‡è¦–çª—æ–¹æ³•

### ğŸ“ UI è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RVT Assistant                    ğŸ”„ [V1] âš« [V2]         â”‚ â† å³ä¸Šè§’ Toggle Bar
â”‚                                     â†‘                    â”‚
â”‚                             å›ºå®šåœ¨é ‚éƒ¨ï¼Œz-index: 100     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  [æœå°‹è¼¸å…¥æ¡†]                                            â”‚
â”‚  [ç™¼é€æŒ‰éˆ•]                                              â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ‘¤ User: è«‹èªªæ˜è»Ÿé«”é…ç½®æµç¨‹                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ¤– Assistant  [V2: ä¸Šä¸‹æ–‡å¢å¼·]  â† ç‰ˆæœ¬æ¨™è¨˜          â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚ ğŸ“ ä¸»è¦çµæœ:                                       â”‚ â”‚
â”‚  â”‚ æ®µè½ 3.2: è»Ÿé«”é…ç½®æ­¥é©Ÿ...                         â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚ â¬†ï¸ å‰ç½®æ®µè½: (å¯å±•é–‹/æ”¶èµ·)                        â”‚ â”‚
â”‚  â”‚   æ®µè½ 3.1: æº–å‚™å·¥ä½œ...                           â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚ â¬‡ï¸ å¾ŒçºŒæ®µè½: (å¯å±•é–‹/æ”¶èµ·)                        â”‚ â”‚
â”‚  â”‚   æ®µè½ 3.3: é©—è­‰æ­¥é©Ÿ...                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¨ Toggle Bar æ¨£å¼

```jsx
// è¦–è¦ºæ•ˆæœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”µ V1: åŸºç¤æœå°‹    [  âšª â†’  ]    â­• V2: ä¸Šä¸‹æ–‡å¢å¼·  â”‚
â”‚      (ç•¶å‰é¸æ“‡)       Toggle       (æœªé¸æ“‡)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// åˆ‡æ›å¾Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â­• V1: åŸºç¤æœå°‹    [  âš« â†  ]    ğŸŸ¢ V2: ä¸Šä¸‹æ–‡å¢å¼·  â”‚
â”‚      (æœªé¸æ“‡)       Toggle        (ç•¶å‰é¸æ“‡) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. å¾Œç«¯å¯¦ä½œ

### ğŸ“‚ æª”æ¡ˆä½ç½®

```
backend/api/views/viewsets/knowledge_viewsets.py
library/common/knowledge_base/section_search_service.py
```

### 2.1 ä¿®æ”¹ API ç«¯é»

#### é¸é … Aï¼šä¿®æ”¹ç¾æœ‰ APIï¼ˆæ¨è–¦ï¼‰

```python
# backend/api/views/viewsets/knowledge_viewsets.py

class RVTGuideViewSet(LibraryManagerMixin, FallbackLogicMixin, 
                      VectorManagementMixin, viewsets.ModelViewSet):
    """RVT Assistant çŸ¥è­˜åº« ViewSet"""
    
    @action(detail=False, methods=['post'])
    def search_sections(self, request):
        """
        æ®µè½æœå°‹ APIï¼ˆæ”¯æ´ V1/V2 åˆ‡æ›ï¼‰
        
        POST /api/rvt-guides/search_sections/
        
        Request Body:
        {
            "query": "è»Ÿé«”é…ç½®",
            "limit": 5,
            "threshold": 0.7,
            "version": "v1",           // âœ… æ–°å¢ï¼š'v1' æˆ– 'v2' (é è¨­ 'v1')
            "context_window": 2,       // V2 å°ˆç”¨åƒæ•¸
            "context_mode": "both"     // V2 å°ˆç”¨åƒæ•¸: 'adjacent', 'parent_child', 'both'
        }
        
        Response:
        {
            "success": true,
            "version": "v1",           // å¯¦éš›ä½¿ç”¨çš„ç‰ˆæœ¬
            "results": [...],          // æœå°‹çµæœ
            "execution_time": "45ms"   // åŸ·è¡Œæ™‚é–“ï¼ˆç”¨æ–¼æ•ˆèƒ½æ¯”è¼ƒï¼‰
        }
        """
        try:
            # 1. è§£æåƒæ•¸
            query = request.data.get('query', '')
            version = request.data.get('version', 'v1')  # âœ… é è¨­ V1
            limit = request.data.get('limit', 5)
            threshold = request.data.get('threshold', 0.7)
            
            if not query:
                return Response({
                    'success': False,
                    'error': 'æŸ¥è©¢å…§å®¹ä¸èƒ½ç‚ºç©º'
                }, status=400)
            
            # 2. å°å…¥æœå°‹æœå‹™
            from library.common.knowledge_base.section_search_service import SectionSearchService
            search_service = SectionSearchService()
            
            # 3. è¨˜éŒ„é–‹å§‹æ™‚é–“ï¼ˆç”¨æ–¼æ•ˆèƒ½æ¸¬é‡ï¼‰
            import time
            start_time = time.time()
            
            # 4. æ ¹æ“šç‰ˆæœ¬åŸ·è¡Œæœå°‹
            if version == 'v2':
                # V2: ä¸Šä¸‹æ–‡å¢å¼·æœå°‹
                context_window = request.data.get('context_window', 1)
                context_mode = request.data.get('context_mode', 'adjacent')
                
                results = search_service.search_sections_with_expanded_context(
                    query=query,
                    source_table='rvt_guide',
                    limit=limit,
                    threshold=threshold,
                    context_window=context_window,
                    context_mode=context_mode
                )
            else:
                # V1: åŸºç¤æœå°‹ï¼ˆç¾æœ‰æ–¹æ³•ï¼‰
                results = search_service.search_sections(
                    query=query,
                    source_table='rvt_guide',
                    limit=limit,
                    threshold=threshold
                )
            
            # 5. è¨ˆç®—åŸ·è¡Œæ™‚é–“
            execution_time = (time.time() - start_time) * 1000  # è½‰æ›ç‚ºæ¯«ç§’
            
            # 6. è¿”å›çµæœ
            return Response({
                'success': True,
                'version': version,
                'results': results,
                'execution_time': f'{execution_time:.0f}ms'
            })
            
        except Exception as e:
            logger.error(f"æ®µè½æœå°‹å¤±æ•—: {str(e)}", exc_info=True)
            return Response({
                'success': False,
                'error': str(e)
            }, status=500)
```

#### é¸é … Bï¼šå‰µå»ºæ–° API ç«¯é»ï¼ˆå‚™é¸ï¼‰

å¦‚æœä¸æƒ³ä¿®æ”¹ç¾æœ‰ APIï¼Œå¯ä»¥å‰µå»ºæ–°ç«¯é»ï¼š

```python
@action(detail=False, methods=['post'])
def search_sections_v2(self, request):
    """V2: ä¸Šä¸‹æ–‡å¢å¼·æœå°‹ API"""
    # ... V2 å°ˆç”¨å¯¦ä½œ
```

### 2.2 Protocol Assistant åŒæ­¥ä¿®æ”¹

```python
# backend/api/views/viewsets/knowledge_viewsets.py

class ProtocolGuideViewSet(LibraryManagerMixin, FallbackLogicMixin,
                           VectorManagementMixin, viewsets.ModelViewSet):
    """Protocol Assistant çŸ¥è­˜åº« ViewSet"""
    
    @action(detail=False, methods=['post'])
    def search_sections(self, request):
        """
        æ®µè½æœå°‹ APIï¼ˆæ”¯æ´ V1/V2 åˆ‡æ›ï¼‰
        
        âš ï¸ å¯¦ä½œèˆ‡ RVTGuideViewSet ç›¸åŒï¼Œåªéœ€ä¿®æ”¹ source_table
        """
        # ... è¤‡è£½ä¸Šé¢çš„å¯¦ä½œ
        # å”¯ä¸€å·®ç•°ï¼šsource_table='protocol_guide'
```

---

## 3. å‰ç«¯å¯¦ä½œ

### ğŸ“‚ æª”æ¡ˆçµæ§‹

```
frontend/src/
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useRvtChat.js              â† ä¿®æ”¹ï¼šæ·»åŠ ç‰ˆæœ¬ç‹€æ…‹
â”‚   â””â”€â”€ useProtocolAssistantChat.js â† ä¿®æ”¹ï¼šæ·»åŠ ç‰ˆæœ¬ç‹€æ…‹
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ RvtAssistantChatPage.js    â† ä¿®æ”¹ï¼šæ·»åŠ  Toggle Bar
â”‚   â””â”€â”€ ProtocolAssistantChatPage.js â† ä¿®æ”¹ï¼šæ·»åŠ  Toggle Bar
â””â”€â”€ components/
    â””â”€â”€ SearchVersionToggle.jsx     â† æ–°å¢ï¼šToggle Bar çµ„ä»¶
```

### 3.1 å‰µå»º Toggle çµ„ä»¶

```jsx
// frontend/src/components/SearchVersionToggle.jsx

import React from 'react';
import { Switch, Space, Tag, Tooltip, Card } from 'antd';
import { ThunderboltOutlined, ExperimentOutlined } from '@ant-design/icons';
import './SearchVersionToggle.css';

const SearchVersionToggle = ({ version, onToggle }) => {
  return (
    <Card
      className="search-version-toggle"
      size="small"
      style={{
        position: 'absolute',
        top: 20,
        right: 20,
        zIndex: 100,
        boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
        borderRadius: 8,
        minWidth: 300
      }}
    >
      <Space size="middle" align="center">
        {/* V1 æ¨™ç±¤ */}
        <Tooltip title="åŸºç¤å‘é‡æœå°‹ï¼Œå¿«é€Ÿå›æ‡‰">
          <Tag 
            color={version === 'v1' ? 'blue' : 'default'}
            style={{ 
              fontSize: 13, 
              padding: '4px 12px',
              cursor: 'pointer'
            }}
            onClick={() => version !== 'v1' && onToggle()}
          >
            <ThunderboltOutlined /> V1: åŸºç¤æœå°‹
          </Tag>
        </Tooltip>
        
        {/* Toggle Switch */}
        <Tooltip 
          title={
            version === 'v1' 
              ? 'åˆ‡æ›åˆ° V2ï¼šè‡ªå‹•æä¾›ä¸Šä¸‹æ–‡æ®µè½' 
              : 'åˆ‡æ›åˆ° V1ï¼šåƒ…é¡¯ç¤ºåŒ¹é…çµæœ'
          }
        >
          <Switch
            checked={version === 'v2'}
            onChange={onToggle}
            checkedChildren={<ExperimentOutlined />}
            unCheckedChildren={<ThunderboltOutlined />}
            style={{ minWidth: 50 }}
          />
        </Tooltip>
        
        {/* V2 æ¨™ç±¤ */}
        <Tooltip title="åŒ…å«å‰å¾Œæ®µè½å’Œçˆ¶å­æ®µè½ï¼Œç†è§£æ›´å®Œæ•´">
          <Tag 
            color={version === 'v2' ? 'green' : 'default'}
            style={{ 
              fontSize: 13, 
              padding: '4px 12px',
              cursor: 'pointer'
            }}
            onClick={() => version !== 'v2' && onToggle()}
          >
            <ExperimentOutlined /> V2: ä¸Šä¸‹æ–‡å¢å¼·
          </Tag>
        </Tooltip>
      </Space>
    </Card>
  );
};

export default SearchVersionToggle;
```

```css
/* frontend/src/components/SearchVersionToggle.css */

.search-version-toggle {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.search-version-toggle .ant-card-body {
  padding: 12px 16px;
}

.search-version-toggle .ant-tag {
  margin: 0;
  transition: all 0.3s ease;
}

.search-version-toggle .ant-tag:hover {
  transform: scale(1.05);
}

.search-version-toggle .ant-switch {
  transition: all 0.3s ease;
}
```

### 3.2 ä¿®æ”¹ Hookï¼š`useRvtChat.js`

```javascript
// frontend/src/hooks/useRvtChat.js

import { useState, useCallback } from 'react';
import api from '../services/api';

const useRvtChat = () => {
  const [messages, setMessages] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  
  // âœ… æ–°å¢ï¼šç‰ˆæœ¬ç‹€æ…‹ï¼ˆé è¨­ V1ï¼‰
  const [searchVersion, setSearchVersion] = useState('v1');

  const sendMessage = async (message) => {
    if (!message.trim() || isLoading) return;

    const userMessage = {
      role: 'user',
      content: message,
      timestamp: new Date().toISOString()
    };

    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);
    setError(null);

    try {
      // âœ… ç™¼é€è«‹æ±‚æ™‚å¸¶ä¸Šç‰ˆæœ¬åƒæ•¸
      const response = await api.post('/api/rvt-guides/search_sections/', {
        query: message,
        limit: 5,
        threshold: 0.7,
        version: searchVersion,  // âœ… ä½¿ç”¨ç•¶å‰ç‰ˆæœ¬
        context_window: 2,        // V2 åƒæ•¸
        context_mode: 'both'      // V2 åƒæ•¸
      });

      const data = response.data;

      const assistantMessage = {
        role: 'assistant',
        content: data.results,
        version: data.version,        // âœ… è¨˜éŒ„å¯¦éš›ä½¿ç”¨çš„ç‰ˆæœ¬
        executionTime: data.execution_time,  // âœ… è¨˜éŒ„åŸ·è¡Œæ™‚é–“
        timestamp: new Date().toISOString()
      };

      setMessages(prev => [...prev, assistantMessage]);

    } catch (error) {
      console.error('æœå°‹å¤±æ•—:', error);
      setError('æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      
      // æ·»åŠ éŒ¯èª¤è¨Šæ¯
      const errorMessage = {
        role: 'assistant',
        content: 'æŠ±æ­‰ï¼Œæœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚',
        error: true,
        timestamp: new Date().toISOString()
      };
      setMessages(prev => [...prev, errorMessage]);
      
    } finally {
      setIsLoading(false);
    }
  };

  // âœ… æ–°å¢ï¼šåˆ‡æ›ç‰ˆæœ¬çš„å‡½æ•¸
  const toggleVersion = useCallback(() => {
    setSearchVersion(prev => {
      const newVersion = prev === 'v1' ? 'v2' : 'v1';
      console.log(`æœå°‹ç‰ˆæœ¬å·²åˆ‡æ›: ${prev} â†’ ${newVersion}`);
      return newVersion;
    });
  }, []);

  // âœ… æ–°å¢ï¼šæ¸…é™¤å°è©±
  const clearMessages = useCallback(() => {
    setMessages([]);
    setError(null);
  }, []);

  return {
    messages,
    isLoading,
    error,
    sendMessage,
    searchVersion,      // âœ… å°å‡ºç•¶å‰ç‰ˆæœ¬
    toggleVersion,      // âœ… å°å‡ºåˆ‡æ›å‡½æ•¸
    clearMessages
  };
};

export default useRvtChat;
```

### 3.3 ä¿®æ”¹èŠå¤©é é¢ï¼š`RvtAssistantChatPage.js`

```javascript
// frontend/src/pages/RvtAssistantChatPage.js

import React from 'react';
import { Layout, Typography } from 'antd';
import useRvtChat from '../hooks/useRvtChat';
import SearchVersionToggle from '../components/SearchVersionToggle';
import MessageList from '../components/chat/MessageList';
import InputBox from '../components/chat/InputBox';
import './RvtAssistantChatPage.css';

const { Content } = Layout;
const { Title } = Typography;

const RvtAssistantChatPage = () => {
  const { 
    messages, 
    isLoading, 
    sendMessage, 
    searchVersion,     // âœ… ç²å–ç•¶å‰ç‰ˆæœ¬
    toggleVersion      // âœ… ç²å–åˆ‡æ›å‡½æ•¸
  } = useRvtChat();

  return (
    <Layout className="rvt-chat-page" style={{ height: '100vh', position: 'relative' }}>
      {/* âœ… Toggle Bar çµ„ä»¶ï¼ˆå›ºå®šåœ¨å³ä¸Šè§’ï¼‰ */}
      <SearchVersionToggle 
        version={searchVersion}
        onToggle={toggleVersion}
      />

      <Content style={{ padding: '24px', paddingTop: '80px' }}>
        <div className="chat-container" style={{ 
          maxWidth: 1200, 
          margin: '0 auto',
          height: 'calc(100vh - 120px)',
          display: 'flex',
          flexDirection: 'column'
        }}>
          <Title level={3} style={{ marginBottom: 24 }}>
            RVT Assistant
          </Title>

          {/* è¨Šæ¯åˆ—è¡¨ */}
          <MessageList 
            messages={messages} 
            isLoading={isLoading}
            searchVersion={searchVersion}  // âœ… å‚³éç‰ˆæœ¬è³‡è¨Š
          />

          {/* è¼¸å…¥æ¡† */}
          <InputBox 
            onSend={sendMessage}
            isLoading={isLoading}
            placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..."
          />
        </div>
      </Content>
    </Layout>
  );
};

export default RvtAssistantChatPage;
```

### 3.4 ä¿®æ”¹è¨Šæ¯åˆ—è¡¨ï¼šé¡¯ç¤ºç‰ˆæœ¬æ¨™è¨˜

```javascript
// frontend/src/components/chat/MessageList.jsx

import React from 'react';
import { Card, Tag, Typography, Collapse, Space } from 'antd';
import { ThunderboltOutlined, ExperimentOutlined, ClockCircleOutlined } from '@ant-design/icons';

const { Text } = Typography;
const { Panel } = Collapse;

const MessageList = ({ messages, isLoading, searchVersion }) => {
  return (
    <div className="message-list" style={{ 
      flex: 1, 
      overflowY: 'auto', 
      marginBottom: 16 
    }}>
      {messages.map((msg, idx) => (
        <Card 
          key={idx}
          className={`message-card ${msg.role}`}
          style={{ marginBottom: 16 }}
        >
          {/* è¨Šæ¯é ­éƒ¨ï¼šé¡¯ç¤ºç‰ˆæœ¬æ¨™è¨˜å’ŒåŸ·è¡Œæ™‚é–“ */}
          {msg.role === 'assistant' && !msg.error && (
            <div style={{ marginBottom: 12 }}>
              <Space>
                {/* âœ… ç‰ˆæœ¬æ¨™è¨˜ */}
                <Tag 
                  color={msg.version === 'v2' ? 'green' : 'blue'}
                  icon={msg.version === 'v2' ? <ExperimentOutlined /> : <ThunderboltOutlined />}
                >
                  {msg.version === 'v2' ? 'V2: ä¸Šä¸‹æ–‡å¢å¼·' : 'V1: åŸºç¤æœå°‹'}
                </Tag>
                
                {/* âœ… åŸ·è¡Œæ™‚é–“ */}
                {msg.executionTime && (
                  <Tag icon={<ClockCircleOutlined />}>
                    {msg.executionTime}
                  </Tag>
                )}
              </Space>
            </div>
          )}

          {/* è¨Šæ¯å…§å®¹ */}
          {msg.role === 'user' ? (
            <div>
              <Text strong>æ‚¨ï¼š</Text>
              <div style={{ marginTop: 8 }}>{msg.content}</div>
            </div>
          ) : (
            <div>
              <Text strong>ğŸ¤– RVT Assistantï¼š</Text>
              
              {/* V2 è¨Šæ¯ï¼šé¡¯ç¤ºä¸Šä¸‹æ–‡ */}
              {msg.version === 'v2' && msg.content?.context ? (
                <div style={{ marginTop: 12 }}>
                  {/* ä¸»è¦çµæœ */}
                  <div>
                    <Text type="success">ğŸ“ ä¸»è¦çµæœï¼š</Text>
                    <div style={{ marginTop: 8 }}>
                      {/* æ¸²æŸ“ä¸»è¦æœå°‹çµæœ */}
                      {msg.content.main_results?.map((result, i) => (
                        <div key={i} style={{ marginBottom: 16 }}>
                          <Text strong>{result.title}</Text>
                          <div>{result.content}</div>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* ä¸Šä¸‹æ–‡æ®µè½ï¼ˆå¯æ‘ºç–Šï¼‰ */}
                  <Collapse 
                    ghost 
                    style={{ marginTop: 16 }}
                    defaultActiveKey={['before', 'after']}
                  >
                    {/* å‰ç½®æ®µè½ */}
                    {msg.content.context.before?.length > 0 && (
                      <Panel 
                        header={`â¬†ï¸ å‰ç½®æ®µè½ (${msg.content.context.before.length})`}
                        key="before"
                      >
                        {msg.content.context.before.map((item, i) => (
                          <div key={i} style={{ marginBottom: 12, paddingLeft: 12, borderLeft: '3px solid #1890ff' }}>
                            <Text type="secondary">{item.section_id}</Text>
                            <div>{item.content}</div>
                          </div>
                        ))}
                      </Panel>
                    )}

                    {/* å¾ŒçºŒæ®µè½ */}
                    {msg.content.context.after?.length > 0 && (
                      <Panel 
                        header={`â¬‡ï¸ å¾ŒçºŒæ®µè½ (${msg.content.context.after.length})`}
                        key="after"
                      >
                        {msg.content.context.after.map((item, i) => (
                          <div key={i} style={{ marginBottom: 12, paddingLeft: 12, borderLeft: '3px solid #52c41a' }}>
                            <Text type="secondary">{item.section_id}</Text>
                            <div>{item.content}</div>
                          </div>
                        ))}
                      </Panel>
                    )}
                  </Collapse>
                </div>
              ) : (
                /* V1 è¨Šæ¯ï¼šç°¡å–®åˆ—è¡¨ */
                <div style={{ marginTop: 8 }}>
                  {msg.content?.map((result, i) => (
                    <div key={i} style={{ marginBottom: 16 }}>
                      <Text strong>{result.title}</Text>
                      <div>{result.content}</div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </Card>
      ))}

      {/* Loading æŒ‡ç¤ºå™¨ */}
      {isLoading && (
        <Card className="message-card assistant loading">
          <Text type="secondary">æ­£åœ¨æœå°‹...</Text>
        </Card>
      )}
    </div>
  );
};

export default MessageList;
```

### 3.5 Protocol Assistant åŒæ­¥ä¿®æ”¹

```javascript
// frontend/src/hooks/useProtocolAssistantChat.js
// âœ… è¤‡è£½ useRvtChat.js çš„å®Œæ•´å¯¦ä½œï¼Œåªéœ€ä¿®æ”¹ API ç«¯é»

// frontend/src/pages/ProtocolAssistantChatPage.js
// âœ… è¤‡è£½ RvtAssistantChatPage.js çš„å®Œæ•´å¯¦ä½œ
```

---

## 4. æ¸¬è©¦æŒ‡å—

### 4.1 åŠŸèƒ½æ¸¬è©¦

#### æ¸¬è©¦ 1ï¼šç‰ˆæœ¬åˆ‡æ›

```
æ­¥é©Ÿï¼š
1. é–‹å•Ÿ RVT Assistant èŠå¤©é é¢
2. ç¢ºèªå³ä¸Šè§’é¡¯ç¤º Toggle Bar
3. é è¨­æ‡‰ç‚º V1ï¼ˆè—è‰²æ¨™è¨˜ï¼‰
4. é»æ“Š Switch åˆ‡æ›åˆ° V2
5. ç¢ºèªåˆ‡æ›æˆåŠŸï¼ˆç¶ è‰²æ¨™è¨˜ï¼‰
6. å†æ¬¡åˆ‡æ›å› V1

é æœŸçµæœï¼š
âœ… Toggle Bar æ­£å¸¸é¡¯ç¤º
âœ… ç‰ˆæœ¬åˆ‡æ›æµæš¢ç„¡å»¶é²
âœ… æ¨™ç±¤é¡è‰²æ­£ç¢ºè®ŠåŒ–
```

#### æ¸¬è©¦ 2ï¼šV1 æœå°‹

```
æ­¥é©Ÿï¼š
1. ç¢ºä¿é¸æ“‡ V1
2. è¼¸å…¥ï¼š"è«‹èªªæ˜è»Ÿé«”é…ç½®æµç¨‹"
3. ç™¼é€è¨Šæ¯
4. è§€å¯Ÿå›æ‡‰

é æœŸçµæœï¼š
âœ… é¡¯ç¤º "V1: åŸºç¤æœå°‹" æ¨™ç±¤
âœ… åƒ…é¡¯ç¤ºåŒ¹é…çš„æ®µè½
âœ… ç„¡ä¸Šä¸‹æ–‡å±•é–‹é¢æ¿
âœ… åŸ·è¡Œæ™‚é–“ < 100ms
```

#### æ¸¬è©¦ 3ï¼šV2 æœå°‹

```
æ­¥é©Ÿï¼š
1. åˆ‡æ›åˆ° V2
2. è¼¸å…¥ï¼š"è«‹èªªæ˜è»Ÿé«”é…ç½®æµç¨‹"
3. ç™¼é€è¨Šæ¯
4. è§€å¯Ÿå›æ‡‰

é æœŸçµæœï¼š
âœ… é¡¯ç¤º "V2: ä¸Šä¸‹æ–‡å¢å¼·" æ¨™ç±¤
âœ… é¡¯ç¤ºä¸»è¦çµæœ
âœ… é¡¯ç¤º "â¬†ï¸ å‰ç½®æ®µè½" æ‘ºç–Šé¢æ¿
âœ… é¡¯ç¤º "â¬‡ï¸ å¾ŒçºŒæ®µè½" æ‘ºç–Šé¢æ¿
âœ… åŸ·è¡Œæ™‚é–“ < 200ms
```

#### æ¸¬è©¦ 4ï¼šåˆ‡æ›å¾Œæœå°‹

```
æ­¥é©Ÿï¼š
1. åœ¨ V1 æ¨¡å¼æœå°‹ä¸€æ¬¡
2. åˆ‡æ›åˆ° V2
3. æœå°‹ç›¸åŒå•é¡Œ
4. æ¯”è¼ƒçµæœå·®ç•°

é æœŸçµæœï¼š
âœ… å…©æ¬¡æœå°‹çš„ä¸»è¦çµæœç›¸åŒï¼ˆç›¸åŒçš„ç›¸ä¼¼åº¦æ’åºï¼‰
âœ… V2 å¤šäº†ä¸Šä¸‹æ–‡æ®µè½
âœ… å…©å€‹ç‰ˆæœ¬çš„å›æ‡‰ç¨ç«‹é¡¯ç¤º
```

### 4.2 è·¨ Assistant æ¸¬è©¦

```
æ¸¬è©¦æ¸…å–®ï¼š
â–¡ RVT Assistant - V1 æœå°‹
â–¡ RVT Assistant - V2 æœå°‹
â–¡ Protocol Assistant - V1 æœå°‹
â–¡ Protocol Assistant - V2 æœå°‹
â–¡ åˆ‡æ›ç‰ˆæœ¬å¾Œåˆ·æ–°é é¢ï¼ˆç‹€æ…‹æ˜¯å¦ä¿ç•™ï¼‰
```

### 4.3 éŒ¯èª¤è™•ç†æ¸¬è©¦

```
æ¸¬è©¦å ´æ™¯ï¼š
1. ç©ºæŸ¥è©¢ â†’ æ‡‰é¡¯ç¤ºéŒ¯èª¤æç¤º
2. API å¤±æ•— â†’ æ‡‰é¡¯ç¤ºå‹å–„éŒ¯èª¤è¨Šæ¯
3. ç¶²è·¯ä¸­æ–· â†’ æ‡‰æç¤ºé‡è©¦
4. V2 æœå°‹ç„¡ä¸Šä¸‹æ–‡ â†’ æ‡‰æ­£å¸¸é¡¯ç¤ºä¸»è¦çµæœ
```

### 4.4 æ•ˆèƒ½æ¸¬è©¦

```sql
-- æŸ¥è©¢ V1 vs V2 çš„å¹³å‡åŸ·è¡Œæ™‚é–“
SELECT 
    version,
    AVG(execution_time) as avg_time,
    COUNT(*) as search_count
FROM (
    -- æ¨¡æ“¬è¨˜éŒ„ï¼ˆå¦‚æœæœ‰çµ±è¨ˆè¡¨ï¼‰
    SELECT 'v1' as version, 45 as execution_time
    UNION ALL
    SELECT 'v2' as version, 85 as execution_time
) t
GROUP BY version;
```

---

## 5. éƒ¨ç½²æª¢æŸ¥æ¸…å–®

### 5.1 å¾Œç«¯éƒ¨ç½²

```bash
# 1. ç¢ºèª Django å®¹å™¨é‹è¡Œ
docker compose ps | grep django

# 2. æ¸¬è©¦ API ç«¯é»
curl -X POST http://localhost/api/rvt-guides/search_sections/ \
  -H "Content-Type: application/json" \
  -d '{
    "query": "æ¸¬è©¦",
    "version": "v1"
  }'

# 3. æ¸¬è©¦ V2 ç«¯é»
curl -X POST http://localhost/api/rvt-guides/search_sections/ \
  -H "Content-Type: application/json" \
  -d '{
    "query": "æ¸¬è©¦",
    "version": "v2",
    "context_window": 2,
    "context_mode": "both"
  }'

# 4. æª¢æŸ¥æ—¥èªŒ
docker logs ai-django --tail 50
```

### 5.2 å‰ç«¯éƒ¨ç½²

```bash
# 1. é‡æ–°å»ºæ§‹å‰ç«¯
cd frontend
npm run build

# 2. é‡å•Ÿå®¹å™¨
docker compose restart ai-react

# 3. æ¸…é™¤ç€è¦½å™¨å¿«å–
# Chrome: Ctrl+Shift+Delete

# 4. æ¸¬è©¦è¨ªå•
# http://localhost:3000/rvt-assistant/chat
```

### 5.3 æœ€çµ‚æª¢æŸ¥

```
éƒ¨ç½²æª¢æŸ¥æ¸…å–®ï¼š
â–¡ å¾Œç«¯ API æ­£å¸¸å›æ‡‰
â–¡ V1 å’Œ V2 éƒ½èƒ½æ­£å¸¸æœå°‹
â–¡ Toggle Bar é¡¯ç¤ºæ­£å¸¸
â–¡ ç‰ˆæœ¬åˆ‡æ›ç„¡å»¶é²
â–¡ RVT Assistant åŠŸèƒ½æ­£å¸¸
â–¡ Protocol Assistant åŠŸèƒ½æ­£å¸¸
â–¡ ç„¡ Console éŒ¯èª¤
â–¡ ç„¡ API éŒ¯èª¤
â–¡ æ•ˆèƒ½ç¬¦åˆé æœŸï¼ˆV1 < 100ms, V2 < 200msï¼‰
```

---

## ğŸ“Š ä½¿ç”¨çµ±è¨ˆï¼ˆå¯é¸ï¼‰

### ç°¡å–®çµ±è¨ˆè¡¨ï¼ˆ1 å°æ™‚å¯¦ä½œï¼‰

```sql
-- backend/api/models.py

CREATE TABLE search_version_usage (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES auth_user(id),
    assistant_type VARCHAR(50),  -- 'rvt_assistant', 'protocol_assistant'
    version VARCHAR(10),          -- 'v1', 'v2'
    query TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    
    INDEX idx_version_usage_user (user_id),
    INDEX idx_version_usage_version (version, created_at)
);

-- æŸ¥è©¢çµ±è¨ˆ
SELECT 
    version,
    COUNT(*) as usage_count,
    COUNT(DISTINCT user_id) as unique_users,
    DATE(created_at) as date
FROM search_version_usage
WHERE created_at >= NOW() - INTERVAL '7 days'
GROUP BY version, DATE(created_at)
ORDER BY date DESC, version;
```

---

## ğŸ¯ æˆåŠŸæ¨™æº–

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… Toggle Bar æ­£å¸¸é¡¯ç¤ºå’Œåˆ‡æ›
- âœ… V1 å’Œ V2 æœå°‹éƒ½æ­£å¸¸å·¥ä½œ
- âœ… ç‰ˆæœ¬æ¨™è¨˜æ­£ç¢ºé¡¯ç¤º
- âœ… V2 ä¸Šä¸‹æ–‡æ­£ç¢ºå±•ç¤º

### æ•ˆèƒ½è¦æ±‚
- âœ… V1 æœå°‹ï¼š< 100ms
- âœ… V2 æœå°‹ï¼š< 200ms
- âœ… ç‰ˆæœ¬åˆ‡æ›ï¼š< 50ms
- âœ… ç„¡è¨˜æ†¶é«”æ´©æ¼

### ç”¨æˆ¶é«”é©—
- âœ… UI ç¾è§€ï¼Œç¬¦åˆ Ant Design è¦ç¯„
- âœ… åˆ‡æ›æµæš¢ç„¡å¡é “
- âœ… éŒ¯èª¤æç¤ºå‹å–„
- âœ… éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆæ”¯æ´æ‰‹æ©Ÿï¼‰

---

## ğŸ“š ç›¸é—œæ–‡æª”

- **å¯¦ä½œè¨ˆç•«**: `/docs/development/context-window-implementation-plan.md`
- **A/B æ¸¬è©¦æ–¹æ¡ˆ**: `/docs/development/context-window-ab-testing-plan.md`
- **å‘é‡æœå°‹æŒ‡å—**: `/docs/vector-search/vector-search-guide.md`

---

**æ–‡æª”ç‰ˆæœ¬**: v1.0  
**å‰µå»ºæ—¥æœŸ**: 2025-11-09  
**é è¨ˆå®Œæˆ**: 1-2 å¤©  
**é©ç”¨ Assistant**: RVT Assistant, Protocol Assistant

**ä¸‹ä¸€æ­¥**ï¼šé–‹å§‹å¯¦ä½œ â†’ æ¸¬è©¦ â†’ éƒ¨ç½² â†’ æ”¶é›†åé¥‹
