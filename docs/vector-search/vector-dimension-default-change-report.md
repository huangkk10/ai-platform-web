# å‘é‡ç¶­åº¦é è¨­å€¼ä¿®æ”¹å ±å‘Š

**ä¿®æ”¹æ—¥æœŸ**: 2025-10-22  
**ä¿®æ”¹äººå“¡**: AI Platform Team  
**ä¿®æ”¹å…§å®¹**: å°‡ `get_embedding_service()` é è¨­æ¨¡å‹å¾ 768 ç¶­æ”¹ç‚º 1024 ç¶­

---

## âœ… ä¿®æ”¹å…§å®¹

### ä¿®æ”¹æª”æ¡ˆ
**æª”æ¡ˆè·¯å¾‘**: `backend/api/services/embedding_service.py`

### ä¿®æ”¹å‰
```python
def __init__(self, model_type: str = 'standard'):
    """
    åˆå§‹åŒ–åµŒå…¥æœå‹™
    
    Args:
        model_type: æ¨¡å‹é¡å‹ ('lightweight', 'standard', 'high_precision')
    """
    if model_type not in self.MODEL_CONFIGS:
        # å¦‚æœæ˜¯èˆŠçš„æ¨¡å‹åç¨±ï¼Œå›é€€åˆ°è¼•é‡ç´šæ¨¡å‹
        if isinstance(model_type, str) and 'MiniLM' in model_type:
            model_type = 'lightweight'
        else:
            model_type = 'standard'  # é»˜èªä½¿ç”¨ 768 ç¶­æ¨™æº–æ¨¡å‹
```

### ä¿®æ”¹å¾Œ
```python
def __init__(self, model_type: str = 'ultra_high'):
    """
    åˆå§‹åŒ–åµŒå…¥æœå‹™
    
    Args:
        model_type: æ¨¡å‹é¡å‹ (é è¨­: 'ultra_high' - 1024ç¶­å¤šèªè¨€æ¨¡å‹)
                   å¯é¸: 'lightweight' (384ç¶­), 'standard' (768ç¶­), 'high_precision' (768ç¶­)
    """
    if model_type not in self.MODEL_CONFIGS:
        # å¦‚æœæ˜¯èˆŠçš„æ¨¡å‹åç¨±ï¼Œå›é€€åˆ° ultra_high
        if isinstance(model_type, str) and 'MiniLM' in model_type:
            model_type = 'lightweight'
        else:
            model_type = 'ultra_high'  # é è¨­ä½¿ç”¨ 1024 ç¶­æ¨¡å‹ï¼ˆèˆ‡è³‡æ–™åº«ä¸€è‡´ï¼‰
```

---

## ğŸ¯ ä¿®æ”¹åŸå› 

### å•é¡ŒèƒŒæ™¯
1. **è³‡æ–™åº«å‘é‡ç¶­åº¦**: å·²çµ±ä¸€ç‚º 1024 ç¶­
   - `document_embeddings`: `vector(1024)` âœ…
   - `document_section_embeddings`: `vector(1024)` âœ…

2. **ç¨‹å¼ç¢¼é è¨­ç¶­åº¦**: åŸç‚º 768 ç¶­
   - `get_embedding_service()` é è¨­ä½¿ç”¨ `'standard'` æ¨¡å‹
   - `'standard'` æ¨¡å‹ç”Ÿæˆ 768 ç¶­å‘é‡

3. **ç¶­åº¦ä¸åŒ¹é…å•é¡Œ**:
   - ç•¶ç¨‹å¼ç¢¼èª¿ç”¨ `get_embedding_service()` è€ŒæœªæŒ‡å®šæ¨¡å‹æ™‚
   - ç”Ÿæˆ 768 ç¶­å‘é‡
   - å˜—è©¦æ’å…¥ 1024 ç¶­è³‡æ–™åº«
   - **çµæœ**: PostgreSQL å ±éŒ¯ `dimension mismatch (expected 1024, got 768)`

### å½±éŸ¿ç¯„åœ
ä¿®æ”¹å‰ï¼Œä»¥ä¸‹ 12 è™•ç¨‹å¼ç¢¼å­˜åœ¨æ½›åœ¨å•é¡Œï¼š
1. `backend/api/management/commands/generate_know_issue_embeddings.py` - 1 è™•
2. `backend/api/views/viewsets.py` - 1 è™•
3. `backend/api/views/viewsets/knowledge_viewsets.py` - 4 è™•
4. `backend/api/views/mixins/vector_management_mixin.py` - 2 è™•
5. `library/common/knowledge_base/base_vector_service.py` - 3 è™•
6. `library/protocol_guide/viewset_manager.py` - 1 è™•

---

## âœ… æ¸¬è©¦é©—è­‰

### æ¸¬è©¦è…³æœ¬
**ä½ç½®**: `tests/test_vector_search/test_default_embedding_dimension.py`

### æ¸¬è©¦çµæœ

#### æ¸¬è©¦ 1: é è¨­æ¨¡å‹ç¶­åº¦æª¢æŸ¥ âœ…
```
âœ… æ¨¡å‹é¡å‹: ultra_high
âœ… æ¨¡å‹åç¨±: intfloat/multilingual-e5-large
âœ… å‘é‡ç¶­åº¦: 1024
âœ… é è¨­ç¶­åº¦æ­£ç¢ºï¼š1024 ç¶­
```

#### æ¸¬è©¦ 2: å‘é‡ç”Ÿæˆé©—è­‰ âœ…
```
æ¸¬è©¦æ–‡æœ¬ 1: USB Type-C æ¸¬è©¦æŒ‡å—
  ç”Ÿæˆå‘é‡ç¶­åº¦: 1024 âœ…

æ¸¬è©¦æ–‡æœ¬ 2: Protocol æ¸¬è©¦æµç¨‹
  ç”Ÿæˆå‘é‡ç¶­åº¦: 1024 âœ…

æ¸¬è©¦æ–‡æœ¬ 3: RVT Assistant ä½¿ç”¨èªªæ˜
  ç”Ÿæˆå‘é‡ç¶­åº¦: 1024 âœ…

âœ… æ‰€æœ‰å‘é‡ç”Ÿæˆæ¸¬è©¦é€šé
```

#### æ¸¬è©¦ 3: è³‡æ–™åº«æ’å…¥é©—è­‰ âœ…
```
æº–å‚™æ’å…¥æ¸¬è©¦å‘é‡:
  ä¾†æºè¡¨: test_dimension_check
  ä¾†æº ID: 99999

âœ… å‘é‡æ’å…¥æˆåŠŸ

è³‡æ–™åº«é©—è­‰:
  ä¾†æºè¡¨: test_dimension_check
  ä¾†æº ID: 99999
  å‘é‡ç¶­åº¦: 1024 âœ…
  å…§å®¹é•·åº¦: 37

âœ… è³‡æ–™åº«ä¸­çš„å‘é‡ç¶­åº¦æ­£ç¢ºï¼š1024 ç¶­
âœ… æ¸¬è©¦è³‡æ–™æ¸…ç†æˆåŠŸ
```

#### æ¸¬è©¦ 4: æ˜ç¢ºæŒ‡å®šæ¨¡å‹é¡å‹ âœ…
```
âœ… lightweight     â†’ 384 ç¶­ï¼ˆæ­£ç¢ºï¼‰
âœ… standard        â†’ 768 ç¶­ï¼ˆæ­£ç¢ºï¼‰
âœ… high_precision  â†’ 768 ç¶­ï¼ˆæ­£ç¢ºï¼‰
âœ… ultra_high      â†’ 1024 ç¶­ï¼ˆæ­£ç¢ºï¼‰

âœ… æ‰€æœ‰æ¨¡å‹é¡å‹é©—è­‰é€šé
```

### æ¸¬è©¦ç¸½çµ
```
ç¸½è¨ˆ: 4/4 å€‹æ¸¬è©¦é€šé

ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼é è¨­ç¶­åº¦ä¿®æ”¹æˆåŠŸï¼
âœ… get_embedding_service() ç¾åœ¨é è¨­ä½¿ç”¨ 1024 ç¶­å‘é‡
âœ… èˆ‡è³‡æ–™åº«ç¶­åº¦å®Œå…¨ä¸€è‡´
```

---

## ğŸ“Š ä¿®æ”¹æ•ˆæœ

### ä¿®æ”¹å‰ âŒ
```python
# èª¿ç”¨æ–¹å¼
service = get_embedding_service()

# çµæœ
- æ¨¡å‹é¡å‹: standard
- å‘é‡ç¶­åº¦: 768
- è³‡æ–™åº«ç¶­åº¦: 1024
- ç‹€æ…‹: âŒ ç¶­åº¦ä¸åŒ¹é…ï¼Œæ’å…¥å¤±æ•—
```

### ä¿®æ”¹å¾Œ âœ…
```python
# èª¿ç”¨æ–¹å¼ï¼ˆç›¸åŒï¼‰
service = get_embedding_service()

# çµæœ
- æ¨¡å‹é¡å‹: ultra_high
- å‘é‡ç¶­åº¦: 1024
- è³‡æ–™åº«ç¶­åº¦: 1024
- ç‹€æ…‹: âœ… ç¶­åº¦ä¸€è‡´ï¼Œé‹ä½œæ­£å¸¸
```

---

## ğŸ¯ å½±éŸ¿åˆ†æ

### æ­£é¢å½±éŸ¿ âœ…
1. **è§£æ±ºç¶­åº¦ä¸åŒ¹é…å•é¡Œ**
   - æ‰€æœ‰æœªæŒ‡å®šæ¨¡å‹çš„èª¿ç”¨ç¾åœ¨éƒ½ä½¿ç”¨ 1024 ç¶­
   - èˆ‡è³‡æ–™åº«å®Œå…¨ä¸€è‡´
   - ä¸å†ç™¼ç”Ÿ `dimension mismatch` éŒ¯èª¤

2. **æå‡å‘é‡å“è³ª**
   - 1024 ç¶­å‘é‡æ¯” 768 ç¶­æ›´ç²¾ç¢º
   - ä½¿ç”¨ `intfloat/multilingual-e5-large` æ¨¡å‹ï¼ˆæœ€ä½³å¤šèªè¨€æ¨¡å‹ï¼‰
   - èªç¾©ç†è§£èƒ½åŠ›æ›´å¼·

3. **ç°¡åŒ–ç¶­è­·**
   - ç„¡éœ€åœ¨æ¯è™•èª¿ç”¨éƒ½æŒ‡å®š `'ultra_high'`
   - é è¨­å€¼èˆ‡è³‡æ–™åº«ä¸€è‡´ï¼Œæ›´ç›´è§€
   - æ¸›å°‘æœªä¾†å‡ºéŒ¯çš„å¯èƒ½æ€§

### å‘å¾Œç›¸å®¹æ€§ âœ…
1. **æ˜ç¢ºæŒ‡å®šæ¨¡å‹çš„ç¨‹å¼ç¢¼ä¸å—å½±éŸ¿**
   ```python
   # é€™äº›èª¿ç”¨ä¸å—å½±éŸ¿
   service = get_embedding_service('standard')      # ä»ç‚º 768 ç¶­
   service = get_embedding_service('lightweight')   # ä»ç‚º 384 ç¶­
   service = get_embedding_service('ultra_high')    # ä»ç‚º 1024 ç¶­
   ```

2. **å·²æ£„ç”¨çš„å‡½æ•¸ä»å¯é‹ä½œ**
   ```python
   # ä¿ç•™çš„èˆŠç‰ˆç›¸å®¹å‡½æ•¸
   search_rvt_guide_with_vectors_768_legacy()  # æ˜ç¢ºä½¿ç”¨ 'standard'
   ```

### æ³¨æ„äº‹é … âš ï¸
1. **æ¨¡å‹è¼‰å…¥æ™‚é–“**
   - `intfloat/multilingual-e5-large` æ¨¡å‹è¼ƒå¤§ï¼ˆç´„ 1.3 GBï¼‰
   - é¦–æ¬¡è¼‰å…¥éœ€è¦ 3-5 ç§’
   - å»ºè­°ä½¿ç”¨ preload é è¼‰å…¥æœå‹™

2. **è¨˜æ†¶é«”ä½¿ç”¨**
   - 1024 ç¶­æ¨¡å‹æ¯” 768 ç¶­æ¨¡å‹ä½”ç”¨æ›´å¤šè¨˜æ†¶é«”
   - å¢åŠ ç´„ 30-40% è¨˜æ†¶é«”ä½¿ç”¨
   - å°æ–¼è¨˜æ†¶é«”å—é™çš„ç’°å¢ƒï¼Œå¯æ˜ç¢ºæŒ‡å®š `'standard'`

---

## ğŸ”„ å¾ŒçºŒå»ºè­°

### å·²å®Œæˆ âœ…
1. âœ… ä¿®æ”¹é è¨­æ¨¡å‹ç‚º `'ultra_high'` (1024 ç¶­)
2. âœ… å‰µå»ºæ¸¬è©¦è…³æœ¬é©—è­‰ä¿®æ”¹
3. âœ… æ¸¬è©¦æ‰€æœ‰åŠŸèƒ½æ­£å¸¸é‹ä½œ

### å»ºè­°é€²è¡Œ ğŸ”§
1. **æ¸…ç†å·²æ£„ç”¨ä»£ç¢¼**ï¼ˆå„ªå…ˆç´šï¼šä¸­ï¼‰
   - åˆªé™¤ `search_rvt_guide_with_vectors_768_legacy()`
   - åˆªé™¤ `_get_rvt_guide_results()`
   - é€™äº›å‡½æ•¸å·²ç„¡å¯¦éš›ç”¨é€”

2. **ç§»é™¤ `use_1024_table` åƒæ•¸**ï¼ˆå„ªå…ˆç´šï¼šä½ï¼‰
   - è³‡æ–™åº«å·²çµ±ä¸€ç‚º 1024 ç¶­
   - æ­¤åƒæ•¸å·²ç„¡æ„ç¾©
   - å¯ä»¥ç°¡åŒ– API

3. **æ›´æ–°æ–‡æª”**ï¼ˆå„ªå…ˆç´šï¼šä¸­ï¼‰
   - æ›´æ–° vector-search-guide.md
   - èªªæ˜é è¨­æ¨¡å‹å·²æ”¹ç‚º 1024 ç¶­
   - æä¾›æœ€ä½³å¯¦è¸å»ºè­°

---

## ğŸ“š ç›¸é—œæ–‡æª”

### ä¿®æ”¹ç›¸é—œ
- **å¯©è¨ˆå ±å‘Š**: `/docs/vector-search/vector-dimension-audit-report.md`
- **æ¸¬è©¦è…³æœ¬**: `/tests/test_vector_search/test_default_embedding_dimension.py`
- **ä¿®æ”¹æª”æ¡ˆ**: `/backend/api/services/embedding_service.py`

### å‘é‡æœå°‹ç›¸é—œ
- **å‘é‡æœå°‹æŒ‡å—**: `/docs/vector-search/vector-search-guide.md`
- **å¿«é€Ÿåƒè€ƒ**: `/docs/vector-search/vector-search-quick-reference.md`
- **å‡ç´šæ‘˜è¦**: `/docs/vector-search/vector-upgrade-1024-summary.md`

---

## ğŸ‰ çµè«–

**ä¿®æ”¹ç‹€æ…‹**: âœ… æˆåŠŸå®Œæˆ

**æ ¸å¿ƒæ”¹è®Š**: 
- `get_embedding_service()` é è¨­æ¨¡å‹ï¼š`'standard'` (768 ç¶­) â†’ `'ultra_high'` (1024 ç¶­)

**æ¸¬è©¦çµæœ**: 
- 4/4 æ¸¬è©¦é€šé âœ…
- å‘é‡ç”Ÿæˆæ­£å¸¸ âœ…
- è³‡æ–™åº«æ’å…¥æ­£å¸¸ âœ…
- ç¶­åº¦å®Œå…¨ä¸€è‡´ âœ…

**å½±éŸ¿è©•ä¼°**:
- âœ… è§£æ±ºç¶­åº¦ä¸åŒ¹é…å•é¡Œ
- âœ… æå‡å‘é‡å“è³ª
- âœ… ä¿æŒå‘å¾Œç›¸å®¹æ€§
- âœ… ç°¡åŒ–æœªä¾†ç¶­è­·

**å»ºè­°å¾ŒçºŒè¡Œå‹•**:
1. æ¸…ç†å·²æ£„ç”¨ä»£ç¢¼
2. æ›´æ–°ç›¸é—œæ–‡æª”
3. ç›£æ§ç”Ÿç”¢ç’°å¢ƒé‹ä½œ

---

**ğŸ“… æ›´æ–°æ—¥æœŸ**: 2025-10-22  
**ğŸ“ ç‰ˆæœ¬**: v1.0  
**âœï¸ ä¿®æ”¹äººå“¡**: AI Platform Team  
**ğŸ¯ ç‹€æ…‹**: ä¿®æ”¹å®Œæˆï¼Œæ¸¬è©¦é€šé
