# Benchmark 批量測試系統設計文檔

## 📋 文檔資訊

- **創建日期**：2025-11-23
- **作者**：AI Platform Team
- **狀態**：✅ 設計完成，待實施驗證
- **相關文檔**：
  - [模組化重構規劃](./SYSTEM_A_MODULAR_REFACTORING_PLAN.md)
  - [Benchmark Dashboard 文檔](../../frontend/src/pages/benchmark/)

---

## 🎯 問題分析

### 當前測試流程的問題

1. **手動選擇版本**
   - 用戶需要手動選擇版本
   - 每次只能測試一個版本
   - 需要手動切換版本再次測試

2. **重複測試無意義**
   - ✅ 您的觀察完全正確！
   - 相同的測試案例 + 相同的版本 = 相同的結果
   - 重複執行只是浪費時間和資源

3. **結果難以比較**
   - 結果分散在不同的 Test Run 中
   - 需要手動查看每個 Test Run 的詳細頁面
   - 缺少並列對比視圖

4. **缺乏歷史追蹤**
   - 無法判斷某個版本是否已經測試過
   - 不知道何時需要重新測試
   - 資料更新或演算法變更後需要手動記錄

### 理想的測試流程

```
步驟 1：一次性執行所有版本測試
   ↓
步驟 2：自動生成對比報告
   ↓
步驟 3：找出最佳版本和權衡分析
   ↓
步驟 4：只在資料/演算法變更時重新測試
```

---

## 🎨 解決方案設計

### 方案概述：批量版本測試系統

**核心理念**：
- 一次執行，測試所有版本
- 自動對比，生成排名報告
- 智能判斷，避免重複測試
- 視覺化比較，快速決策

### 架構設計

```
┌─────────────────────────────────────────────────────────────┐
│ 前端：批量測試執行頁面                                          │
├─────────────────────────────────────────────────────────────┤
│ - 勾選要測試的版本（或全選）                                    │
│ - 勾選要使用的測試案例（或全選）                                │
│ - 一鍵執行批量測試                                             │
│ - 即時顯示進度                                                │
│ - 自動生成對比報告                                             │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ API：POST /api/benchmark/versions/batch_test/               │
├─────────────────────────────────────────────────────────────┤
│ Body: {                                                      │
│   "version_ids": [5, 6, 7],     // 可選                      │
│   "test_case_ids": [1, 2, 3],   // 可選                      │
│   "force_retest": false          // 是否強制重測             │
│ }                                                            │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 後端：BatchVersionTester（批量測試器）                         │
├─────────────────────────────────────────────────────────────┤
│ 1. 準備版本列表                                               │
│    - 如果未指定，測試所有版本                                  │
│    - 智能判斷是否需要重新測試                                  │
│                                                              │
│ 2. 準備測試案例                                               │
│    - 如果未指定，使用所有啟用的案例                            │
│    - 確保測試案例一致性                                       │
│                                                              │
│ 3. 並行/順序執行測試                                          │
│    - 使用現有的 BenchmarkTestRunner                          │
│    - 每個版本創建一個 TestRun                                 │
│    - 記錄測試開始和完成時間                                   │
│                                                              │
│ 4. 生成對比報告                                               │
│    - 提取所有版本的核心指標                                   │
│    - 生成多維度排名                                           │
│    - 分析權衡關係                                             │
│    - 標記最佳版本                                             │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 前端：對比報告視圖                                             │
├─────────────────────────────────────────────────────────────┤
│ 📊 雷達圖：多維度對比                                          │
│ 📈 折線圖：指標變化趨勢                                        │
│ 📋 表格：詳細數據對比                                          │
│ 🏆 排名：各維度最佳版本                                        │
│ 💡 建議：場景化推薦                                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 實施檔案清單

### 已創建的檔案

| 檔案 | 行數 | 狀態 | 說明 |
|------|------|------|------|
| `backend/library/benchmark/batch_version_tester.py` | ~600 行 | ✅ 已創建 | 批量測試核心邏輯 |
| `backend/batch_test_all_versions.py` | ~150 行 | ✅ 已創建 | 命令行執行腳本 |
| `backend/api/views/viewsets/benchmark_viewsets.py` | +85 行 | ✅ 已修改 | 添加批量測試 API |

### 待創建的檔案

| 檔案 | 預計行數 | 優先級 | 說明 |
|------|---------|--------|------|
| `frontend/src/pages/benchmark/BatchTestExecutionPage.js` | ~400 行 | 🔥 高 | 批量測試執行頁面 |
| `frontend/src/pages/benchmark/BatchComparisonPage.js` | ~500 行 | 🔥 高 | 批量對比報告頁面 |
| `frontend/src/services/benchmarkApi.js` | +30 行 | 🔥 高 | 添加批量測試 API |
| `frontend/src/components/benchmark/VersionComparisonChart.jsx` | ~200 行 | 📊 中 | 版本對比圖表組件 |
| `frontend/src/components/benchmark/TradeOffAnalysis.jsx` | ~150 行 | 📊 中 | 權衡分析組件 |

---

## 🔧 核心功能詳解

### 1. 智能重測判斷

**問題**：如何避免重複測試？

**解決方案**：
```python
def _needs_testing(self, version, test_case_ids):
    """
    判斷版本是否需要測試
    
    檢查條件：
    1. 是否已有測試記錄？
    2. 測試案例集是否相同？
    3. 測試是否成功完成？
    4. 資料是否有更新？（可選）
    """
    recent_run = version.test_runs.filter(
        status='completed',
        run_type='batch_comparison'
    ).order_by('-created_at').first()
    
    if not recent_run:
        return True  # 沒有測試記錄
    
    # 檢查測試案例是否相同
    tested_case_ids = set(
        recent_run.results.values_list('test_case_id', flat=True)
    )
    if set(test_case_ids) != tested_case_ids:
        return True  # 測試案例不同
    
    return False  # 已有相同測試
```

**使用方式**：
- 預設：自動跳過已測試的版本
- `force_retest=True`：強制重新測試所有版本

### 2. 多維度對比

**對比維度**：

| 維度 | 指標 | 排序 | 說明 |
|------|------|------|------|
| **整體分數** | overall_score | 降序 | 綜合評分，越高越好 |
| **精準度** | precision | 降序 | 搜尋結果的準確性 |
| **召回率** | recall | 降序 | 找到所有相關結果的能力 |
| **F1 分數** | f1_score | 降序 | 精準度和召回率的平衡 |
| **NDCG** | ndcg | 降序 | 排序品質 |
| **響應時間** | avg_response_time | 升序 | 越快越好 |
| **通過率** | pass_rate | 降序 | 測試案例通過百分比 |

**排名結果**：
```json
{
  "ranking": {
    "by_overall_score": [
      {"version_name": "V3 - 混合 70-30", "overall_score": 53.6},
      {"version_name": "Baseline Version", "overall_score": 46.5},
      ...
    ],
    "by_precision": [...],
    "by_recall": [...],
    "by_response_time": [...]
  }
}
```

### 3. 權衡分析

**問題**：不同版本各有優劣，如何選擇？

**解決方案**：自動識別不同場景的最佳版本

```python
trade_offs = [
    {
        'type': 'high_precision',
        'description': '高精準度版本（Precision > 80%）',
        'versions': ['V1 - 純段落向量'],
        'note': '適合需要高準確性的場景，可能會漏掉一些結果'
    },
    {
        'type': 'high_recall',
        'description': '高召回率版本（Recall > 90%）',
        'versions': ['V2 - 純全文向量', 'Baseline'],
        'note': '適合需要找到所有相關結果的場景，可能包含較多不相關結果'
    },
    {
        'type': 'balanced',
        'description': '平衡版本（Precision 和 Recall 差距 < 10%）',
        'versions': ['V3 - 混合 70-30'],
        'note': '適合大多數場景的通用配置'
    },
    {
        'type': 'fast',
        'description': '快速版本（響應時間 < 平均值的 80%）',
        'versions': ['V3 - 混合 70-30', 'V4 - 混合 50-50'],
        'note': '適合需要快速回應的即時場景'
    }
]
```

### 4. 批次追蹤

**Batch ID 格式**：`20251123_153045`（日期_時間）

**用途**：
- 識別同一批次的測試
- 追蹤測試歷史
- 分析不同批次的結果差異

**資料庫標記**：
```python
test_run = BenchmarkTestRun.objects.create(
    version=version,
    run_name=f"{batch_name} - {version.version_name}",
    run_type='batch_comparison',  # ⚠️ 標記為批量測試
    notes=f"批次 ID: {batch_id}\n{notes}"
)
```

---

## 📊 使用場景與範例

### 場景 1：初次建立基準線

**目標**：找出所有版本中的最佳配置

**操作**：
```bash
# 命令行
python backend/batch_test_all_versions.py --force

# 或透過 API
POST /api/benchmark/versions/batch_test/
{
  "force_retest": true
}
```

**預期結果**：
```
📊 批量測試摘要報告
================================================================================

📋 基本資訊:
   批次 ID: 20251123_153045
   測試版本數: 7
   測試案例數: 50
   總執行時間: 35 秒

🏆 版本排名（按整體分數）:
   1. V3 - 混合權重 70-30 ⭐
      整體分數: 53.60
      Precision: 80.00%
      Recall: 100.00%
      F1: 88.89%
      響應時間: 108.87ms

   2. V1 - 純段落向量搜尋 🎯
      整體分數: 53.60
      Precision: 80.00%
      Recall: 100.00%
      F1: 88.89%
      響應時間: 115.23ms

   3. Baseline Version
      整體分數: 46.50
      Precision: 74.00%
      Recall: 100.00%
      F1: 85.06%
      響應時間: 2244.37ms

⭐ 綜合最佳版本: V3 - 混合權重 70-30
   整體分數: 53.60

📈 權衡分析:
   • 高精準度版本（Precision > 80%）
     版本: V1 - 純段落向量搜尋, V3 - 混合權重 70-30
     說明: 適合需要高準確性的場景，可能會漏掉一些結果

   • 快速版本（響應時間 < 180ms）
     版本: V3 - 混合權重 70-30, V4 - 混合權重 50-50
     說明: 適合需要快速回應的即時場景
```

### 場景 2：快速測試（前 10 個案例）

**目標**：快速驗證新演算法

**操作**：
```bash
python backend/batch_test_all_versions.py --versions 7,8,9 --limit 10
```

**預期結果**：
- 只測試版本 7, 8, 9
- 只使用前 10 個測試案例
- 預計執行時間 < 1 分鐘

### 場景 3：特定難度測試

**目標**：測試演算法在困難案例上的表現

**操作**：
```bash
python backend/batch_test_all_versions.py --difficulty hard
```

**預期結果**：
- 測試所有版本
- 只使用 "hard" 難度的案例
- 比較各版本在困難案例的表現

### 場景 4：增量測試（智能跳過）

**目標**：只測試尚未測試的新版本

**操作**：
```bash
# 第一次執行：測試所有版本（ID=3-9）
python backend/batch_test_all_versions.py

# 新增版本 ID=10, 11
# 第二次執行：自動跳過 ID=3-9，只測試 ID=10, 11
python backend/batch_test_all_versions.py
```

**預期結果**：
```
📋 已選擇 7 個版本進行測試
   跳過版本: 3, 4, 5, 6, 7, 8, 9（已有測試結果）
   測試版本: 10, 11（新版本）
```

---

## 🎨 前端視覺化設計

### 1. 批量測試執行頁面

**路由**：`/benchmark/batch-test`

**功能佈局**：
```
┌─────────────────────────────────────────────────────────────┐
│ 📊 批量版本測試                                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ 🎯 選擇要測試的版本                                           │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ ☑ Baseline Version (v2.1.0-baseline) 🎯              │   │
│ │ ☑ V1 - 純段落向量搜尋 (v3.1-section-only)             │   │
│ │ ☑ V2 - 純全文向量搜尋 (v3.2-document-only)            │   │
│ │ ☑ V3 - 混合權重 70-30 (v3.3-hybrid-70-30) ⭐         │   │
│ │ ☑ V4 - 混合權重 50-50 (v3.4-hybrid-50-50)            │   │
│ │ ☑ V5 - 混合權重 80-20 (v3.5-hybrid-80-20)            │   │
│ │                                                       │   │
│ │ [☑ 全選] [☐ 只測試新版本] [☐ 強制重測]               │   │
│ └───────────────────────────────────────────────────────┘   │
│                                                              │
│ 🎯 選擇測試案例（可選）                                       │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ ⦿ 使用所有啟用的測試案例 (50 個)                      │   │
│ │ ○ 自訂選擇                                            │   │
│ │   類別: [全部 ▼]  難度: [全部 ▼]  題型: [全部 ▼]    │   │
│ │   或限制數量: [ 10 ] 個（用於快速測試）               │   │
│ └───────────────────────────────────────────────────────┘   │
│                                                              │
│ 💡 預計測試:                                                 │
│    - 版本數: 6 個                                            │
│    - 案例數: 50 個                                           │
│    - 總測試: 300 次                                          │
│    - 預計時間: ~3 分鐘                                       │
│                                                              │
│ [          🚀 開始批量測試          ]                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2. 對比報告頁面

**路由**：`/benchmark/comparison/{batch_id}`

**功能佈局**：
```
┌─────────────────────────────────────────────────────────────┐
│ 📊 批量測試對比報告                                           │
│ 批次 ID: 20251123_153045  |  測試時間: 2025-11-23 15:30     │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ 🏆 綜合最佳版本: V3 - 混合權重 70-30 (整體分數: 53.60)        │
│                                                              │
│ 📊 雷達圖對比                                                 │
│ ┌───────────────────────────────────────────────────────┐   │
│ │           Precision (精準度)                          │   │
│ │                   /\                                  │   │
│ │                  /  \                                 │   │
│ │    Response    /    \    Recall                      │   │
│ │      Time ────┼──────┼──── (召回率)                 │   │
│ │                \    /                                 │   │
│ │                 \  /                                  │   │
│ │             F1 Score                                  │   │
│ │                                                       │   │
│ │ ─── Baseline  ─── V1  ─── V3  ─── V4                │   │
│ └───────────────────────────────────────────────────────┘   │
│                                                              │
│ 📋 詳細數據對比表                                             │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ 版本        │ 分數 │ Precision │ Recall │ F1  │ RT   │   │
│ ├──────────────┼──────┼───────────┼────────┼─────┼──────┤   │
│ │ V3 (70-30) ⭐│ 53.6 │ 80.0%    │ 100%   │88.9%│109ms │   │
│ │ V1 (Section)│ 53.6 │ 80.0%    │ 100%   │88.9%│115ms │   │
│ │ Baseline 🎯 │ 46.5 │ 74.0%    │ 100%   │85.1%│2244ms│   │
│ │ V4 (50-50)  │ 51.6 │ 80.0%    │  95%   │87.0%│120ms │   │
│ │ V5 (80-20)  │ 50.0 │ 75.0%    │  98%   │85.3%│130ms │   │
│ └───────────────────────────────────────────────────────┘   │
│                                                              │
│ 💡 場景化推薦                                                 │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ 🎯 高精準度場景: V1, V3 (Precision > 80%)            │   │
│ │    適合：準確性優先、容錯率低的場景                   │   │
│ │                                                       │   │
│ │ 📚 高召回率場景: Baseline, V5 (Recall > 98%)         │   │
│ │    適合：不能遺漏重要資訊的場景                       │   │
│ │                                                       │   │
│ │ ⚖️  平衡場景: V3 (Precision/Recall 差距 < 10%)       │   │
│ │    適合：大多數通用場景                               │   │
│ │                                                       │   │
│ │ ⚡ 快速回應場景: V3, V4 (RT < 150ms)                 │   │
│ │    適合：即時互動、用戶體驗敏感的場景                 │   │
│ └───────────────────────────────────────────────────────┘   │
│                                                              │
│ [  查看詳細測試記錄  ] [  導出對比報告  ] [  設為基準線  ]   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 🚀 實施計劃

### Phase 1：後端驗證（已完成）✅

- [x] 創建 `BatchVersionTester` 類別
- [x] 創建命令行執行腳本
- [x] 添加 API 端點 `/batch_test/`
- [x] 撰寫設計文檔

### Phase 2：後端測試（待執行）

- [ ] 執行命令行測試
  ```bash
  python backend/batch_test_all_versions.py --limit 5 --verbose
  ```
- [ ] 驗證批量測試邏輯
- [ ] 驗證對比報告生成
- [ ] 驗證智能跳過機制

### Phase 3：前端開發（待實施）

- [ ] 創建批量測試執行頁面
- [ ] 創建對比報告頁面
- [ ] 開發版本對比圖表組件
- [ ] 開發權衡分析組件
- [ ] 添加批量測試 API 調用

### Phase 4：整合測試（待實施）

- [ ] 前後端整合測試
- [ ] 用戶體驗測試
- [ ] 效能測試
- [ ] 文檔完善

---

## 📈 預期效益

### 時間節省

**當前流程**：
- 手動選擇版本：30 秒 × 7 版本 = 3.5 分鐘
- 等待測試執行：2 分鐘 × 7 版本 = 14 分鐘
- 手動查看結果：1 分鐘 × 7 版本 = 7 分鐘
- 手動比較分析：5 分鐘
- **總計：~30 分鐘**

**改進後流程**：
- 勾選版本（或全選）：10 秒
- 一鍵執行：1 秒
- 自動測試：14 分鐘（不需人工等待）
- 自動生成報告：10 秒
- 查看對比報告：2 分鐘
- **總計：~3 分鐘**（節省 90%）

### 決策品質提升

1. **全面對比**：看到所有版本的優劣勢
2. **場景推薦**：自動識別最適合的版本
3. **資料驅動**：基於實際測試結果決策
4. **歷史追蹤**：了解版本演化趨勢

### 資源節省

1. **避免重複測試**：智能判斷機制
2. **按需測試**：可選擇特定版本或案例
3. **快速驗證**：支援限制案例數量的快速測試

---

## 🎯 最佳實踐建議

### 1. 初次使用

**建議流程**：
1. 先執行快速測試（`--limit 10`）驗證系統
2. 確認無誤後執行完整測試（所有案例）
3. 分析對比報告，標記最佳版本為基準
4. 保存對比報告作為決策依據

### 2. 日常使用

**建議**：
- ✅ **資料更新後**：執行批量測試
- ✅ **演算法更新後**：執行批量測試
- ✅ **新增版本後**：自動測試新版本（智能跳過舊版本）
- ❌ **不建議**：每天重複測試（結果不會變）

### 3. 測試策略

**完整測試**（所有案例）：
- 用途：建立基準線、重要決策
- 頻率：資料更新、演算法變更時
- 時間：~15 分鐘

**快速測試**（10-20 個案例）：
- 用途：快速驗證、初步評估
- 頻率：開發過程中
- 時間：~2 分鐘

**特定測試**（困難案例）：
- 用途：壓力測試、極端情況評估
- 頻率：需要時
- 時間：依案例數量

---

## 📚 相關資源

### 程式碼檔案

- `backend/library/benchmark/batch_version_tester.py` - 批量測試核心邏輯
- `backend/batch_test_all_versions.py` - 命令行執行腳本
- `backend/api/views/viewsets/benchmark_viewsets.py` - API 端點

### API 文檔

**POST** `/api/benchmark/versions/batch_test/`

**請求範例**：
```json
{
  "version_ids": [5, 6, 7],
  "force_retest": false
}
```

**回應範例**：
```json
{
  "success": true,
  "batch_id": "20251123_153045",
  "test_run_ids": [13, 14, 15],
  "comparison": {
    "versions": [...],
    "ranking": {...},
    "best_version": {...},
    "trade_offs": [...]
  },
  "summary": {...}
}
```

### 命令行使用

```bash
# 測試所有版本
python backend/batch_test_all_versions.py

# 測試指定版本
python backend/batch_test_all_versions.py --versions 5,6,7

# 快速測試（前 10 個案例）
python backend/batch_test_all_versions.py --limit 10

# 強制重新測試
python backend/batch_test_all_versions.py --force

# 保存結果到檔案
python backend/batch_test_all_versions.py --output result.json
```

---

## 🎉 總結

### 核心價值

1. **✅ 解決重複測試問題**
   - 您的觀察完全正確
   - 相同配置 = 相同結果
   - 智能判斷，避免浪費

2. **✅ 批量執行，自動對比**
   - 一次執行所有版本
   - 自動生成對比報告
   - 節省 90% 時間

3. **✅ 場景化推薦**
   - 不僅給出排名
   - 提供場景化建議
   - 幫助快速決策

4. **✅ 歷史追蹤**
   - 記錄每次測試
   - 追蹤版本演化
   - 資料驅動決策

### 下一步

1. **立即可執行**：
   ```bash
   # 驗證後端邏輯
   docker exec ai-django python /app/batch_test_all_versions.py --limit 5
   ```

2. **待開發**：
   - 前端批量測試執行頁面
   - 前端對比報告視覺化

3. **待優化**：
   - 支援並行測試（加快速度）
   - 支援即時進度推送
   - 支援更多對比維度

---

**📅 文檔創建日期**：2025-11-23  
**✍️ 作者**：AI Platform Team  
**🎯 狀態**：設計完成，後端實施完成，待驗證和前端開發  
**🔖 標籤**：#benchmark #batch-testing #comparison #optimization
