# 🔧 RRF K 值參數新增規劃

> **狀態**: 📋 規劃中  
> **建立日期**: 2025-12-03  
> **預估工時**: 1.5 小時  
> **影響範圍**: Threshold 設定頁面、一階搜尋服務

---

## 📋 需求摘要

在 **Threshold 設定管理** 頁面的「一階設定（常用）」區塊中，新增 **RRF K 值** 參數，讓用戶可以調整向量搜尋與關鍵字搜尋的融合權重。

---

## 🔍 技術背景

### 什麼是 RRF（Reciprocal Rank Fusion）？

RRF 是一種用於融合多個搜尋結果列表的算法，目前用於 **一階段混合搜尋**：

```
一階段搜尋流程：
┌─────────────────┐     ┌─────────────────┐
│  向量搜尋        │     │  關鍵字搜尋      │
│  (語義理解)      │     │  (精確匹配)      │
└────────┬────────┘     └────────┬────────┘
         │                       │
         └───────────┬───────────┘
                     ▼
            ┌─────────────────┐
            │  RRF 融合        │
            │  (K 值參數)      │
            └────────┬────────┘
                     ▼
            ┌─────────────────┐
            │  最終排序結果    │
            └─────────────────┘
```

### RRF 算法公式

```
RRF_score(d) = Σ 1 / (k + rank(d))
```

- `k`: RRF 常數（目前硬編碼為 60）
- `rank(d)`: 文檔 d 在各個搜尋結果中的排名（從 1 開始）

### K 值對結果的影響

| K 值範圍 | 效果 | 適用場景 |
|----------|------|----------|
| **30-50** | 排名差異放大，**頂部結果更突出** | 精確查詢，需要最佳答案 |
| **60** | 業界標準，平衡穩定 | 通用場景（目前預設值） |
| **80-120** | 排名差異縮小，**結果更平均** | 探索性查詢，需要多樣性 |

### 實際影響範例

假設 Query = "IOL 密碼"：

**K = 30（較小值）時：**
```
文檔 A：向量排名 1, 關鍵字排名 5
  → RRF = 1/(30+1) + 1/(30+5) = 0.0323 + 0.0286 = 0.0609

文檔 B：向量排名 5, 關鍵字排名 1
  → RRF = 1/(30+5) + 1/(30+1) = 0.0286 + 0.0323 = 0.0609
  
差距：兩者相等（向量和關鍵字同等重要）
```

**K = 60（標準值）時：**
```
文檔 A：向量排名 1, 關鍵字排名 5
  → RRF = 1/(60+1) + 1/(60+5) = 0.0164 + 0.0154 = 0.0318

文檔 B：向量排名 5, 關鍵字排名 1
  → RRF = 1/(60+5) + 1/(60+1) = 0.0154 + 0.0164 = 0.0318

差距：兩者相等
```

**K = 120（較大值）時：**
```
文檔 A：向量排名 1, 關鍵字排名 10
  → RRF = 1/(120+1) + 1/(120+10) = 0.00826 + 0.00769 = 0.01595

文檔 B：向量排名 10, 關鍵字排名 1
  → RRF = 1/(120+10) + 1/(120+1) = 0.00769 + 0.00826 = 0.01595

差距：排名差異被「平滑化」，前後結果分數更接近
```

---

## 🎯 目標 UI 設計

### 現有表格結構

```
┌────────────────┬──────────────────────────────────────────┬─────────────────────────────┬─────────────┬────────┐
│                │        ☆ 一階設定（常用）                  │     二階設定（進階）          │ Window 進階  │        │
│   Assistant    ├──────────────┬──────────┬────────────────┼─────────────────────────────┼─────────────┤  操作  │
│                │段落向量Threshold│ 標題權重  │   內容權重      │            ...             │     ...     │        │
├────────────────┼──────────────┼──────────┼────────────────┼─────────────────────────────┼─────────────┼────────┤
│Protocol Assist │     90%      │   10%    │     90%        │            ...             │     ...     │  編輯  │
│RVT Assistant   │     80%      │   70%    │     30%        │            ...             │     ...     │  編輯  │
└────────────────┴──────────────┴──────────┴────────────────┴─────────────────────────────┴─────────────┴────────┘
```

### 新增欄位後的表格結構

```
┌────────────────┬─────────────────────────────────────────────────────────────┬─────────────────────────────┬─────────────┬────────┐
│                │                  ☆ 一階設定（常用）                           │     二階設定（進階）          │ Window 進階  │        │
│   Assistant    ├──────────────┬──────────┬────────────────┬─────────────────┼─────────────────────────────┼─────────────┤  操作  │
│                │段落向量Threshold│ 標題權重  │   內容權重      │ 🆕 RRF K 值     │            ...             │     ...     │        │
├────────────────┼──────────────┼──────────┼────────────────┼─────────────────┼─────────────────────────────┼─────────────┼────────┤
│Protocol Assist │     90%      │   10%    │     90%        │       60        │            ...             │     ...     │  編輯  │
│RVT Assistant   │     80%      │   70%    │     30%        │       60        │            ...             │     ...     │  編輯  │
└────────────────┴──────────────┴──────────┴────────────────┴─────────────────┴─────────────────────────────┴─────────────┴────────┘
```

### 編輯彈窗設計（一階設定區塊）

```
┌─────────────────────────────────────────────────────────────────────┐
│                        編輯 Threshold 設定                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ☆ 一階設定（常用）- 段落級別的語義搜尋                                │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                                                             │   │
│  │  段落向量 Threshold        標題權重           內容權重        │   │
│  │  ┌─────────────────┐    ┌───────────────┐  ┌─────────────┐ │   │
│  │  │  80%            │    │  70%          │  │  30%        │ │   │
│  │  └─────────────────┘    └───────────────┘  └─────────────┘ │   │
│  │                                                             │   │
│  │  🆕 RRF 融合 K 值 ⓘ                                         │   │
│  │  ┌─────────────────────────────────────────────────────┐   │   │
│  │  │  60                                                  │   │   │
│  │  │  ├────────────────────●────────────────────────────┤   │   │
│  │  │  30                  60                          120   │   │
│  │  └─────────────────────────────────────────────────────┘   │   │
│  │                                                             │   │
│  │  ⓘ 提示：                                                   │   │
│  │  • K 值較小(30-50)：頂部結果更突出，適合精確查詢               │   │
│  │  • K 值較大(80-120)：結果更平均，適合探索性查詢                │   │
│  │  • 業界標準值：60                                            │   │
│  │                                                             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  二階設定（進階）- 全文級別的深度搜尋                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  ...（現有欄位不變）                                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│                                           [ 取消 ]    [ 儲存 ]      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 📁 需要修改的檔案清單

### 1️⃣ 後端 Model（資料庫欄位）

**檔案**: `backend/api/models.py`

```python
# SearchThresholdSetting 類別中新增欄位

# === 🆕 混合搜尋配置（一階段） ===
stage1_rrf_k = models.IntegerField(
    default=60,
    verbose_name="一階段 RRF K 值",
    help_text="RRF 融合常數。較小值(30-50)讓頂部結果更突出；較大值(80-120)讓結果更平均。業界標準: 60"
)
```

### 2️⃣ 資料庫 Migration

**執行命令**:
```bash
docker exec ai-django python manage.py makemigrations api --name add_stage1_rrf_k
docker exec ai-django python manage.py migrate
```

### 3️⃣ 後端 Serializer

**檔案**: `backend/api/serializers.py` 或 `backend/api/serializers/search_threshold_serializers.py`

```python
# SearchThresholdSettingSerializer 中新增欄位
class SearchThresholdSettingSerializer(serializers.ModelSerializer):
    class Meta:
        model = SearchThresholdSetting
        fields = [
            # ... 現有欄位
            'stage1_rrf_k',  # 🆕 新增
        ]
```

### 4️⃣ 前端表格欄位

**檔案**: `frontend/src/pages/admin/ThresholdSettingsPage.js`

**新增表格欄位**:
```javascript
// 在「一階設定（常用）」欄位群組中新增
{
  title: (
    <span>
      RRF K 值
      <Tooltip title="RRF 融合常數，影響向量與關鍵字搜尋的融合權重">
        <InfoCircleOutlined style={{ marginLeft: 4 }} />
      </Tooltip>
    </span>
  ),
  dataIndex: 'stage1_rrf_k',
  key: 'stage1_rrf_k',
  width: 100,
  render: (value) => <Tag color="purple">{value}</Tag>,
}
```

### 5️⃣ 前端編輯表單

**檔案**: `frontend/src/pages/admin/ThresholdSettingsPage.js`

**新增表單欄位**:
```javascript
// 在一階設定區塊中新增
<Form.Item
  name="stage1_rrf_k"
  label={
    <span>
      RRF 融合 K 值
      <Tooltip title="影響向量與關鍵字搜尋的融合權重。較小值讓頂部結果更突出；較大值讓結果更平均">
        <InfoCircleOutlined style={{ marginLeft: 8 }} />
      </Tooltip>
    </span>
  }
  rules={[{ required: true, message: '請輸入 RRF K 值' }]}
>
  <Slider
    min={30}
    max={120}
    marks={{
      30: '30',
      60: '60 (標準)',
      120: '120',
    }}
    tooltip={{ formatter: (value) => `K = ${value}` }}
  />
</Form.Item>
```

### 6️⃣ 搜尋服務讀取配置

**檔案**: `library/protocol_guide/search_service.py`

**修改位置**: `_merge_with_rrf` 方法呼叫處

```python
# 從資料庫讀取 RRF K 值
def _get_rrf_k_from_settings(self) -> int:
    """從資料庫讀取 RRF K 值配置"""
    try:
        from api.models import SearchThresholdSetting
        setting = SearchThresholdSetting.objects.get(
            assistant_type=self._get_assistant_type()
        )
        return setting.stage1_rrf_k
    except:
        return 60  # 預設值

# 使用配置
rrf_k = self._get_rrf_k_from_settings()
merged_results = self._merge_with_rrf(vector_results, keyword_results, k=rrf_k)
```

**檔案**: `library/common/knowledge_base/section_search_service.py`

**修改位置**: 同上，讀取配置值

---

## 📊 資料庫欄位變更

### 新增欄位

| 欄位名稱 | 類型 | 預設值 | 說明 |
|----------|------|--------|------|
| `stage1_rrf_k` | IntegerField | 60 | 一階段 RRF 融合常數 |

### 欄位驗證規則

```python
def clean(self):
    # RRF K 值驗證
    if self.stage1_rrf_k < 30:
        self.stage1_rrf_k = 30
    elif self.stage1_rrf_k > 120:
        self.stage1_rrf_k = 120
```

---

## ✅ 實作檢查清單

### 第一階段：後端實作

- [ ] 1.1 修改 `backend/api/models.py` - 新增 `stage1_rrf_k` 欄位
- [ ] 1.2 建立 Migration 檔案
- [ ] 1.3 執行 Migration
- [ ] 1.4 修改 Serializer - 新增 `stage1_rrf_k`
- [ ] 1.5 驗證 API 回傳新欄位

### 第二階段：前端實作

- [ ] 2.1 修改表格欄位定義 - 新增 RRF K 值欄位
- [ ] 2.2 修改編輯表單 - 新增 Slider 輸入元件
- [ ] 2.3 更新表單初始值和提交邏輯
- [ ] 2.4 調整表格寬度和排版

### 第三階段：搜尋服務整合

- [ ] 3.1 修改 `library/protocol_guide/search_service.py`
- [ ] 3.2 修改 `library/rvt_guide/search_service.py`（如果有獨立實作）
- [ ] 3.3 修改 `library/common/knowledge_base/section_search_service.py`
- [ ] 3.4 確保所有 RRF 融合呼叫都使用資料庫配置

### 第四階段：測試驗證

- [ ] 4.1 測試 API 欄位新增/修改
- [ ] 4.2 測試前端顯示和編輯功能
- [ ] 4.3 測試搜尋服務讀取配置
- [ ] 4.4 測試不同 K 值對搜尋結果的影響
- [ ] 4.5 測試預設值（新記錄）

---

## 🧪 測試計畫

### 測試案例 1：API 欄位測試

```bash
# 取得設定
curl -X GET http://localhost/api/search-threshold-settings/

# 預期回應包含 stage1_rrf_k 欄位
{
  "id": 1,
  "assistant_type": "rvt_assistant",
  "stage1_rrf_k": 60,
  ...
}
```

### 測試案例 2：前端編輯測試

1. 進入 Threshold 設定頁面
2. 點擊「編輯」按鈕
3. 調整 RRF K 值 Slider 到 80
4. 點擊儲存
5. 驗證表格顯示更新為 80

### 測試案例 3：搜尋效果測試

```python
# 測試不同 K 值的搜尋結果
query = "IOL 密碼"

# K=30 測試
results_k30 = search_with_rrf_k(query, k=30)

# K=60 測試（標準）
results_k60 = search_with_rrf_k(query, k=60)

# K=120 測試
results_k120 = search_with_rrf_k(query, k=120)

# 比較結果排序差異
```

---

## ⚠️ 注意事項

### 向後相容性

1. **預設值**：新欄位 `stage1_rrf_k` 預設值為 60（業界標準），確保現有系統行為不變
2. **Migration**：確保 Migration 為現有記錄設定正確的預設值
3. **API**：新增欄位為可選，API 呼叫不需要強制傳入

### 效能考量

1. RRF K 值的變更**不會影響搜尋效能**，只影響結果排序
2. 配置值會被快取，不會每次搜尋都查詢資料庫

### UI/UX 考量

1. 使用 **Slider** 而非 Input Number，更直觀
2. 標示 **業界標準值 60**，幫助用戶理解
3. 提供 **Tooltip 說明**，解釋參數意義

---

## 📅 時程規劃

| 階段 | 任務 | 預估時間 |
|------|------|----------|
| 第一階段 | 後端 Model + Migration + Serializer | 20 分鐘 |
| 第二階段 | 前端表格 + 編輯表單 | 30 分鐘 |
| 第三階段 | 搜尋服務整合 | 20 分鐘 |
| 第四階段 | 測試驗證 | 20 分鐘 |
| **合計** | | **約 1.5 小時** |

---

## 📝 備註

- 此規劃僅涉及 **一階設定** 區塊
- 如需在二階設定也支援 RRF K 值，可後續擴展新增 `stage2_rrf_k` 欄位
- 目前 RRF 融合僅用於一階段混合搜尋，二階段使用純向量搜尋

---

**📌 規劃完成，待確認後執行**
