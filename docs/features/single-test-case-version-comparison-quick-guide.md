# å–®ä¸€æ¸¬è©¦æ¡ˆä¾‹ç‰ˆæœ¬æ¯”è¼ƒ - å¿«é€Ÿå¯¦ä½œæŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

åœ¨ VSA æ¸¬è©¦æ¡ˆä¾‹è¡¨æ ¼ä¸­ï¼Œç‚ºæ¯å€‹å•é¡Œæ·»åŠ ã€Œç‰ˆæœ¬æ¯”è¼ƒã€æŒ‰éˆ•ï¼Œä¸€éµæ¸¬è©¦è©²å•é¡Œåœ¨æ‰€æœ‰æœå°‹ç‰ˆæœ¬ï¼ˆV1-V5ï¼‰çš„è¡¨ç¾ã€‚

```
åŸæœ¬ï¼šæ¸¬è©¦ 100 å€‹å•é¡Œ Ã— 5 ç‰ˆæœ¬ = 40 åˆ†é˜
ç¾åœ¨ï¼šæ¸¬è©¦   1 å€‹å•é¡Œ Ã— 5 ç‰ˆæœ¬ = 30 ç§’

ç¯€çœæ™‚é–“ï¼š99.2% âš¡
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. ä½¿ç”¨è€…æ“ä½œæµç¨‹
```
VSA æ¸¬è©¦æ¡ˆä¾‹åˆ—è¡¨
    â†“
é»æ“Šã€Œç‰ˆæœ¬æ¯”è¼ƒã€æŒ‰éˆ• (ğŸ§ª)
    â†“
å½ˆå‡º Modalï¼Œé¡¯ç¤ºæ¸¬è©¦è³‡è¨Š
    â†“
è‡ªå‹•é–‹å§‹æ¸¬è©¦ 5 å€‹ç‰ˆæœ¬
    â†“
é¡¯ç¤ºå³æ™‚é€²åº¦æ¢ï¼ˆ0% â†’ 100%ï¼‰
    â†“
é¡¯ç¤ºæ¸¬è©¦çµæœè¡¨æ ¼
    â†“
å¯æ’åºã€åŒ¯å‡ºã€é‡æ–°æ¸¬è©¦
```

### 2. UI æ•ˆæœåœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ§ª ç‰ˆæœ¬æ¯”è¼ƒæ¸¬è©¦ - ULINK æ¸¬è©¦çš„å®‰è£ç¨‹å¼å’Œæ¸¬è©¦è…³æœ¬...        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ğŸ“Š æ¸¬è©¦è³‡è¨Š                                              â”‚
â”‚  å•é¡Œï¼šULINK æ¸¬è©¦çš„å®‰è£ç¨‹å¼å’Œæ¸¬è©¦è…³æœ¬æœ¬å­˜æ”¾åœ¨ NAS ...      â”‚
â”‚  é›£åº¦ï¼šeasy  |  é—œéµå­—ï¼š[20%] [100%] [33%]               â”‚
â”‚                                                         â”‚
â”‚  â³ é€²åº¦ï¼š[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘] 80% (4/5 å®Œæˆ)           â”‚
â”‚                                                         â”‚
â”‚  ğŸ“‹ æ¸¬è©¦çµæœ                                              â”‚
â”‚  #  ç‰ˆæœ¬åç¨±          P     R     F1    ç‹€æ…‹              â”‚
â”‚  1  V1-ç´”æ®µè½æœå°‹    20%   100%  33%   âœ…               â”‚
â”‚  2  V2-ç´”å…¨æ–‡æœå°‹    10%   100%  18%   âœ…               â”‚
â”‚  3  V3-æ··åˆ70-30    10%   100%  18%   âœ…               â”‚
â”‚  4  V4-æ··åˆ50-50    10%   100%  18%   âœ…               â”‚
â”‚  5  V5-æ··åˆ80-20    æ¸¬è©¦ä¸­...          ğŸ”„               â”‚
â”‚                                                         â”‚
â”‚  [ğŸ’¾ åŒ¯å‡º]  [ğŸ”„ é‡æ¸¬]                      [âŒ é—œé–‰]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### æŠ€è¡“æ£§
```
å‰ç«¯ï¼šReact + Ant Design
å¾Œç«¯ï¼šDjango REST Framework
æ¸¬è©¦å¼•æ“ï¼šlibrary/benchmark/
è³‡æ–™åº«ï¼šPostgreSQL
```

### æª”æ¡ˆçµæ§‹
```
frontend/src/
â”œâ”€â”€ pages/benchmark/
â”‚   â”œâ”€â”€ UnifiedTestCasePage.js          # ä¿®æ”¹ï¼šæ·»åŠ æŒ‰éˆ•
â”‚   â””â”€â”€ VersionComparisonModal.jsx      # ğŸ†• æ–°å¢çµ„ä»¶
â””â”€â”€ services/
    â””â”€â”€ unifiedBenchmarkApi.js          # ä¿®æ”¹ï¼šæ·»åŠ  API

backend/
â”œâ”€â”€ api/views/viewsets/
â”‚   â””â”€â”€ unified_benchmark_viewsets.py   # ä¿®æ”¹ï¼šæ·»åŠ  action
â””â”€â”€ library/benchmark/
    â””â”€â”€ single_case_version_tester.py   # ğŸ†• æ–°å¢é¡åˆ¥
```

### API è¨­è¨ˆ
```
POST /api/unified-benchmark/test-cases/{id}/version_comparison/
Request:
{
  "version_ids": [1, 2, 3, 4, 5],  // å¯é¸ï¼Œé è¨­å…¨éƒ¨
  "force_retest": false
}

Response (åŒæ­¥):
{
  "success": true,
  "task_id": "uuid-1234",
  "results": [
    {
      "version_id": 1,
      "version_name": "V1 - ç´”æ®µè½å‘é‡æœå°‹",
      "metrics": {
        "precision": 0.20,
        "recall": 1.00,
        "f1_score": 0.33
      },
      "response_time": 1.23,
      "status": "success"
    },
    // ... å…¶ä»– 4 å€‹ç‰ˆæœ¬
  ],
  "summary": {
    "total_versions": 5,
    "best_version": {...},
    "avg_response_time": 1.5
  }
}
```

---

## ğŸ”§ å¯¦ä½œæ­¥é©Ÿï¼ˆ5 å¤©ï¼‰

### Day 1: å¾Œç«¯æ ¸å¿ƒé‚è¼¯
```python
# Step 1: å‰µå»º library/benchmark/single_case_version_tester.py

class SingleCaseVersionTester:
    def __init__(self, test_case_id, version_ids=None):
        self.test_case_id = test_case_id
        self.version_ids = version_ids
    
    def run_comparison(self):
        """åŸ·è¡Œç‰ˆæœ¬æ¯”è¼ƒæ¸¬è©¦"""
        # 1. ç²å–æ¸¬è©¦æ¡ˆä¾‹
        # 2. ç²å–è¦æ¸¬è©¦çš„ç‰ˆæœ¬
        # 3. é€å€‹æ¸¬è©¦ç‰ˆæœ¬
        # 4. è¿”å›çµæœ
        pass
    
    def _test_single_version(self, test_case, version):
        """è¤‡ç”¨ BatchVersionTester çš„é‚è¼¯"""
        from library.benchmark.batch_version_tester import BatchVersionTester
        batch_tester = BatchVersionTester(verbose=False)
        return batch_tester._execute_single_test(test_case, version)
```

### Day 2: å¾Œç«¯ API
```python
# Step 2: ä¿®æ”¹ backend/api/views/viewsets/unified_benchmark_viewsets.py

class UnifiedBenchmarkTestCaseViewSet(viewsets.ModelViewSet):
    # ... ç¾æœ‰ä»£ç¢¼
    
    @action(detail=True, methods=['post'])
    def version_comparison(self, request, pk=None):
        """å–®ä¸€æ¸¬è©¦æ¡ˆä¾‹çš„ç‰ˆæœ¬æ¯”è¼ƒ"""
        test_case = self.get_object()
        version_ids = request.data.get('version_ids', None)
        
        from library.benchmark.single_case_version_tester import SingleCaseVersionTester
        tester = SingleCaseVersionTester(test_case.id, version_ids)
        result = tester.run_comparison()
        
        return Response({
            'success': True,
            'results': result['results'],
            'summary': result['summary']
        })
```

### Day 3: å‰ç«¯ Modal çµ„ä»¶
```javascript
// Step 3: å‰µå»º frontend/src/pages/benchmark/VersionComparisonModal.jsx

const VersionComparisonModal = ({ visible, onClose, testCase }) => {
  const [loading, setLoading] = useState(false);
  const [results, setResults] = useState([]);
  
  const startTest = async () => {
    setLoading(true);
    const response = await unifiedBenchmarkApi.versionComparison(testCase.id);
    setResults(response.data.results);
    setLoading(false);
  };
  
  return (
    <Modal visible={visible} onCancel={onClose} width="90%">
      {/* æ¸¬è©¦è³‡è¨Šå¡ç‰‡ */}
      {/* é€²åº¦æ¢ */}
      {/* çµæœè¡¨æ ¼ */}
    </Modal>
  );
};
```

### Day 4: æ•´åˆåˆ°ä¸»é é¢
```javascript
// Step 4: ä¿®æ”¹ frontend/src/pages/benchmark/UnifiedTestCasePage.js

// 1. å°å…¥çµ„ä»¶
import VersionComparisonModal from './VersionComparisonModal';

// 2. æ·»åŠ æŒ‰éˆ•åˆ°è¡¨æ ¼
{
  title: 'æ“ä½œ',
  render: (_, record) => (
    <Space>
      {/* ç¾æœ‰æŒ‰éˆ• */}
      <Tooltip title="ç‰ˆæœ¬æ¯”è¼ƒæ¸¬è©¦">
        <Button 
          icon={<ExperimentOutlined />}
          type="primary"
          ghost
          onClick={() => handleVersionComparison(record)}
        />
      </Tooltip>
    </Space>
  )
}

// 3. æ·»åŠ  Modal
<VersionComparisonModal
  visible={versionComparisonVisible}
  onClose={() => setVersionComparisonVisible(false)}
  testCase={selectedTestCase}
/>
```

### Day 5: æ¸¬è©¦èˆ‡å„ªåŒ–
```bash
# åŠŸèƒ½æ¸¬è©¦
âœ… æ¸¬è©¦å–®ä¸€å•é¡Œçš„ç‰ˆæœ¬æ¯”è¼ƒ
âœ… é©—è­‰çµæœæº–ç¢ºæ€§
âœ… æ¸¬è©¦éŒ¯èª¤è™•ç†

# æ•ˆèƒ½æ¸¬è©¦
âœ… 5 å€‹ç‰ˆæœ¬æ¸¬è©¦æ™‚é–“ < 30 ç§’
âœ… UI éŸ¿æ‡‰æµæš¢

# ä½¿ç”¨è€…é«”é©—
âœ… Loading å‹•ç•«
âœ… çµæœæ’åº
âœ… åŒ¯å‡ºåŠŸèƒ½
```

---

## ğŸ“Š é—œéµä»£ç¢¼ç‰‡æ®µ

### 1. å¾Œç«¯æ¸¬è©¦é‚è¼¯ï¼ˆæ ¸å¿ƒï¼‰
```python
def _test_single_version(self, test_case, version):
    """æ¸¬è©¦å–®ä¸€ç‰ˆæœ¬"""
    # æ ¹æ“š version.parameters é…ç½®æœå°‹ç­–ç•¥
    search_params = version.parameters
    
    # åŸ·è¡Œæœå°‹ï¼ˆè¤‡ç”¨ç¾æœ‰é‚è¼¯ï¼‰
    search_service = ProtocolGuideSearchService()
    results = search_service.search_with_vectors(
        query=test_case.question,
        **search_params
    )
    
    # è©•ä¼°çµæœï¼ˆP/R/F1ï¼‰
    evaluator = SearchResultEvaluator()
    metrics = evaluator.evaluate(
        results=results,
        expected_keywords=test_case.answer_keywords
    )
    
    # å„²å­˜åˆ°è³‡æ–™åº«
    test_run = BenchmarkTestRun.objects.create(
        test_type='vsa',
        batch_name=f"å–®æ¡ˆä¾‹æ¸¬è©¦ - {test_case.question[:30]}",
        notes=f"ç‰ˆæœ¬æ¯”è¼ƒæ¸¬è©¦",
        created_from='single_case_comparison'  # æ¨™è¨˜ä¾†æº
    )
    
    BenchmarkTestResult.objects.create(
        test_run=test_run,
        test_case=test_case,
        version=version,
        precision=metrics['precision'],
        recall=metrics['recall'],
        f1_score=metrics['f1_score']
    )
    
    return {
        'version_id': version.id,
        'version_name': version.version_name,
        'metrics': metrics,
        'status': 'success'
    }
```

### 2. å‰ç«¯çµæœè¡¨æ ¼ï¼ˆUIï¼‰
```javascript
const columns = [
  {
    title: 'F1 Score',
    dataIndex: ['metrics', 'f1_score'],
    render: (value) => (
      <Tag color={value > 0.3 ? 'green' : value > 0.15 ? 'orange' : 'red'}>
        {(value * 100).toFixed(0)}%
      </Tag>
    ),
    sorter: (a, b) => a.metrics.f1_score - b.metrics.f1_score,
    defaultSortOrder: 'descend'  // é è¨­æŒ‰ F1 é™åºæ’åˆ—
  }
];

<Table
  columns={columns}
  dataSource={results}
  rowKey="version_id"
  pagination={false}
  scroll={{ y: 400 }}
/>
```

### 3. API Serviceï¼ˆå‰ç«¯ï¼‰
```javascript
// frontend/src/services/unifiedBenchmarkApi.js

versionComparison: async (testCaseId, data = {}) => {
  return api.post(
    `/unified-benchmark/test-cases/${testCaseId}/version_comparison/`, 
    data
  );
}
```

---

## âš¡ æ•ˆèƒ½è€ƒé‡

### åŒæ­¥ vs éåŒæ­¥åŸ·è¡Œ
```
ğŸ“Œ Phase 1 å»ºè­°ï¼šåŒæ­¥åŸ·è¡Œ
åŸå› ï¼š
âœ… æ¸¬è©¦æ™‚é–“çŸ­ï¼ˆ20-30 ç§’ï¼‰
âœ… å¯¦ä½œç°¡å–®
âœ… ç”¨æˆ¶é«”é©—å¥½ï¼ˆç«‹å³çœ‹åˆ°çµæœï¼‰

æœªä¾†å‡ç´šï¼šå¦‚æœç‰ˆæœ¬æ•¸é‡ > 10ï¼Œå†è€ƒæ…®éåŒæ­¥
```

### å¿«å–ç­–ç•¥
```python
# å¯é¸ï¼šæ·»åŠ çµæœå¿«å–ï¼ˆé¿å…é‡è¤‡æ¸¬è©¦ï¼‰
cache_key = f"vsa_comparison_{test_case.id}_{version_ids_hash}"
if cache_key in cache and not force_retest:
    return cache.get(cache_key)

# åŸ·è¡Œæ¸¬è©¦...

cache.set(cache_key, result, timeout=3600)  # å¿«å– 1 å°æ™‚
```

---

## ğŸ¯ ä½¿ç”¨å ´æ™¯ç¯„ä¾‹

### å ´æ™¯ 1: ç™¼ç¾å•é¡Œè¡¨ç¾ä¸ä½³
```
å•é¡Œï¼šã€ŒULINK æ¸¬è©¦çš„å®‰è£ç¨‹å¼å’Œæ¸¬è©¦è…³æœ¬æœ¬å­˜æ”¾åœ¨ NAS çš„å“ªå€‹è·¯å¾‘ï¼Ÿã€
ç•¶å‰ç‰ˆæœ¬ (V3): F1 = 18%

æ“ä½œï¼šé»æ“Šã€Œç‰ˆæœ¬æ¯”è¼ƒã€
çµæœï¼š
- V1: F1 = 33% âœ… ï¼ˆæœ€ä½³ï¼‰
- V2: F1 = 18%
- V3: F1 = 18% ï¼ˆç•¶å‰ï¼‰
- V4: F1 = 18%
- V5: F1 = 18%

çµè«–ï¼šé€™å€‹å•é¡Œåœ¨ V1ï¼ˆç´”æ®µè½æœå°‹ï¼‰è¡¨ç¾æœ€å¥½ï¼
```

### å ´æ™¯ 2: èª¿æ•´é—œéµå­—å¾Œé©—è­‰
```
å•é¡Œï¼šä¿®æ”¹äº†æŸå€‹å•é¡Œçš„ç­”æ¡ˆé—œéµå­—

æ“ä½œï¼š
1. ä¿®æ”¹é—œéµå­—
2. é»æ“Šã€Œç‰ˆæœ¬æ¯”è¼ƒã€
3. æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬çš„ P/R/F1 è®ŠåŒ–

çµæœï¼šå¿«é€Ÿé©—è­‰é—œéµå­—èª¿æ•´æ˜¯å¦æœ‰æ•ˆ
```

### å ´æ™¯ 3: æ–°å¢å•é¡Œå¾Œè©•ä¼°
```
å•é¡Œï¼šæ–°å¢äº†ä¸€å€‹æ¸¬è©¦æ¡ˆä¾‹

æ“ä½œï¼šç«‹å³é€²è¡Œç‰ˆæœ¬æ¯”è¼ƒæ¸¬è©¦

çµæœï¼š
- åˆ¤æ–·å•é¡Œå“è³ªï¼ˆæ˜¯å¦å¤ªé›£æˆ–å¤ªç°¡å–®ï¼‰
- æ‰¾å‡ºæœ€é©åˆè©²å•é¡Œçš„æœå°‹ç‰ˆæœ¬
```

---

## ğŸ“¦ äº¤ä»˜ç‰©æ¸…å–®

### ç¨‹å¼ç¢¼
- [ ] `backend/library/benchmark/single_case_version_tester.py`
- [ ] `backend/api/views/viewsets/unified_benchmark_viewsets.py` (ä¿®æ”¹)
- [ ] `frontend/src/pages/benchmark/VersionComparisonModal.jsx`
- [ ] `frontend/src/pages/benchmark/UnifiedTestCasePage.js` (ä¿®æ”¹)
- [ ] `frontend/src/services/unifiedBenchmarkApi.js` (ä¿®æ”¹)

### æ¸¬è©¦
- [ ] å–®å…ƒæ¸¬è©¦ï¼ˆå¾Œç«¯ï¼‰
- [ ] API æ¸¬è©¦ï¼ˆPostman/curlï¼‰
- [ ] E2E æ¸¬è©¦ï¼ˆå‰ç«¯ï¼‰
- [ ] æ•ˆèƒ½æ¸¬è©¦å ±å‘Š

### æ–‡æª”
- [ ] API æ–‡æª”æ›´æ–°
- [ ] ä½¿ç”¨è€…æ‰‹å†Š
- [ ] æ¶æ§‹æ–‡æª”ï¼ˆæœ¬æ–‡ä»¶ï¼‰

---

## âœ… é©—æ”¶æ¨™æº–

### åŠŸèƒ½æ€§
- [x] é»æ“ŠæŒ‰éˆ•å¾Œå½ˆå‡º Modal
- [x] è‡ªå‹•é–‹å§‹æ¸¬è©¦ 5 å€‹ç‰ˆæœ¬
- [x] é¡¯ç¤ºå³æ™‚é€²åº¦ï¼ˆ0% â†’ 100%ï¼‰
- [x] é¡¯ç¤ºçµæœè¡¨æ ¼ï¼ˆP/R/F1ï¼‰
- [x] æ”¯æ´çµæœæ’åº
- [x] æ”¯æ´åŒ¯å‡º CSV
- [x] éŒ¯èª¤è™•ç†ï¼ˆé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼‰

### æ•ˆèƒ½æ€§
- [x] 5 å€‹ç‰ˆæœ¬æ¸¬è©¦å®Œæˆæ™‚é–“ < 35 ç§’
- [x] UI éŸ¿æ‡‰æ™‚é–“ < 200ms
- [x] ä¸é˜»å¡å…¶ä»–æ“ä½œ

### æ˜“ç”¨æ€§
- [x] æŒ‰éˆ•ä½ç½®æ˜é¡¯
- [x] Loading å‹•ç•«æµæš¢
- [x] çµæœæ˜“æ–¼ç†è§£ï¼ˆé¡è‰²ç·¨ç¢¼ï¼‰
- [x] å¯é‡è¤‡æ¸¬è©¦

---

## ğŸš€ å¾ŒçºŒæ“´å±•

### Phase 2 å¯èƒ½åŠŸèƒ½
1. **æ‰¹é‡å•é¡Œæ¯”è¼ƒ**ï¼šé¸æ“‡ 2-10 å€‹å•é¡Œï¼Œä¸€æ¬¡æ¸¬è©¦
2. **ç‰ˆæœ¬é¸æ“‡å™¨**ï¼šåªæ¸¬è©¦æŒ‡å®šçš„ 2-3 å€‹ç‰ˆæœ¬
3. **æ­·å²è¨˜éŒ„**ï¼šæŸ¥çœ‹è©²å•é¡Œçš„æ­·å²æ¸¬è©¦è¨˜éŒ„
4. **è¶¨å‹¢åœ–è¡¨**ï¼šè¦–è¦ºåŒ–ç‰ˆæœ¬æ•ˆæœå·®ç•°
5. **æ™ºèƒ½æ¨è–¦**ï¼šAI æ¨è–¦æœ€ä½³ç‰ˆæœ¬

---

## ğŸ“ è¯çµ¡è³‡è¨Š

**å•é¡Œå›å ±**ï¼šæäº¤ Issue  
**åŠŸèƒ½å»ºè­°**ï¼šæäº¤ Feature Request  
**æŠ€è¡“è¨è«–**ï¼šè¯ç¹«é–‹ç™¼åœ˜éšŠ

---

**æ–‡æª”ç‰ˆæœ¬**: v1.0  
**æœ€å¾Œæ›´æ–°**: 2025-11-28  
**ç‹€æ…‹**: âœ… è¦åŠƒå®Œæˆï¼Œå¾…å¯¦ä½œ
