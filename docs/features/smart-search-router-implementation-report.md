# 智能搜尋路由器實施總結報告

**日期**：2025-11-11  
**專案**：AI Platform - Protocol Guide Smart Search Router  
**狀態**：✅ Phase 1 & 2 完成（核心邏輯 + API 整合）  
**作者**：AI Platform Team

---

## 📋 執行摘要

成功實現了 Protocol Guide 的**智能搜尋路由器**（Smart Search Router），實現兩階段搜尋降級策略，提升用戶體驗和搜尋準確度。

### 🎯 核心目標達成

1. ✅ **關鍵字檢測**：自動識別用戶是否要求完整文檔（51 個關鍵字）
2. ✅ **智能路由**：根據關鍵字自動切換搜尋模式
3. ✅ **不確定性檢測**：識別 AI 回答是否不確定（38 個關鍵字）
4. ✅ **降級機制**：不確定時自動返回參考資料
5. ✅ **API 整合**：無縫整合到現有 Protocol Guide API

---

## 🏗️ 系統架構

### 兩種搜尋模式

#### 模式 A：關鍵字優先全文搜尋
```
用戶查詢（含全文關鍵字）
    ↓
全文向量搜尋（Top 3）
    ↓
Dify AI 回答
    ↓
檢測不確定性
    ├─ 確定 → 返回 AI 回答
    └─ 不確定 → 降級模式（返回參考資料）
```

**適用場景**：
- 用戶查詢包含：完整、全文、所有步驟、詳細流程等關鍵字
- 範例：「Cup顏色完整內容是什麼？」

#### 模式 B：標準兩階段搜尋
```
用戶查詢（無全文關鍵字）
    ↓
階段 1: 段落向量搜尋（Top 5）
    ↓
Dify AI 回答
    ↓
檢測不確定性
    ├─ 確定 → 返回 AI 回答
    └─ 不確定 ↓
階段 2: 全文向量搜尋（Top 3）
    ↓
Dify AI 回答
    ↓
檢測不確定性
    ├─ 確定 → 返回 AI 回答
    └─ 不確定 → 降級模式（返回參考資料）
```

**適用場景**：
- 標準查詢，無特定全文要求
- 範例：「Cup顏色是什麼？」

---

## 📁 實施的檔案與模組

### 1. 核心檢測器

#### `library/common/query_analysis/keyword_detector.py` (170 行)
**功能**：檢測用戶查詢是否包含全文關鍵字

**關鍵組件**：
- `FULL_DOCUMENT_KEYWORDS`：51 個全文關鍵字（中英文）
- `contains_full_document_keywords()`：返回 (bool, keyword)
- 測試覆蓋率：9/9 通過

**範例關鍵字**：
```python
# 中文
完整、全部、全文、完整內容、所有步驟、詳細流程...

# 英文
full, complete, entire, all steps, detailed...
```

#### `library/common/ai_response/uncertainty_detector.py` (220 行)
**功能**：檢測 AI 回答是否表達不確定

**關鍵組件**：
- `UNCERTAINTY_KEYWORDS`：38 個不確定關鍵字
- `is_uncertain_response()`：返回 (bool, keyword)
- `format_fallback_response()`：格式化參考資料
- 測試覆蓋率：9/9 通過

**範例不確定關鍵字**：
```python
# 中文
不清楚、不知道、沒有找到、抱歉、無法回答...

# 英文
I don't know, I'm not sure, no information...
```

**降級模式輸出範例**：
```
抱歉，我目前沒有足夠的資訊來完整回答您的問題。

📚 **以下是可能相關的參考資料**：

### 1. 📄 Cup 測試指南
**來源**：`protocol_guide_20`
**相似度**：86%

**內容摘要**：
Cup 測試流程包括...
```

### 2. 智能路由器

#### `library/protocol_guide/smart_search_router.py` (150 行)
**功能**：根據關鍵字路由到模式 A 或模式 B

**關鍵方法**：
- `route_search_strategy()`：決定路由策略
- `handle_smart_search()`：主入口函數
- 測試覆蓋率：9/9 路由決策通過

**路由決策日誌範例**：
```
🔍 智能路由: 用戶查詢='Cup顏色完整內容是什麼？...'
   檢測全文關鍵字: True (含: 完整)
   路由決策: mode_a (關鍵字優先全文搜尋)
```

### 3. 搜尋處理器

#### `library/protocol_guide/keyword_triggered_handler.py` (270 行)
**功能**：模式 A 處理器（關鍵字優先全文搜尋）

**流程**：
1. 執行全文向量搜尋（Top 3）
2. 請求 Dify AI
3. 檢測不確定性
4. 如不確定 → 降級模式

**配置參數**：
- `TOP_K = 3`：返回前 3 個全文文檔
- 閾值：0.5

#### `library/protocol_guide/two_tier_handler.py` (360 行)
**功能**：模式 B 處理器（兩階段搜尋）

**流程**：
1. 階段 1：段落搜尋（Top 5）→ Dify AI → 檢測不確定
2. 如不確定 → 階段 2：全文搜尋（Top 3）→ Dify AI → 檢測不確定
3. 仍不確定 → 降級模式

**配置參數**：
- `STAGE_1_TOP_K = 5`：階段 1 返回前 5 個段落
- `STAGE_2_TOP_K = 3`：階段 2 返回前 3 個全文文檔
- 閾值：0.5

### 4. 搜尋服務擴展

#### `library/protocol_guide/search_service.py` (新增 80 行)
**新增方法**：
- `section_search()`：段落向量搜尋
- `full_document_search()`：全文向量搜尋

**功能**：
- 統一的搜尋結果格式
- 支援智能路由器調用
- 向下兼容現有功能

### 5. API 整合

#### `library/protocol_guide/api_handlers.py` (新增 100 行)
**覆寫方法**：
- `handle_chat_api()`：使用智能路由器處理聊天請求

**API 回應格式**：
```json
{
  "success": true,
  "answer": "AI 回答內容...",
  "mode": "mode_a",              // 或 "mode_b"
  "stage": 1,                    // 僅模式 B
  "is_fallback": false,
  "fallback_reason": null,
  "message_id": "msg_xxx",
  "conversation_id": "conv_xxx",
  "response_time": 2.34,
  "tokens": {"prompt": 1234, "completion": 567},
  "search_results_count": 3
}
```

### 6. 配置管理

#### `library/protocol_guide/smart_search_config.py` (220 行)
**功能**：統一管理配置參數

**配置項目**：
- 模式 A：top_k, threshold
- 模式 B 階段 1：top_k, threshold
- 模式 B 階段 2：top_k, threshold
- 不確定性檢測：strict_mode, min_response_length
- Dify：timeout, verbose

**使用範例**：
```python
from library.protocol_guide.smart_search_config import get_default_config

config = get_default_config()
print(config.mode_a_top_k)  # 3
```

---

## 🧪 測試結果

### Phase 1: 核心邏輯測試
```
✅ 關鍵字檢測：9/9 通過
✅ 不確定檢測：9/9 通過
✅ 路由決策：9/9 通過
✅ 模式 A 結構：4/4 通過
✅ 模式 B 結構：5/5 通過
✅ 搜尋服務：4/4 通過
───────────────────────
總計：40/40 全部通過 ✅
```

### Phase 2: API 整合測試
```
✅ API Handler 方法：3/3 通過
✅ 智能路由器導入：通過
✅ Dify 配置獲取：通過
✅ API 請求結構：通過
✅ 回應格式驗證：通過
───────────────────────
總計：5/5 全部通過 ✅
```

### 配置類測試
```
✅ 預設配置驗證：通過
✅ 自定義配置驗證：通過
✅ 字典轉換：通過
✅ 非法配置檢測：通過
───────────────────────
總計：4/4 全部通過 ✅
```

---

## 📊 效能指標（預期）

### 搜尋準確度提升
- **模式 A**：直接全文搜尋，減少不相關段落干擾
- **模式 B**：兩階段降級，平衡效率與準確度
- **降級模式**：確保用戶始終獲得有用資訊

### 響應時間
- **單階段查詢**（模式 A）：~2-3 秒
- **兩階段查詢**（模式 B）：~4-6 秒（僅在必要時）
- **降級模式**：即時返回（無需 AI 處理）

### 用戶體驗改善
- ✅ 自動識別用戶意圖（是否要求完整文檔）
- ✅ 智能降級，避免「不知道」的尷尬
- ✅ 提供參考資料來源，方便用戶自查

---

## 🔄 執行流程示例

### 範例 1：模式 A（含全文關鍵字）

**用戶輸入**：「Cup顏色完整內容是什麼？」

**執行流程**：
```
1. 關鍵字檢測 → True (匹配: "完整內容")
2. 路由決策 → mode_a
3. 全文向量搜尋 → 找到 3 個相關文檔
4. Dify AI 處理 → 生成回答
5. 不確定性檢測 → False (回答確定)
6. 返回 AI 回答 ✅
```

### 範例 2：模式 B（無全文關鍵字，階段 1 成功）

**用戶輸入**：「Cup顏色是什麼？」

**執行流程**：
```
1. 關鍵字檢測 → False
2. 路由決策 → mode_b
3. 階段 1: 段落搜尋 → 找到 5 個相關段落
4. Dify AI 處理 → 生成回答
5. 不確定性檢測 → False (回答確定)
6. 返回 AI 回答 ✅
```

### 範例 3：模式 B（階段 1 不確定，階段 2 成功）

**用戶輸入**：「UNH-IOL 測試完整流程」

**執行流程**：
```
1. 關鍵字檢測 → True (匹配: "完整流程")
2. 路由決策 → mode_a
3. 全文向量搜尋 → 找到 2 個相關文檔（分數較低）
4. Dify AI 處理 → 「抱歉，我不太清楚...」
5. 不確定性檢測 → True (匹配: "不太清楚")
6. 進入降級模式 → 返回參考資料 ✅
```

### 範例 4：降級模式（兩階段都不確定）

**用戶輸入**：「新產品 XYZ 的測試方法」（資料庫中無此產品）

**執行流程**：
```
1. 關鍵字檢測 → False
2. 路由決策 → mode_b
3. 階段 1: 段落搜尋 → 找到 3 個低相關段落
4. Dify AI 處理 → 「抱歉，沒有找到相關資料」
5. 不確定性檢測 → True (匹配: "沒有找到")
6. 進入階段 2: 全文搜尋 → 找到 1 個文檔（分數很低）
7. Dify AI 處理 → 「我不確定這是否相關...」
8. 不確定性檢測 → True (匹配: "不確定")
9. 進入降級模式 → 返回參考資料 ✅
```

---

## 📈 下一步計劃（Phase 3 & 4）

### Phase 3: 實際測試與優化
- [ ] 使用真實查詢測試兩種模式
- [ ] 驗證 Dify AI 回應和降級邏輯
- [ ] 調整閾值和 TOP_K 參數
- [ ] 效能測試和優化

### Phase 4: 前端整合
- [ ] 前端 Response 格式適配
- [ ] 聊天介面顯示模式標籤
  - 📋 全文搜尋
  - 🔄 已自動切換
  - 📚 參考資料
- [ ] 用戶反饋收集
- [ ] UI/UX 優化

### Phase 5: 監控與迭代
- [ ] 添加搜尋日誌和分析
- [ ] A/B 測試評估效果
- [ ] 根據用戶反饋優化關鍵字
- [ ] 擴展到其他 Assistant（RVT Guide 等）

---

## 🎯 成功指標（KPI）

### 量化指標
1. **準確率提升**：目標 +15%（相比單一搜尋策略）
2. **用戶滿意度**：目標 85% 以上
3. **降級率**：< 20%（表示大多數查詢能在前期階段回答）
4. **平均響應時間**：< 5 秒

### 質化指標
1. ✅ 用戶能快速找到完整文檔
2. ✅ AI 回答更準確、更有針對性
3. ✅ 避免「不知道」的尷尬情況
4. ✅ 提供清晰的參考資料來源

---

## 📝 技術亮點

### 1. 模組化設計
- 每個組件獨立、可測試
- 易於維護和擴展
- 可複用到其他 Assistant

### 2. 智能路由
- 自動識別用戶意圖
- 無需手動切換搜尋模式
- 日誌詳細，易於調試

### 3. 降級機制
- 多層保護，確保用戶體驗
- 清晰的參考資料格式
- 避免 AI 胡說八道

### 4. 配置驅動
- 參數統一管理
- 易於調整和優化
- 支援 A/B 測試

---

## 🚀 部署建議

### 1. 灰度發布
- 先對 10% 用戶啟用
- 監控效果和問題
- 逐步擴大到全量

### 2. 監控指標
- 搜尋模式分佈（mode_a vs mode_b）
- 降級率
- 響應時間
- 用戶反饋評分

### 3. 回滾計劃
- 保留原有 API 作為備選
- 快速切換開關
- 錯誤日誌監控

---

## 📚 相關文檔

1. **架構設計**：`docs/features/two-tier-search-fallback-strategy.md`
2. **測試腳本**：
   - `library/protocol_guide/test_smart_router.py`
   - `library/protocol_guide/test_api_integration.py`
3. **配置範例**：`library/protocol_guide/smart_search_config.py`

---

## ✅ 總結

**Phase 1 & 2 已完成**：
- ✅ 核心邏輯實施完成（40/40 測試通過）
- ✅ API 整合完成（5/5 測試通過）
- ✅ 配置管理完成（4/4 測試通過）
- ✅ 文檔和註釋完整
- ✅ 代碼模組化、可擴展

**下一步**：
- 🔄 Phase 3：實際測試與優化
- 📱 Phase 4：前端 UI 整合
- 📊 Phase 5：監控與迭代

**預期效果**：
- 搜尋準確度提升 +15%
- 用戶滿意度 > 85%
- 降級率 < 20%
- 平均響應時間 < 5 秒

---

**報告完成日期**：2025-11-11  
**狀態**：✅ Phase 1 & 2 完成，待進行 Phase 3 實際測試
