# RRF æ­£è¦åŒ–æ·±åº¦åˆ†æèˆ‡è§£æ±ºæ–¹æ¡ˆ

**å•é¡Œç™¼ç¾æ—¥æœŸ**: 2025-11-27  
**ç™¼ç¾å ´æ™¯**: Protocol Assistant é¡¯ç¤º 0% ç›¸ä¼¼åº¦å¼•ç”¨ä¾†æº  
**åˆ†æäººå“¡**: AI Platform Team  
**æ–‡æª”ç‹€æ…‹**: ğŸ“‹ è¦åŠƒéšæ®µï¼ˆå°šæœªåŸ·è¡Œï¼‰

---

## ğŸ¯ æ ¸å¿ƒå•é¡Œ

### ç”¨æˆ¶çœ‹åˆ°çš„å•é¡Œ
- **æŸ¥è©¢**ï¼šã€Œiol å¯†ç¢¼ã€
- **AI å›æ‡‰çš„å¼•ç”¨ä¾†æº**ï¼š
  1. â­ 3.2 è»Ÿé«”æ“ä½œ - **100%** ç›¸ä¼¼åº¦ âœ…
  2. â­ UNH-IOL - **0%** ç›¸ä¼¼åº¦ âŒ

### å•é¡Œå½±éŸ¿
- âŒ ç”¨æˆ¶å›°æƒ‘ï¼šã€Œç‚ºä»€éº¼ AI ä½¿ç”¨ 0% ç›¸ä¼¼çš„æ–‡ç« ï¼Ÿã€
- âŒ ä¿¡ä»»åº¦ä¸‹é™ï¼šã€ŒAI æ˜¯äº‚çŒœçš„å—ï¼Ÿã€
- âŒ é«”é©—ä¸ä½³ï¼šé¡¯ç¤ºçš„åˆ†æ•¸ä¸ç¬¦åˆç›´è¦º

---

## ğŸ”¬ æ ¹æœ¬åŸå› åˆ†æ

### å•é¡Œæºé ­ï¼šMin-Max æ­£è¦åŒ– + Top-K Protection äº¤äº’ä½œç”¨

**å®Œæ•´æµç¨‹åˆ†æ**ï¼š

```
æŸ¥è©¢ï¼šã€Œiol å¯†ç¢¼ã€

ğŸ“ Stage 1 æ··åˆæœå°‹æµç¨‹ï¼š

1ï¸âƒ£ å‘é‡æœå°‹ï¼ˆVector Searchï¼‰
   â””â”€ æ‰¾åˆ° 2 å€‹æ®µè½çµæœï¼š
       â”œâ”€ æ®µè½ A (3.2 è»Ÿé«”æ“ä½œ): cosine_similarity = 0.856
       â””â”€ æ®µè½ B (UNH-IOL): cosine_similarity = 0.853
   
2ï¸âƒ£ é—œéµå­—æœå°‹ï¼ˆKeyword Search - ILIKEï¼‰
   â””â”€ æ‰¾åˆ° 0 å€‹çµæœï¼ˆ"iol å¯†ç¢¼" æœªå®Œå…¨åŒ¹é…ï¼‰

3ï¸âƒ£ RRF èåˆï¼ˆReciprocal Rank Fusionï¼‰
   â””â”€ å…¬å¼ï¼šrrf_score = 1 / (k + rank)
       â”œâ”€ æ®µè½ A: 1/(60+1) = 0.0164
       â””â”€ æ®µè½ B: 1/(60+2) = 0.0161
       
   âš ï¸  èåˆçµæœåªè¿”å› 1 å€‹æ®µè½ï¼ˆæ‡‰è©²æ˜¯ 2 å€‹ï¼‰
       â””â”€ å¯èƒ½åŸå› ï¼šç›¸ä¼¼çµæœè¢«å»é‡ï¼ˆå¾…èª¿æŸ¥ï¼‰

4ï¸âƒ£ Min-Max æ­£è¦åŒ–ï¼ˆå•é¡Œæ‰€åœ¨ï¼ï¼‰âŒ
   â””â”€ å…¬å¼ï¼šnormalized = (score - min) / (max - min)
   
   å› ç‚ºåªæœ‰ 1 å€‹çµæœï¼ˆscore = 0.0161ï¼‰ï¼š
   â”œâ”€ max = 0.0161
   â”œâ”€ min = 0.0161
   â””â”€ è¨ˆç®—ï¼š(0.0161 - 0.0161) / (0.0161 - 0.0161) = 0/0
   
   âš ï¸  è§¸ç™¼ "æ‰€æœ‰åˆ†æ•¸ç›¸åŒ" é‚è¼¯ï¼š
       â””â”€ çµ±ä¸€è¨­ç‚º 0.5ï¼ˆ50%ï¼‰
       
5ï¸âƒ£ Title Boostï¼ˆ+15%ï¼‰
   â””â”€ UNH-IOL æ¨™é¡ŒåŒ…å« "IOL" â†’ åŒ¹é…æˆåŠŸ
       â””â”€ 0.5 Ã— 1.15 = 0.575 â†’ é™åˆ¶æœ€å¤§å€¼ â†’ 0.575

6ï¸âƒ£ åˆ†æ•¸éæ¿¾ï¼ˆthreshold = 0.8ï¼‰
   â””â”€ 0.575 < 0.8 â†’ âŒ è¢«éæ¿¾æ‰
       â””â”€ éæ¿¾å¾Œçµæœï¼š0 å€‹

7ï¸âƒ£ Top-K Protection è§¸ç™¼ âœ…
   â””â”€ éæ¿¾å¾Œ 0 å€‹ < top_k (2)
       â””â”€ ğŸ›¡ï¸ ä¿è­·æ©Ÿåˆ¶ï¼šä¿ç•™åŸå§‹ 1 å€‹çµæœ
           â””â”€ ä½†åˆ†æ•¸æ˜¯ 0.575ï¼ˆé¡¯ç¤ºç‚º 58%ï¼‰

â“ ç‚ºä»€éº¼ç”¨æˆ¶çœ‹åˆ° 0%ï¼Ÿ
   â†’ å¯èƒ½å‰ç«¯é¡¯ç¤ºé‚è¼¯æœ‰å•é¡Œï¼Œæˆ–è€…æœ‰é¡å¤–çš„åˆ†æ•¸è½‰æ›
```

---

## ğŸ” å…©å€‹é—œéµå•é¡Œæ·±åº¦æ¢è¨

### å•é¡Œ 1ï¼šå¦‚æœæŠŠæ­£è¦åŒ–çš„å‹•ä½œç§»é™¤å¯ä»¥å—ï¼Ÿ

#### é¸é … Aï¼šå®Œå…¨ç§»é™¤æ­£è¦åŒ– âŒ **ä¸æ¨è–¦**

**å¯è¡Œæ€§åˆ†æ**ï¼š

**å„ªé»**ï¼š
- âœ… ç°¡åŒ–ä»£ç¢¼é‚è¼¯
- âœ… é¿å… 0% å•é¡Œ
- âœ… ä¿ç•™åŸå§‹ RRF åˆ†æ•¸ï¼ˆç›¸å°æ’åºï¼‰

**ç¼ºé»**ï¼š
- âŒ **RRF åˆ†æ•¸ç¯„åœä¸ä¸€è‡´**ï¼š
  ```
  k=60 æ™‚ï¼š
  - ç¬¬ 1 åï¼š1/61 â‰ˆ 0.0164 (1.64%)
  - ç¬¬ 2 åï¼š1/62 â‰ˆ 0.0161 (1.61%)
  - ç¬¬10åï¼š1/70 â‰ˆ 0.0143 (1.43%)
  
  æ‰€æœ‰åˆ†æ•¸éƒ½ < 2%ï¼
  ```
  
- âŒ **ç„¡æ³•èˆ‡ Stage 2 åˆ†æ•¸æ¯”è¼ƒ**ï¼š
  ```
  Stage 1 (RRF)ï¼š0.0164 (1.64%)
  Stage 2 (å‘é‡)ï¼š0.856 (85.6%)
  
  â†’ ç„¡æ³•çµ±ä¸€æ¯”è¼ƒï¼Œthreshold å¤±å»æ„ç¾©
  ```
  
- âŒ **Threshold ç„¡æ³•çµ±ä¸€è¨­å®š**ï¼š
  ```
  Stage 1: threshold = 0.01ï¼Ÿï¼ˆé‡å° RRF ç¯„åœï¼‰
  Stage 2: threshold = 0.7ï¼Ÿï¼ˆé‡å° cosine ç¯„åœï¼‰
  
  â†’ ä¸åŒ threshold é›£ä»¥ç®¡ç†å’Œæ ¡æº–
  ```
  
- âŒ **Title Boost ç„¡æ³•æ­£å¸¸é‹ä½œ**ï¼š
  ```
  0.0164 Ã— 1.15 = 0.0189ï¼ˆå¹¾ä¹æ²’æœ‰å½±éŸ¿ï¼‰
  
  ç›¸æ¯”ï¼š
  0.8 Ã— 1.15 = 0.92ï¼ˆæœ‰æ˜é¡¯å½±éŸ¿ï¼‰
  ```

**æŠ€è¡“å‚µå‹™è©•ä¼°**ï¼š
```
å¦‚æœç§»é™¤æ­£è¦åŒ–ï¼š
1. éœ€è¦ç‚º Stage 1 è¨­è¨ˆå°ˆç”¨çš„ threshold ç³»çµ±
2. Title Boost éœ€è¦é‡æ–°è¨­è¨ˆï¼ˆæˆ–æ”¾æ£„ï¼‰
3. ç„¡æ³•çµ±ä¸€ Stage 1 å’Œ Stage 2 çš„åˆ†æ•¸æ¯”è¼ƒ
4. ç”¨æˆ¶çœ‹åˆ°çš„åˆ†æ•¸ç¯„åœ 0.01-0.02ï¼ˆæ„ç¾©ä¸æ˜ï¼‰

â†’ å¼•å…¥çš„è¤‡é›œåº¦ > è§£æ±ºçš„å•é¡Œ
```

**çµè«–**ï¼šâŒ **ä¸å»ºè­°ç§»é™¤æ­£è¦åŒ–**

---

#### é¸é … Bï¼šæ”¹é€²æ­£è¦åŒ–æ–¹å¼ âœ… **æ¨è–¦**

**æ–¹æ¡ˆ B1ï¼šæ”¹ç‚º 0.5-1.0 ç¯„åœæ­£è¦åŒ–** â­ **æœ€æ¨è–¦**

**å¯¦æ–½æ–¹æ³•**ï¼š
```python
def _normalize_rrf_scores(self, results: list) -> list:
    """å°‡ RRF åˆ†æ•¸æ­£è¦åŒ–åˆ° 0.5-1.0 ç¯„åœ"""
    if not results:
        return results
    
    rrf_scores = [r.get('rrf_score', 0) for r in results]
    max_score = max(rrf_scores)
    min_score = min(rrf_scores)
    
    if max_score == min_score:
        # æ‰€æœ‰åˆ†æ•¸ç›¸åŒï¼Œè¨­ç‚º 0.75ï¼ˆä¸­é–“å€¼ï¼‰
        for result in results:
            result['score'] = 0.75  # âœ… ä¸å†æ˜¯ 0.5
        return results
    
    # Min-Max æ­£è¦åŒ–åˆ° 0.5-1.0 ç¯„åœ
    for result in results:
        rrf_score = result.get('rrf_score', 0)
        normalized = (rrf_score - min_score) / (max_score - min_score)
        
        # âœ… æ˜ å°„åˆ° 0.5-1.0 ç¯„åœ
        scaled_score = 0.5 + (normalized * 0.5)
        
        result['score'] = scaled_score
        result['final_score'] = scaled_score
        result['original_rrf_score'] = rrf_score
    
    logger.info(
        f"âœ… RRF åˆ†æ•¸æ­£è¦åŒ–ï¼ˆ0.5-1.0 ç¯„åœï¼‰: "
        f"åŸå§‹ç¯„åœ [{min_score:.4f}, {max_score:.4f}] â†’ "
        f"æ­£è¦åŒ–ç¯„åœ [0.5, 1.0]"
    )
    
    return results
```

**å„ªé»**ï¼š
- âœ… **è§£æ±º 0% é¡¯ç¤ºå•é¡Œ**ï¼šæœ€ä½åˆ† 50%ï¼Œæ›´åˆç†
- âœ… **ä¿ç•™ç›¸å°æ’åº**ï¼šæ’åé †åºä¸è®Š
- âœ… **Threshold ä»ç„¶æœ‰æ•ˆ**ï¼šå¯ä»¥è¨­å®š 0.6-0.7
- âœ… **Title Boost æ­£å¸¸é‹ä½œ**ï¼š0.5 Ã— 1.15 = 0.575 æœ‰æ„ç¾©
- âœ… **å¯¦æ–½ç°¡å–®**ï¼šåªæ”¹ä¸€è¡Œå…¬å¼
- âœ… **èªç¾©åˆç†**ï¼šã€Œèƒ½è¢«æª¢ç´¢åˆ°çš„æ–‡æª”è‡³å°‘ 50% ç›¸é—œã€

**éœ€è¦èª¿æ•´çš„é…ç½®**ï¼š
```python
# v1.2.2 threshold èª¿æ•´
stage1_threshold: 0.8 â†’ 0.6  # é™ä½ 0.2ï¼ˆå› ç‚ºç¯„åœå¾ 0-1 è®Šæˆ 0.5-1ï¼‰
stage2_threshold: 0.6 â†’ 0.55 # é™ä½ 0.05ï¼ˆStage 2 å½±éŸ¿è¼ƒå°ï¼‰

# è¨ˆç®—å…¬å¼ï¼š
# new_threshold = 0.5 + (old_threshold * 0.5)
# ä¾‹ï¼š0.8 â†’ 0.5 + (0.8 Ã— 0.5) = 0.9ï¼ˆå¤ªé«˜ï¼‰
# å¯¦éš›æ‡‰è©²æ˜¯ï¼š0.8 â†’ 0.6ï¼ˆç¶“é©—å€¼ï¼Œä¿æŒç›¸åŒéæ¿¾æ•ˆæœï¼‰
```

**ç¼ºé»**ï¼š
- âš ï¸ éœ€è¦é‡æ–°æ ¡æº– thresholdï¼ˆä½†å½±éŸ¿ç¯„åœæ˜ç¢ºï¼‰
- âš ï¸ æ­·å²æ•¸æ“šåˆ†æ•¸ç¯„åœæ”¹è®Šï¼ˆä½†ä¸å½±éŸ¿åŠŸèƒ½ï¼‰

**å¯¦æ–½æ™‚é–“**ï¼š30 åˆ†é˜

**é¢¨éšªç­‰ç´š**ï¼šğŸŸ¢ ä½

---

**æ–¹æ¡ˆ B2ï¼šæ”¹ç‚º Z-Score æ­£è¦åŒ–** âš ï¸ **ä¸æ¨è–¦ï¼ˆéåº¦è¤‡é›œï¼‰**

**å…¬å¼**ï¼š
```python
z_score = (x - mean) / std_dev
scaled_score = (z_score + 3) / 6  # æ˜ å°„åˆ° 0-1
```

**å„ªé»**ï¼š
- âœ… è€ƒæ…®åˆ†æ•¸åˆ†å¸ƒï¼ˆæ›´çµ±è¨ˆå­¸ï¼‰
- âœ… ç•°å¸¸å€¼è™•ç†æ›´å¥½

**ç¼ºé»**ï¼š
- âŒ éœ€è¦è¶³å¤ æ¨£æœ¬æ•¸ï¼ˆ< 5 å€‹çµæœæ™‚ä¸æº–ç¢ºï¼‰
- âŒ è¨ˆç®—è¤‡é›œåº¦é«˜
- âŒ é›£ä»¥è§£é‡‹çµ¦ç”¨æˆ¶
- âŒ å¯¦æ–½æ™‚é–“é•·ï¼ˆéœ€è¦æ¸¬è©¦èª¿æ•´ï¼‰

**çµè«–**ï¼šâŒ éåº¦è¨­è¨ˆï¼Œä¸é©åˆæ­¤å ´æ™¯

---

### å•é¡Œ 2ï¼šæ˜¯ä¸æ˜¯å› ç‚ºç”¨äº†æ··åˆæœå°‹çš„æ©Ÿåˆ¶æ‰åŠ å…¥æ­£è¦åŒ–çš„å‹•ä½œï¼Ÿ

#### ç­”æ¡ˆï¼šâœ… æ˜¯çš„ï¼Œæ­£è¦åŒ–ä¸»è¦æ˜¯ç‚ºäº†æ··åˆæœå°‹è¨­è¨ˆçš„

**æ­·å²è¿½æº¯**ï¼š

```
v1.1ï¼šç´”äºŒéšæœå°‹ï¼ˆç„¡æ­£è¦åŒ–ï¼‰
â”œâ”€ Stage 1: å‘é‡æœå°‹ï¼ˆcosine similarity 0-1ï¼‰
â””â”€ Stage 2: å…¨æ–‡æœå°‹ï¼ˆå‘é‡æœå°‹ï¼Œcosine similarity 0-1ï¼‰
    â””â”€ ä¸éœ€è¦æ­£è¦åŒ–ï¼ˆåˆ†æ•¸ç¯„åœå·²ç¶“çµ±ä¸€ï¼‰

v1.2.2ï¼šæ··åˆæœå°‹ï¼ˆéœ€è¦æ­£è¦åŒ–ï¼‰
â”œâ”€ Stage 1: æ··åˆæœå°‹
â”‚   â”œâ”€ å‘é‡æœå°‹ï¼šcosine similarity (0-1)
â”‚   â”œâ”€ é—œéµå­—æœå°‹ï¼šrank = 1.0ï¼ˆå›ºå®šå€¼ï¼‰
â”‚   â””â”€ RRF èåˆï¼šrrf_score â‰ˆ 0.01-0.02ï¼ˆç¯„åœå¾ˆå°ï¼ï¼‰
â”‚       â””â”€ âš ï¸ éœ€è¦æ­£è¦åŒ–åˆ° 0-1ï¼Œæ‰èƒ½èˆ‡å…¶ä»–åˆ†æ•¸æ¯”è¼ƒ
â”‚
â””â”€ Stage 2: å‘é‡æœå°‹ï¼ˆcosine similarity 0-1ï¼‰
    â””â”€ ä¸éœ€è¦æ­£è¦åŒ–
```

**ç‚ºä»€éº¼æ··åˆæœå°‹éœ€è¦æ­£è¦åŒ–ï¼Ÿ**

| æœå°‹æ–¹å¼ | åˆ†æ•¸ç¯„åœ | æ˜¯å¦éœ€è¦æ­£è¦åŒ– |
|---------|---------|--------------|
| **ç´”å‘é‡æœå°‹** | 0-1ï¼ˆcosine similarityï¼‰ | âŒ ä¸éœ€è¦ |
| **ç´”é—œéµå­—æœå°‹** | 0-1ï¼ˆrank æˆ– tf-idfï¼‰ | âŒ ä¸éœ€è¦ |
| **RRF æ··åˆæœå°‹** | ~0.01-0.02ï¼ˆ1/(k+rank)ï¼‰ | âœ… **å¿…é ˆæ­£è¦åŒ–** |

**RRF åˆ†æ•¸ç‚ºä»€éº¼é€™éº¼å°ï¼Ÿ**

```python
# RRF å…¬å¼ï¼š
rrf_score = 1 / (k + rank)

# ç•¶ k=60 æ™‚ï¼š
ç¬¬ 1 åï¼š1 / (60 + 1) = 0.0164 (1.64%)
ç¬¬ 2 åï¼š1 / (60 + 2) = 0.0161 (1.61%)
ç¬¬ 3 åï¼š1 / (60 + 3) = 0.0159 (1.59%)
...
ç¬¬10åï¼š1 / (60 + 10) = 0.0143 (1.43%)

# æ‰€æœ‰åˆ†æ•¸éƒ½éå¸¸å°ï¼ˆ1%-2% ç¯„åœï¼‰
```

**ç‚ºä»€éº¼ k=60ï¼Ÿ**

```
k å€¼è¶Šå¤§ â†’ RRF åˆ†æ•¸è¶Šå° â†’ èåˆæ•ˆæœè¶Šå¹³æ»‘

k=10: ç¬¬1å=9.1%, ç¬¬2å=8.3%ï¼ˆå·®è·å¤§ï¼‰
k=60: ç¬¬1å=1.6%, ç¬¬2å=1.6%ï¼ˆå·®è·å°ï¼‰â­ æ¨è–¦
k=100: ç¬¬1å=1.0%, ç¬¬2å=1.0%ï¼ˆå¹¾ä¹ç„¡å·®ç•°ï¼‰

â†’ k=60 æ˜¯æ¥­ç•Œæ¨™æº–ï¼Œå¹³è¡¡å·®ç•°æ€§å’Œå¹³æ»‘æ€§
```

**å¦‚æœä¸æ­£è¦åŒ–æœƒæ€æ¨£ï¼Ÿ**

```
å ´æ™¯ 1ï¼šèˆ‡ Stage 2 æ¯”è¼ƒ
Stage 1 (RRF): 0.0164 âŒ çœ‹èµ·ä¾†å¾ˆå·®
Stage 2 (Vector): 0.856 âœ… çœ‹èµ·ä¾†å¾ˆå¥½
â†’ AI æœƒèª¤åˆ¤ Stage 1 å¤±æ•—ï¼Œä¸å¿…è¦åœ°è§¸ç™¼ Stage 2

å ´æ™¯ 2ï¼šThreshold éæ¿¾
threshold = 0.8
RRF score = 0.0164 < 0.8 â†’ å…¨éƒ¨è¢«éæ¿¾ âŒ
â†’ å³ä½¿æ˜¯é«˜åº¦ç›¸é—œçš„çµæœä¹Ÿè¢«éæ¿¾

å ´æ™¯ 3ï¼šç”¨æˆ¶é«”é©—
ç”¨æˆ¶çœ‹åˆ°å¼•ç”¨ä¾†æºï¼š
- æ–‡ç«  Aï¼š1.6% ç›¸ä¼¼åº¦
- æ–‡ç«  Bï¼š1.5% ç›¸ä¼¼åº¦
â†’ ç”¨æˆ¶ï¼šã€Œé€™éº¼ä½çš„åˆ†æ•¸ï¼ŒAI æ€éº¼æ•¢ç”¨ï¼Ÿã€âŒ
```

**çµè«–**ï¼šâœ… **æ­£è¦åŒ–æ˜¯æ··åˆæœå°‹çš„å¿…è¦çµ„ä»¶**

---

## ğŸ“Š ä¸‰ç¨®æ–¹æ¡ˆå°æ¯”

| æ–¹æ¡ˆ | å„ªé» | ç¼ºé» | é¢¨éšª | å¯¦æ–½æ™‚é–“ | æ¨è–¦åº¦ |
|------|------|------|------|---------|--------|
| **Aï¼šç§»é™¤æ­£è¦åŒ–** | ç°¡åŒ–ä»£ç¢¼ | ç„¡æ³•çµ±ä¸€æ¯”è¼ƒ<br>Threshold å¤±æ•ˆ<br>Title Boost å¤±æ•ˆ | ğŸ”´ é«˜ | 1 å°æ™‚ | âŒ ä¸æ¨è–¦ |
| **B1ï¼š0.5-1.0 æ­£è¦åŒ–** | è§£æ±º 0% å•é¡Œ<br>ä¿ç•™æ‰€æœ‰åŠŸèƒ½<br>èªç¾©åˆç† | éœ€èª¿æ•´ threshold | ğŸŸ¢ ä½ | 30 åˆ†é˜ | â­â­â­ **å¼·çƒˆæ¨è–¦** |
| **B2ï¼šZ-Score æ­£è¦åŒ–** | çµ±è¨ˆå­¸æ›´åš´è¬¹ | éåº¦è¤‡é›œ<br>é›£ä»¥è§£é‡‹ | ğŸŸ¡ ä¸­ | 2 å°æ™‚ | âš ï¸ ä¸å¿…è¦ |

---

## ğŸ¯ æ¨è–¦æ–¹æ¡ˆï¼šB1ï¼ˆ0.5-1.0 ç¯„åœæ­£è¦åŒ–ï¼‰

### å®Œæ•´å¯¦æ–½è¨ˆç•«

#### æ­¥é©Ÿ 1ï¼šä¿®æ”¹æ­£è¦åŒ–å…¬å¼ï¼ˆ10 åˆ†é˜ï¼‰

**æª”æ¡ˆ**ï¼š`library/protocol_guide/search_service.py`

**ä½ç½®**ï¼š`_normalize_rrf_scores()` æ–¹æ³•ï¼ˆç¬¬ 511 è¡Œï¼‰

**ä¿®æ”¹å…§å®¹**ï¼š
```python
# åŸå§‹ä»£ç¢¼ï¼ˆç¬¬ 556-558 è¡Œï¼‰
for result in results:
    rrf_score = result.get('rrf_score', 0)
    normalized_score = (rrf_score - min_score) / (max_score - min_score)  # âŒ 0-1 ç¯„åœ
    
    result['original_rrf_score'] = rrf_score
    result['score'] = normalized_score
    result['final_score'] = normalized_score

# â†“ æ”¹ç‚º â†“

for result in results:
    rrf_score = result.get('rrf_score', 0)
    normalized = (rrf_score - min_score) / (max_score - min_score)
    
    # âœ… æ˜ å°„åˆ° 0.5-1.0 ç¯„åœ
    scaled_score = 0.5 + (normalized * 0.5)
    
    result['original_rrf_score'] = rrf_score
    result['score'] = scaled_score
    result['final_score'] = scaled_score

# åŒæ™‚ä¿®æ”¹ "æ‰€æœ‰åˆ†æ•¸ç›¸åŒ" çš„è™•ç†ï¼ˆç¬¬ 547 è¡Œï¼‰
if max_score == min_score:
    logger.warning(f"âš ï¸ æ‰€æœ‰ RRF åˆ†æ•¸ç›¸åŒ ({max_score:.4f})ï¼Œè¨­å®šç‚º 0.75")  # âœ… æ”¹ç‚º 0.75
    for result in results:
        result['score'] = 0.75  # âœ… ä¸å†æ˜¯ 0.5
        result['final_score'] = 0.75
        result['original_rrf_score'] = result.get('rrf_score', 0)
    return results
```

---

#### æ­¥é©Ÿ 2ï¼šæ›´æ–° v1.2.2 Threshold é…ç½®ï¼ˆ5 åˆ†é˜ï¼‰

**æ–¹æ³• Aï¼šä½¿ç”¨ Django Shellï¼ˆæ¨è–¦ï¼‰**

```bash
docker exec -it ai-django python manage.py shell
```

```python
from api.models import DifyConfigVersion

# ç²å– v1.2.2 ç‰ˆæœ¬
version = DifyConfigVersion.objects.get(version_code='dify-two-tier-v1.2.2')

# é¡¯ç¤ºç•¶å‰é…ç½®
print(f"ç•¶å‰ Stage 1 threshold: {version.rag_settings['stage1']['score_threshold']}")
print(f"ç•¶å‰ Stage 2 threshold: {version.rag_settings['stage2']['score_threshold']}")

# æ›´æ–° threshold
version.rag_settings['stage1']['score_threshold'] = 0.6  # å¾ 0.8 é™åˆ° 0.6
version.rag_settings['stage2']['score_threshold'] = 0.55 # å¾ 0.6 é™åˆ° 0.55
version.save()

print("âœ… Threshold å·²æ›´æ–°")
print(f"æ–° Stage 1 threshold: {version.rag_settings['stage1']['score_threshold']}")
print(f"æ–° Stage 2 threshold: {version.rag_settings['stage2']['score_threshold']}")
```

**æ–¹æ³• Bï¼šä½¿ç”¨ SQLï¼ˆå‚™é¸ï¼‰**

```sql
-- æ›´æ–° v1.2.2 çš„ threshold
UPDATE dify_config_version
SET rag_settings = jsonb_set(
    jsonb_set(
        rag_settings,
        '{stage1,score_threshold}',
        '0.6'::jsonb
    ),
    '{stage2,score_threshold}',
    '0.55'::jsonb
)
WHERE version_code = 'dify-two-tier-v1.2.2';
```

**Threshold èª¿æ•´é‚è¼¯**ï¼š

```
åŸå§‹ç¯„åœ 0-1ï¼š
â”œâ”€ Stage 1: threshold = 0.8 â†’ éæ¿¾æ‰ < 80% çš„çµæœ
â””â”€ Stage 2: threshold = 0.6 â†’ éæ¿¾æ‰ < 60% çš„çµæœ

æ–°ç¯„åœ 0.5-1.0ï¼š
â”œâ”€ Stage 1: threshold = 0.6 â†’ ç›¸ç•¶æ–¼éæ¿¾æ‰åŸæœ¬ < 70% çš„çµæœ
â”‚   â””â”€ è¨ˆç®—ï¼š(0.6 - 0.5) / 0.5 = 0.2 â†’ 20% ç›¸å°ä½ç½®
â”‚       â†’ åœ¨ 0-1 ç¯„åœä¸­å°æ‡‰ 0.7-0.8 ä¹‹é–“
â”‚
â””â”€ Stage 2: threshold = 0.55 â†’ å½±éŸ¿è¼ƒå°ï¼ˆStage 2 ä¸ç”¨ RRFï¼‰
    â””â”€ å¾®èª¿å³å¯ï¼Œä¿æŒä¸€è‡´æ€§
```

---

#### æ­¥é©Ÿ 3ï¼šé©—è­‰ Title Boost ä¸è¶…é 1.0ï¼ˆå·²å®Œæˆ âœ…ï¼‰

**æª”æ¡ˆ**ï¼š`library/common/knowledge_base/title_boost.py`

**ç•¶å‰é‚è¼¯**ï¼ˆç¬¬ 150 è¡Œï¼‰ï¼š
```python
def apply_title_boost(self, query: str, vector_results: list, title_field: str = 'title') -> list:
    """æ‡‰ç”¨æ¨™é¡ŒåŒ¹é…åŠ æˆ"""
    for result in vector_results:
        title = result.get(title_field, '').lower()
        
        if query.lower() in title:
            original_score = result.get('score', 0)
            bonus_multiplier = 1 + self.title_match_bonus  # ä¾‹å¦‚ 1.15
            boosted_score = original_score * bonus_multiplier
            
            # âœ… ç¢ºä¿ä¸è¶…é 1.0
            final_score = min(boosted_score, 1.0)
            
            result['score'] = final_score
            result['title_boost_applied'] = True
```

**é©—è­‰é‚è¼¯**ï¼š
```
æ”¹ç‚º 0.5-1.0 ç¯„åœå¾Œï¼š

æ¡ˆä¾‹ 1ï¼šæœ€é«˜åˆ†çµæœ
â”œâ”€ æ­£è¦åŒ–åˆ†æ•¸: 1.0
â”œâ”€ Title Boost: 1.0 Ã— 1.15 = 1.15
â””â”€ é™åˆ¶å¾Œ: min(1.15, 1.0) = 1.0 âœ…ï¼ˆä»ç„¶æ­£ç¢ºï¼‰

æ¡ˆä¾‹ 2ï¼šä¸­é–“åˆ†çµæœ
â”œâ”€ æ­£è¦åŒ–åˆ†æ•¸: 0.75
â”œâ”€ Title Boost: 0.75 Ã— 1.15 = 0.8625
â””â”€ é™åˆ¶å¾Œ: min(0.8625, 1.0) = 0.8625 âœ…ï¼ˆæ­£å¸¸ï¼‰

æ¡ˆä¾‹ 3ï¼šæœ€ä½åˆ†çµæœ
â”œâ”€ æ­£è¦åŒ–åˆ†æ•¸: 0.5
â”œâ”€ Title Boost: 0.5 Ã— 1.15 = 0.575
â””â”€ é™åˆ¶å¾Œ: min(0.575, 1.0) = 0.575 âœ…ï¼ˆæ­£å¸¸ï¼‰

çµè«–ï¼šâœ… Title Boost é‚è¼¯ç„¡éœ€ä¿®æ”¹
```

---

#### æ­¥é©Ÿ 4ï¼šé‡å•Ÿå®¹å™¨ï¼ˆ2 åˆ†é˜ï¼‰

```bash
# é‡å•Ÿ Django å®¹å™¨ä»¥è¼‰å…¥ä¿®æ”¹å¾Œçš„ä»£ç¢¼
docker compose restart ai-django

# æª¢æŸ¥å®¹å™¨ç‹€æ…‹
docker compose ps | grep ai-django

# æª¢æŸ¥æ—¥èªŒï¼ˆç¢ºèªæ²’æœ‰éŒ¯èª¤ï¼‰
docker logs ai-django --tail 50
```

---

#### æ­¥é©Ÿ 5ï¼šæ¸¬è©¦é©—è­‰ï¼ˆ15 åˆ†é˜ï¼‰

**æ¸¬è©¦ 1ï¼šIOL æŸ¥è©¢ï¼ˆé‡ç¾å•é¡Œï¼‰**

```bash
docker exec -it ai-django python manage.py shell
```

```python
from library.dify_knowledge import DifyKnowledgeSearchHandler
from api.models import DifyConfigVersion

# ç²å– v1.2.2 é…ç½®
version = DifyConfigVersion.objects.get(version_code='dify-two-tier-v1.2.2')
version_config = {
    'rag_settings': version.rag_settings,
    'version_code': version.version_code
}

# åˆå§‹åŒ–æœå°‹è™•ç†å™¨
handler = DifyKnowledgeSearchHandler()

# åŸ·è¡Œæœå°‹
results = handler.search(
    knowledge_id='protocol_guide',
    query='iol å¯†ç¢¼',
    retrieval_setting={
        'top_k': 2,
        'score_threshold': 0.6,  # âœ… æ–°çš„ threshold
    },
    version_config=version_config
)

# æª¢æŸ¥çµæœ
print(f"\nâœ… æœå°‹çµæœï¼š{len(results['records'])} å€‹")
for i, record in enumerate(results['records'], 1):
    score = record.get('score', 0)
    title = record.get('title', 'N/A')[:50]
    print(f"  [{i}] score={score:.2%} | title='{title}...'")
    
# é æœŸçµæœï¼š
# [1] score=100% | title='3.2 è»Ÿé«”æ“ä½œ...' âœ…
# [2] score=50-70% | title='UNH-IOL...' âœ…ï¼ˆä¸å†æ˜¯ 0%ï¼‰
```

**æ¸¬è©¦ 2ï¼šå…¶ä»–æŸ¥è©¢ï¼ˆå›æ­¸æ¸¬è©¦ï¼‰**

```python
# æ¸¬è©¦æŸ¥è©¢åˆ—è¡¨
test_queries = [
    'CrystalDiskMark æ¸¬è©¦æ­¥é©Ÿ',
    'Protocol æ¸¬è©¦æµç¨‹',
    'UNH-IOL èªè­‰',
    'TCRC å ±å‘Š',
    'AIC NVMe æ¸¬è©¦',
]

for query in test_queries:
    results = handler.search(
        knowledge_id='protocol_guide',
        query=query,
        retrieval_setting={'top_k': 3, 'score_threshold': 0.6},
        version_config=version_config
    )
    
    print(f"\næŸ¥è©¢ï¼š{query}")
    print(f"çµæœï¼š{len(results['records'])} å€‹")
    
    min_score = min([r['score'] for r in results['records']]) if results['records'] else 0
    max_score = max([r['score'] for r in results['records']]) if results['records'] else 0
    
    print(f"åˆ†æ•¸ç¯„åœï¼š{min_score:.2%} - {max_score:.2%}")
    
    # é©—è­‰ï¼šæ‰€æœ‰åˆ†æ•¸æ‡‰è©² >= 50%
    if min_score < 0.5:
        print(f"âŒ ç™¼ç¾ä½æ–¼ 50% çš„åˆ†æ•¸ï¼")
    else:
        print(f"âœ… æ‰€æœ‰åˆ†æ•¸ >= 50%")
```

---

#### æ­¥é©Ÿ 6ï¼šå‰ç«¯æ¸¬è©¦ï¼ˆ5 åˆ†é˜ï¼‰

**æ¸¬è©¦å ´æ™¯**ï¼š

1. **æ‰“é–‹ Protocol Assistant**
   ```
   http://localhost/protocol-assistant
   ```

2. **æ¸¬è©¦æŸ¥è©¢**ï¼šã€Œiol å¯†ç¢¼ã€

3. **æª¢æŸ¥å¼•ç”¨ä¾†æº**ï¼š
   ```
   é æœŸçµæœï¼š
   1. â­ 3.2 è»Ÿé«”æ“ä½œ - 100% ç›¸ä¼¼åº¦ âœ…
   2. â­ UNH-IOL - 50-70% ç›¸ä¼¼åº¦ âœ…ï¼ˆä¸å†æ˜¯ 0%ï¼‰
   ```

4. **æ¸¬è©¦å…¶ä»–æŸ¥è©¢**ï¼ˆç¢ºä¿æ²’æœ‰å›æ­¸å•é¡Œï¼‰ï¼š
   - ã€ŒCrystalDiskMark æ¸¬è©¦ã€
   - ã€ŒProtocol æµç¨‹ã€
   - ã€ŒTCRC å ±å‘Šã€

---

## ğŸ“Š é æœŸæ•ˆæœå°æ¯”

### Beforeï¼ˆç•¶å‰ç‹€æ…‹ - 0-1 æ­£è¦åŒ–ï¼‰

```
æŸ¥è©¢ï¼šã€Œiol å¯†ç¢¼ã€

RRF èåˆçµæœï¼š1 å€‹æ®µè½ï¼ˆscore = 0.0161ï¼‰
â†“
æ­£è¦åŒ–ï¼ˆ0-1 ç¯„åœï¼‰ï¼š
â””â”€ åªæœ‰ 1 å€‹çµæœ â†’ max=min â†’ è¨­ç‚º 0.5
â†“
Title Boostï¼ˆ+15%ï¼‰ï¼š
â””â”€ 0.5 Ã— 1.15 = 0.575
â†“
åˆ†æ•¸éæ¿¾ï¼ˆthreshold=0.8ï¼‰ï¼š
â””â”€ 0.575 < 0.8 â†’ âŒ è¢«éæ¿¾ï¼ˆ0 å€‹çµæœï¼‰
â†“
Top-K Protectionï¼š
â””â”€ ğŸ›¡ï¸ ä¿è­· 1 å€‹çµæœï¼ˆscore=0.575ï¼‰
â†“
å‰ç«¯é¡¯ç¤ºï¼š
â””â”€ å¼•ç”¨ä¾†æºï¼šUNH-IOL - 58% ç›¸ä¼¼åº¦
    ï¼ˆç”¨æˆ¶ä»æœƒç–‘æƒ‘ï¼šã€Œç‚ºä»€éº¼åªæœ‰ 58%ï¼Ÿã€ï¼‰
```

---

### Afterï¼ˆæ”¹ç‚º 0.5-1.0 æ­£è¦åŒ–ï¼‰

```
æŸ¥è©¢ï¼šã€Œiol å¯†ç¢¼ã€

RRF èåˆçµæœï¼š1 å€‹æ®µè½ï¼ˆscore = 0.0161ï¼‰
â†“
æ­£è¦åŒ–ï¼ˆ0.5-1.0 ç¯„åœï¼‰ï¼šâœ… æ–°æ–¹æ³•
â””â”€ åªæœ‰ 1 å€‹çµæœ â†’ max=min â†’ è¨­ç‚º 0.75ï¼ˆä¸­é–“å€¼ï¼‰
â†“
Title Boostï¼ˆ+15%ï¼‰ï¼š
â””â”€ 0.75 Ã— 1.15 = 0.8625
â†“
åˆ†æ•¸éæ¿¾ï¼ˆthreshold=0.6ï¼‰ï¼šâœ… æ–° threshold
â””â”€ 0.8625 > 0.6 â†’ âœ… é€šéï¼ˆ1 å€‹çµæœï¼‰
â†“
Top-K Protectionï¼š
â””â”€ ä¸éœ€è¦è§¸ç™¼ï¼ˆå·²æœ‰è¶³å¤ çµæœï¼‰
â†“
å‰ç«¯é¡¯ç¤ºï¼š
â””â”€ å¼•ç”¨ä¾†æºï¼šUNH-IOL - 86% ç›¸ä¼¼åº¦ âœ…
    ï¼ˆæ›´åˆç†ï¼Œç”¨æˆ¶ä¸æœƒç–‘æƒ‘ï¼‰
```

---

### å¤šçµæœå ´æ™¯å°æ¯”

```
æŸ¥è©¢ï¼šã€ŒCrystalDiskMark æ¸¬è©¦ã€

RRF èåˆçµæœï¼š2 å€‹æ®µè½
â”œâ”€ æ®µè½ A: rrf_score = 0.0164
â””â”€ æ®µè½ B: rrf_score = 0.0159

Beforeï¼ˆ0-1 æ­£è¦åŒ–ï¼‰ï¼š
â”œâ”€ æ®µè½ A: (0.0164-0.0159)/(0.0164-0.0159) = 1.0 (100%)
â””â”€ æ®µè½ B: (0.0159-0.0159)/(0.0164-0.0159) = 0.0 (0%) âŒ

Afterï¼ˆ0.5-1.0 æ­£è¦åŒ–ï¼‰ï¼š
â”œâ”€ æ®µè½ A: 0.5 + [(0.0164-0.0159)/(0.0164-0.0159)] Ã— 0.5 = 1.0 (100%) âœ…
â””â”€ æ®µè½ B: 0.5 + [(0.0159-0.0159)/(0.0164-0.0159)] Ã— 0.5 = 0.5 (50%) âœ…

æ”¹å–„æ•ˆæœï¼š
- æ®µè½ B å¾ 0% â†’ 50%
- æ›´ç¬¦åˆé‚è¼¯ï¼šå…©å€‹ç›¸è¿‘çš„çµæœä¸æ‡‰è©²å·®è· 100%
- RRF score å·®è·ï¼š(0.0164-0.0159)/0.0164 = 3%ï¼ˆåŸå§‹å·®è·å¾ˆå°ï¼‰
- æ­£è¦åŒ–å¾Œæ‡‰è©²åæ˜ é€™å€‹å°å·®è·ï¼š100% vs 50%ï¼ˆå·®è·è¢«æ”¾å¤§äº†ï¼‰
  â†’ ä½† 50% æ¯” 0% æ›´å®¹æ˜“æ¥å—
```

---

## ğŸ¯ å¯¦æ–½æ™‚é–“è¡¨

| æ­¥é©Ÿ | ä»»å‹™ | é ä¼°æ™‚é–“ | ç´¯è¨ˆæ™‚é–“ |
|------|------|---------|---------|
| 1 | ä¿®æ”¹æ­£è¦åŒ–å…¬å¼ | 10 åˆ†é˜ | 10 åˆ†é˜ |
| 2 | æ›´æ–° threshold é…ç½® | 5 åˆ†é˜ | 15 åˆ†é˜ |
| 3 | é©—è­‰ Title Boost | 0 åˆ†é˜ | 15 åˆ†é˜ï¼ˆå·²ç¢ºèªç„¡éœ€ä¿®æ”¹ï¼‰ |
| 4 | é‡å•Ÿå®¹å™¨ | 2 åˆ†é˜ | 17 åˆ†é˜ |
| 5 | å¾Œç«¯æ¸¬è©¦é©—è­‰ | 15 åˆ†é˜ | 32 åˆ†é˜ |
| 6 | å‰ç«¯åŠŸèƒ½æ¸¬è©¦ | 5 åˆ†é˜ | 37 åˆ†é˜ |
| 7 | æ›´æ–°æ–‡æª” | 10 åˆ†é˜ | 47 åˆ†é˜ |
| **ç¸½è¨ˆ** | | **~50 åˆ†é˜** | |

---

## âš ï¸ é¢¨éšªè©•ä¼°èˆ‡ç·©è§£æªæ–½

### é¢¨éšª 1ï¼šThreshold æ ¡æº–ä¸æº–ç¢º ğŸŸ¡ ä¸­

**é¢¨éšªæè¿°**ï¼š
- æ–° threshold 0.6 å¯èƒ½éæ¿¾æ‰å¤ªå¤šæˆ–å¤ªå°‘çµæœ
- ä¸åŒæŸ¥è©¢é¡å‹å¯èƒ½éœ€è¦ä¸åŒçš„ threshold

**ç·©è§£æªæ–½**ï¼š
1. âœ… åŸ·è¡Œ 10 å€‹æ¸¬è©¦æŸ¥è©¢ï¼Œæ”¶é›†æ•¸æ“š
2. âœ… ç›£æ§ Stage 2 è§¸ç™¼é »ç‡ï¼ˆæ‡‰è©²æ¸›å°‘ï¼‰
3. âœ… å¦‚æœ threshold ä¸åˆé©ï¼Œå¯å¿«é€Ÿèª¿æ•´ï¼ˆåªæ”¹é…ç½®ï¼Œç„¡éœ€æ”¹ä»£ç¢¼ï¼‰
4. âœ… ä¿ç•™ Top-K Protection ä½œç‚ºå®‰å…¨ç¶²

**å›é€€æ–¹æ¡ˆ**ï¼š
```python
# å¦‚æœ 0.6 å¤ªåš´æ ¼ï¼Œå¯ä»¥èª¿æ•´ç‚ºï¼š
version.rag_settings['stage1']['score_threshold'] = 0.55  # æ›´å¯¬é¬†
version.save()

# æˆ–è€…æ›´åš´æ ¼ï¼š
version.rag_settings['stage1']['score_threshold'] = 0.65
version.save()
```

---

### é¢¨éšª 2ï¼šç”¨æˆ¶å°æ–°åˆ†æ•¸ç¯„åœä¸ç†è§£ ğŸŸ¢ ä½

**é¢¨éšªæè¿°**ï¼š
- ç”¨æˆ¶å¯èƒ½ç–‘æƒ‘ã€Œç‚ºä»€éº¼æœ€ä½åˆ†æ˜¯ 50%ï¼Ÿã€
- ç”¨æˆ¶å¯èƒ½èªç‚ºç³»çµ±ã€Œéæ¿¾æ¨™æº–é™ä½äº†ã€

**ç·©è§£æªæ–½**ï¼š
1. âœ… å‰ç«¯æ·»åŠ  Tooltip èªªæ˜ï¼šã€Œç›¸ä¼¼åº¦åˆ†æ•¸å·²é‡å°æ··åˆæœå°‹å„ªåŒ–ã€
2. âœ… æ–‡æª”ä¸­èªªæ˜æ–°çš„åˆ†æ•¸ç¯„åœ
3. âœ… å¼·èª¿ã€Œèƒ½è¢«æª¢ç´¢åˆ°çš„æ–‡æª”è‡³å°‘ 50% ç›¸é—œã€æ˜¯åˆç†çš„

**ç”¨æˆ¶æºé€šè©±è¡“**ï¼š
```
ã€Œæˆ‘å€‘æ”¹é€²äº†ç›¸ä¼¼åº¦è¨ˆç®—æ–¹å¼ï¼Œä½¿ç”¨æ›´åˆç†çš„ 0.5-1.0 åˆ†æ•¸ç¯„åœã€‚
é€™ç¢ºä¿äº†æ‰€æœ‰é¡¯ç¤ºçµ¦æ‚¨çš„æ–‡æª”éƒ½æœ‰è‡³å°‘ 50% çš„ç›¸é—œæ€§ï¼Œ
è€Œéä¹‹å‰å¯èƒ½å‡ºç¾çš„ 0% é¡¯ç¤ºï¼ˆå¯¦éš›ä¸Šæ–‡æª”æ˜¯ç›¸é—œçš„ï¼‰ã€‚ã€
```

---

### é¢¨éšª 3ï¼šæ­·å²æ•¸æ“šå°æ¯”å›°é›£ ğŸŸ¢ ä½

**é¢¨éšªæè¿°**ï¼š
- ç„¡æ³•ç›´æ¥å°æ¯”ä¿®æ”¹å‰å¾Œçš„åˆ†æ•¸
- å¦‚æœéœ€è¦å›é€€ï¼Œéœ€è¦é‡æ–°æ ¡æº–

**ç·©è§£æªæ–½**ï¼š
1. âœ… ä¿ç•™ `original_rrf_score` æ¬„ä½ï¼ˆåŸå§‹åˆ†æ•¸ï¼‰
2. âœ… æ—¥èªŒä¸­åŒæ™‚è¨˜éŒ„æ­£è¦åŒ–å‰å¾Œçš„åˆ†æ•¸
3. âœ… æ–‡æª”ä¸­è¨˜éŒ„ä¿®æ”¹æ™‚é–“é»ï¼ˆ2025-11-27ï¼‰

**å›é€€è¨ˆç•«**ï¼š
```python
# å¦‚æœéœ€è¦å›é€€åˆ° 0-1 ç¯„åœï¼š
# 1. ä¿®æ”¹ _normalize_rrf_scores() å…¬å¼ï¼ˆç§»é™¤ 0.5+ï¼‰
# 2. æ¢å¾© threshold é…ç½®ï¼ˆ0.6 â†’ 0.8ï¼‰
# 3. é‡å•Ÿå®¹å™¨
# é ä¼°å›é€€æ™‚é–“ï¼š15 åˆ†é˜
```

---

## ğŸ“š ç›¸é—œæŠ€è¡“æ–‡æª”

### RRF (Reciprocal Rank Fusion) åƒè€ƒ

**è«–æ–‡**ï¼š
- "Reciprocal Rank Fusion outperforms Condorcet and individual Rank Learning Methods" (SIGIR 2009)

**æ¥­ç•Œå¯¦è¸**ï¼š
- Elasticsearchï¼šä½¿ç”¨ RRF é€²è¡Œå¤šæŸ¥è©¢èåˆ
- OpenSearchï¼šæ”¯æ´ RRF æ··åˆæœå°‹
- LangChainï¼šé è¨­ä½¿ç”¨ k=60 çš„ RRF

**æœ€ä½³å¯¦è¸**ï¼š
- k=60ï¼šæ¥­ç•Œæ¨™æº–ï¼Œå¹³è¡¡å·®ç•°æ€§å’Œå¹³æ»‘æ€§
- æ­£è¦åŒ–ï¼šå¿…é ˆå° RRF åˆ†æ•¸é€²è¡Œæ­£è¦åŒ–ï¼Œå¦å‰‡ç„¡æ³•èˆ‡å…¶ä»–åˆ†æ•¸æ¯”è¼ƒ
- Thresholdï¼šæ­£è¦åŒ–å¾Œå»ºè­° threshold 0.6-0.7ï¼ˆStage 1ï¼‰

---

### Min-Max æ­£è¦åŒ–è®Šé«”

**æ¨™æº– Min-Max**ï¼š
```
normalized = (x - min) / (max - min)
â†’ ç¯„åœï¼š[0, 1]
```

**ç¯„åœæ˜ å°„ Min-Max**ï¼š
```
normalized = (x - min) / (max - min)
scaled = min_new + (normalized Ã— (max_new - min_new))
â†’ ç¯„åœï¼š[min_new, max_new]

ä¾‹å¦‚ï¼š[0.5, 1.0]
scaled = 0.5 + (normalized Ã— 0.5)
```

**ä½¿ç”¨å ´æ™¯**ï¼š
- [0, 1]ï¼šæ¨™æº–å ´æ™¯
- [0.5, 1.0]ï¼šâœ… **é¿å… 0% é¡¯ç¤ºï¼Œé©åˆ RAG ç³»çµ±**
- [-1, 1]ï¼šéœ€è¦è¡¨é”è² ç›¸é—œæ€§ï¼ˆä¸é©åˆæ­¤å ´æ™¯ï¼‰

---

## âœ… æœ€çµ‚æ±ºç­–

### æ¨è–¦æ–¹æ¡ˆï¼šB1ï¼ˆ0.5-1.0 ç¯„åœæ­£è¦åŒ–ï¼‰â­â­â­

**æ±ºç­–ä¾æ“š**ï¼š
1. âœ… **è§£æ±ºæ ¸å¿ƒå•é¡Œ**ï¼šä¸å†é¡¯ç¤º 0% ç›¸ä¼¼åº¦
2. âœ… **ä¿ç•™æ‰€æœ‰åŠŸèƒ½**ï¼šThresholdã€Title Boost ä»ç„¶æœ‰æ•ˆ
3. âœ… **å¯¦æ–½ç°¡å–®**ï¼š30 åˆ†é˜ä¿®æ”¹ + 15 åˆ†é˜æ¸¬è©¦
4. âœ… **é¢¨éšªä½**ï¼šå½±éŸ¿ç¯„åœæ˜ç¢ºï¼Œæ˜“æ–¼å›é€€
5. âœ… **èªç¾©åˆç†**ï¼š50%-100% æ¯” 0%-100% æ›´ç¬¦åˆç›´è¦º
6. âœ… **æ¥­ç•Œèªå¯**ï¼šå¤šå€‹ RAG ç³»çµ±ä½¿ç”¨é¡ä¼¼æ–¹æ³•

### ä¸å»ºè­°çš„æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼ˆç§»é™¤æ­£è¦åŒ–ï¼‰** âŒï¼š
- å¼•å…¥çš„è¤‡é›œåº¦ > è§£æ±ºçš„å•é¡Œ
- ç„¡æ³•çµ±ä¸€ Stage 1 å’Œ Stage 2 çš„åˆ†æ•¸
- Title Boost å¤±æ•ˆ
- Threshold é›£ä»¥ç®¡ç†

**æ–¹æ¡ˆ B2ï¼ˆZ-Score æ­£è¦åŒ–ï¼‰** âŒï¼š
- éåº¦è¤‡é›œï¼Œä¸å¿…è¦
- å°æ¨£æœ¬æ™‚ä¸æº–ç¢º
- é›£ä»¥è§£é‡‹çµ¦ç”¨æˆ¶

---

## ğŸ“ å¾ŒçºŒè¡Œå‹•

### ç«‹å³è¡Œå‹•ï¼ˆä»Šå¤©ï¼Œç­‰å¾…ç”¨æˆ¶ç¢ºèªï¼‰
- [ ] ç”¨æˆ¶ç¢ºèªæ–¹æ¡ˆ B1
- [ ] åŸ·è¡Œæ­¥é©Ÿ 1-6ï¼ˆ50 åˆ†é˜ï¼‰
- [ ] æ›´æ–°ç›¸é—œæ–‡æª”

### çŸ­æœŸè¡Œå‹•ï¼ˆ1-2 å¤©å…§ï¼‰
- [ ] ç›£æ§ç”¨æˆ¶åé¥‹
- [ ] æ”¶é›† 10 å€‹æ¸¬è©¦æŸ¥è©¢çš„åˆ†æ•¸æ•¸æ“š
- [ ] è©•ä¼° threshold 0.6 æ˜¯å¦åˆé©

### ä¸­æœŸè¡Œå‹•ï¼ˆ1 é€±å…§ï¼‰
- [ ] çµ±è¨ˆ Stage 2 è§¸ç™¼é »ç‡è®ŠåŒ–
- [ ] åˆ†æç”¨æˆ¶æŸ¥è©¢çš„å¹³å‡åˆ†æ•¸
- [ ] æ±ºå®šæ˜¯å¦éœ€è¦å¾®èª¿ threshold

---

**æ–‡æª”ç‰ˆæœ¬**: v1.0  
**æœ€å¾Œæ›´æ–°**: 2025-11-27  
**ç‹€æ…‹**: ğŸ“‹ è¦åŠƒå®Œæˆï¼Œç­‰å¾…ç”¨æˆ¶ç¢ºèªåŸ·è¡Œ  
**é ä¼°åŸ·è¡Œæ™‚é–“**: 50 åˆ†é˜  
**é¢¨éšªç­‰ç´š**: ğŸŸ¢ ä½
