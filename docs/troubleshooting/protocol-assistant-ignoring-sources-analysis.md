# 🔍 Protocol Assistant 忽略引用來源問題分析報告

**問題日期**: 2025-11-27  
**報告人**: AI Assistant  
**問題嚴重度**: 🔴 高（影響用戶體驗）

---

## 📋 問題描述

### 用戶反饋
用戶在 Protocol Assistant 中詢問 **"avl sop"** 時遇到以下問題：

| 項目 | 實際情況 |
|------|---------|
| **引用來源檢索** | ✅ 成功找到 Google AVL 和 ULINK |
| **引用來源顯示** | ✅ 正確顯示在 UI 中 |
| **AI 回答內容** | ❌ **沒有使用引用來源，而是用自己的知識回答** |

---

## 🔬 技術診斷結果

### 1️⃣ 後端搜尋完全正常 ✅

從 Django 日誌（2025-11-27 14:26:12）可以看到：

```log
✅ 組裝完成: Google AVL, 包含 25 個 sections, 13798 字元
✅ 組裝完成: ULINK, 包含 46 個 sections, 8142 字元
✅ Protocol Guide 搜索結果: 2 條 (stage=1)
✅ 分數過濾結果: 2 -> 2 (threshold: 0.8)
  [1] ✅通過 | score=0.9000 | title='Google AVL...'
  [2] ✅通過 | score=0.9000 | title='ULINK...'
✅ 搜索完成: 最終返回 2 條結果給 Dify
```

**結論**：後端完美運作，返回了高質量的文檔內容。

---

### 🧪 實際 API 測試（2025-11-27 14:35）

**直接呼叫 Dify API 測試結果**：

```bash
測試查詢: "avl sop"

✅ 知識庫檢索成功:
  [1] Google AVL (score: 0.9000)
  [2] ULINK (score: 0.9000)

❌ AI 實際回應:
"I'm not entirely sure what you're looking for with 'avl sop.'
Could you let me know a bit more context?
- AVL tree: Are you asking for...
- AVL (company): Do you need...
- Other: Is this related to..."
```

**關鍵發現**：
- ✅ Dify 成功檢索到 2 份高分文檔（90% 相似度）
- ❌ AI **完全忽略**這 2 份文檔的內容
- ❌ AI 反而在**猜測**用戶問的是什麼
- ❌ AI 說 "I'm not entirely sure"（明明有資料但說不確定）

**這直接證實了 Prompt 配置問題**：LLM 收到了資料但被指示不要使用。

---

### 2️⃣ Dify 成功接收資料 ✅

根據日誌和系統架構，Dify 外部知識庫 API 確實收到了：
- 2 個完整文檔（Google AVL 13798 字元, ULINK 8142 字元）
- 相似度分數：0.9000（90%）
- 完整的 SOP 操作流程內容

**結論**：Dify 成功接收到了引用來源資料。

---

### 3️⃣ 問題出在 Dify Prompt 配置 ❌

**根本原因**：Protocol Guide APP 的 System Prompt 給予 LLM **過多判斷權**

根據以下證據：
1. ✅ 知識庫成功檢索到 2 份高分文檔（Google AVL, ULINK，90% 相似度）
2. ❌ AI 完全不使用這些文檔，反而說 "I'm not entirely sure"
3. ❌ AI 開始猜測和詢問，而不是直接回答

#### ✅ 實際 Prompt 分析（已確認）

**問題指令 #2**：
```markdown
2. 若知識庫內容與問題有關，回覆內容盡量還原知識庫內容為主，
   不要加太多非知識庫提到的問題。
```

**問題指令 #3**：
```markdown
3. 若知識庫內容與問題無關，可以依自身能力還回答。
```

#### 💥 問題分析

**關鍵問題**：這兩條指令給了 LLM 一個「判斷開關」

```
LLM 的錯誤思考流程：
1. 收到查詢 "avl sop"（英文，看起來模糊）
2. 收到知識庫結果：Google AVL, ULINK（中文標題）
3. LLM 自問：「這些資料真的『與問題有關』嗎？」
4. LLM 判斷：「我不確定，可能『無關』」
5. LLM 執行：第 3 條 → 「依自身能力回答」❌
6. 結果：忽略知識庫，用自己的知識猜測
```

**根本問題**：
- ❌ Prompt 沒有明確定義什麼叫「有關」
- ❌ LLM 可以自己判斷「有關」或「無關」
- ❌ 當 LLM 不確定時，傾向判斷為「無關」（更安全）
- ❌ 沒有「強制使用知識庫」的指令

#### 💥 矛盾邏輯導致的結果

當用戶問 "avl sop" 時：

```
1. Dify 搜尋 → 返回 2 份文檔（Google AVL, ULINK）
2. LLM 閱讀 Prompt 第 8 條 → 「不能使用多份資料」
3. LLM 思考：「有 2 份資料，但我不能用多份」
4. LLM 結論：「這些資料我不能用」
5. LLM 回答：使用自己的知識回答 ❌
```

---

## 🎯 解決方案

### ✅ 修正 Prompt 第 2 條和第 3 條，新增第 12 條

#### 修正版第 2 條：強制使用知識庫原則
```markdown
2. **強制使用知識庫原則**  
   只要知識庫返回了搜尋結果（無論幾筆），你都必須優先使用這些資料回答。
   - 知識庫的搜尋結果已經過系統智能匹配，相似度高達 80-90%
   - 不要自行判斷「是否相關」，系統已經判斷過了
   - 回覆內容必須以知識庫內容為主，盡量還原原文
   - 不要加太多非知識庫提到的內容
```

#### 修正版第 3 條：知識庫無結果時的處理
```markdown
3. **知識庫無結果時的處理**  
   只有當知識庫完全沒有返回任何搜尋結果時（0 筆資料），
   才可以使用你自己的知識回答，並說明「知識庫中未找到相關資料」。
```

#### 新增第 12 條：多份資料整合原則
```markdown
12. **多份知識庫資料的整合**  
    當知識庫返回多份資料時（例如 2-3 筆）：
    - 這表示所有資料都與問題相關（系統已篩選過）
    - 請整合所有資料的內容來回答
    - 優先使用相似度最高的資料，其他資料作為補充
    - 目標：提供完整且準確的答案
```

### 🎯 修正重點

| 項目 | ❌ 原版問題 | ✅ 修正方案 |
|------|-----------|-----------|
| **判斷權** | LLM 自己判斷「有關/無關」 | 系統已判斷，LLM 直接使用 |
| **使用條件** | 「若與問題有關」（模糊） | 「只要有返回結果」（明確） |
| **多份資料** | 沒有明確指引 | 新增第 12 條：整合所有資料 |
| **信任度** | LLM 可以質疑系統判斷 | 強調「系統已智能匹配，相似度 80-90%」 |

**完整修正版 Prompt**：請查看 `/docs/ai-integration/PROTOCOL_GUIDE_PROMPT_FIXED_V2.md`

---

## 🛠️ 修復步驟

### 步驟 1：更新 Dify System Prompt

1. **登入 Dify 工作室**
   ```
   URL: http://10.10.172.37
   帳號: [管理員帳號]
   ```

2. **找到 Protocol Guide APP**
   - 在「工作室」中找到 `Protocol Guide` 應用
   - 點擊「編輯」進入設定頁面

3. **更新 System Prompt**
   - 找到「System Prompt」或「指令」區塊
   - 使用完整修正版 Prompt（見 `/docs/ai-integration/DIFY_PROTOCOL_GUIDE_PROMPT_FIXED.md`）
   - **重點修改第 8 條和第 9 條**

4. **儲存並發布**
   - 點擊「儲存」
   - 確認變更已生效

---

### 步驟 2：測試驗證

#### 測試案例 1：多份資料整合（重點）
```
輸入: avl sop
預期結果: 整合 Google AVL 和 ULINK 的內容回答
預期行為: AI 會說「根據知識庫資料...」並引用兩份文檔
```

#### 測試案例 2：單一資料來源
```
輸入: CrystalDiskMark 如何測試
預期結果: 使用 CrystalDiskMark 文檔內容回答
預期行為: AI 會引用 CrystalDiskMark SOP 的完整步驟
```

#### 測試案例 3：確實沒有資料
```
輸入: 如何優化量子電腦效能
預期結果: AI 說明「知識庫中未找到相關資料」後給一般性建議
預期行為: 誠實告知沒有相關資料，不編造內容
```

---

### 步驟 3：前端測試（重要）

⚠️ **必須開啟新對話進行測試**（舊對話可能有快取）

```bash
# 測試流程
1. 開啟 Protocol Assistant
2. 點擊「新對話」（清除舊的對話上下文）
3. 輸入: avl sop
4. 觀察回答內容
5. 確認 AI 有引用 Google AVL 和 ULINK 的內容
```

---

## 📊 修正前後對比

### ❌ 修正前的行為
```
User: avl sop

[外部知識庫搜尋]
✅ 找到 Google AVL (相似度 90%)
✅ 找到 ULINK (相似度 90%)

[LLM 處理]
❌ 讀取 Prompt 第 8 條：「不要引用多份資料」
❌ 判斷：「我有 2 份資料，但不能用多份」
❌ 決定：不使用知識庫資料

[AI 回答]
❌ 使用自己的知識回答（不是來自知識庫）
❌ 雖然顯示了引用來源，但內容沒有使用
```

---

### ✅ 修正後的行為
```
User: avl sop

[外部知識庫搜尋]
✅ 找到 Google AVL (相似度 90%)
✅ 找到 ULINK (相似度 90%)

[LLM 處理]
✅ 讀取 Prompt 第 8 條：「多份相關資料時，請整合回答」
✅ 判斷：「兩份資料都相關，可以整合使用」
✅ 決定：整合兩份文檔的內容

[AI 回答]
✅ 「根據知識庫資料，AVL 測試流程如下...」
✅ 整合 Google AVL 和 ULINK 的內容
✅ 提供完整且準確的答案
```

---

## 🔍 為什麼 RVT Assistant 沒有這個問題？

### RVT Assistant 的 Prompt 設計（參考）

RVT Assistant 的 System Prompt **沒有「不要引用多份資料」的限制**，因此：

1. ✅ 當搜尋返回多份資料時，LLM 可以自由整合使用
2. ✅ LLM 會根據相關性決定使用哪些資料
3. ✅ 提供的答案更完整、更準確

**建議**：Protocol Assistant 也應該遵循相同的設計原則。

---

## 🎓 Prompt 設計最佳實踐

### ✅ 好的 Prompt 指令
```markdown
✅ 「當知識庫返回多份相關資料時，請整合回答」
✅ 「優先使用最相關的資料」
✅ 「目標：提供完整且準確的答案」
✅ 「如果知識庫確實沒有資料，誠實說明」
```

### ❌ 壞的 Prompt 指令
```markdown
❌ 「不要引用多份資料」（過度限制）
❌ 「找不到就貼整段」（邏輯不清）
❌ 「只使用你非常確定的資訊」（過於謹慎）
❌ 「必須有詳細步驟才能回答」（過度嚴格）
```

---

## 📚 相關文檔

### 完整修正版 Prompt
📄 **檔案位置**：`/docs/ai-integration/DIFY_PROTOCOL_GUIDE_PROMPT_FIXED.md`

**內容包含**：
- ✅ 完整的修正版 System Prompt
- ✅ 修正前後對比表
- ✅ 3 個實際回答範例
- ✅ 使用方法和測試步驟

### 其他參考文檔
- 📄 `/docs/ai-integration/DIFY_APP_PROMPT_FIX_GUIDE.md` - Prompt 修正完整指南
- 📄 `/docs/troubleshooting/dify-recall-test-limitation.md` - Dify 召回測試限制
- 📄 `/docs/architecture/mode-b-two-tier-search-complete-flow.md` - 兩階段搜尋架構

---

## 🎯 總結

### 問題根源
✅ **Dify System Prompt 第 8 條指令邏輯矛盾**  
✅ **禁止使用多份資料 → LLM 拒絕使用知識庫**  
✅ **後端和前端都正常，問題在 Prompt 配置**

### 解決方案
✅ **修正 Prompt 第 8 條：允許整合多份相關資料**  
✅ **修正 Prompt 第 9 條：明確「確實找不到」的處理方式**  
✅ **參考 RVT Assistant 的成功經驗**

### 預期效果
✅ **AI 能正常使用外部知識庫的所有資料**  
✅ **提供完整、準確的答案**  
✅ **用戶體驗大幅改善**

---

**最後更新**: 2025-11-27 14:30  
**問題狀態**: 🔴 待修復（需更新 Dify Prompt）  
**預計修復時間**: 5 分鐘（更新 Prompt + 測試）  
**影響範圍**: Protocol Assistant 所有查詢  
**優先級**: 🔴 高（影響用戶使用體驗）

---

## ✅ 快速修復檢查清單

- [ ] 登入 Dify 工作室 (http://10.10.172.37)
- [ ] 找到 Protocol Guide APP
- [ ] 複製修正版 Prompt（從 `DIFY_PROTOCOL_GUIDE_PROMPT_FIXED.md`）
- [ ] 替換整個 System Prompt
- [ ] 儲存並發布
- [ ] 開啟新對話測試 "avl sop"
- [ ] 確認 AI 有引用 Google AVL 和 ULINK 內容
- [ ] 測試其他查詢（CrystalDiskMark, Burn in Test）
- [ ] 確認「找不到資料」的情況也正常處理

**修復完成後，請回報測試結果！** ✅
