# Protocol Assistant Dify 提示詞優化指南

## 問題描述

**症狀**：Protocol Assistant 已經成功搜尋到包含密碼資訊的文檔（UNH-IOL，相似度 83%），並返回給 Dify AI，但 AI 仍然回答「抱歉，我目前無法取得 IOL 內部的 root 密碼」。

**實際文檔內容**：
```markdown
## 3.2 執行指令
對該目錄點右鍵 → 開啟終端機 (Open to Terminal)
依序輸入以下指令：

(1) 輸入sudo su
(2) 密碼為1  ← 密碼明確在這裡！
(3) cd nvme/
```

## 根本原因分析

### ✅ 後端搜尋系統正常
- 段落搜尋（Stage 1）：成功返回 1-2 條結果（threshold=0.8）
- 文檔搜尋（Stage 2）：成功返回 3 條完整文檔（包含 UNH-IOL）
- 資料大小：17KB 的知識內容成功傳送給 Dify

### ❌ Dify AI 理解層面的問題

可能原因：

1. **提示詞過度保守**
   - Dify 工作室的系統提示詞可能包含「不要透露敏感資訊」的指示
   - AI 錯誤地將「root 密碼」歸類為敏感資訊
   - 即使文檔中明確寫出密碼，AI 仍然拒絕回答

2. **上下文理解問題**
   - AI 可能沒有正確理解「密碼為1」就是 sudo/root 密碼
   - 可能期望看到「root 密碼：xxx」這樣的明確格式
   - 對於步驟式說明的理解能力不足

3. **知識來源信任度**
   - AI 可能認為內部文檔不夠「權威」
   - 對於簡單的密碼（如「1」）持懷疑態度

## 解決方案

### 方案 1：優化 Dify 工作室的提示詞（推薦）

**目標**：讓 AI 更願意提供文檔中明確記載的資訊

#### 當前提示詞檢查項目
前往 Dify 工作室 → Protocol Guide 應用 → 提示詞設置，檢查是否包含以下限制：

❌ **可能導致問題的提示詞**：
```
- 不要提供敏感資訊
- 不要透露密碼或憑證
- 當無法確定答案時，應該說「我不知道」
```

#### ✅ 建議的提示詞優化

**系統提示詞**（建議添加或修改）：
```markdown
你是 Protocol Assistant，專門協助工程師進行 Protocol 測試工作。

## 核心職責
1. 根據知識庫中的文檔，提供準確的技術資訊和操作步驟
2. 對於知識庫中明確記載的資訊（包括密碼、指令、路徑等），應該直接提供給用戶
3. 這些資訊是公司內部技術文檔，不屬於外部敏感資訊

## 回答原則
- ✅ 當知識庫中有明確答案時，應該直接提供（包括密碼、帳號等技術資訊）
- ✅ 對於操作步驟中的密碼，應該完整引用文檔內容
- ✅ 如果密碼在步驟說明中（如「(2) 密碼為1」），應該明確告知用戶
- ❌ 只有在知識庫完全沒有相關資訊時，才說「不知道」
- ❌ 不要因為資訊「看起來敏感」而拒絕提供文檔中明確記載的內容

## 特別注意
- IOL、UNH-IOL 等測試工具的密碼都記錄在操作文檔中
- 用戶詢問「密碼」時，應該檢查文檔中的操作步驟
- 如果步驟中提到「密碼為 X」，應該直接告知用戶
```

#### 🎯 針對密碼查詢的特別提示

在「變數」或「補充說明」中添加：
```markdown
## 關於密碼資訊的處理原則

用戶經常詢問測試工具的登入密碼（如 IOL、RVT 工具等）：
- 這些密碼記錄在公司內部操作文檔中
- 文檔的「執行指令」或「操作步驟」部分通常會說明
- 例如：「(2) 密碼為1」 表示密碼就是「1」
- 應該直接引用文檔內容，告訴用戶密碼

範例回答：
❌ 錯誤：「抱歉，我無法取得 IOL 的 root 密碼」
✅ 正確：「根據 UNH-IOL 操作文檔，在步驟 3.2 中說明：執行 sudo su 後，密碼為 1」
```

### 方案 2：文檔格式優化

如果提示詞優化後仍有問題，可以調整文檔格式：

#### ✅ 當前格式（較隱晦）
```markdown
## 3.2 執行指令
依序輸入以下指令：
(1) 輸入sudo su
(2) 密碼為1
(3) cd nvme/
```

#### ✅ 優化後格式（更明確）
```markdown
## 3.2 執行指令與密碼

### Root 密碼資訊
- **IOL Root 密碼**：1
- **Sudo 密碼**：1

### 執行步驟
依序輸入以下指令：
(1) 輸入sudo su
(2) 輸入密碼：1  ← IOL 系統的 root 密碼
(3) cd nvme/
```

### 方案 3：添加 FAQ 段落

在 UNH-IOL 文檔最前面添加：

```markdown
# UNH-IOL 快速參考

## 常見問題 (FAQ)

**Q: IOL 的 root 密碼是什麼？**
A: IOL 系統的 root 密碼是 `1`（數字一）

**Q: 執行 sudo su 時需要輸入什麼密碼？**
A: 密碼是 `1`（數字一）

---

（以下是原有內容）
# 1. IOL 執行檔＆文件 內部存放路徑
...
```

### 方案 4：檢查 Dify 的「回答模式」設定

在 Dify 工作室檢查：
- 回答模式：是否設定為「嚴謹模式」？→ 建議改為「平衡模式」
- 內容過濾：是否啟用了過度的安全過濾？→ 建議關閉或調整

## 驗證步驟

### 1. 提示詞優化後的測試

修改 Dify 提示詞後，測試以下查詢：

```
測試 1：「IOL 的 root 密碼是什麼？」
預期回答：「根據 UNH-IOL 操作文檔，IOL 的 root 密碼是 1」

測試 2：「執行 sudo su 需要什麼密碼？」
預期回答：「在 UNH-IOL 的操作步驟中，執行 sudo su 後需要輸入密碼 1」

測試 3：「IOL 裡面的 root 密碼」
預期回答：「根據文檔 3.2 執行指令的說明，密碼為 1」
```

### 2. 對比測試

同時測試其他 Assistant（如 RVT Assistant）是否有類似問題。

### 3. 日誌監控

```bash
# 查看 Dify 請求和回應
docker logs ai-django --tail 100 | grep -A 10 "iol.*密碼"

# 確認知識檢索結果
# 應該看到：
# ✅ 搜索返回 X 條結果
# ✅ 最終返回 X 條結果給 Dify
```

## 技術細節

### 當前系統流程（已驗證正常）

```
用戶查詢「iol root密碼」
    ↓
Protocol Assistant API (/api/protocol-guide/chat/)
    ↓
兩階段搜尋機制
    ├─ Stage 1: 段落搜尋 (auto mode, threshold=0.8)
    │   └─ ✅ 返回 1-2 個段落給 Dify
    │
    └─ Stage 2: 文檔搜尋 (document_only mode, threshold=0.8)
        └─ ✅ 返回 3 個完整文檔給 Dify（包含 UNH-IOL）
            包含完整的 17KB 知識內容
                ↓
            Dify AI 處理
                ↓
            ❌ AI 回答「抱歉，我不知道」（提示詞或理解問題）
                ↓
            降級模式觸發
                ↓
            系統顯示：「建議參考以下文件」+ 文檔列表
```

### 日誌證據

```log
# 成功檢索到知識
[INFO] 16:40:54,560 ✅ 搜索完成: 最終返回 3 條結果給 Dify
[INFO] 16:40:54,561 "POST /api/dify/knowledge/retrieval HTTP/1.0" 200 17904
                                                                    ↑
                                                            17KB 知識內容

# 但 AI 仍然不確定
[INFO] 16:40:57,689 🔍 不確定檢測: 找到關鍵字 '抱歉'
[INFO] 16:40:57,689 ⚠️ 階段 2 回答不確定 (含關鍵字: 抱歉)
[INFO] 16:40:57,689 🔄 進入降級模式
```

## 結論

**問題不在於搜尋系統**（搜尋系統工作正常），而在於 **Dify AI 的提示詞和理解能力**。

**最佳解決方案**：
1. ✅ **優先**：優化 Dify 工作室的提示詞（最快、最有效）
2. ✅ **輔助**：調整文檔格式，使資訊更明確
3. ✅ **補充**：添加 FAQ 段落，提供直接答案

**預期效果**：
- AI 能夠直接回答「IOL 的 root 密碼是 1」
- 不再需要依賴降級模式顯示文檔列表
- 用戶體驗顯著提升

---

**文檔更新日期**：2025-11-13
**問題發現者**：Admin User
**分析者**：AI Platform Team
**狀態**：待 Dify 提示詞優化
