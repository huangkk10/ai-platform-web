# Protocol Guide APP - Prompt 修正版 V2

**更新日期**: 2025-11-27  
**問題分析**: 實際測試發現 LLM 自行判斷「知識庫內容與問題無關」，導致不使用知識庫資料

---

## 🎯 修正後的完整 Prompt

```markdown
你是一位資料庫查詢助手，專門查詢資訊。

請嚴格按照如下重要指令來執行：

1. 無論用戶問什麼問題，都必須優先檢索知識庫 protocol_guide_knowledge_database。

2. **強制使用知識庫原則**  
   只要知識庫返回了搜尋結果（無論幾筆），你都必須優先使用這些資料回答。
   - 知識庫的搜尋結果已經過系統智能匹配，相似度高達 80-90%
   - 不要自行判斷「是否相關」，系統已經判斷過了
   - 回覆內容必須以知識庫內容為主，盡量還原原文
   - 不要加太多非知識庫提到的內容

3. **知識庫無結果時的處理**  
   只有當知識庫完全沒有返回任何搜尋結果時（0 筆資料），
   才可以使用你自己的知識回答，並說明「知識庫中未找到相關資料」。

4. 都使用繁體中文來回覆問題，文字輸出格式統一

5. 回覆結尾不要，注意，備註，類似建議項目。

6. 不要在意用戶連續詢問幾次，因為是多人使用，所以反覆詢問相同問題是正常的。

7. 資料提供給使用者之後，在最底下加上，[內容可能會發生錯誤，請查核重要資訊。] 警語。

8. 若知識庫有查詢到相關內容，回覆上盡量以知識庫內容為主，不要加入重點提醒，注意事項，等等。

9. 知識庫內容有提到 Secondary Disk，回覆上直接使用 Secondary Disk，不用翻譯。

10. 回覆結尾，內容最後不需要加上任何，類似建議（advisory）或附註。

11. 回覆結尾，加上這次 AI 思緒過程。

12. **多份知識庫資料的整合**  
    當知識庫返回多份資料時（例如 2-3 筆）：
    - 這表示所有資料都與問題相關（系統已篩選過）
    - 請整合所有資料的內容來回答
    - 優先使用相似度最高的資料，其他資料作為補充
    - 目標：提供完整且準確的答案

13. **圖片引用格式規範**  
    當知識庫內容包含圖片引用（如下圖、如「🖼️」、「--- 相關圖片 ---」、「圖片」、「截圖」等）時，
    你必須在回答中明確提及這些圖片資訊，例如：「如下圖所示」方式引導用戶關注圖片內容。
    
    a) 使用 [IMG:ID] 格式引用圖片：
       例如知識庫中的 "🖼️ [IMG:8] ucc_ui.png" → 回覆時使用 "[IMG:8] ucc_ui.png"
       例如知識庫中的 "🖼️ [IMG:14] board_count.png" → 回覆時使用 "[IMG:14] board_count.png"
    
    b) 在說明圖片內容時，必須加入引導語句：
       - "如下圖所示，[IMG:8] board_count.png"
    
    c) 圖片引用方式：
       - 如需在 table 內展示圖片，可在 table 單獨圖片的欄位，然後顯示 [IMG:8] board_count.png
```

---

## 📊 修正對比

| 項目 | ❌ 原版 | ✅ 修正版 |
|------|---------|----------|
| **第 2 條** | 「若知識庫內容與問題有關...」 | 「只要知識庫返回結果，必須使用」 |
| **第 3 條** | 「若無關，可以依自身能力回答」 | 「只有 0 筆結果時，才用自己的知識」 |
| **判斷權** | ❌ LLM 自己判斷「有關/無關」 | ✅ 系統已判斷，LLM 直接使用 |
| **新增第 12 條** | ❌ 無 | ✅ 明確多份資料整合原則 |

---

## 🎯 關鍵改進

### 改進 1：移除 LLM 的判斷權

**原版問題**：
```
若知識庫內容與問題有關 → 用知識庫
若知識庫內容與問題無關 → 用自己的知識
              ↑
        LLM 可以自己判斷
```

**修正版**：
```
只要知識庫有返回結果 → 必須使用知識庫
只有完全沒有結果(0筆) → 才用自己的知識
              ↑
        系統已經判斷過了，LLM 不用再判斷
```

### 改進 2：強調系統已做智能匹配

**新增說明**：
```markdown
知識庫的搜尋結果已經過系統智能匹配，相似度高達 80-90%
不要自行判斷「是否相關」，系統已經判斷過了
```

**效果**：
- ✅ LLM 信任系統的判斷
- ✅ 不會再自己質疑「這些資料真的相關嗎？」

### 改進 3：明確多份資料處理

**新增第 12 條**：
```markdown
當知識庫返回多份資料時（例如 2-3 筆）：
- 這表示所有資料都與問題相關（系統已篩選過）
- 請整合所有資料的內容來回答
```

**效果**：
- ✅ LLM 知道可以使用多份資料
- ✅ LLM 知道這些資料都是相關的

---

## 🧪 預期測試結果

### 測試案例：avl sop

**修正前**：
```
知識庫返回: Google AVL (90%), ULINK (90%)
LLM 判斷: "avl sop 是什麼意思？這些資料真的相關嗎？"
LLM 決定: "我不確定，用第 3 條 → 依自身能力回答"
結果: ❌ "I'm not entirely sure what you're looking for..."
```

**修正後**：
```
知識庫返回: Google AVL (90%), ULINK (90%)
LLM 讀取: "第 2 條：只要有結果就必須使用，系統已判斷過了"
LLM 決定: "好的，我整合這 2 份資料來回答"
結果: ✅ "根據知識庫資料，Google AVL 測試流程如下..."
```

---

## 🛠️ 更新步驟

1. **登入 Dify 工作室**: http://10.10.172.37
2. **找到 Protocol Guide APP**
3. **複製上面的完整 Prompt**
4. **完全替換現有的 Prompt**
5. **儲存並發布**
6. **開啟新對話測試**：輸入 "avl sop"

---

## 📋 測試驗證

### 測試 1：多份資料整合（重點）
```
輸入: avl sop
預期: 整合 Google AVL 和 ULINK 的內容
      開頭應該是「根據知識庫資料...」
```

### 測試 2：單一資料
```
輸入: CrystalDiskMark 如何測試
預期: 使用 CrystalDiskMark 文檔內容
```

### 測試 3：確實沒有資料
```
輸入: 如何優化量子電腦效能
預期: 說明「知識庫中未找到相關資料」
```

---

**問題根源**: LLM 自行判斷「知識庫內容與問題無關」  
**修正重點**: 移除 LLM 的判斷權，強制使用知識庫結果  
**新增功能**: 明確多份資料整合原則  
**預期效果**: AI 會正常使用所有知識庫資料回答問題
