# ğŸ” Dify äºŒéšæœå°‹ v1.1 æ¸¬è©¦æµç¨‹å®Œæ•´åˆ†æ

## ğŸ“‹ å•é¡Œèªªæ˜

**ç”¨æˆ¶ç–‘å•**ï¼š
> Dify äºŒéšæœå°‹ v1.1 é€™å€‹ç‰ˆæœ¬çš„æ¸¬è©¦ï¼Œå®ƒæœƒå»è¨­å®š Top K å—ï¼Ÿé‚„æ˜¯å…¨éƒ½ä½¿ç”¨ Dify å·¥ä½œå®¤çš„è¨­å®šï¼Œåªæ˜¯åˆ†æä¸åŸ·è¡Œï¼Ÿ

## âœ… ç­”æ¡ˆç¸½çµ

**Dify äºŒéšæœå°‹ v1.1 çš„æ¸¬è©¦åŸ·è¡Œæ–¹å¼**ï¼š

1. **å®Œå…¨ä½¿ç”¨ Dify å·¥ä½œå®¤çš„è¨­å®š** âœ…
2. **ä¸æœƒè¦†è“‹æˆ–ä¿®æ”¹ Top K** âœ…
3. **ä¸æ˜¯åªåˆ†æï¼Œè€Œæ˜¯çœŸå¯¦åŸ·è¡Œæ¸¬è©¦** âœ…
4. **è®“ Dify å®Œå…¨è‡ªä¸»è™•ç† RAG æª¢ç´¢** âœ…

---

## ğŸ¯ è©³ç´°åˆ†æ

### 1ï¸âƒ£ **ç‰ˆæœ¬é…ç½®å…§å®¹ï¼ˆè³‡æ–™åº«å¯¦éš›å€¼ï¼‰**

å¾è³‡æ–™åº«æŸ¥è©¢çµæœï¼š

```json
{
  "rag_settings": {
    "stage1": {
      "top_k": 20,
      "threshold": 0.8,
      "title_weight": 95,
      "content_weight": 5
    },
    "stage2": {
      "top_k": 10,
      "threshold": 0.8,
      "title_weight": 10,
      "content_weight": 90
    },
    "retrieval_mode": "two_stage",
    "search_service": "ProtocolGuideSearchService",
    "use_backend_search": true
  },
  "retrieval_mode": "two_stage"
}
```

**ğŸš¨ é‡è¦èªªæ˜**ï¼š
- **é€™äº›é…ç½®æ˜¯ã€Œèªªæ˜æ€§è³ªã€**ï¼Œç”¨ä¾†è¨˜éŒ„ Dify å·¥ä½œå®¤ä¸­çš„è¨­å®š
- **åœ¨æ¸¬è©¦åŸ·è¡Œæ™‚ï¼Œä¸æœƒå‚³éçµ¦ Dify API**
- **åªç”¨æ–¼è¿½è¹¤å’Œæ–‡æª”åŒ–ä¸åŒç‰ˆæœ¬çš„å·®ç•°**

---

### 2ï¸âƒ£ **å¯¦éš›æ¸¬è©¦åŸ·è¡Œæµç¨‹**

#### **æ¸¬è©¦æ¶æ§‹**ï¼š

```
æ¸¬è©¦ç³»çµ± (DifyTestRunner)
  â†“
DifyAPIClient.send_question()
  â†“
Dify Request Manager
  â†“
HTTP POST â†’ Dify Chat API (http://10.10.172.37/v1/chat-messages)
  â†“
Dify å·¥ä½œå®¤è™•ç†ï¼ˆä½¿ç”¨å·¥ä½œå®¤ä¸­çš„é…ç½®ï¼‰
  â”œâ”€ è®€å– App é…ç½® (Protocol Guide)
  â”œâ”€ åŸ·è¡Œ RAG æª¢ç´¢ï¼ˆä½¿ç”¨å·¥ä½œå®¤çš„ Top Kã€Thresholdï¼‰
  â”œâ”€ å‘¼å«å¤–éƒ¨çŸ¥è­˜åº« API
  â””â”€ LLM ç”Ÿæˆç­”æ¡ˆ
  â†“
å›å‚³ç­”æ¡ˆçµ¦æ¸¬è©¦ç³»çµ±
  â†“
KeywordEvaluator è©•åˆ†
  â†“
å„²å­˜çµæœåˆ°è³‡æ–™åº«
```

---

### 3ï¸âƒ£ **é—œéµç¨‹å¼ç¢¼åˆ†æ**

#### **DifyAPIClient çš„è«‹æ±‚ Payload**

```python
# backend/library/dify_benchmark/dify_api_client.py

def send_question(self, question: str, ...):
    # æ§‹å»ºè«‹æ±‚ payload
    payload = {
        'query': question,
        'user': user_id,
        'response_mode': 'blocking',
        'inputs': {}
    }
    
    # âš ï¸ æ³¨æ„ï¼šæ²’æœ‰å‚³éä»»ä½• retrieval_setting
    # âš ï¸ æ²’æœ‰ top_kã€score_threshold ç­‰åƒæ•¸
    # âš ï¸ å®Œå…¨äº¤çµ¦ Dify ä½¿ç”¨å·¥ä½œå®¤é…ç½®
    
    if conversation_id:
        payload['conversation_id'] = conversation_id
    
    # ç›´æ¥å‘¼å« Dify API
    response = self.request_manager.make_dify_request(
        api_url=self.api_url,
        headers=headers,
        payload=payload,
        timeout=self.timeout
    )
```

**ğŸ” é‡é»**ï¼š
- âœ… **åªå‚³é `query`ï¼ˆå•é¡Œï¼‰å’Œ `user`ï¼ˆç”¨æˆ¶ IDï¼‰**
- âŒ **ä¸å‚³é `retrieval_setting`**
- âŒ **ä¸å‚³é `top_k`ã€`score_threshold`**
- âœ… **è®“ Dify å®Œå…¨è‡ªä¸»æ±ºå®šå¦‚ä½•åŸ·è¡Œ RAG**

---

### 4ï¸âƒ£ **èˆ‡å¤–éƒ¨çŸ¥è­˜åº« API çš„å€åˆ¥**

#### **æƒ…å¢ƒ Aï¼šå¤–éƒ¨çŸ¥è­˜åº« API å‘¼å«**ï¼ˆç”± Dify ç™¼èµ·ï¼‰

```json
POST http://10.10.172.37/api/dify/knowledge/retrieval/
{
  "knowledge_id": "protocol_guide_db",
  "query": "crystaldiskmark å¦‚ä½•æ”¾æ¸¬",
  "retrieval_setting": {
    "top_k": 3,              // âœ… Dify å·¥ä½œå®¤è¨­å®šçš„å€¼
    "score_threshold": 0.5   // âœ… Dify å·¥ä½œå®¤è¨­å®šçš„å€¼
  }
}
```

**èªªæ˜**ï¼š
- é€™æ˜¯ Dify ä¸»å‹•å‘¼å«å¾Œç«¯çš„å¤–éƒ¨çŸ¥è­˜åº« API
- `top_k` å’Œ `score_threshold` ä¾†è‡ª **Dify å·¥ä½œå®¤çš„é…ç½®**
- å¾Œç«¯æ¥æ”¶é€™äº›åƒæ•¸ä¸¦åŸ·è¡Œæœå°‹

#### **æƒ…å¢ƒ Bï¼šBenchmark æ¸¬è©¦å‘¼å«**ï¼ˆæ¸¬è©¦ç³»çµ±ç™¼èµ·ï¼‰

```json
POST http://10.10.172.37/v1/chat-messages
{
  "query": "crystaldiskmark å¦‚ä½•æ”¾æ¸¬",
  "user": "benchmark_tester",
  "response_mode": "blocking"
}
```

**èªªæ˜**ï¼š
- é€™æ˜¯æ¸¬è©¦ç³»çµ±ç›´æ¥å‘¼å« Dify Chat API
- **ä¸å‚³éä»»ä½•æª¢ç´¢åƒæ•¸**
- Dify å…§éƒ¨æœƒè‡ªå‹•æ‡‰ç”¨å·¥ä½œå®¤é…ç½®
- ç„¶å¾Œ Dify è‡ªå·±å»å‘¼å«å¤–éƒ¨çŸ¥è­˜åº« APIï¼ˆå¸¶å·¥ä½œå®¤çš„åƒæ•¸ï¼‰

---

### 5ï¸âƒ£ **ç‰ˆæœ¬é…ç½®çš„å¯¦éš›ç”¨é€”**

è³‡æ–™åº«ä¸­çš„ `rag_settings` æ¬„ä½ç”¨é€”ï¼š

```python
# âœ… ç”¨æ–¼æ–‡æª”è¨˜éŒ„
description = """
ç¬¬ä¸€éšæ®µï¼šåˆ†æ®µå‘é‡æœå°‹
  â€¢ æ®µè½å‘é‡ Thresholdï¼š80%
  â€¢ æ¨™é¡Œæ¬Šé‡ï¼š95%
  â€¢ å…§å®¹æ¬Šé‡ï¼š5%
  
ç¬¬äºŒéšæ®µï¼šå…¨æ–‡å‘é‡æœå°‹
  â€¢ æ®µè½å‘é‡ Thresholdï¼š80%
  â€¢ æ¨™é¡Œæ¬Šé‡ï¼š10%
  â€¢ å…§å®¹æ¬Šé‡ï¼š90%
"""

# âœ… ç”¨æ–¼ç‰ˆæœ¬å°æ¯”
# å¯ä»¥æ¯”è¼ƒä¸åŒç‰ˆæœ¬çš„é…ç½®å·®ç•°

# âœ… ç”¨æ–¼åˆ†æå ±å‘Š
# é¡¯ç¤ºæ¸¬è©¦æ™‚ä½¿ç”¨çš„è¨­å®šï¼ˆå³ä½¿ä¸å¯¦éš›å‚³éï¼‰

# âŒ ä¸ç”¨æ–¼å¯¦éš›çš„ API å‘¼å«
# æ¸¬è©¦æ™‚ä¸æœƒå°‡é€™äº›åƒæ•¸å‚³çµ¦ Dify
```

---

## ğŸ”„ å®Œæ•´æ¸¬è©¦æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VSA æ¸¬è©¦é é¢                                             â”‚
â”‚  - é¸æ“‡ç‰ˆæœ¬ï¼šDify äºŒéšæœå°‹ v1.1                           â”‚
â”‚  - é»æ“Šã€ŒåŸ·è¡Œæ¸¬è©¦ã€                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DifyTestRunner                                           â”‚
â”‚  - è®€å–ç‰ˆæœ¬é…ç½®ï¼ˆåƒ…ç”¨æ–¼è¨˜éŒ„ï¼‰                              â”‚
â”‚  - åˆå§‹åŒ– DifyAPIClient                                   â”‚
â”‚  - æº–å‚™ 55 ç­†æ¸¬è©¦æ¡ˆä¾‹                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DifyAPIClient.send_question()                            â”‚
â”‚                                                           â”‚
â”‚  FOR EACH æ¸¬è©¦æ¡ˆä¾‹:                                        â”‚
â”‚    payload = {                                            â”‚
â”‚      "query": "ä»€éº¼æ˜¯ I3C?",   â† åªå‚³å•é¡Œ                 â”‚
â”‚      "user": "benchmark_tester",                          â”‚
â”‚      "response_mode": "blocking"                          â”‚
â”‚    }                                                      â”‚
â”‚    âš ï¸ ä¸å‚³ top_kã€threshold ç­‰åƒæ•¸                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dify Chat API (http://10.10.172.37/v1/chat-messages)    â”‚
â”‚                                                           â”‚
â”‚  1. è®€å– App é…ç½®ï¼ˆProtocol Guide / app-MgZZOhADk...ï¼‰    â”‚
â”‚  2. è®€å–å·¥ä½œå®¤ä¸­çš„ RAG è¨­å®šï¼š                              â”‚
â”‚     - Top K: 3 (æˆ– 5)         â† å·¥ä½œå®¤è¨­å®š                â”‚
â”‚     - Score Threshold: 0.5    â† å·¥ä½œå®¤è¨­å®š                â”‚
â”‚     - æª¢ç´¢æ¨¡å¼: èªç¾©æœå°‹                                   â”‚
â”‚  3. åŸ·è¡Œ RAG æª¢ç´¢                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dify å‘¼å«å¤–éƒ¨çŸ¥è­˜åº« API                                   â”‚
â”‚                                                           â”‚
â”‚  POST /api/dify/knowledge/retrieval/                      â”‚
â”‚  {                                                        â”‚
â”‚    "knowledge_id": "protocol_guide_db",                   â”‚
â”‚    "query": "ä»€éº¼æ˜¯ I3C?",                                 â”‚
â”‚    "retrieval_setting": {                                 â”‚
â”‚      "top_k": 3,              â† ä¾†è‡ªå·¥ä½œå®¤é…ç½®            â”‚
â”‚      "score_threshold": 0.5   â† ä¾†è‡ªå·¥ä½œå®¤é…ç½®            â”‚
â”‚    }                                                      â”‚
â”‚  }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾Œç«¯æœå°‹æœå‹™ (ProtocolGuideSearchService)                 â”‚
â”‚                                                           â”‚
â”‚  IF use_backend_search == true:                           â”‚
â”‚    - åŸ·è¡ŒäºŒéšæ®µæœå°‹ï¼ˆå¦‚æœç‰ˆæœ¬æ”¯æ´ï¼‰                         â”‚
â”‚    - Stage 1: åˆ†æ®µæœå°‹ï¼ˆTitle 95%, Content 5%ï¼‰           â”‚
â”‚    - Stage 2: å…¨æ–‡æœå°‹ï¼ˆTitle 10%, Content 90%ï¼‰          â”‚
â”‚  ELSE:                                                    â”‚
â”‚    - åŸ·è¡Œæ¨™æº–å‘é‡æœå°‹                                      â”‚
â”‚                                                           â”‚
â”‚  è¿”å›æœå°‹çµæœçµ¦ Dify                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dify LLM ç”Ÿæˆç­”æ¡ˆ                                        â”‚
â”‚  - ä½¿ç”¨æª¢ç´¢åˆ°çš„æ–‡æª”ä½œç‚ºä¸Šä¸‹æ–‡                              â”‚
â”‚  - ç”Ÿæˆå›ç­”                                               â”‚
â”‚  - è¿”å›çµ¦æ¸¬è©¦ç³»çµ±                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KeywordEvaluator è©•åˆ†                                    â”‚
â”‚  - æª¢æŸ¥é—œéµå­—åŒ¹é…                                          â”‚
â”‚  - è¨ˆç®—åˆ†æ•¸ = (åŒ¹é…æ•¸/ç¸½æ•¸) Ã— 100                          â”‚
â”‚  - åˆ¤æ–·æ˜¯å¦åŠæ ¼ (â‰¥60 åˆ†)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å„²å­˜æ¸¬è©¦çµæœ                                             â”‚
â”‚  - DifyTestRun (æ¸¬è©¦æ‰¹æ¬¡)                                 â”‚
â”‚  - DifyTestResult (æ¯é¡Œçµæœ)                              â”‚
â”‚  - DifyAnswerEvaluation (è©•åˆ†è©³æƒ…)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ é—œéµçµè«–

### âœ… **æ¸¬è©¦ç³»çµ±çš„è¡Œç‚º**

| é …ç›® | èªªæ˜ |
|------|------|
| **Top K è¨­å®š** | âŒ æ¸¬è©¦ç³»çµ±**ä¸è¨­å®š** Top K |
| **Threshold è¨­å®š** | âŒ æ¸¬è©¦ç³»çµ±**ä¸è¨­å®š** Score Threshold |
| **ä½¿ç”¨çš„é…ç½®** | âœ… **å®Œå…¨ä½¿ç”¨ Dify å·¥ä½œå®¤çš„é…ç½®** |
| **æ˜¯å¦åŸ·è¡Œæ¸¬è©¦** | âœ… **çœŸå¯¦åŸ·è¡Œ**ï¼Œä¸æ˜¯åªåˆ†æ |
| **RAG æª¢ç´¢** | âœ… ç”± Dify è‡ªä¸»åŸ·è¡Œï¼ˆä½¿ç”¨å·¥ä½œå®¤é…ç½®ï¼‰ |
| **å¾Œç«¯æœå°‹** | âœ… å¦‚æœ `use_backend_search=true`ï¼ŒæœƒåŸ·è¡ŒäºŒéšæ®µæœå°‹ |

### ğŸ“ **ç‰ˆæœ¬é…ç½®çš„ä½œç”¨**

```python
rag_settings = {
    "stage1": {"top_k": 20, "threshold": 0.8, ...},
    "stage2": {"top_k": 10, "threshold": 0.8, ...}
}
```

**ç”¨é€”**ï¼š
1. âœ… **æ–‡æª”è¨˜éŒ„**ï¼šè¨˜éŒ„ Dify å·¥ä½œå®¤ä¸­çš„é…ç½®
2. âœ… **ç‰ˆæœ¬å°æ¯”**ï¼šæ¯”è¼ƒä¸åŒç‰ˆæœ¬çš„è¨­å®šå·®ç•°
3. âœ… **åˆ†æå ±å‘Š**ï¼šé¡¯ç¤ºæ¸¬è©¦æ™‚çš„é…ç½®èªªæ˜
4. âœ… **å¾Œç«¯æœå°‹**ï¼šå¦‚æœ `use_backend_search=true`ï¼Œç”¨æ–¼äºŒéšæ®µæœå°‹çš„æ¬Šé‡é…ç½®
5. âŒ **ä¸å‚³éçµ¦ Dify**ï¼šæ¸¬è©¦æ™‚ä¸æœƒå°‡é€™äº›åƒæ•¸å‚³çµ¦ Dify API

---

## ğŸ” é©—è­‰æ–¹æ³•

### æ–¹æ³• 1ï¼šæŸ¥çœ‹æ—¥èªŒ

```bash
# æŸ¥çœ‹æ¸¬è©¦åŸ·è¡Œæ—¥èªŒ
docker logs ai-django --tail 200 | grep "DifyAPIClient"

# æ‡‰è©²çœ‹åˆ°é¡ä¼¼ï¼š
# [INFO] DifyAPIClient: ç™¼é€å•é¡Œåˆ° Dify: question=ä»€éº¼æ˜¯ I3C?
# [INFO] DifyAPIClient: payload={'query': '...', 'user': '...', 'response_mode': 'blocking'}
# âš ï¸ æ²’æœ‰ top_kã€threshold ç­‰åƒæ•¸
```

### æ–¹æ³• 2ï¼šæª¢æŸ¥ç¨‹å¼ç¢¼

```python
# backend/library/dify_benchmark/dify_api_client.py ç¬¬ 98 è¡Œ

payload = {
    'query': question,
    'user': user_id,
    'response_mode': 'blocking',
    'inputs': {}
}

# âš ï¸ ç¢ºèªï¼šæ²’æœ‰ retrieval_setting
# âš ï¸ ç¢ºèªï¼šæ²’æœ‰ top_k
# âš ï¸ ç¢ºèªï¼šæ²’æœ‰ score_threshold
```

### æ–¹æ³• 3ï¼šDify å·¥ä½œå®¤æŸ¥çœ‹

1. ç™»å…¥ Dify å·¥ä½œå®¤ (http://10.10.172.37)
2. é–‹å•Ÿ Protocol Guide App
3. æª¢æŸ¥ã€ŒçŸ¥è­˜åº«ã€â†’ã€Œæª¢ç´¢è¨­å®šã€
4. é€™è£¡çš„ Top K å’Œ Threshold **å°±æ˜¯æ¸¬è©¦æ™‚å¯¦éš›ä½¿ç”¨çš„å€¼**

---

## ğŸ“Š å¯¦éš›æ¡ˆä¾‹

### æ¡ˆä¾‹ï¼šæ¸¬è©¦ "ä»€éº¼æ˜¯ I3C?"

```
1. æ¸¬è©¦ç³»çµ±ç™¼é€è«‹æ±‚ï¼š
   POST /v1/chat-messages
   {
     "query": "ä»€éº¼æ˜¯ I3C?",
     "user": "benchmark_tester"
   }

2. Dify å…§éƒ¨è™•ç†ï¼š
   - è®€å–å·¥ä½œå®¤é…ç½®ï¼šTop K = 3, Threshold = 0.5
   - å‘¼å«å¤–éƒ¨çŸ¥è­˜åº«ï¼š
     POST /api/dify/knowledge/retrieval/
     {
       "query": "ä»€éº¼æ˜¯ I3C?",
       "retrieval_setting": {
         "top_k": 3,          â† ä¾†è‡ªå·¥ä½œå®¤
         "score_threshold": 0.5  â† ä¾†è‡ªå·¥ä½œå®¤
       }
     }

3. å¾Œç«¯åŸ·è¡Œæœå°‹ï¼š
   - å¦‚æœæ˜¯äºŒéšæœå°‹ç‰ˆæœ¬ï¼ŒåŸ·è¡Œ Stage 1 + Stage 2
   - è¿”å›æœ€å¤š 3 ç­†çµæœçµ¦ Dify

4. Dify ç”Ÿæˆç­”æ¡ˆä¸¦è¿”å›

5. æ¸¬è©¦ç³»çµ±è©•åˆ†ä¸¦è¨˜éŒ„çµæœ
```

---

## ğŸ“ ç¸½çµ

**Dify äºŒéšæœå°‹ v1.1 çš„æ¸¬è©¦åŸ·è¡Œæ©Ÿåˆ¶**ï¼š

1. **æ¸¬è©¦ç³»çµ±ä¸è¨­å®šä»»ä½•æª¢ç´¢åƒæ•¸**ï¼ˆTop Kã€Thresholdï¼‰
2. **å®Œå…¨ä¿¡ä»» Dify å·¥ä½œå®¤çš„é…ç½®**
3. **è®“ Dify è‡ªä¸»æ±ºå®šå¦‚ä½•åŸ·è¡Œ RAG**
4. **çœŸå¯¦åŸ·è¡Œæ¸¬è©¦ï¼Œä¸æ˜¯æ¨¡æ“¬æˆ–åˆ†æ**
5. **ç‰ˆæœ¬é…ç½®åƒ…ç”¨æ–¼è¨˜éŒ„å’Œæ–‡æª”åŒ–**

**å¦‚æœè¦ä¿®æ”¹ Top K æˆ– Threshold**ï¼š
- âœ… **æ­£ç¢ºæ–¹å¼**ï¼šåœ¨ Dify å·¥ä½œå®¤ä¸­ä¿®æ”¹ Protocol Guide App çš„æª¢ç´¢è¨­å®š
- âŒ **éŒ¯èª¤æ–¹å¼**ï¼šä¿®æ”¹è³‡æ–™åº«ä¸­çš„ `rag_settings`ï¼ˆä¸æœƒç”Ÿæ•ˆï¼‰

---

**ğŸ“… æ›´æ–°æ—¥æœŸ**: 2025-11-25  
**ğŸ“ ç‰ˆæœ¬**: v1.0  
**âœï¸ ä½œè€…**: AI Platform Team  
**ğŸ¯ ç”¨é€”**: èªªæ˜ VSA æ¸¬è©¦ç³»çµ±çš„å¯¦éš›åŸ·è¡Œæ©Ÿåˆ¶
