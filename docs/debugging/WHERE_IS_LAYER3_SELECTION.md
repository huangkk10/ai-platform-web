# Layer 3 æ™ºèƒ½é¸æ“‡æ©Ÿåˆ¶åœ¨å“ªè£¡ï¼Ÿ

## ğŸ¯ ç›´æ¥ç­”æ¡ˆ

**Layer 3 æ™ºèƒ½é¸æ“‡æ©Ÿåˆ¶ä¸åœ¨æ‚¨çš„ç¨‹å¼ç¢¼ä¸­ï¼**

å®ƒä½æ–¼ **Dify AI å·¥ä½œå®¤å…§éƒ¨ï¼ˆé»‘ç®±ï¼‰**ï¼Œæ‚¨çš„ç¨‹å¼ç¢¼ç„¡æ³•è¨ªå•æˆ–ä¿®æ”¹é€™éƒ¨åˆ†é‚è¼¯ã€‚

---

## ğŸ“ å®Œæ•´æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‚¨çš„ç¨‹å¼ç¢¼ç¯„åœ                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Frontend (React)                                            â”‚
â”‚    â†“                                                         â”‚
â”‚  useProtocolAssistantChat.js                                 â”‚
â”‚    â†“ POST /api/protocol-guide/chat/                         â”‚
â”‚    â†“ { message: "crystaldiskmark", conversation_id }        â”‚
â”‚                                                              â”‚
â”‚  Backend (Django)                                            â”‚
â”‚    â†“                                                         â”‚
â”‚  ğŸ“ library/protocol_guide/api_handlers.py                  â”‚
â”‚    - handle_chat_api()                                       â”‚
â”‚    â†“                                                         â”‚
â”‚  ğŸ“ library/protocol_guide/smart_search_router.py           â”‚
â”‚    - route_search_strategy()                                 â”‚
â”‚    - Decision: mode_b (two-tier search)                      â”‚
â”‚    â†“                                                         â”‚
â”‚  ğŸ“ library/protocol_guide/two_tier_handler.py              â”‚
â”‚    - handle_two_tier_search()                                â”‚
â”‚    - Stage 1: _request_dify_chat()                          â”‚
â”‚    - Stage 2: _request_dify_chat() (if uncertain)           â”‚
â”‚    â†“                                                         â”‚
â”‚  ğŸ“ library/dify_integration/chat_client.py                 â”‚
â”‚    - chat(question, conversation_id, user)                   â”‚
â”‚    - æ§‹å»º payload: { query, conversation_id, inputs: {} }   â”‚
â”‚    - HTTP POST to http://10.10.172.37/v1/chat-messages      â”‚
â”‚    â†“                                                         â”‚
â”‚    â¬‡ï¸ ç™¼é€ HTTP è«‹æ±‚ â¬‡ï¸                                      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ HTTP POST
         â”‚ Payload: { "query": "crystaldiskmark", 
         â”‚            "conversation_id": "xxx",
         â”‚            "inputs": {} }
         â†“
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Dify AI å·¥ä½œå®¤å…§éƒ¨ï¼ˆé»‘ç®± - æ‚¨ç„¡æ³•æ§åˆ¶çš„éƒ¨åˆ†ï¼‰               â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                â•‘
â•‘  ğŸ”¹ æ¥æ”¶è«‹æ±‚                                                  â•‘
â•‘    - query: "crystaldiskmark"                                 â•‘
â•‘    - conversation_id: "xxx"                                   â•‘
â•‘                                                                â•‘
â•‘  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â•‘
â•‘  Layer 1: Dify å…§éƒ¨å‘é‡æœå°‹ç³»çµ± âœ…                           â•‘
â•‘  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â•‘
â•‘    Algorithm: PostgreSQL pgvector + cosine similarity         â•‘
â•‘    Knowledge Base: Protocol Guide çŸ¥è­˜åº«                      â•‘
â•‘                                                                â•‘
â•‘    åŸ·è¡Œå‘é‡æœå°‹...                                            â•‘
â•‘    Results:                                                    â•‘
â•‘      1. CrystalDiskMark 5 (90.74%)  â† æœ€é«˜åˆ†                â•‘
â•‘      2. I3C ç›¸é—œèªªæ˜ (85.32%)       â† æ¬¡é«˜åˆ†                â•‘
â•‘      3. å…¶ä»–æ–‡æª” (< 85%)                                      â•‘
â•‘                                                                â•‘
â•‘  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â•‘
â•‘  Layer 2: Threshold éæ¿¾ âš ï¸                                  â•‘
â•‘  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â•‘
â•‘    Score threshold: 0.85 (ç•¶å‰è¨­å®š)                           â•‘
â•‘                                                                â•‘
â•‘    éæ¿¾çµæœ:                                                  â•‘
â•‘      âœ… CrystalDiskMark: 90.74% > 0.85 (é€šé)                â•‘
â•‘      âœ… I3C: 85.32% > 0.85 (é€šé) â† å•é¡Œæ ¹æºï¼               â•‘
â•‘      âŒ å…¶ä»–: < 0.85 (éæ¿¾æ‰)                                â•‘
â•‘                                                                â•‘
â•‘    å€™é¸æ–‡æª”æ•¸é‡: 2 å€‹                                         â•‘
â•‘    â¬‡ï¸ å‚³éçµ¦ Layer 3                                         â•‘
â•‘                                                                â•‘
â•‘  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â•‘
â•‘  Layer 3: AI æ™ºèƒ½é¸æ“‡æ©Ÿåˆ¶ âš ï¸âš ï¸âš ï¸ (é»‘ç®±ï¼)                  â•‘
â•‘  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â•‘
â•‘                                                                â•‘
â•‘    ğŸ“Š è¼¸å…¥:                                                   â•‘
â•‘      - å€™é¸æ–‡æª”: [CrystalDiskMark (90.74%), I3C (85.32%)]   â•‘
â•‘      - å°è©±è¨˜æ†¶: conversation_id = "xxx"                      â•‘
â•‘      - æŸ¥è©¢å…§å®¹: "crystaldiskmark"                           â•‘
â•‘                                                                â•‘
â•‘    ğŸ§  å…§éƒ¨è™•ç†é‚è¼¯ï¼ˆæ‚¨çœ‹ä¸åˆ°çš„éƒ¨åˆ†ï¼‰:                        â•‘
â•‘                                                                â•‘
â•‘      1ï¸âƒ£ å°è©±è¨˜æ†¶æª¢æŸ¥:                                        â•‘
â•‘         - æª¢æŸ¥ conversation_id æ­·å²è¨˜éŒ„                      â•‘
â•‘         - è¨ˆç®—ä¸»é¡Œæ¬Šé‡ (Topic Weight)                        â•‘
â•‘         - è¨ˆç®—æ–‡æª”é¸æ“‡æ­·å² (Document Selection History)      â•‘
â•‘                                                                â•‘
â•‘      2ï¸âƒ£ å¤šæ¨£åŒ–ç­–ç•¥ (Diversity Strategy):                    â•‘
â•‘         - é¿å…é‡è¤‡å…§å®¹ (Anti-repetition)                     â•‘
â•‘         - æ™‚é–“çª—å£æ•ˆæ‡‰ (Time Window Effect)                  â•‘
â•‘         - æ–°é®®åº¦çå‹µ (Freshness Bonus)                       â•‘
â•‘                                                                â•‘
â•‘      3ï¸âƒ£ ä¸»é¡Œé€£è²«æ€§ (Topic Coherence):                       â•‘
â•‘         - ç•¶å‰å°è©±ä¸»é¡Œ (Current Topic)                        â•‘
â•‘         - ä¸»é¡Œåˆ‡æ›æª¢æ¸¬ (Topic Switch Detection)              â•‘
â•‘         - é€£è²«æ€§çå‹µ/æ‡²ç½° (Coherence Bonus/Penalty)          â•‘
â•‘                                                                â•‘
â•‘      4ï¸âƒ£ æŸ¥è©¢ç›¸é—œæ€§ (Query Relevance):                       â•‘
â•‘         - æŸ¥è©¢è©åŒ¹é… (Query Term Matching)                   â•‘
â•‘         - èªç¾©ç›¸ä¼¼åº¦ (Semantic Similarity)                   â•‘
â•‘                                                                â•‘
â•‘      5ï¸âƒ£ å‹•æ…‹æ¬Šé‡èª¿æ•´ (Dynamic Weight Adjustment):           â•‘
â•‘         - ç¶œåˆæ‰€æœ‰å› ç´                                         â•‘
â•‘         - è¨ˆç®—æœ€çµ‚åˆ†æ•¸                                        â•‘
â•‘         - é¸æ“‡æœ€é«˜åˆ†æ–‡æª”                                      â•‘
â•‘                                                                â•‘
â•‘    ğŸ’¡ æ±ºç­–ç¯„ä¾‹:                                               â•‘
â•‘                                                                â•‘
â•‘      Query #1 (æ–°å°è©±):                                       â•‘
â•‘        CrystalDiskMark: 90.74% + 0% (ç„¡è¨˜æ†¶) = 90.74%        â•‘
â•‘        I3C: 85.32% + 0% (ç„¡è¨˜æ†¶) = 85.32%                    â•‘
â•‘        âœ… é¸æ“‡: CrystalDiskMark (æœ€é«˜åˆ†)                     â•‘
â•‘                                                                â•‘
â•‘      Query #2 (15ç§’å¾Œï¼ŒåŒä¸€å°è©±):                            â•‘
â•‘        CrystalDiskMark: 90.74% - 10% (é‡è¤‡æ‡²ç½°) = 80.74%     â•‘
â•‘        I3C: 85.32% + 15% (å¤šæ¨£åŒ–çå‹µ) = 100.32%              â•‘
â•‘        âŒ é¸æ“‡: I3C (å‹•æ…‹èª¿æ•´å¾Œæœ€é«˜)                         â•‘
â•‘                                                                â•‘
â•‘      Query #3 (20ç§’å¾Œï¼ŒåŒä¸€å°è©±):                            â•‘
â•‘        CrystalDiskMark: 90.74% - 5% (æ™‚é–“çª—å£) = 85.74%      â•‘
â•‘        I3C: 85.32% + 15% (è¨˜æ†¶å¼·åŒ–) = 100.32%                â•‘
â•‘        âŒ é¸æ“‡: I3C (è¨˜æ†¶å¼·åŒ–)                               â•‘
â•‘                                                                â•‘
â•‘    ğŸ“¤ è¼¸å‡º:                                                   â•‘
â•‘      - é¸ä¸­çš„æ–‡æª”: CrystalDiskMark æˆ– I3C                    â•‘
â•‘      - metadata.retriever_resources (å¼•ç”¨ä¾†æº)                â•‘
â•‘                                                                â•‘
â•‘  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â•‘
â•‘  ğŸ¤– LLM ç”Ÿæˆå›ç­”                                             â•‘
â•‘  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â•‘
â•‘                                                                â•‘
â•‘    åŸºæ–¼é¸ä¸­çš„æ–‡æª”ç”Ÿæˆ AI å›ç­”...                             â•‘
â•‘    Result: { answer, message_id, conversation_id, metadata }  â•‘
â•‘                                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         â”‚
         â”‚ HTTP Response
         â”‚ { "answer": "...", 
         â”‚   "metadata": { "retriever_resources": [...] },
         â”‚   "conversation_id": "xxx" }
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‚¨çš„ç¨‹å¼ç¢¼ç¯„åœï¼ˆç¹¼çºŒï¼‰                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  ğŸ“ library/dify_integration/chat_client.py                 â”‚
â”‚    - æ¥æ”¶ Dify å›æ‡‰                                          â”‚
â”‚    - è§£æ JSON                                               â”‚
â”‚    - è¿”å›: { success: True, answer, metadata, ... }         â”‚
â”‚    â†“                                                         â”‚
â”‚  ğŸ“ library/protocol_guide/two_tier_handler.py              â”‚
â”‚    - æª¢æ¸¬å›ç­”æ˜¯å¦ä¸ç¢ºå®š                                      â”‚
â”‚    - å¦‚æœç¢ºå®š â†’ è¿”å›çµæœ                                     â”‚
â”‚    - å¦‚æœä¸ç¢ºå®š â†’ Stage 2 (æ·»åŠ ã€Œå®Œæ•´å…§å®¹ã€)                â”‚
â”‚    â†“                                                         â”‚
â”‚  ğŸ“ library/protocol_guide/api_handlers.py                  â”‚
â”‚    - è¿”å› JSON Response                                      â”‚
â”‚    â†“                                                         â”‚
â”‚  Frontend (React)                                            â”‚
â”‚    - é¡¯ç¤º AI å›ç­”                                            â”‚
â”‚    - é¡¯ç¤ºå¼•ç”¨ä¾†æº (metadata.retriever_resources)            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” æ‚¨çš„ç¨‹å¼ç¢¼ä¸­ã€Œæ²’æœ‰ã€é¸æ“‡é‚è¼¯

### è­‰æ“š 1: chat_client.py (Line 140-148)

```python
# library/dify_integration/chat_client.py

if response.status_code == 200:
    result = response.json()
    return {
        'success': True,
        'answer': result.get('answer', ''),        # âœ… ç›´æ¥å– Dify çš„å›ç­”
        'response_time': elapsed,
        'message_id': result.get('message_id', ''),
        'conversation_id': result.get('conversation_id', ''),
        'metadata': result.get('metadata', {}),    # âœ… ç›´æ¥å– Dify çš„ metadata
        'usage': result.get('usage', {}),
        'raw_response': result                     # âœ… åŸå§‹å›æ‡‰
    }
```

**é—œéµé»**ï¼š
- âœ… æ‚¨çš„ç¨‹å¼åªæ˜¯ã€Œæ¥æ”¶ã€Dify çš„çµæœ
- âœ… **æ²’æœ‰ä»»ä½•ç¨‹å¼ç¢¼ä¿®æ”¹æˆ–éæ¿¾ metadata.retriever_resources**
- âœ… **æ²’æœ‰ä»»ä½•ç¨‹å¼ç¢¼é‡æ–°é¸æ“‡æ–‡æª”**
- âœ… **ç›´æ¥å‚³é Dify é¸æ“‡çš„çµæœçµ¦å‰ç«¯**

---

### è­‰æ“š 2: two_tier_handler.py (Line 108-113)

```python
# library/protocol_guide/two_tier_handler.py

return {
    'answer': stage_1_answer,
    'mode': 'mode_b',
    'stage': 1,
    'is_fallback': False,
    'message_id': stage_1_response.get('message_id'),
    'conversation_id': stage_1_response.get('conversation_id', conversation_id),
    'response_time': response_time,
    'tokens': stage_1_response.get('metadata', {}).get('usage', {}),
    'metadata': stage_1_response.get('raw_response', {}).get('metadata', {}),  # âœ… ç›´æ¥å‚³é Dify çš„ metadata
}
```

**é—œéµé»**ï¼š
- âœ… `metadata` ç›´æ¥ä¾†è‡ª `stage_1_response.get('raw_response', {}).get('metadata', {})`
- âœ… **æ²’æœ‰ä»»ä½•ç¨‹å¼ç¢¼ä¿®æ”¹ metadata**
- âœ… **metadata.retriever_resources å®Œå…¨ç”± Dify æ±ºå®š**

---

### è­‰æ“š 3: api_handlers.py (è¿”å›çµ¦å‰ç«¯)

```python
# library/protocol_guide/api_handlers.py

result = router.handle_smart_search(
    user_query=message,
    conversation_id=conversation_id,
    user_id=user_id
)

# ç›´æ¥è¿”å›çµæœçµ¦å‰ç«¯
return Response({
    'success': True,
    'answer': result['answer'],          # âœ… ä¾†è‡ª Dify
    'metadata': result.get('metadata'),  # âœ… ä¾†è‡ª Difyï¼ˆæœªä¿®æ”¹ï¼‰
    # ...
})
```

---

## âŒ æ‚¨çš„ç¨‹å¼ç¢¼ä¸­ã€Œæ‰¾ä¸åˆ°ã€çš„æ±è¥¿

### æœå°‹çµæœ 1: æ–‡æª”é¸æ“‡é‚è¼¯

```bash
# æœå°‹: "select document" æˆ– "choose document"
grep -r "select.*document\|choose.*document" library/protocol_guide/
grep -r "selection.*logic" library/protocol_guide/

# çµæœ: æ‰¾ä¸åˆ°ä»»ä½•æ–‡æª”é¸æ“‡é‚è¼¯ï¼
```

### æœå°‹çµæœ 2: retriever_resources ä¿®æ”¹

```bash
# æœå°‹: ä¿®æ”¹ retriever_resources çš„ç¨‹å¼ç¢¼
grep -r "retriever_resources.*=\|retriever_resources\[" library/

# çµæœ: åªæœ‰è®€å–ï¼Œæ²’æœ‰ä¿®æ”¹ï¼
```

### æœå°‹çµæœ 3: å°è©±è¨˜æ†¶è™•ç†

```bash
# æœå°‹: å°è©±è¨˜æ†¶ç›¸é—œé‚è¼¯
grep -r "conversation.*memory\|memory.*weight\|topic.*weight" library/

# çµæœ: æ‰¾ä¸åˆ°ä»»ä½•å°è©±è¨˜æ†¶è™•ç†é‚è¼¯ï¼
```

---

## ğŸ¯ é—œéµçµè«–

### âœ… æ‚¨çš„ç¨‹å¼ç¢¼ã€Œæœ‰ã€çš„éƒ¨åˆ†

1. **ç™¼é€è«‹æ±‚åˆ° Dify**
   - ä½ç½®: `library/dify_integration/chat_client.py`
   - åŠŸèƒ½: æ§‹å»º HTTP è«‹æ±‚ï¼Œå‚³é `query` å’Œ `conversation_id`

2. **æ¥æ”¶ Dify å›æ‡‰**
   - ä½ç½®: `library/dify_integration/chat_client.py`
   - åŠŸèƒ½: è§£æ JSONï¼Œæå– `answer` å’Œ `metadata`

3. **æª¢æ¸¬ä¸ç¢ºå®šæ€§**
   - ä½ç½®: `library/protocol_guide/two_tier_handler.py`
   - åŠŸèƒ½: æª¢æŸ¥ AI å›ç­”æ˜¯å¦åŒ…å«ã€Œä¸ç¢ºå®šã€é—œéµå­—
   - è§¸ç™¼: å¦‚æœä¸ç¢ºå®š â†’ Stage 2 (æ·»åŠ ã€Œå®Œæ•´å…§å®¹ã€)

4. **å‚³éçµæœçµ¦å‰ç«¯**
   - ä½ç½®: `library/protocol_guide/api_handlers.py`
   - åŠŸèƒ½: è¿”å› JSON Response

---

### âŒ æ‚¨çš„ç¨‹å¼ç¢¼ã€Œæ²’æœ‰ã€çš„éƒ¨åˆ†

1. **Layer 1: å‘é‡æœå°‹**
   - âŒ æ‚¨çš„ç¨‹å¼ç¢¼ä¸åŸ·è¡Œå‘é‡æœå°‹
   - âœ… Dify å…§éƒ¨åŸ·è¡Œ

2. **Layer 2: Threshold éæ¿¾**
   - âŒ æ‚¨çš„ç¨‹å¼ç¢¼ä¸éæ¿¾åˆ†æ•¸
   - âœ… Dify å…§éƒ¨éæ¿¾

3. **Layer 3: AI æ™ºèƒ½é¸æ“‡**ï¼ˆæ‚¨å•çš„é€™å€‹ï¼ï¼‰
   - âŒ æ‚¨çš„ç¨‹å¼ç¢¼ä¸é¸æ“‡æ–‡æª”
   - âŒ æ‚¨çš„ç¨‹å¼ç¢¼ä¸è™•ç†å°è©±è¨˜æ†¶
   - âŒ æ‚¨çš„ç¨‹å¼ç¢¼ä¸è¨ˆç®—å‹•æ…‹æ¬Šé‡
   - âœ… **å®Œå…¨ç”± Dify AI å…§éƒ¨æ±ºå®š**

---

## ğŸ”§ æ‚¨ã€Œå”¯ä¸€èƒ½åšã€çš„äº‹

### é¸é … 1: èª¿æ•´ Dify å·¥ä½œå®¤è¨­å®šï¼ˆç„¡éœ€ç¨‹å¼ç¢¼ï¼‰

```
Dify å·¥ä½œå®¤ â†’ Protocol Guide æ‡‰ç”¨ â†’ æª¢ç´¢è¨­ç½®
â”œâ”€ Score threshold: 0.85 â†’ 0.88
â”œâ”€ Top K: 3
â”œâ”€ Rerank æ¨¡å‹: Jina Rerank v1 or v2
â””â”€ æª¢ç´¢æ¨¡å¼: æ··åˆæª¢ç´¢ or ç´”å‘é‡æª¢ç´¢
```

**æ•ˆæœ**ï¼š
- æé«˜ Threshold â†’ æ¸›å°‘å€™é¸æ–‡æª” â†’ æ¸›å°‘ Layer 3 é¸æ“‡çš„æ©Ÿæœƒ

---

### é¸é … 2: ä¿®æ”¹ç¨‹å¼ç¢¼æ””æˆªçµæœï¼ˆä¾µå…¥æ€§ï¼‰

å¦‚æœæ‚¨æƒ³ã€Œè¦†è“‹ã€Dify çš„é¸æ“‡ï¼Œéœ€è¦åœ¨ `two_tier_handler.py` ä¸­æ·»åŠ é‚è¼¯ï¼š

```python
# library/protocol_guide/two_tier_handler.py

def handle_two_tier_search(...):
    # åŸæœ‰é‚è¼¯...
    stage_1_response = self._request_dify_chat(...)
    
    # âœ… æ–°å¢ï¼šæ””æˆª Dify çš„é¸æ“‡çµæœ
    raw_metadata = stage_1_response.get('raw_response', {}).get('metadata', {})
    all_candidates = raw_metadata.get('retriever_resources', [])
    
    if all_candidates:
        # âœ… è‡ªè¨‚é¸æ“‡é‚è¼¯ï¼ˆè¦†è“‹ Dify Layer 3ï¼‰
        selected_doc = custom_select_document(all_candidates, user_query)
        
        # âœ… è¦†è“‹ metadata
        raw_metadata['retriever_resources'] = [selected_doc]
    
    return {
        'answer': stage_1_answer,
        'metadata': raw_metadata,  # âœ… ä½¿ç”¨ä¿®æ”¹å¾Œçš„ metadata
        # ...
    }

def custom_select_document(candidates, query):
    """è‡ªè¨‚é¸æ“‡é‚è¼¯ï¼ˆå–ä»£ Dify Layer 3ï¼‰"""
    # ç´”åˆ†æ•¸å„ªå…ˆï¼ˆç¢ºå®šæ€§ï¼‰
    return max(candidates, key=lambda x: x.get('score', 0))
```

**é€™å°±æ˜¯ä¹‹å‰è¦åŠƒæ–‡æª”ä¸­çš„ã€Œæ–¹æ¡ˆ C1: è‡ªè¨‚é¸æ“‡é‚è¼¯è¦†è“‹ã€ï¼**

---

## ğŸ“Š ç¸½çµè¡¨

| é …ç›® | ä½ç½® | æ‚¨èƒ½æ§åˆ¶å—ï¼Ÿ | èªªæ˜ |
|------|------|-------------|------|
| **å‰ç«¯è«‹æ±‚** | `useProtocolAssistantChat.js` | âœ… æ˜¯ | æ‚¨å¯ä»¥ä¿®æ”¹å‚³éçš„åƒæ•¸ |
| **API è·¯ç”±** | `api_handlers.py` | âœ… æ˜¯ | æ‚¨å¯ä»¥ä¿®æ”¹è·¯ç”±é‚è¼¯ |
| **æ™ºèƒ½è·¯ç”±** | `smart_search_router.py` | âœ… æ˜¯ | æ‚¨å¯ä»¥ä¿®æ”¹è·¯ç”±ç­–ç•¥ |
| **å…©éšæ®µè™•ç†** | `two_tier_handler.py` | âœ… æ˜¯ | æ‚¨å¯ä»¥ä¿®æ”¹éšæ®µé‚è¼¯ |
| **Dify è«‹æ±‚** | `chat_client.py` | âœ… æ˜¯ | æ‚¨å¯ä»¥ä¿®æ”¹è«‹æ±‚åƒæ•¸ |
| **Layer 1 (å‘é‡æœå°‹)** | Dify AI å…§éƒ¨ | âŒ å¦ | **é»‘ç®±ï¼Œç„¡æ³•è¨ªå•** |
| **Layer 2 (Threshold)** | Dify å·¥ä½œå®¤è¨­å®š | âš ï¸ éƒ¨åˆ† | åªèƒ½é€é UI ä¿®æ”¹è¨­å®š |
| **Layer 3 (æ™ºèƒ½é¸æ“‡)** | Dify AI å…§éƒ¨ | âŒ å¦ | **é»‘ç®±ï¼Œç„¡æ³•è¨ªå•** â¬…ï¸ æ‚¨å•çš„é€™å€‹ï¼ |
| **å›æ‡‰æ¥æ”¶** | `chat_client.py` | âœ… æ˜¯ | æ‚¨å¯ä»¥æ””æˆªå’Œä¿®æ”¹çµæœ |
| **çµæœè¿”å›** | `api_handlers.py` | âœ… æ˜¯ | æ‚¨å¯ä»¥ä¿®æ”¹è¿”å›æ ¼å¼ |

---

## ğŸ’¡ æœ€çµ‚ç­”æ¡ˆ

**ã€ŒLayer 3 æ™ºèƒ½é¸æ“‡æ©Ÿåˆ¶çš„ç¨‹å¼åœ¨å“ªè£¡ï¼Ÿã€**

ç­”æ¡ˆï¼š**åœ¨ Dify AI å·¥ä½œå®¤å…§éƒ¨ï¼Œæ‚¨çš„ç¨‹å¼ç¢¼ä¸­æ‰¾ä¸åˆ°ã€‚**

**æ‚¨èƒ½åšä»€éº¼ï¼Ÿ**

1. **æ–¹æ¡ˆ A**ï¼šä¿®æ”¹ Dify å·¥ä½œå®¤è¨­å®šï¼ˆæé«˜ Thresholdï¼‰
   - ä½ç½®: Dify å·¥ä½œå®¤ â†’ Protocol Guide â†’ æª¢ç´¢è¨­ç½®
   - æ•ˆæœ: æ¸›å°‘å€™é¸æ–‡æª”ï¼Œé¿å…è§¸ç™¼ Layer 3 é¸æ“‡

2. **æ–¹æ¡ˆ B**ï¼šä¿®æ”¹ç¨‹å¼ç¢¼æ””æˆªçµæœï¼ˆä¾µå…¥æ€§ï¼‰
   - ä½ç½®: `library/protocol_guide/two_tier_handler.py`
   - æ•ˆæœ: è¦†è“‹ Dify çš„é¸æ“‡ï¼Œä½¿ç”¨è‡ªè¨‚é‚è¼¯
   - åƒè€ƒ: è¦åŠƒæ–‡æª”ä¸­çš„ã€Œæ–¹æ¡ˆ C1ã€

3. **æ–¹æ¡ˆ C**ï¼šç§»é™¤ conversation_idï¼ˆæ¥µç«¯ï¼‰
   - ä½ç½®: `library/protocol_guide/two_tier_handler.py`
   - æ•ˆæœ: ç¦ç”¨å°è©±è¨˜æ†¶ï¼Œæ¸›å°‘ Layer 3 å¹²æ“¾
   - åƒè€ƒ: è¦åŠƒæ–‡æª”ä¸­çš„ã€Œæ–¹æ¡ˆ B1ã€

---

## ğŸ“… æ–‡æª”è³‡è¨Š

- **å‰µå»ºæ—¥æœŸ**: 2025-11-12
- **ç‰ˆæœ¬**: v1.0
- **ç”¨é€”**: è§£é‡‹ Layer 3 çš„ä½ç½®å’Œæ‚¨ç¨‹å¼ç¢¼çš„è™•ç†æ–¹å¼
- **ç›¸é—œæ–‡æª”**: 
  - `DIFY_AI_LAYER3_SELECTION_MECHANISM_ANALYSIS.md` - Layer 3 æ©Ÿåˆ¶è©³ç´°åˆ†æ
  - `LAYER3_STABILITY_IMPROVEMENT_PLAN.md` - ç©©å®šåº¦æå‡æ–¹æ¡ˆ
  - `PROTOCOL_ASSISTANT_ARCHITECTURE_VALIDATION.md` - æ¶æ§‹é©—è­‰

---

**ç°¡å–®èªªï¼šLayer 3 æ˜¯ Dify AI çš„ã€Œé­”æ³•ã€ï¼Œæ‚¨åªèƒ½çœ‹åˆ°çµæœï¼Œçœ‹ä¸åˆ°éç¨‹ã€‚** ğŸ©âœ¨
