# ğŸ” VSA æ¸¬è©¦ vs Web Protocol Assistant äºŒéšæœå°‹å°æ¯”åˆ†æ

## ğŸ“‹ å•é¡Œèªªæ˜

**ç”¨æˆ¶ç–‘å•**ï¼š
> Dify äºŒéšæœå°‹ v1.1 çš„å‹•ä½œçœŸçš„å¦‚åŒä½ ç•«çš„æµç¨‹åœ–ä¸€æ¨£å—ï¼Ÿå¦‚æœæ˜¯é€™æ¨£çš„è©±ï¼Œæ˜¯ä¸æ˜¯å°±è·Ÿ web Protocol Assistant è£¡é¢çš„å‹•ä½œæœ‰äº›ä¸ä¸€æ¨£äº†ï¼Ÿ

**æ ¸å¿ƒæ··æ·†é»**ï¼š
1. **VSA æ¸¬è©¦**ä¸­çš„ã€ŒDify äºŒéšæœå°‹ v1.1ã€æ˜¯ä»€éº¼æ„æ€ï¼Ÿ
2. **Web Protocol Assistant** çš„äºŒéšæ®µæœå°‹æµç¨‹æ˜¯ä»€éº¼ï¼Ÿ
3. å…©è€…çš„å·®ç•°åœ¨å“ªè£¡ï¼Ÿ

---

## âœ… é—œéµç™¼ç¾ï¼šå…©è€…å®Œå…¨ä¸åŒï¼

### ğŸ¯ çµè«–å…ˆè¡Œ

| ç‰¹æ€§ | VSA æ¸¬è©¦ (Dify äºŒéšæœå°‹ v1.1) | Web Protocol Assistant |
|------|------------------------------|------------------------|
| **åŸ·è¡Œæ–¹å¼** | âœ… **ä¸€æ¬¡æ€§** Dify API å‘¼å« | âŒ **ä¸æ˜¯**çœŸæ­£çš„äºŒéšæ®µ Dify å‘¼å« |
| **æœå°‹æ¬¡æ•¸** | 1 æ¬¡ | 1 æ¬¡ï¼ˆå¯¦éš›ä¸Šï¼‰ |
| **äºŒéšæœå°‹ä½ç½®** | ğŸ”§ **å¾Œç«¯**åŸ·è¡ŒäºŒéšæœå°‹ | ğŸ”§ **å¾Œç«¯**åŸ·è¡ŒäºŒéšæœå°‹ |
| **Dify å‘¼å«æ¬¡æ•¸** | 1 æ¬¡ | 1 æ¬¡ |
| **èª°æ±ºå®šäºŒéš** | ç‰ˆæœ¬é…ç½®ï¼ˆè³‡æ–™åº«ï¼‰ | ç‰ˆæœ¬é…ç½®ï¼ˆè³‡æ–™åº«ï¼‰ |
| **é©ç”¨å ´æ™¯** | Benchmark æ¸¬è©¦ | å¯¦éš›ç”¨æˆ¶ä½¿ç”¨ |

**ğŸš¨ é‡è¦æ¾„æ¸…**ï¼š
- **å…©è€…çš„ã€ŒäºŒéšæœå°‹ã€éƒ½æ˜¯æŒ‡å¾Œç«¯çš„æœå°‹ç­–ç•¥**
- **ä¸æ˜¯æŒ‡ã€Œå…©æ¬¡å‘¼å« Dify APIã€**
- **Web Protocol Assistant ç›®å‰æ²’æœ‰å¯¦ä½œã€Œç¬¬ä¸€æ¬¡ Dify â†’ åˆ¤æ–· â†’ ç¬¬äºŒæ¬¡ Difyã€çš„é‚è¼¯**

---

## ğŸ“Š è©³ç´°å°æ¯”åˆ†æ

### 1ï¸âƒ£ VSA æ¸¬è©¦ï¼ˆDify äºŒéšæœå°‹ v1.1ï¼‰

#### åŸ·è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ¸¬è©¦ç³»çµ± (DifyTestRunner)                                â”‚
â”‚    POST /v1/chat-messages                                   â”‚
â”‚    {                                                        â”‚
â”‚      "query": "CrystalDiskMark å¦‚ä½•æ”¾æ¸¬?",                  â”‚
â”‚      "user": "benchmark_tester"                             â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Dify è®€å–å·¥ä½œå®¤é…ç½®                                       â”‚
â”‚    Top K = 3ï¼ˆå‡è¨­ï¼‰                                        â”‚
â”‚    å‘¼å«å¤–éƒ¨çŸ¥è­˜åº« APIï¼š                                      â”‚
â”‚    POST /api/dify/knowledge/retrieval/                      â”‚
â”‚    {                                                        â”‚
â”‚      "retrieval_setting": {                                 â”‚
â”‚        "top_k": 3,                                          â”‚
â”‚        "score_threshold": 0.5                               â”‚
â”‚      }                                                      â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å¾Œç«¯åŸ·è¡ŒäºŒéšæœå°‹ï¼ˆåŸºæ–¼ç‰ˆæœ¬é…ç½®ï¼‰                          â”‚
â”‚                                                             â”‚
â”‚    # æª¢æŸ¥ç‰ˆæœ¬é…ç½®                                           â”‚
â”‚    if retrieval_mode == 'two_stage':                        â”‚
â”‚        # Stage 1: Section æœå°‹                              â”‚
â”‚        section_results = search(                            â”‚
â”‚            top_k=20,        # ç‰ˆæœ¬é…ç½® stage1.top_k        â”‚
â”‚            threshold=0.8,   # ç‰ˆæœ¬é…ç½® stage1.threshold    â”‚
â”‚            title_weight=95, # ç‰ˆæœ¬é…ç½®                     â”‚
â”‚            content_weight=5                                 â”‚
â”‚        )                                                    â”‚
â”‚                                                             â”‚
â”‚        # Stage 2: Document æœå°‹                             â”‚
â”‚        document_results = search(                           â”‚
â”‚            top_k=10,        # ç‰ˆæœ¬é…ç½® stage2.top_k        â”‚
â”‚            threshold=0.8,   # ç‰ˆæœ¬é…ç½® stage2.threshold    â”‚
â”‚            title_weight=10, # ç‰ˆæœ¬é…ç½®                     â”‚
â”‚            content_weight=90                                â”‚
â”‚        )                                                    â”‚
â”‚                                                             â”‚
â”‚        # åˆä½µçµæœï¼ˆæœ€å¤š 30 ç­†ï¼‰                             â”‚
â”‚        merged = section_results + document_results          â”‚
â”‚                                                             â”‚
â”‚        # æœ€å¾Œæ‰æ‡‰ç”¨ Dify çš„ top_k=3                        â”‚
â”‚        final = merged[:3]                                   â”‚
â”‚                                                             â”‚
â”‚    return final  # è¿”å›çµ¦ Dify                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é—œéµç‰¹å¾µ

1. **åªå‘¼å«ä¸€æ¬¡ Dify API**
2. **äºŒéšæœå°‹åœ¨å¾Œç«¯è‡ªå‹•åŸ·è¡Œ**ï¼ˆåŸºæ–¼ç‰ˆæœ¬é…ç½®çš„ `retrieval_mode`ï¼‰
3. **Dify æ”¶åˆ°çš„æ˜¯å·²ç¶“åˆä½µå¥½çš„çµæœ**
4. **ç‰ˆæœ¬é…ç½®æ±ºå®šæ˜¯å¦ä½¿ç”¨äºŒéšæœå°‹**

---

### 2ï¸âƒ£ Web Protocol Assistant

#### å¯¦éš›åŸ·è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‰ç«¯ç™¼é€è«‹æ±‚                                             â”‚
â”‚    POST /api/protocol-guides/chat/                          â”‚
â”‚    {                                                        â”‚
â”‚      "message": "CrystalDiskMark å¦‚ä½•æ”¾æ¸¬?",                â”‚
â”‚      "conversation_id": "xxx"                               â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ProtocolChatHandler è™•ç†è«‹æ±‚                             â”‚
â”‚                                                             â”‚
â”‚    def _execute_chat_request():                             â”‚
â”‚        payload = {                                          â”‚
â”‚            'query': message,                                â”‚
â”‚            'user': f"web_user_{user.id}",                   â”‚
â”‚            'response_mode': 'blocking'                      â”‚
â”‚        }                                                    â”‚
â”‚        # âš ï¸ åªç™¼é€ä¸€æ¬¡è«‹æ±‚çµ¦ Dify                           â”‚
â”‚        response = requests.post(                            â”‚
â”‚            dify_config.api_url,                             â”‚
â”‚            headers=headers,                                 â”‚
â”‚            json=payload                                     â”‚
â”‚        )                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Dify å‘¼å«å¤–éƒ¨çŸ¥è­˜åº«ï¼ˆèˆ‡ VSA æ¸¬è©¦ç›¸åŒï¼‰                    â”‚
â”‚    POST /api/dify/knowledge/retrieval/                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å¾Œç«¯åŸ·è¡Œæœå°‹ï¼ˆå¯èƒ½æ˜¯äºŒéšæœå°‹ï¼Œå–æ±ºæ–¼é…ç½®ï¼‰                â”‚
â”‚    # âš ï¸ èˆ‡ VSA æ¸¬è©¦ä½¿ç”¨ç›¸åŒçš„æœå°‹é‚è¼¯                       â”‚
â”‚    # âš ï¸ æ˜¯å¦äºŒéšæœå°‹å–æ±ºæ–¼ç•¶å‰çš„é…ç½®                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. è¿”å›ç­”æ¡ˆçµ¦å‰ç«¯                                           â”‚
â”‚    {                                                        â”‚
â”‚      "success": true,                                       â”‚
â”‚      "answer": "...",                                       â”‚
â”‚      "conversation_id": "..."                               â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é—œéµç‰¹å¾µ

1. **ä¹Ÿæ˜¯åªå‘¼å«ä¸€æ¬¡ Dify API** âœ…
2. **æ²’æœ‰ã€Œåˆ¤æ–·æ˜¯å¦éœ€è¦äºŒéšæ®µã€çš„é‚è¼¯** âŒ
3. **ä½¿ç”¨èˆ‡ VSA æ¸¬è©¦ç›¸åŒçš„å¾Œç«¯æœå°‹é‚è¼¯**
4. **æ˜¯å¦äºŒéšæœå°‹å–æ±ºæ–¼ç•¶å‰ç³»çµ±é…ç½®ï¼Œä¸æ˜¯å‹•æ…‹æ±ºå®š**

---

## ğŸš¨ æ‚¨æåˆ°çš„ã€Œç†æƒ³ä¸­çš„äºŒéšæ®µã€æµç¨‹

### æ‚¨æœŸæœ›çš„æµç¨‹ï¼ˆç›®å‰**æœªå¯¦ä½œ**ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éšæ®µ 1: ç¬¬ä¸€æ¬¡ Dify API å‘¼å«                                â”‚
â”‚                                                             â”‚
â”‚ POST /v1/chat-messages                                      â”‚
â”‚ {                                                           â”‚
â”‚   "query": "CrystalDiskMark å¦‚ä½•æ”¾æ¸¬?",                     â”‚
â”‚   "retrieval_setting": {                                    â”‚
â”‚     "search_mode": "section_only",  â† åªæœå°‹æ®µè½           â”‚
â”‚     "top_k": 20,                                            â”‚
â”‚     "title_weight": 95,                                     â”‚
â”‚     "content_weight": 5                                     â”‚
â”‚   }                                                         â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â”‚ Dify å›æ‡‰: "æ ¹æ“š Section æœå°‹ï¼Œæˆ‘æ‰¾åˆ°..."                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ¤æ–·éšæ®µ: AI åˆ†æå›æ‡‰                                        â”‚
â”‚                                                             â”‚
â”‚ if AI_å›æ‡‰_ä¸å¤ å®Œæ•´():                                       â”‚
â”‚     éœ€è¦é€²è¡Œç¬¬äºŒéšæ®µæœå°‹ = True                              â”‚
â”‚ else:                                                       â”‚
â”‚     ç›´æ¥è¿”å›ç­”æ¡ˆ                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éšæ®µ 2: ç¬¬äºŒæ¬¡ Dify API å‘¼å«ï¼ˆå¦‚æœéœ€è¦ï¼‰                     â”‚
â”‚                                                             â”‚
â”‚ POST /v1/chat-messages                                      â”‚
â”‚ {                                                           â”‚
â”‚   "query": "è«‹æä¾›æ›´è©³ç´°çš„å®Œæ•´æ–‡æª”å…§å®¹",                     â”‚
â”‚   "conversation_id": "previous_id",  â† å»¶çºŒå°è©±            â”‚
â”‚   "retrieval_setting": {                                    â”‚
â”‚     "search_mode": "document_only",  â† åªæœå°‹å…¨æ–‡æª”        â”‚
â”‚     "top_k": 10,                                            â”‚
â”‚     "title_weight": 10,                                     â”‚
â”‚     "content_weight": 90                                    â”‚
â”‚   }                                                         â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â”‚ Dify å›æ‡‰: "æ ¹æ“šå®Œæ•´æ–‡æª”ï¼Œè©³ç´°æ­¥é©Ÿæ˜¯..."                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### âš ï¸ ç‚ºä»€éº¼é€™å€‹æµç¨‹ç›®å‰æ²’æœ‰å¯¦ä½œï¼Ÿ

**åŸå›  1ï¼šæŠ€è¡“é™åˆ¶**
- Dify API ä¸æ”¯æ´åœ¨å–®æ¬¡è«‹æ±‚ä¸­æŒ‡å®š `search_mode`
- å¤–éƒ¨çŸ¥è­˜åº« API ä¹Ÿæ²’æœ‰ `search_mode` åƒæ•¸
- æœå°‹æ¨¡å¼æ˜¯ç”±å¾Œç«¯é…ç½®æ±ºå®šï¼Œä¸æ˜¯ç”± Dify è«‹æ±‚åƒæ•¸æ±ºå®š

**åŸå›  2ï¼šæ¶æ§‹è¨­è¨ˆ**
- ç•¶å‰çš„äºŒéšæœå°‹æ˜¯ã€Œä¸¦è¡ŒåŸ·è¡Œã€è€Œéã€Œé †åºåŸ·è¡Œã€
- Section æœå°‹å’Œ Document æœå°‹åŒæ™‚é€²è¡Œï¼Œç„¶å¾Œåˆä½µçµæœ
- ä¸æ˜¯ã€Œå…ˆ Sectionï¼Œåˆ¤æ–·å¾Œå† Documentã€

**åŸå›  3ï¼šæ•ˆèƒ½è€ƒé‡**
- å…©æ¬¡ Dify API å‘¼å«æœƒå¢åŠ å»¶é²ï¼ˆç´„ 2-5 ç§’ Ã— 2ï¼‰
- ç”¨æˆ¶é«”é©—æœƒå—å½±éŸ¿
- ç•¶å‰çš„ä¸¦è¡Œæœå°‹æ–¹å¼æ›´å¿«

---

## ğŸ“‹ å¯¦éš›ç¨‹å¼ç¢¼é©—è­‰

### VSA æ¸¬è©¦çš„å¯¦éš›ä»£ç¢¼

```python
# backend/library/dify_benchmark/dify_api_client.py

class DifyAPIClient:
    def send_question(self, question: str, ...):
        # æ§‹å»ºè«‹æ±‚ payload
        payload = {
            'query': question,
            'user': user_id,
            'response_mode': 'blocking',
            'inputs': {}
        }
        
        # âš ï¸ æ²’æœ‰å‚³é retrieval_setting
        # âš ï¸ æ²’æœ‰ search_mode
        # âš ï¸ å®Œå…¨äº¤çµ¦å¾Œç«¯æ±ºå®š
        
        response = self.request_manager.make_dify_request(
            api_url=self.api_url,
            headers=headers,
            payload=payload
        )
```

### Web Protocol Assistant çš„å¯¦éš›ä»£ç¢¼

```python
# library/dify_integration/protocol_chat_handler.py

class ProtocolChatHandler:
    def _execute_chat_request(self, message, ...):
        payload = {
            'inputs': {},
            'query': message,
            'response_mode': 'blocking',
            'user': f"web_user_{user.id}"
        }
        
        # âš ï¸ ä¹Ÿæ²’æœ‰å‚³é retrieval_setting
        # âš ï¸ ä¹Ÿæ²’æœ‰ search_mode
        # âš ï¸ ä¹Ÿæ˜¯å®Œå…¨äº¤çµ¦å¾Œç«¯æ±ºå®š
        
        response = self._make_dify_request(
            dify_config.api_url,
            headers,
            payload
        )
```

### å¾Œç«¯æœå°‹æœå‹™çš„å¯¦éš›ä»£ç¢¼

```python
# backend/library/benchmark/search_strategies/hybrid_weighted_strategy.py

class HybridWeightedStrategy(BaseSearchStrategy):
    def execute(self, query: str, ...):
        # Step 1: æ®µè½æœå°‹ï¼ˆstage=1ï¼‰
        section_results = self.search_service.search_with_vectors(
            query=query,
            limit=limit * 2,
            threshold=section_threshold,
            search_mode='section_only',
            stage=1  # âš ï¸ title=95%/content=5%
        )
        
        # Step 2: å…¨æ–‡æœå°‹ï¼ˆstage=2ï¼‰
        document_results = self.search_service.search_with_vectors(
            query=query,
            limit=limit * 2,
            threshold=document_threshold,
            search_mode='document_only',
            stage=2  # âš ï¸ title=10%/content=90%
        )
        
        # Step 3: åˆä½µçµæœ
        merged_results = self._weighted_merge(
            section_results, document_results,
            section_weight, document_weight
        )
        
        return merged_results
```

---

## ğŸ¯ ç¸½çµå°æ¯”è¡¨

| é …ç›® | VSA æ¸¬è©¦ | Web Protocol Assistant | æ‚¨æœŸæœ›çš„æµç¨‹ |
|------|---------|----------------------|-------------|
| **Dify API å‘¼å«æ¬¡æ•¸** | 1 æ¬¡ | 1 æ¬¡ | 2 æ¬¡ |
| **äºŒéšæœå°‹ä½ç½®** | å¾Œç«¯ä¸¦è¡ŒåŸ·è¡Œ | å¾Œç«¯ä¸¦è¡ŒåŸ·è¡Œ | å‰ç«¯é †åºæ§åˆ¶ |
| **åˆ¤æ–·é‚è¼¯** | ç‰ˆæœ¬é…ç½®æ±ºå®š | ç³»çµ±é…ç½®æ±ºå®š | AI å›æ‡‰åˆ¤æ–· |
| **æœå°‹æ¨¡å¼** | ä¸¦è¡Œï¼ˆSection + Documentï¼‰ | ä¸¦è¡Œï¼ˆSection + Documentï¼‰ | é †åºï¼ˆSection â†’ Documentï¼‰ |
| **å¯¦ä½œç‹€æ…‹** | âœ… å·²å¯¦ä½œ | âœ… å·²å¯¦ä½œ | âŒ æœªå¯¦ä½œ |

---

## ğŸ” ç‚ºä»€éº¼æœƒæœ‰é€™å€‹èª¤è§£ï¼Ÿ

### 1. **ã€ŒäºŒéšæœå°‹ã€çš„è¡“èªæ··æ·†**

- **å¾Œç«¯äºŒéšæœå°‹**ï¼šæŒ‡åœ¨å–®æ¬¡æœå°‹ä¸­ï¼ŒåŒæ™‚åŸ·è¡Œ Section å’Œ Document å…©ç¨®æœå°‹æ¨¡å¼
- **å‰ç«¯äºŒéšæ®µè™•ç†**ï¼šæŒ‡å…ˆå‘¼å« Difyï¼Œåˆ¤æ–·å¾Œå†æ¬¡å‘¼å« Difyï¼ˆæ‚¨æœŸæœ›çš„æ–¹å¼ï¼‰

### 2. **ç‰ˆæœ¬åç¨±å®¹æ˜“èª¤å°**

- **ã€ŒDify äºŒéšæœå°‹ v1.1ã€**ï¼šå¯¦éš›ä¸Šæ˜¯æŒ‡**å¾Œç«¯ä½¿ç”¨äºŒéšæœå°‹ç­–ç•¥**
- ä¸æ˜¯æŒ‡ã€Œå…©æ¬¡å‘¼å« Difyã€

### 3. **æ–‡æª”èªªæ˜ä¸å¤ æ¸…æ¥š**

- æˆ‘ä¹‹å‰çš„æµç¨‹åœ–å¯èƒ½è®“æ‚¨èª¤ä»¥ç‚ºæœ‰å…©æ¬¡ Dify å‘¼å«
- å¯¦éš›ä¸Šæ‰€æœ‰çš„ã€ŒäºŒéšã€éƒ½ç™¼ç”Ÿåœ¨å¾Œç«¯çš„å–®æ¬¡æœå°‹ä¸­

---

## ğŸ’¡ å¦‚æœè¦å¯¦ä½œæ‚¨æœŸæœ›çš„æµç¨‹

### éœ€è¦çš„æ”¹å‹•

#### 1. **å‰ç«¯éœ€è¦æ·»åŠ åˆ¤æ–·é‚è¼¯**

```python
# library/dify_integration/protocol_chat_handler.py

def _execute_two_phase_chat(self, message, dify_config, user):
    # Phase 1: Section æœå°‹
    phase1_response = self._call_dify_with_section_mode(message)
    
    # åˆ¤æ–·æ˜¯å¦éœ€è¦ Phase 2
    if self._need_phase2(phase1_response):
        # Phase 2: Document æœå°‹
        phase2_response = self._call_dify_with_document_mode(
            message,
            conversation_id=phase1_response['conversation_id']
        )
        return phase2_response
    else:
        return phase1_response
```

#### 2. **éœ€è¦å¾Œç«¯æ”¯æ´ search_mode åƒæ•¸**

```python
# å¤–éƒ¨çŸ¥è­˜åº« API éœ€è¦æ¥å— search_mode
POST /api/dify/knowledge/retrieval/
{
  "retrieval_setting": {
    "search_mode": "section_only",  # æˆ– "document_only"
    "top_k": 20
  }
}
```

#### 3. **éœ€è¦åˆ¤æ–·é‚è¼¯**

```python
def _need_phase2(self, phase1_response):
    """åˆ¤æ–·æ˜¯å¦éœ€è¦ç¬¬äºŒéšæ®µ"""
    answer = phase1_response.get('answer', '')
    
    # ç°¡å–®åˆ¤æ–·é‚è¼¯
    if 'æ‰¾ä¸åˆ°' in answer or 'æ²’æœ‰' in answer:
        return True
    if len(answer) < 100:  # å›ç­”å¤ªçŸ­
        return True
    return False
```

---

## âœ… æœ€çµ‚ç­”æ¡ˆ

**Dify äºŒéšæœå°‹ v1.1 çš„å¯¦éš›æµç¨‹**ï¼š
1. âœ… åªå‘¼å«ä¸€æ¬¡ Dify API
2. âœ… å¾Œç«¯è‡ªå‹•åŸ·è¡ŒäºŒéšæœå°‹ï¼ˆSection + Documentï¼‰
3. âœ… å…©ç¨®æœå°‹æ¨¡å¼ä¸¦è¡ŒåŸ·è¡Œï¼Œç„¶å¾Œåˆä½µçµæœ
4. âŒ **ä¸æ˜¯**å…ˆ Section å¾Œåˆ¤æ–·å† Document
5. âŒ **ä¸æ˜¯**å…©æ¬¡å‘¼å« Dify

**Web Protocol Assistant çš„å¯¦éš›æµç¨‹**ï¼š
- èˆ‡ VSA æ¸¬è©¦**å®Œå…¨ç›¸åŒ**
- ä¹Ÿæ˜¯ä¸€æ¬¡ Dify å‘¼å« + å¾Œç«¯äºŒéšæœå°‹
- æ²’æœ‰å¯¦ä½œã€Œåˆ¤æ–·å¾Œå†æ¬¡å‘¼å«ã€çš„é‚è¼¯

**æ‚¨æœŸæœ›çš„æµç¨‹**ï¼š
- ç›®å‰**æœªå¯¦ä½œ**
- éœ€è¦å‰ç«¯æ·»åŠ åˆ¤æ–·é‚è¼¯
- éœ€è¦å¾Œç«¯æ”¯æ´ search_mode åƒæ•¸
- éœ€è¦é¡å¤–çš„é–‹ç™¼å·¥ä½œ

---

**ğŸ“… æ›´æ–°æ—¥æœŸ**: 2025-11-25  
**ğŸ“ ç‰ˆæœ¬**: v1.0  
**âœï¸ ä½œè€…**: AI Platform Team  
**ğŸ¯ ç”¨é€”**: é‡æ¸… VSA æ¸¬è©¦å’Œ Web Protocol Assistant çš„äºŒéšæœå°‹å·®ç•°
